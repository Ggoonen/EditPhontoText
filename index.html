<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الأسطول</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Arabic', sans-serif;
            background-color: #0d1117;
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        body::-webkit-scrollbar {
            display: none;
        }
        body {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .btn {
            @apply px-6 py-3 rounded-full font-bold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-600 text-gray-100 hover:bg-gray-700;
        }
        .btn-success {
            @apply bg-green-600 text-white hover:bg-green-700;
        }
        .btn-warning {
            @apply bg-yellow-600 text-white hover:bg-yellow-700;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700;
        }
        .resource-btn-wrapper {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            background-color: #21262d;
            border-radius: 50px;
            padding: 5px 10px 5px 5px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            z-index: 1000;
            border: 2px solid #30363d;
            margin-top: 20px;
        }
        .resource-btn-wrapper:hover {
            background-color: #2b323b;
            transform: translateX(-50%) scale(1.05);
        }
        .resource-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .resource-btn::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 1;
        }
        .resource-btn .progress-circle {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        .resource-btn .circle-bg {
            fill: none;
            stroke: #3b4554;
            stroke-width: 8;
        }
        .resource-btn .circle-progress {
            fill: none;
            stroke: #f39c12;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s ease-out;
        }
        .resource-btn .resource-content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }
        .resource-btn .resource-content i {
            font-size: 1.5rem;
            margin-bottom: 0px;
        }
        .resource-btn .resource-content span {
            font-size: 0.8rem;
        }
        .resource-btn-text {
            font-size: 0.9rem;
            font-weight: bold;
            color: #e2e8f0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #161b22;
            color: #e2e8f0;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.7);
            width: 90%;
            max-width: 450px;
            text-align: center;
            border: 1px solid #30363d;
        }
        .close-button {
            color: #a0aec0;
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }
        .close-button:hover,
        .close-button:focus {
            color: #cbd5e0;
            text-decoration: none;
            cursor: pointer;
        }
        .section-container {
            position: relative;
            background-color: #161b22;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #30363d;
        }
        .header-container {
            background-color: #161b22;
            border-bottom: 4px solid #f39c12;
            padding: 12px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            position: relative;
            z-index: 10;
        }
        .header-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            padding: 0 16px;
        }
        .header-item {
            background-color: #21262d;
            border-radius: 10px;
            padding: 10px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            min-width: 70px;
        }
        .header-item i {
            font-size: 1.6rem;
            margin-bottom: 2px;
        }
        .header-item span {
            font-size: 0.85rem;
            font-weight: 700;
            color: #cbd5e0;
            text-align: center;
        }
        .header-fleet-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e2e8f0;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 16px;
            text-align: center;
            background-color: #21262d;
            border-radius: 10px;
            padding: 8px 15px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            max-width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .header-fleet-name #fleetName {
            margin-left: 8px;
            margin-right: 8px;
        }
        .header-fleet-name #fleetStarIcon {
            font-size: 1.2rem;
        }
        .header-logout-btn {
            background-color: #dc2626;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            transition: background-color 0.2s ease;
            margin-right: 16px;
        }
        .header-logout-btn:hover {
            background-color: #ef4444;
        }

        .pill-style-item {
            border-radius: 50px;
            padding: 1rem 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), inset 0 2px 5px rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            min-height: 120px;
        }

        .pill-style-item::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 1;
        }

        .pill-style-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.6), inset 0 2px 5px rgba(255, 255, 255, 0.3);
        }

        .pill-style-item .content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .pill-style-item i {
            font-size: 4rem;
            margin-bottom: 0.5rem;
            color: white;
        }

        .pill-style-item span {
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .pill-style-item .notification-dot {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 15px;
            height: 15px;
            background-color: #f39c12;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            z-index: 3;
        }


        .main-menu-item-bg-1 {
            background: linear-gradient(to bottom, #A0522D, #8B4513);
        }
        .main-menu-item-bg-2 {
            background: linear-gradient(to bottom, #8BC34A, #6B8E23);
        }
        .main-menu-item-bg-3 {
            background: linear-gradient(to bottom, #9370DB, #8A2BE2);
        }
        .main-menu-item-bg-4 {
            background: linear-gradient(to bottom, #FF8C00, #FF4500);
        }
        .main-menu-item-bg-5 {
            background: linear-gradient(to bottom, #4682B4, #4169E1);
        }
        .main-menu-item-bg-6 {
            background: linear-gradient(to bottom, #20B2AA, #008B8B);
        }
        .main-menu-item-bg-roulette {
            background: linear-gradient(to bottom, #DC143C, #8B0000);
        }
        .main-menu-item-bg-developments {
            background: linear-gradient(to bottom, #00BFFF, #1E90FF);
        }


        .store-item {
            background-color: #21262d;
            border-radius: 30px;
            padding: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 3px rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 100px;
            position: relative;
            overflow: hidden;
        }
        .store-item::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }

        .store-item:hover {
            transform: translateY(-3px);
        }

        .store-item i {
            font-size: 2.5rem;
            margin-bottom: 0.2rem;
            position: relative;
            z-index: 2;
        }

        .store-item h3 {
            font-size: 0.9rem;
            font-weight: bold;
            color: #e2e8f0;
            position: relative;
            z-index: 2;
        }
        .store-item .price-display {
            font-size: 0.8rem;
            font-weight: bold;
            color: #cbd5e0;
            margin-top: 0.2rem;
            display: flex;
            align-items: center;
            gap: 2px;
            position: relative;
            z-index: 2;
        }
        .store-item .price-display i.fa-dollar-sign {
            color: #4CAF50;
        }
        .store-item .price-display i.fa-key {
            color: #FFD700;
        }

        @keyframes gold-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .golden-text {
            background: linear-gradient(90deg, #ffd700, #ffec8b, #ffd700, #ffec8b);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: gold-animation 3s linear infinite;
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.5s ease-out forwards;
        }

        #storeItemDetailModal .modal-content {
            max-width: 500px;
            padding: 30px;
        }
        #storeItemDetailModal h2 {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }
        #storeItemDetailModal .item-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }
        #storeItemDetailModal .item-description {
            font-size: 1.1rem;
            color: #a0aec0;
            margin-bottom: 25px;
        }
        #storeItemDetailModal .item-price {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #storeItemDetailModal .item-price i.fa-dollar-sign {
            color: #4CAF50;
            margin-left: 10px;
            font-size: 1.8rem;
        }
        #storeItemDetailModal .item-price i.fa-key {
            color: #FFD700;
            margin-left: 10px;
            font-size: 1.8rem;
        }
        #storeItemDetailModal .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .pill-modal-btn {
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 3px rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
            color: white;
        }
        .pill-modal-btn::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        .pill-modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), inset 0 1px 3px rgba(255, 255, 255, 0.25);
        }
        .pill-modal-btn.bg-blue-600 {
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
        }
        .pill-modal-btn.bg-gray-600 {
            background: linear-gradient(to bottom, #6b7280, #4b5563);
        }

        .ship-item-card {
            background-color: #21262d;
            border-radius: 50px;
            padding: 1rem 1.5rem;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4), inset 0 2px 5px rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        .ship-item-card::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 50px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 1;
        }
        .ship-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.6), inset 0 2px 5px rgba(255, 255, 255, 0.3);
        }
        .ship-item-card .icon-container {
            position: relative;
            z-index: 2;
            margin-right: 1.5rem;
            padding-left: 10px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ship-item-card .icon-container i {
            font-size: 3.5rem;
            color: #60a5fa;
            position: absolute;
        }
        .ship-item-card .icon-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .ship-item-card .info-container {
            position: relative;
            z-index: 2;
            flex-grow: 1;
        }
        .ship-item-card h3 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e2e8f0;
            margin-bottom: 0.25rem;
        }
        .ship-item-card p {
            font-size: 1rem;
            color: #a0aec0;
        }
        .ship-item-card .progress-bar-wrapper {
            background-color: #4a5568;
            border-radius: 5px;
            height: 8px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .ship-item-card .progress-bar {
            background-color: #3b82f6;
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease-out;
        }
        .ship-item-card .level-text {
            font-size: 0.85rem;
            color: #cbd5e0;
            margin-top: 0.25rem;
        }
        .ship-item-card .upgrade-btn-container {
            position: relative;
            z-index: 2;
            margin-left: 1.5rem;
        }
        .ship-item-card .upgrade-btn {
            @apply px-5 py-2 rounded-full font-bold text-base transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg;
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
        }
        .ship-item-card .upgrade-btn::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        .ship-item-card .upgrade-btn:hover {
            transform: translateY(-2px);
        }

        @keyframes fall-and-fade {
            0% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(5px); opacity: 0.5; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .cooldown-active {
            animation: fall-and-fade 1.5s infinite ease-in-out;
        }

        .roulette-container {
            background-color: #21262d;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #30363d;
            max-width: 450px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .roulette-display-area {
            width: 100%;
            height: 200px;
            border-radius: 12px;
            background-color: #1a202c;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 1.5rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.7);
            border: 5px solid #30363d;
            overflow: hidden;
            font-size: 3.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            background-image: linear-gradient(to right, #2d3748 1px, transparent 1px), linear-gradient(to bottom, #2d3748 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .multiplier-display-bottom-right {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            z-index: 3;
        }

        .plane-path {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .plane-path svg {
            position: absolute;
            width: 32px;
            height: 32px;
            color: #FFD700;
            transition: transform linear;
            transform-origin: center center;
        }

        @keyframes crash-shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .roulette-display-area.crashed {
            background-color: #FF0000 !important;
            border-color: #CC0000 !important;
            box-shadow: 0 0 25px rgba(255,0,0,0.9) !important;
            animation: crash-shake 0.3s ease-in-out;
        }

        .roulette-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            margin-top: 1.5rem;
        }
        .roulette-controls input {
            background-color: #3b4554;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 0.75rem;
            color: #e2e8f0;
            text-align: center;
            font-size: 1.1rem;
        }
        .roulette-controls .spin-btn-style {
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 3px rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
            color: white;
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
        }
        .roulette-controls .spin-btn-style:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), inset 0 1px 3px rgba(255, 255, 255, 0.25);
        }
        .roulette-controls .cash-out-btn-style {
            background: linear-gradient(to bottom, #FFD700, #DAA520);
            color: #333;
            border: 2px solid rgba(255, 255, 255, 0.15);
        }
        .roulette-controls .cash-out-btn-style:hover {
            background: linear-gradient(to bottom, #FFEB3B, #FFC107);
        }

        .roulette-result {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 1.5rem;
            color: #e2e8f0;
        }
        .roulette-cooldown-display {
            font-size: 1rem;
            color: #a0aec0;
            margin-top: 0.5rem;
        }

        .ship-selection-option {
            background-color: #21262d;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .ship-selection-option:hover {
            background-color: #2b323b;
        }
        .ship-selection-option.selected {
            border-color: #f39c12;
            box-shadow: 0 0 10px rgba(243,156,18,0.5);
        }
        .ship-selection-option input[type="radio"] {
            margin-left: 10px;
            accent-color: #f39c12;
        }
        .ship-selection-option label {
            flex-grow: 1;
            text-align: right;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .ship-form-item {
            display: flex;
            align-items: center;
            background-color: #21262d;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 1px solid #30363d;
        }
        .ship-form-item .icon-wrapper {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            flex-shrink: 0;
        }
        .ship-form-item .icon-wrapper i {
            font-size: 2.5rem;
            color: #60a5fa;
        }
        .ship-form-item .icon-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .ship-form-item .text-content {
            flex-grow: 1;
            text-align: right;
        }
        .ship-form-item h4 {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e2e8f0;
        }
        .ship-form-item p {
            font-size: 0.9rem;
            color: #a0aec0;
        }
        .attack-player-item {
            background-color: #21262d;
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .attack-player-item .player-info {
            display: flex;
            flex-direction: column;
            text-align: right;
            flex-grow: 1;
        }
        .attack-player-item .player-info h3 {
            font-size: 1.2rem;
            font-weight: bold;
            color: #e2e8f0;
        }
        .attack-player-item .player-info p {
            font-size: 0.9rem;
            color: #a0aec0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }
        .attack-player-item .attack-btn-wrapper {
            margin-left: 15px;
            flex-shrink: 0;
        }
        .attack-player-btn {
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 3px rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
            color: white;
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
            min-width: 80px;
            text-align: center;
        }
        .attack-player-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), inset 0 1px 3px rgba(255, 255, 255, 0.25);
        }
        .attack-player-btn:disabled {
            background: linear-gradient(to bottom, #6b7280, #4b5563);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col" oncontextmenu="return false;">

    <div id="authModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">تسجيل الدخول / التسجيل</h2>
            <input type="email" id="authEmailInput" placeholder="البريد الإلكتروني" class="w-full p-3 rounded bg-gray-700 text-white border border-gray-600 mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="authPasswordInput" placeholder="كلمة المرور" class="w-full p-3 rounded bg-gray-700 text-white border border-gray-600 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex flex-col gap-3">
                <button id="loginBtn" class="btn btn-primary w-full">تسجيل الدخول</button>
                <button id="registerBtn" class="btn btn-secondary w-full">تسجيل جديد</button>
            </div>
        </div>
    </div>

    <div id="initialFleetNameModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">أهلاً بك أيها القائد!</h2>
            <p class="mb-6">الرجاء تعيين اسم لأسطولك:</p>
            <input type="text" id="initialFleetNameInput" placeholder="اسم الأسطول" class="w-full p-3 rounded bg-gray-700 text-white border border-gray-600 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="confirmInitialFleetNameBtn" class="btn btn-primary w-full">تأكيد</button>
        </div>
    </div>

    <header class="header-container w-full">
        <div class="header-stats-grid w-full max-w-4xl mx-auto">
            <div class="header-item">
                <i class="fas fa-fist-raised text-red-500"></i>
                <span id="playerPower">0</span>
            </div>
            <div class="header-item">
                <i class="fas fa-dollar-sign text-green-400"></i>
                <span id="playerMoney">0</span>
            </div>
            <div class="header-item">
                <i class="fas fa-key text-yellow-400"></i>
                <span id="playerKeys">0</span>
            </div>
        </div>
        <div class="header-fleet-name flex justify-between items-center px-4">
            <span id="fleetName">أسطولي العظيم</span>
            <i id="fleetStarIcon" class="fas fa-star text-yellow-300 hidden"></i>
        </div>
        <div class="text-center mt-2">
            <button id="logoutBtn" class="header-logout-btn">تسجيل الخروج</button>
        </div>
    </header>

    <main class="flex-grow p-4 flex flex-col items-center justify-center relative">
        <section id="mainMenu" class="grid grid-cols-2 md:grid-cols-3 gap-6 mb-8 w-full max-w-4xl hidden">
            <div class="pill-style-item main-menu-item-bg-1" onclick="showSection('myFleet')">
                <div class="content">
                    <i class="fas fa-ship"></i>
                    <span>أسطولي</span>
                </div>
            </div>
            <div class="pill-style-item main-menu-item-bg-2" onclick="showSection('store')">
                <div class="content">
                    <i class="fas fa-store"></i>
                    <span>المتجر</span>
                </div>
            </div>
            <div class="pill-style-item main-menu-item-bg-3" onclick="showSection('onlineSection')">
                <div class="content">
                    <i class="fas fa-globe"></i>
                    <span>اونلاين</span>
                </div>
            </div>
            <div class="pill-style-item main-menu-item-bg-roulette" onclick="showSection('rouletteSection')">
                <div class="content">
                    <i class="fas fa-dice"></i>
                    <span>روليت</span>
                </div>
            </div>
            <div class="pill-style-item main-menu-item-bg-developments" onclick="showSection('developmentsSection')">
                <div class="content">
                    <i class="fas fa-rocket"></i> 
                    <span>التطورات</span>
                </div>
            </div>
        </section>

        <section id="myFleet" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">أسطولي</h2>
            <div class="space-y-6">
                <div class="ship-item-card">
                    <div class="icon-container">
                        <i class="fas fa-ship"></i>
                        <img id="ship1IconImg" src="" alt="Ship Icon" class="w-full h-full object-contain" style="display: none;" draggable="false">
                    </div>
                    <div class="info-container">
                        <h3>السفينة الأساسية</h3>
                        <p>القوة: <span id="ship1Power">0</span></p>
                        <div class="progress-bar-wrapper">
                            <div id="ship1Progress" class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <p class="level-text">المستوى: <span id="ship1Level">0</span> / <span id="ship1MaxPower">10000</span></p>
                        <p id="ship1CooldownDisplay" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    <div class="upgrade-btn-container">
                        <button id="upgradeShip1" class="upgrade-btn">تطوير</button>
                    </div>
                </div>

                <div id="ship2Container" class="ship-item-card opacity-50 pointer-events-none">
                    <div class="icon-container">
                        <i class="fas fa-ship text-gray-500"></i>
                        <img id="ship2IconImg" src="" alt="Image of Ship Icon" style="display: none;" draggable="false">
                    </div>
                    <div class="info-container">
                        <h3 class="text-gray-400">السفينة الثانية</h3>
                        <p class="text-gray-300">القوة: <span id="ship2Power">0</span></p>
                        <div class="progress-bar-wrapper">
                            <div id="ship2Progress" class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <p class="level-text">المستوى: <span id="ship2Level">0</span> / <span id="ship2MaxPower">10000</span></p>
                        <p id="ship2CooldownDisplay" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    <div class="upgrade-btn-container">
                        <button id="upgradeShip2" class="upgrade-btn" disabled>تطوير</button>
                    </div>
                </div>

                <div id="ship3Container" class="ship-item-card opacity-50 pointer-events-none">
                    <div class="icon-container">
                        <i class="fas fa-ship text-gray-500"></i>
                        <img id="ship3IconImg" src="" alt="Image of Ship Icon" style="display: none;" draggable="false">
                    </div>
                    <div class="info-container">
                        <h3 class="text-gray-400">السفينة الثالثة</h3>
                        <p class="text-gray-300">القوة: <span id="ship3Power">0</span></p>
                        <div class="progress-bar-wrapper">
                            <div id="ship3Progress" class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <p class="level-text">المستوى: <span id="ship3Level">0</span> / <span id="ship3MaxPower">10000</span></p>
                        <p id="ship3CooldownDisplay" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    <div class="upgrade-btn-container">
                        <button id="upgradeShip3" class="upgrade-btn" disabled>تطوير</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="store" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">المتجر</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('completeUpgrade')">
                    <i class="fas fa-hourglass-end text-yellow-500"></i>
                    <h3>إكمال التطوير</h3>
                    <div class="price-display">
                        <span>3</span> <i class="fas fa-key"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('goldenName')">
                    <i class="fas fa-crown text-yellow-400"></i>
                    <h3>اسم ذهبي متحرك</h3>
                    <div class="price-display">
                        <span>1500</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('starIcon')">
                    <i class="fas fa-star text-yellow-300"></i>
                    <h3>أيقونة النجمة</h3>
                    <div class="price-display">
                        <span>3000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('shipExpansion')">
                    <i class="fas fa-expand-arrows-alt text-blue-400"></i>
                    <h3>توسيع السفينة</h3>
                    <div class="price-display">
                        <span>50</span> <i class="fas fa-key"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('buyKeys')">
                    <i class="fas fa-key text-yellow-400"></i>
                    <h3>شراء مفاتيح</h3>
                    <div class="price-display">
                        <span>150</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
            </div>
            <p class="text-center text-gray-300 mt-6">المزيد من العناصر قريباً!</p>
        </section>

        <section id="onlineSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">اونلاين</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="pill-style-item main-menu-item-bg-4" onclick="showSection('challengeLog')">
                    <div class="content">
                        <i class="fas fa-scroll"></i>
                        <span>سجل التحدي</span>
                    </div>
                </div>
                <div class="pill-style-item main-menu-item-bg-5" onclick="showSection('attackSection')">
                    <div class="content">
                        <i class="fas fa-crosshairs"></i>
                        <span>الهجوم</span>
                    </div>
                </div>
                <div class="pill-style-item main-menu-item-bg-6" onclick="showSection('onlinePlayersSection')">
                    <div class="content">
                        <i class="fas fa-users"></i>
                        <span>المتصلون حاليا</span>
                    </div>
                </div>
            </div>
        </section>

        <section id="rouletteSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">لعبة الطائرة</h2>
            <div class="roulette-container">
                <div id="rouletteGameElements">
                    <div id="rouletteDisplayArea" class="roulette-display-area">
                        <div class="plane-path">
                            <svg id="planeSvg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9L2 14v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1V20.5L13 19v-2.5l8 2.5z"/>
                            </svg>
                        </div>
                        <span id="multiplierDisplay" class="multiplier-display-bottom-right">1.00x</span>
                    </div>

                    <div class="roulette-controls">
                        <input type="number" id="betAmountInput" placeholder="مبلغ الرهان (20-2000)" min="20" max="2000" class="w-full">
                        <button id="startGameBtn" class="spin-btn-style">ابدأ الجولة</button>
                        <button id="cashOutBtn" class="spin-btn-style cash-out-btn-style hidden" disabled>استلام الأرباح (<span id="potentialWinnings">0</span>)</button>
                        <p id="rouletteResult" class="roulette-result hidden">النتيجة: </p>
                    </div>
                </div>
                <p id="rouletteCooldownDisplay" class="roulette-cooldown-display hidden">الجولة القادمة بعد: </p>
            </div>
        </section>

        <section id="developmentsSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">التطورات</h2>
            <div id="shipFormsList" class="text-right">
            </div>
        </section>

        <section id="challengeLog" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('onlineSection')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">سجل التحدي</h2>
            <ul id="challengeLogList" class="space-y-3">
            </ul>
        </section>

        <section id="attackSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('onlineSection')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">الهجوم</h2>
            <div id="attackablePlayersList" class="space-y-3">
            </div>
            <p class="text-center text-sm text-gray-500 mt-4">الفوز يمنحك 200-800 دولار وفرصة 15% للحصول على مفتاح. الخسارة لا تكلفك شيئاً.</p>
        </section>

        <section id="onlinePlayersSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('onlineSection')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">المتصلون حاليا</h2>
            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3 text-green-300">متصلون</h3>
                <ul id="onlinePlayersList" class="space-y-2">
                </ul>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-3 text-gray-400">غير متصلون</h3>
                <ul id="offlinePlayersList" class="space-y-2">
                </ul>
            </div>
        </section>
    </main>

    <div id="resourceCollectionBtnWrapper" class="resource-btn-wrapper hidden">
        <div id="resourceCollectionBtn" class="resource-btn">
            <svg class="progress-circle" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" class="circle-bg"></circle>
                <circle cx="50" cy="50" r="40" class="circle-progress"></circle>
            </svg>
            <div class="resource-content">
                <i class="fas fa-box-open"></i>
                <span id="accumulatedResourcesDisplay" class="text-lg font-bold">0/200</span>
            </div>
        </div>
        <span class="resource-btn-text">استلام</span>
    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <p id="modalMessage" class="text-lg font-semibold"></p>
            <button class="pill-modal-btn bg-blue-600 mt-4" onclick="closeModal()">حسناً</button>
        </div>
    </div>

    <div id="storeItemDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeStoreItemDetailModal(true)">&times;</span>
            <h2 id="storeItemTitle"></h2>
            <i id="storeItemIcon" class="item-icon"></i>
            <p id="storeItemDescription" class="item-description"></p>
            <p id="storeItemPrice" class="item-price"></p>
            <div class="modal-actions">
                <button id="buyStoreItemBtn" class="pill-modal-btn bg-blue-600">شراء</button>
                <button class="pill-modal-btn bg-gray-600" onclick="closeStoreItemDetailModal(true)">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="shipSelectionModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeShipSelectionModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-4" id="shipExpansionModalTitle">توسيع السفينة</h2>
            <i id="shipExpansionModalIcon" class="item-icon fas fa-expand-arrows-alt text-blue-400"></i>
            <p id="shipExpansionModalDescription" class="item-description">يزيد الحد الأقصى لقوة السفينة المختارة بمقدار 5000 نقطة قوة إضافية. يمكن شراء هذا التوسيع عدة مرات لأي سفينة.</p>
            <p id="shipExpansionModalPrice" class="item-price">10000 <i class="fas fa-dollar-sign text-green-400"></i></p>
            
            <h3 class="text-xl font-bold mb-3">اختر سفينة للتوسيع:</h3>
            <div id="shipSelectionOptions" class="flex flex-col gap-3 mb-6">
            </div>
            <div class="modal-actions">
                <button id="confirmShipExpansionBtn" class="pill-modal-btn bg-blue-600">تأكيد التوسيع</button>
                <button class="pill-modal-btn bg-gray-600" onclick="closeShipSelectionModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, push, query, orderByChild, onDisconnect, serverTimestamp, limitToLast } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBAepZChU6qfWGTQDrzEpJm_TRIrr6vhq8",
            authDomain: "mygame-7c747.firebaseapp.com",
            databaseURL: "https://mygame-7c747-default-rtdb.firebaseio.com",
            projectId: "mygame-7c747",
            appId: "1:191691681571:web:8dbc3991cb550b5e026696",
            storageBucket: "mygame-7c747.firebasestorage.app",
            messagingSenderId: "191691681571",
            measurementId: "G-XDP3YKZGH3"
        };

        const appId = firebaseConfig.projectId; 

        let app;
        let db;
        let auth;
        let userId = null;
        let userDbRef = null; 
        let onlinePlayersListener = null; 
        let attackLogListener = null; 

        let playerPower = 0;
        let playerMoney = 0;
        let playerKeys = 0;
        let fleetName = null; 
        let isGoldenNameActive = false;
        let isStarIconActive = false;

        const INITIAL_SHIP_MAX_POWER = 10000;
        const UPGRADE_COOLDOWN_MS = 3 * 60 * 1000;
        const ATTACK_COOLDOWN_GLOBAL_MS = 7 * 60 * 1000; 

        let globalAttackCooldownEndTime = 0;
        let lastAttackedOpponentId = null; 
        let lastGlobalCooldownState = false; 

        let ship1 = { power: 0, level: 0, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };
        let ship2 = { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };
        let ship3 = { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };

        let accumulatedResources = 0;
        const MAX_ACCUMULATED_RESOURCES = 200;
        const RESOURCE_ACCUMULATION_INTERVAL_MS = 3000;

        const storeItems = {
            completeUpgrade: {
                title: 'إكمال التطوير',
                icon: 'fas fa-hourglass-end text-yellow-500',
                description: 'ينهي وقت انتظار تطوير السفن.',
                price: 3, 
                currency: 'key' 
            },
            goldenName: {
                title: 'اسم ذهبي متحرك',
                icon: 'fas fa-crown text-yellow-400',
                description: 'اجعل اسم أسطولك يتوهج بالذهب.',
                price: 1500,
                currency: 'money'
            },
            starIcon: {
                title: 'أيقونة النجمة',
                icon: 'fas fa-star text-yellow-300',
                description: 'أضف نجمة لامعة بجانب اسمك.',
                price: 3000,
                currency: 'money'
            },
            shipExpansion: {
                title: 'توسيع السفينة',
                icon: 'fas fa-expand-arrows-alt text-blue-400',
                description: 'يزيد الحد الأقصى لقوة السفينة المختارة بمقدار 5000 نقطة قوة إضافية. يمكن شراء هذا التوسيع عدة مرات لأي سفينة.',
                price: 50, 
                currency: 'key' 
            },
            buyKeys: { 
                title: 'شراء مفاتيح',
                icon: 'fas fa-key text-yellow-400',
                description: 'احصل على المزيد من المفاتيح لفتح الميزات أو إكمال التطوير.',
                price: 150, 
                currency: 'money',
                amount: 1 
            }
        };

        const ROULETTE_COOLDOWN_MS = 1 * 60 * 1000;
        let rouletteCooldownEndTime = 0;

        let gameActive = false;
        let currentMultiplier = 1.00;
        let crashPoint = 0;
        let betAmount = 0;
        let hasCashedOut = false;
        let animationFrameId;
        let lastFrameTime = 0;

        let playerPowerEl;
        let playerMoneyEl;
        let playerKeysEl;
        let fleetNameEl;
        let fleetStarIconEl;
        let logoutBtn;

        let ship1PowerEl;
        let ship1LevelEl;
        let ship1ProgressEl;
        let ship1MaxPowerEl;
        let upgradeShip1Btn;
        let ship1CooldownDisplay;
        let ship1IconContainerEl; 
        let ship1IconIEl;
        let ship1IconImgEl;

        let ship2Container;
        let ship2PowerEl;
        let ship2LevelEl;
        let ship2ProgressEl;
        let ship2MaxPowerEl;
        let upgradeShip2Btn;
        let ship2CooldownDisplay;
        let ship2IconContainerEl; 
        let ship2IconImgEl;
        let ship2IconIEl;

        let ship3Container;
        let ship3PowerEl;
        let ship3LevelEl;
        let ship3ProgressEl;
        let ship3MaxPowerEl;
        let upgradeShip3Btn;
        let ship3CooldownDisplay;
        let ship3IconContainerEl; 
        let ship3IconImgEl;
        let ship3IconIEl;

        let mainMenuSection;
        let myFleetSection;
        let storeSection;
        let onlineSection;
        let rouletteSection;
        let developmentsSection; 
        let challengeLogSection;
        let attackSection;
        let onlinePlayersSection;

        let messageModal;
        let modalMessage;

        let authModal;
        let authEmailInput;
        let authPasswordInput;
        let loginBtn;
        let registerBtn;

        let initialFleetNameModal;
        let initialFleetNameInput;
        let confirmInitialFleetNameBtn;

        let resourceCollectionBtnWrapper;
        let resourceCollectionBtn;
        let accumulatedResourcesDisplay;
        let circleProgress;
        let resourceBtnTextEl; 
        let resourceBtnIconEl; 
        const radius = 40;
        const circumference = 2 * Math.PI * radius;

        let storeItemDetailModal;
        let storeItemTitle;
        let storeItemIcon;
        let storeItemDescription;
        let storeItemPrice;
        let buyStoreItemBtn;
        let currentStoreItemKey = null;

        let rouletteGameElements; 
        let rouletteDisplayArea;
        let multiplierDisplay;
        let betAmountInput;
        let startGameBtn;
        let cashOutBtn;
        let potentialWinningsEl;
        let rouletteResult;
        let rouletteCooldownDisplay;
        let planeSvg;

        let shipFormsList; 

        let onlinePlayersListEl;
        let offlinePlayersListEl;
        let challengeLogListEl;
        let attackablePlayersListEl;

        const shipFormsData = [
            { levelRange: '1 - 1000', iconType: 'font-awesome', iconClass: 'fas fa-ship', imgSrc: '' },
            { levelRange: '1001 - 4000', iconType: 'image', iconClass: '', imgSrc: 'https://l.top4top.io/p_3482en0id0.png' },
            { levelRange: '4001 - 9999', iconType: 'image', iconClass: '', imgSrc: 'https://b.top4top.io/p_3482vv1ax2.png' },
            { levelRange: '10000+', iconType: 'image', iconClass: '', imgSrc: 'https://c.top4top.io/p_3482878s83.png' }
        ];

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'm';
            }
            if (num >= 10000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        window.showMessage = function(message) {
            modalMessage.textContent = message;
            modalMessage.classList.remove('hidden');
            messageModal.style.display = 'flex';
        }

        window.closeModal = function() {
            messageModal.style.display = 'none';
        }

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userDbRef = ref(db, `artifacts/${appId}/users/${userId}/playerData`);
                        console.log("Firebase Auth State Changed: User logged in. userId:", userId);
                        
                        const presenceRef = ref(db, `artifacts/${appId}/public/onlinePlayers/${userId}/isOnline`);
                        const lastSeenRef = ref(db, `artifacts/${appId}/public/onlinePlayers/${userId}/lastSeen`);
                        
                        onDisconnect(presenceRef).set(false);
                        onDisconnect(lastSeenRef).set(serverTimestamp());

                        await fetchOrCreateUserData();
                        await updateOnlineStatus(true); 
                        setupPublicDataListeners();

                        authModal.style.display = 'none';

                        setInterval(() => {
                            if (userId) {
                                updateOnlineStatus(true);
                            }
                        }, 30 * 1000); 
                    } else {
                        console.log("Firebase Auth State Changed: User logged out or no user.");
                        userId = null;
                        clearPublicDataListeners();
                        authModal.style.display = 'flex';
                        showSection('hidden'); // Hide all game sections
                        resourceCollectionBtnWrapper.classList.add('hidden');
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                window.showMessage("حدث خطأ في الاتصال بالخادم. يرجى المحاولة لاحقاً.");
            }
        }

        async function registerUser() {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                window.showMessage('تم التسجيل بنجاح! يمكنك الآن تسجيل الدخول.');
                console.log("User registered:", email);
            } catch (error) {
                console.error("Error during registration:", error);
                window.showMessage(`خطأ في التسجيل: ${error.message}`);
            }
        }

        async function loginUser() {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                window.showMessage('تم تسجيل الدخول بنجاح!');
                console.log("User logged in:", email);
            } catch (error) {
                console.error("Error during login:", error);
                window.showMessage(`خطأ في تسجيل الدخول: ${error.message}`);
            }
        }

        async function logoutUser() {
            try {
                await signOut(auth);
                window.showMessage('تم تسجيل الخروج بنجاح!');
                console.log("User logged out.");
            } catch (error) {
                console.error("Error during logout:", error);
                window.showMessage(`خطأ في تسجيل الخروج: ${error.message}`);
            }
        }

        async function fetchOrCreateUserData() {
            if (!userId) {
                console.warn("fetchOrCreateUserData called without userId.");
                return;
            }
            console.log("Attempting to fetch user data for userId:", userId);
            try {
                const snapshot = await get(userDbRef);
                if (snapshot.exists()) {
                    console.log("User data exists. Loading data.");
                    const data = snapshot.val();
                    
                    playerMoney = data.money !== undefined ? data.money : 0;
                    playerKeys = data.keys !== undefined ? data.keys : 0;
                    fleetName = data.fleetName !== undefined ? data.fleetName : null;
                    isGoldenNameActive = data.isGoldenNameActive !== undefined ? data.isGoldenNameActive : false;
                    isStarIconActive = data.isStarIconActive !== undefined ? data.isStarIconActive : false;

                    // Initialize ship objects with defaults if missing or incomplete
                    ship1 = { 
                        power: (data.ship1 && data.ship1.power !== undefined) ? data.ship1.power : 0,
                        level: (data.ship1 && data.ship1.level !== undefined) ? data.ship1.level : 0,
                        cooldownEndTime: (data.ship1 && data.ship1.cooldownEndTime !== undefined) ? data.ship1.cooldownEndTime : 0,
                        maxPower: (data.ship1 && data.ship1.maxPower !== undefined) ? data.ship1.maxPower : INITIAL_SHIP_MAX_POWER
                    };
                    ship2 = { 
                        power: (data.ship2 && data.ship2.power !== undefined) ? data.ship2.power : 0,
                        level: (data.ship2 && data.ship2.level !== undefined) ? data.ship2.level : 0,
                        unlocked: (data.ship2 && data.ship2.unlocked !== undefined) ? data.ship2.unlocked : false,
                        cooldownEndTime: (data.ship2 && data.ship2.cooldownEndTime !== undefined) ? data.ship2.cooldownEndTime : 0,
                        maxPower: (data.ship2 && data.ship2.maxPower !== undefined) ? data.ship2.maxPower : INITIAL_SHIP_MAX_POWER
                    };
                    ship3 = { 
                        power: (data.ship3 && data.ship3.power !== undefined) ? data.ship3.power : 0,
                        level: (data.ship3 && data.ship3.level !== undefined) ? data.ship3.level : 0,
                        unlocked: (data.ship3 && data.ship3.unlocked !== undefined) ? data.ship3.unlocked : false,
                        cooldownEndTime: (data.ship3 && data.ship3.cooldownEndTime !== undefined) ? data.ship3.cooldownEndTime : 0,
                        maxPower: (data.ship3 && data.ship3.maxPower !== undefined) ? data.ship3.maxPower : INITIAL_SHIP_MAX_POWER
                    };

                    globalAttackCooldownEndTime = data.globalAttackCooldownEndTime !== undefined ? data.globalAttackCooldownEndTime : 0;
                    rouletteCooldownEndTime = data.rouletteCooldownEndTime !== undefined ? data.rouletteCooldownEndTime : 0;

                    console.log("Data loaded successfully:", { playerMoney, playerKeys, fleetName, isGoldenNameActive, isStarIconActive, ship1, ship2, ship3, globalAttackCooldownEndTime, rouletteCooldownEndTime });

                } else {
                    console.log("User data does NOT exist. Initializing new data.");
                    fleetName = "أسطولي العظيم"; // Default name for new users
                    playerMoney = 100;
                    playerKeys = 1;
                    isGoldenNameActive = false;
                    isStarIconActive = false;
                    ship1 = { power: 0, level: 0, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };
                    ship2 = { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };
                    ship3 = { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };
                    globalAttackCooldownEndTime = 0;
                    rouletteCooldownEndTime = 0;

                    await set(userDbRef, {
                        money: playerMoney,
                        keys: playerKeys,
                        fleetName: fleetName,
                        isGoldenNameActive: isGoldenNameActive,
                        isStarIconActive: isStarIconActive,
                        ship1: ship1,
                        ship2: ship2,
                        ship3: ship3,
                        globalAttackCooldownEndTime: globalAttackCooldownEndTime,
                        rouletteCooldownEndTime: rouletteCooldownEndTime
                    });
                    console.log("New data initialized and saved to Firebase.");
                }

                updatePlayerStats();
                updateAllShipCooldowns(); 
                updateResourceCircle();
                updateResourceButtonState();
                updateRouletteCooldownUI();
                updateAttackCooldownsUI(); 

                if (fleetName === null || fleetName === "أسطولي العظيم") {
                    initialFleetNameModal.style.display = 'flex';
                } else {
                    window.showSection('mainMenu');
                }

            } catch (error) {
                console.error("Error during fetchOrCreateUserData:", error);
                window.showMessage("حدث خطأ أثناء تحميل بياناتك. يرجى المحاولة لاحقاً.");
            }
        }

        async function saveUserData() {
            if (!userDbRef || !userId) {
                console.warn("saveUserData called without userDbRef or userId. Data not saved.");
                return;
            }
            console.log("Attempting to save user data for userId:", userId);
            try {
                await set(userDbRef, {
                    money: playerMoney,
                    keys: playerKeys,
                    fleetName: fleetName,
                    isGoldenNameActive: isGoldenNameActive,
                    isStarIconActive: isStarIconActive,
                    ship1: ship1,
                    ship2: ship2,
                    ship3: ship3,
                    globalAttackCooldownEndTime: globalAttackCooldownEndTime, 
                    rouletteCooldownEndTime: rouletteCooldownEndTime
                });
                console.log("User data saved successfully.");
            } catch (error) {
                console.error("Error during saveUserData:", error);
                window.showMessage("حدث خطأ أثناء حفظ بياناتك. يرجى المحاولة لاحقاً.");
            }
        }

        async function updateOnlineStatus(isOnline) {
            if (!userId || !fleetName) return;
            try {
                const playerStatusRef = ref(db, `artifacts/${appId}/public/onlinePlayers/${userId}`);
                await set(playerStatusRef, {
                    userId: userId,
                    fleetName: fleetName,
                    power: playerPower,
                    isOnline: isOnline,
                    lastSeen: Date.now(),
                    ship1Power: ship1.power,
                    ship2Power: ship2.power,
                    ship3Power: ship3.power,
                    ship2Unlocked: ship2.unlocked,
                    ship3Unlocked: ship3.unlocked
                });
            } catch (error) {
                console.error("Error updating online status:", error);
            }
        }

        function setupPublicDataListeners() {
            if (!db) return;
            console.log("Setting up public data listeners.");

            const playersRef = ref(db, `artifacts/${appId}/public/onlinePlayers`);
            onlinePlayersListener = onValue(playersRef, (snapshot) => {
                const data = snapshot.val();
                const allPlayers = [];
                if (data) {
                    for (const key in data) {
                        allPlayers.push(data[key]);
                    }
                }
                updateOnlinePlayersUI(allPlayers);
                if (document.getElementById('attackSection').classList.contains('animate-fade-in-up')) {
                    renderAttackablePlayers(allPlayers);
                }
            }, (error) => {
                console.error("Error listening to online players:", error);
            });

            const attackLogRef = ref(db, `artifacts/${appId}/public/attackLog`);
            const attackLogQuery = query(attackLogRef, orderByChild('timestamp'), limitToLast(5));
            attackLogListener = onValue(attackLogQuery, (snapshot) => {
                const data = snapshot.val();
                const attacks = [];
                if (data) {
                    for (const key in data) {
                        attacks.push(data[key]);
                    }
                }
                attacks.sort((a, b) => b.timestamp - a.timestamp); 
                updateChallengeLogUI(attacks);
            }, (error) => {
                console.error("Error listening to attack log:", error);
            });
        }

        function clearPublicDataListeners() {
            console.log("Clearing public data listeners.");
            if (onlinePlayersListener) {
                onlinePlayersListener(); 
                onlinePlayersListener = null;
            }
            if (attackLogListener) {
                attackLogListener();
                attackLogListener = null;
            }
        }

        function updateOnlinePlayersUI(players) {
            if (!onlinePlayersListEl || !offlinePlayersListEl) return;

            onlinePlayersListEl.innerHTML = '';
            offlinePlayersListEl.innerHTML = '';

            const online = players.filter(p => p.isOnline && p.userId !== userId);
            const offline = players.filter(p => !p.isOnline && p.userId !== userId);

            const getStrongestShipPower = (playerData) => {
                let maxPower = 0;
                if (playerData.ship1Power) maxPower = Math.max(maxPower, playerData.ship1Power);
                if (playerData.ship2Power) maxPower = Math.max(maxPower, playerData.ship2Power);
                if (playerData.ship3Power) maxPower = Math.max(maxPower, playerData.ship3Power);
                return maxPower;
            };

            const getUnlockedShipCount = (playerData) => {
                let count = 1;
                if (playerData.ship2Unlocked) count++;
                if (playerData.ship3Unlocked) count++;
                return count;
            };

            if (online.length === 0) {
                onlinePlayersListEl.innerHTML = '<p class="text-center text-gray-400">لا يوجد لاعبون متصلون حالياً غيرك.</p>';
            } else {
                online.forEach(player => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-700 p-3 rounded-md mb-2 flex justify-between items-center';
                    const strongestPower = getStrongestShipPower(player);
                    const unlockedShipsCount = getUnlockedShipCount(player);
                    li.innerHTML = `
                        <span class="font-bold text-green-400">${player.fleetName}</span>
                        <span class="text-sm text-gray-300 ml-2">
                            <i class="fas fa-fist-raised text-red-500 ml-1"></i> ${formatNumber(strongestPower)}
                        </span>
                        <span class="text-sm text-gray-300 ml-2">
                            <i class="fas fa-ship text-blue-400 ml-1"></i> ${unlockedShipsCount}
                        </span>
                    `;
                    onlinePlayersListEl.appendChild(li);
                });
            }

            if (offline.length === 0) {
                offlinePlayersListEl.innerHTML = '<p class="text-center text-gray-400">لا يوجد لاعبون غير متصلين حالياً.</p>';
            } else {
                offline.forEach(player => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-800 p-3 rounded-md mb-2 flex justify-between items-center opacity-70';
                    const strongestPower = getStrongestShipPower(player);
                    const unlockedShipsCount = getUnlockedShipCount(player);
                    li.innerHTML = `
                        <span class="font-bold text-gray-400">${player.fleetName}</span>
                        <span class="text-sm text-gray-500 ml-2">
                            <i class="fas fa-fist-raised text-red-500 ml-1"></i> ${formatNumber(strongestPower)}
                        </span>
                        <span class="text-sm text-gray-500 ml-2">
                            <i class="fas fa-ship text-blue-400 ml-1"></i> ${unlockedShipsCount}
                        </span>
                    `;
                    offlinePlayersListEl.appendChild(li);
                });
            }
        }

        function updateChallengeLogUI(attacks) {
            if (!challengeLogListEl) return;

            challengeLogListEl.innerHTML = '';
            if (attacks.length === 0) {
                challengeLogListEl.innerHTML = '<p class="text-center text-gray-400">لا يوجد سجلات هجوم حالياً.</p>';
                return;
            }

            attacks.forEach(attack => {
                const li = document.createElement('li');
                li.className = 'bg-gray-700 p-3 rounded-md mb-2';
                let resultText = '';
                let resultColor = '';
                let winningsText = '';

                if (attack.attackerId === userId) {
                    if (attack.result === 'win') {
                        resultText = 'فزت';
                        resultColor = 'text-green-400';
                        if (attack.winnings && attack.winnings.money !== undefined) { 
                            winningsText = ` +${formatNumber(attack.winnings.money)} <i class="fas fa-dollar-sign"></i>`;
                        }
                        if (attack.winnings && attack.winnings.key !== undefined) { 
                            winningsText += ` +${attack.winnings.key} <i class="fas fa-key"></i>`;
                        }
                    } else {
                        resultText = 'خسرت';
                        resultColor = 'text-red-400';
                    }
                    li.innerHTML = `<span class="font-bold ${resultColor}">أنت</span> ${resultText} ضد <span class="font-bold">${attack.defenderFleetName}</span>. ${winningsText}`;
                } else if (attack.defenderId === userId) {
                    if (attack.result === 'win') {
                        resultText = 'فاز';
                        resultColor = 'text-green-400';
                    } else {
                        resultText = 'خسر';
                        resultColor = 'text-red-400';
                    }
                    li.innerHTML = `<span class="font-bold">${attack.attackerFleetName}</span> ${resultText} ضد <span class="font-bold ${resultColor}">أسطولك</span>.`;
                } else {
                    if (attack.result === 'win') {
                        resultText = 'فاز';
                        resultColor = 'text-green-400';
                    } else {
                        resultText = 'خسر';
                        resultColor = 'text-red-400';
                    }
                    li.innerHTML = `<span class="font-bold">${attack.attackerFleetName}</span> ${resultText} ضد <span class="font-bold">${attack.defenderFleetName}</span>.`;
                }
                
                const timestamp = typeof attack.timestamp === 'number' ? attack.timestamp : Date.now();
                li.innerHTML += `<p class="text-xs text-gray-500 mt-1">${new Date(timestamp).toLocaleString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>`;
                challengeLogListEl.appendChild(li);
            });
        }

        function renderAttackablePlayers(allPlayers) {
            if (!attackablePlayersListEl || !userId) return;

            attackablePlayersListEl.innerHTML = '';
            let otherPlayers = allPlayers.filter(p => p.userId !== userId);

            const cooldownActive = globalAttackCooldownEndTime > Date.now();
            if (cooldownActive && lastAttackedOpponentId) {
                otherPlayers = otherPlayers.filter(p => p.userId !== lastAttackedOpponentId);
            }

            if (otherPlayers.length === 0) {
                attackablePlayersListEl.innerHTML = '<p class="text-center text-gray-400">لا يوجد لاعبون آخرون للهجوم عليهم حالياً.</p>';
                return;
            }

            otherPlayers.forEach(opponent => {
                const li = document.createElement('div');
                li.className = 'attack-player-item';

                const strongestPower = Math.max(opponent.ship1Power || 0, opponent.ship2Power || 0, opponent.ship3Power || 0);
                const unlockedShipsCount = (opponent.ship2Unlocked ? 1 : 0) + (opponent.ship3Unlocked ? 1 : 0) + 1;

                const cooldownRemaining = globalAttackCooldownEndTime - Date.now();
                const isOnCooldown = cooldownRemaining > 0;
                const buttonText = isOnCooldown ? formatTime(cooldownRemaining) : 'هجوم';
                const buttonDisabled = isOnCooldown ? 'disabled' : '';

                li.innerHTML = `
                    <div class="player-info">
                        <h3>${opponent.fleetName}</h3>
                        <p>
                            <i class="fas fa-fist-raised text-red-500"></i> ${formatNumber(strongestPower)}
                            <i class="fas fa-ship text-blue-400"></i> ${unlockedShipsCount}
                        </p>
                    </div>
                    <div class="attack-btn-wrapper">
                        <button class="attack-player-btn" data-opponent-id="${opponent.userId}" ${buttonDisabled}>
                            ${buttonText}
                        </button>
                    </div>
                `;
                attackablePlayersListEl.appendChild(li);

                const attackButton = li.querySelector('.attack-player-btn');
                attackButton.addEventListener('click', () => performAttack(opponent));
            });
        }

        async function performAttack(opponent) {
            if (!opponent) {
                window.showMessage("الرجاء اختيار خصم أولاً.");
                return;
            }
            if (globalAttackCooldownEndTime > Date.now()) {
                window.showMessage(`لا يمكنك الهجوم الآن. يرجى الانتظار ${formatTime(globalAttackCooldownEndTime - Date.now())}.`);
                return;
            }

            let win = false;
            if (playerPower > opponent.power) {
                win = Math.random() < 0.9; 
            } else {
                win = Math.random() < 0.4; 
            }

            let winnings = { money: 0, key: 0 };
            let resultText = '';

            if (win) {
                const moneyGain = Math.floor(Math.random() * (800 - 200 + 1)) + 200;
                playerMoney += moneyGain;
                winnings.money = moneyGain;
                resultText = `لقد فزت! حصلت على ${formatNumber(moneyGain)} أموال.`;

                if (Math.random() < 0.15) {
                    playerKeys += 1;
                    winnings.key = 1;
                    resultText += " وحصلت على مفتاح!";
                }
            } else {
                resultText = "لقد خسرت الهجوم. لم تخسر شيئاً.";
            }

            window.showMessage(resultText);
            updatePlayerStats();

            globalAttackCooldownEndTime = Date.now() + ATTACK_COOLDOWN_GLOBAL_MS;
            lastAttackedOpponentId = opponent.userId; 
            await saveUserData();
            
            if (document.getElementById('attackSection').classList.contains('animate-fade-in-up')) {
                const playersRef = ref(db, `artifacts/${appId}/public/onlinePlayers`);
                get(playersRef).then(snapshot => {
                    const data = snapshot.val();
                    const allPlayers = [];
                    if (data) {
                        for (const key in data) {
                            allPlayers.push(data[key]);
                        }
                    }
                    renderAttackablePlayers(allPlayers);
                }).catch(error => {
                    console.error("Error re-rendering attackable players after attack:", error);
                    window.showMessage("حدث خطأ أثناء تحميل قائمة اللاعبين للهجوم.");
                });
            }

            try {
                const attackLogRef = ref(db, `artifacts/${appId}/public/attackLog`);
                await push(attackLogRef, {
                    attackerId: userId,
                    attackerFleetName: fleetName,
                    defenderId: opponent.userId,
                    defenderFleetName: opponent.fleetName,
                    result: win ? 'win' : 'loss',
                    winnings: winnings,
                    timestamp: serverTimestamp() 
                });
            } catch (error) {
                console.error("Error logging attack:", error);
            }
        }

        function updateAttackCooldownsUI() {
            const cooldownRemaining = globalAttackCooldownEndTime - Date.now();
            const isOnCooldown = cooldownRemaining > 0;

            const attackButtons = attackablePlayersListEl.querySelectorAll('.attack-player-btn');
            attackButtons.forEach(button => {
                if (isOnCooldown) {
                    button.disabled = true;
                    button.textContent = formatTime(cooldownRemaining);
                } else {
                    button.disabled = false;
                    button.textContent = 'هجوم';
                }
            });

            if (lastGlobalCooldownState && !isOnCooldown) {
                lastAttackedOpponentId = null; 
                if (document.getElementById('attackSection').classList.contains('animate-fade-in-up')) {
                    if (db) {
                        const playersRef = ref(db, `artifacts/${appId}/public/onlinePlayers`);
                        get(playersRef).then(snapshot => {
                            const data = snapshot.val();
                            const allPlayers = [];
                            if (data) {
                                for (const key in data) {
                                    allPlayers.push(data[key]);
                                }
                            }
                            renderAttackablePlayers(allPlayers);
                        }).catch(error => {
                            console.error("Error re-rendering attackable players after cooldown:", error);
                            window.showMessage("حدث خطأ أثناء تحميل قائمة اللاعبين للهجوم.");
                        });
                    }
                }
            }
            lastGlobalCooldownState = isOnCooldown; 
        }

        function populateShipFormsList() {
            if (!shipFormsList) return;
            shipFormsList.innerHTML = '';
            shipFormsData.forEach(form => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('ship-form-item');

                let iconHtml = '';
                if (form.iconType === 'font-awesome') {
                    iconHtml = `<i class="${form.iconClass} text-blue-400"></i>`;
                } else {
                    iconHtml = `<img src="${form.imgSrc}" alt="Image of Ship Form" onerror="this.onerror=null;this.src='https://placehold.co/50x50/21262d/e2e8f0?text=Error';" draggable="false" />`;
                }

                itemDiv.innerHTML = `
                    <div class="icon-wrapper">
                        ${iconHtml}
                    </div>
                    <div class="text-content">
                        <h4>المستوى: ${form.levelRange}</h4>
                        <p>شكل السفينة</p>
                    </div>
                `;
                shipFormsList.appendChild(itemDiv);
            });
        }

        function updatePlayerStats() {
            playerPower = ship1.power + (ship2.unlocked ? ship2.power : 0) + (ship3.unlocked ? ship3.power : 0);
            playerPowerEl.textContent = formatNumber(playerPower);
            playerMoneyEl.textContent = formatNumber(playerMoney);
            playerKeysEl.textContent = formatNumber(playerKeys);
            fleetNameEl.textContent = fleetName;
            
            if (isGoldenNameActive) {
                fleetNameEl.classList.add('golden-text');
            } else {
                fleetNameEl.classList.remove('golden-text');
            }

            if (isStarIconActive) {
                fleetStarIconEl.classList.remove('hidden');
            } else {
                fleetStarIconEl.classList.add('hidden');
            }
            saveUserData(); 
            if (userId) {
                updateOnlineStatus(true); 
            }
        }

        function formatTime(ms) {
            if (ms <= 0) return 'جاهز';
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function getShipIcon(level) {
            if (level >= 10000) {
                return 'https://c.top4top.io/p_3482878s83.png';
            } else if (level >= 4001) {
                return 'https://b.top4top.io/p_3482vv1ax2.png';
            } else if (level >= 1001) {
                return 'https://l.top4top.io/p_3482en0id0.png';
            } else {
                return 'font-awesome'; 
            }
        }

        function updateShipUI(ship, powerEl, levelEl, progressEl, upgradeBtn, containerEl, cooldownDisplayEl, maxPowerEl, iconContainerEl, iconIEl, iconImgEl) {
            powerEl.textContent = formatNumber(ship.power);
            levelEl.textContent = formatNumber(ship.level);
            maxPowerEl.textContent = formatNumber(ship.maxPower);
            const progress = (ship.power / ship.maxPower) * 100;
            progressEl.style.width = `${progress}%`;

            const currentTime = Date.now();
            const isOnCooldown = ship.cooldownEndTime > currentTime;

            if (ship.power >= ship.maxPower) {
                upgradeBtn.disabled = true;
                upgradeBtn.textContent = 'مطور بالكامل';
                upgradeBtn.classList.remove('btn-primary');
                upgradeBtn.classList.add('btn-success');
                cooldownDisplayEl.textContent = '';
                cooldownDisplayEl.classList.remove('cooldown-active');
            } else if (isOnCooldown) {
                upgradeBtn.disabled = true;
                upgradeBtn.textContent = 'في انتظار';
                upgradeBtn.classList.remove('btn-primary');
                cooldownDisplayEl.textContent = `متاح بعد: ${formatTime(ship.cooldownEndTime - currentTime)}`;
                cooldownDisplayEl.classList.add('cooldown-active');
            } else {
                upgradeBtn.disabled = false;
                upgradeBtn.textContent = 'تطوير';
                upgradeBtn.classList.remove('btn-success');
                upgradeBtn.classList.add('btn-primary');
                cooldownDisplayEl.textContent = 'جاهز للتطوير';
                cooldownDisplayEl.classList.remove('cooldown-active');
            }

            if (containerEl) {
                if (ship.unlocked) {
                    containerEl.classList.remove('opacity-50', 'pointer-events-none');
                    containerEl.querySelector('h3').classList.remove('text-gray-400');
                    containerEl.querySelector('h3').classList.add('text-blue-400');
                } else {
                    containerEl.classList.add('opacity-50', 'pointer-events-none');
                    containerEl.querySelector('h3').classList.remove('text-blue-400');
                    containerEl.querySelector('h3').classList.add('text-gray-400');
                }
            }

            const iconSrc = getShipIcon(ship.level);

            if (iconSrc === 'font-awesome') {
                if (iconIEl) {
                    iconIEl.style.display = '';
                    iconIEl.className = 'fas fa-ship';
                    if (ship.unlocked || ship === ship1) {
                        iconIEl.classList.remove('text-gray-500');
                        iconIEl.classList.add('text-blue-400');
                    } else {
                        iconIEl.classList.remove('text-blue-400');
                        iconIEl.classList.add('text-gray-500');
                    }
                }
                if (iconImgEl) {
                    iconImgEl.style.display = 'none';
                }
            } else {
                if (iconIEl) {
                    iconIEl.style.display = 'none';
                }
                if (iconImgEl) {
                    iconImgEl.style.display = '';
                    iconImgEl.src = iconSrc;
                }
            }
        }

        function upgradeShip(ship) {
            const currentTime = Date.now();
            if (ship.power >= ship.maxPower) {
                window.showMessage('هذه السفينة مطورة بالكامل بالفعل!');
                return;
            }
            if (ship.cooldownEndTime > currentTime) {
                window.showMessage(`هذه السفينة في فترة انتظار. يرجى الانتظار ${formatTime(ship.cooldownEndTime - currentTime)}.`);
                return;
            }

            const powerGain = Math.floor(Math.random() * (325 - 45 + 1)) + 45;
            ship.power += powerGain;
            ship.level = Math.min(ship.maxPower, ship.power);

            if (ship.power > ship.maxPower) {
                ship.power = ship.maxPower;
            }

            ship.cooldownEndTime = currentTime + UPGRADE_COOLDOWN_MS;

            updatePlayerStats(); 
            updateShipUI(ship,
                ship === ship1 ? ship1PowerEl : (ship === ship2 ? ship2PowerEl : ship3PowerEl),
                ship === ship1 ? ship1LevelEl : (ship === ship2 ? ship2LevelEl : ship3LevelEl),
                ship === ship1 ? ship1ProgressEl : (ship === ship2 ? ship2ProgressEl : ship3ProgressEl),
                ship === ship1 ? upgradeShip1Btn : (ship === ship2 ? upgradeShip2Btn : upgradeShip3Btn),
                ship === ship1 ? null : (ship === ship2 ? ship2Container : ship3Container),
                ship === ship1 ? ship1CooldownDisplay : (ship === ship2 ? ship2CooldownDisplay : ship3CooldownDisplay),
                ship === ship1 ? ship1MaxPowerEl : (ship === ship2 ? ship2MaxPowerEl : ship3MaxPowerEl),
                ship === ship1 ? ship1IconContainerEl : (ship === ship2 ? ship2IconContainerEl : ship3IconContainerEl),
                ship === ship1 ? ship1IconIEl : (ship === ship2 ? ship2IconIEl : ship3IconIEl),
                ship === ship1 ? ship1IconImgEl : (ship === ship2 ? ship2IconImgEl : ship3IconImgEl)
            );
            
            if (ship === ship1 && ship1.power >= ship1.maxPower && !ship2.unlocked) {
                ship2.unlocked = true;
                updateShipUI(ship2, ship2PowerEl, ship2LevelEl, ship2ProgressEl, upgradeShip2Btn, ship2Container, ship2CooldownDisplay, ship2MaxPowerEl, ship2IconContainerEl, ship2IconIEl, ship2IconImgEl);
                window.showMessage('تم فتح السفينة الثانية!');
            } else if (ship === ship2 && ship2.power >= ship2.maxPower && !ship3.unlocked) {
                ship3.unlocked = true;
                updateShipUI(ship3, ship3PowerEl, ship3LevelEl, ship3ProgressEl, upgradeShip3Btn, ship3Container, ship3CooldownDisplay, ship3MaxPowerEl, ship3IconContainerEl, ship3IconIEl, ship3IconImgEl);
                window.showMessage('تم فتح السفينة الثالثة!');
            }
        }

        function updateAllShipCooldowns() {
            updateShipUI(ship1, ship1PowerEl, ship1LevelEl, ship1ProgressEl, upgradeShip1Btn, null, ship1CooldownDisplay, ship1MaxPowerEl, ship1IconContainerEl, ship1IconIEl, ship1IconImgEl);
            if (ship2.unlocked) {
                updateShipUI(ship2, ship2PowerEl, ship2LevelEl, ship2ProgressEl, upgradeShip2Btn, ship2Container, ship2CooldownDisplay, ship2MaxPowerEl, ship2IconContainerEl, ship2IconIEl, ship2IconImgEl);
            }
            if (ship3.unlocked) {
                updateShipUI(ship3, ship3PowerEl, ship3LevelEl, ship3ProgressEl, upgradeShip3Btn, ship3Container, ship3CooldownDisplay, ship3MaxPowerEl, ship3IconContainerEl, ship3IconIEl, ship3IconImgEl);
            }
            saveUserData(); 
        }

        function updateResourceCircle() {
            const percentage = (accumulatedResources / MAX_ACCUMULATED_RESOURCES) * 100;
            const offset = circumference - (percentage / 100) * circumference;
            circleProgress.style.strokeDashoffset = offset;
            accumulatedResourcesDisplay.textContent = `${accumulatedResources}/${MAX_ACCUMULATED_RESOURCES}`;
        }

        function updateResourceButtonState() {
            if (resourceBtnTextEl && resourceBtnIconEl && circleProgress) { 
                if (accumulatedResources > 0) {
                    resourceCollectionBtnWrapper.classList.remove('opacity-50', 'pointer-events-none');
                    resourceBtnTextEl.textContent = 'استلام';
                    resourceBtnIconEl.classList.remove('text-gray-400');
                    resourceBtnIconEl.classList.add('text-white');
                    circleProgress.style.stroke = '#f39c12'; 
                } else {
                    resourceCollectionBtnWrapper.classList.add('opacity-50', 'pointer-events-none');
                    resourceBtnTextEl.textContent = 'لا توجد موارد';
                    resourceBtnIconEl.classList.add('text-gray-400');
                    resourceBtnIconEl.classList.remove('text-white');
                    circleProgress.style.stroke = '#3b4554'; 
                }
            }
        }

        function autoAccumulateResources() {
            if (accumulatedResources < MAX_ACCUMULATED_RESOURCES) {
                const collectedAmount = Math.floor(Math.random() * 6) + 1;
                accumulatedResources = Math.min(MAX_ACCUMULATED_RESOURCES, accumulatedResources + collectedAmount);
                updateResourceCircle();
            }
            updateResourceButtonState(); 
        }

        function collectAccumulatedResources() {
            if (accumulatedResources > 0) {
                playerMoney += accumulatedResources;
                window.showMessage(`لقد استلمت ${accumulatedResources} من الموارد!`);
                accumulatedResources = 0;
                updatePlayerStats(); 
                updateResourceCircle();
                updateResourceButtonState(); 
            } else {
                window.showMessage('لا توجد موارد لتجميعها حالياً!');
            }
        }

        window.showStoreItemDetail = function(itemKey) {
            currentStoreItemKey = itemKey;
            const item = storeItems[itemKey];

            if (itemKey === 'shipExpansion') {
                window.openShipSelectionModal();
                return;
            }

            storeItemTitle.textContent = item.title;
            storeItemIcon.className = `item-icon ${item.icon}`;
            storeItemDescription.textContent = item.description;
            
            let priceHtml = `${formatNumber(item.price)} `;
            if (item.currency === 'key') {
                priceHtml += `<i class="fas fa-key text-yellow-400"></i>`;
            } else if (item.currency === 'money') {
                priceHtml += `<i class="fas fa-dollar-sign text-green-400"></i>`;
            }
            storeItemPrice.innerHTML = priceHtml;

            if (itemKey === 'goldenName') {
                storeItemTitle.classList.add('golden-text');
            } else {
                storeItemTitle.classList.remove('golden-text');
            }

            storeItemDetailModal.style.display = 'flex';
        }

        window.closeStoreItemDetailModal = function(returnToStore = false) {
            storeItemDetailModal.style.display = 'none';
            storeItemTitle.classList.remove('golden-text');
            currentStoreItemKey = null;
            if (returnToStore) {
                window.showSection('store');
            }
        }

        async function buyStoreItem() {
            if (!currentStoreItemKey) return;

            const item = storeItems[currentStoreItemKey];
            let canAfford = false;
            let message = '';

            if (item.currency === 'key') {
                if (playerKeys >= item.price) {
                    playerKeys -= item.price;
                    canAfford = true;
                } else {
                    message = `ليس لديك ما يكفي من المفاتيح لشراء هذا العنصر (${formatNumber(item.price)} مفتاح).`;
                }
            } else if (item.currency === 'money') {
                if (playerMoney >= item.price) {
                    playerMoney -= item.price;
                    canAfford = true;
                } else {
                    message = `ليس لديك ما يكفي من الأموال لشراء هذا العنصر (${formatNumber(item.price)} أموال).`;
                }
            }

            if (canAfford) {
                if (currentStoreItemKey === 'completeUpgrade') {
                    const currentTime = Date.now();
                    let shipsOnCooldown = 0;
                    if (ship1.cooldownEndTime > currentTime) { ship1.cooldownEndTime = 0; shipsOnCooldown++; }
                    if (ship2.unlocked && ship2.cooldownEndTime > currentTime) { ship2.cooldownEndTime = 0; shipsOnCooldown++; }
                    if (ship3.unlocked && ship3.cooldownEndTime > currentTime) { ship3.cooldownEndTime = 0; shipsOnCooldown++; }

                    if (shipsOnCooldown > 0) {
                        updateAllShipCooldowns(); 
                        message = 'تم إكمال تطوير السفن بنجاح!';
                    } else {
                        if (item.currency === 'key') playerKeys += item.price; 
                        else playerMoney += item.price; 
                        message = 'لا توجد سفن في فترة انتظار حالياً لإكمال تطويرها.';
                        canAfford = false; 
                    }
                } else if (currentStoreItemKey === 'goldenName') {
                    if (isGoldenNameActive) {
                        if (item.currency === 'key') playerKeys += item.price; 
                        else playerMoney += item.price; 
                        message = 'اسمك الذهبي المتحرك مفعل بالفعل!';
                        canAfford = false;
                    } else {
                        isGoldenNameActive = true;
                        message = 'تهانينا! اسم أسطولك أصبح ذهبياً ومتحركاً!';
                    }
                } else if (currentStoreItemKey === 'starIcon') {
                    if (isStarIconActive) {
                        if (item.currency === 'key') playerKeys += item.price; 
                        else playerMoney += item.price; 
                        message = 'أيقونة النجمة مفعلة بالفعل!';
                        canAfford = false;
                    } else {
                        isStarIconActive = true;
                        message = 'تهانينا! أضفت نجمة لامعة بجانب اسم أسطولك!';
                    }
                } else if (currentStoreItemKey === 'buyKeys') { 
                    playerKeys += item.amount; 
                    message = `تهانينا! لقد اشتريت ${item.amount} مفتاح مقابل ${formatNumber(item.price)} أموال.`;
                }
            }
            
            updatePlayerStats(); 
            window.showMessage(message);
            window.closeStoreItemDetailModal(true); 
        }

        window.openShipSelectionModal = function() {
            document.getElementById('shipExpansionModalPrice').innerHTML = `${formatNumber(storeItems.shipExpansion.price)} <i class="fas fa-key text-yellow-400"></i>`;

            let shipSelectionOptions = document.getElementById('shipSelectionOptions');
            shipSelectionOptions.innerHTML = '';
            const ships = [
                { id: 'ship1', name: 'السفينة الأساسية', obj: ship1 },
                { id: 'ship2', name: 'السفينة الثانية', obj: ship2 },
                { id: 'ship3', name: 'السفينة الثالثة', obj: ship3 }
            ];

            ships.forEach(s => {
                if (s.obj.unlocked || s.id === 'ship1') {
                    const optionDiv = document.createElement('div');
                    optionDiv.classList.add('ship-selection-option');
                    optionDiv.innerHTML = `
                        <label for="select-${s.id}">${s.name} (القوة القصوى الحالية: ${formatNumber(s.obj.maxPower)})</label>
                        <input type="radio" id="select-${s.id}" name="selectedShip" value="${s.id}">
                    `;
                    shipSelectionOptions.appendChild(optionDiv);

                    optionDiv.addEventListener('click', () => {
                        document.querySelectorAll('.ship-selection-option').forEach(opt => opt.classList.remove('selected'));
                        optionDiv.classList.add('selected');
                        optionDiv.querySelector('input[type="radio"]').checked = true;
                    });
                }
            });

            document.getElementById('shipSelectionModal').style.display = 'flex';
        }

        window.closeShipSelectionModal = function() {
            document.getElementById('shipSelectionModal').style.display = 'none';
            window.showSection('store'); 
        }

        async function confirmShipExpansion() {
            const selectedRadio = document.querySelector('input[name="selectedShip"]:checked');
            let message = '';
            let purchaseSuccessful = false;

            if (!selectedRadio) {
                message = 'الرجاء اختيار سفينة لتوسيعها.';
            } else {
                const selectedShipId = selectedRadio.value;
                let targetShip;
                if (selectedShipId === 'ship1') targetShip = ship1;
                else if (selectedShipId === 'ship2') targetShip = ship2;
                else if (selectedShipId === 'ship3') targetShip = ship3;

                const item = storeItems['shipExpansion'];
                if (playerKeys >= item.price) { 
                    playerKeys -= item.price; 
                    targetShip.maxPower += 5000;
                    updatePlayerStats(); 
                    updateAllShipCooldowns(); 
                    message = `تم توسيع ${targetShip.name === ship1.name ? 'السفينة الأساسية' : targetShip.name} بنجاح! الحد الأقصى الجديد: ${formatNumber(targetShip.maxPower)}.`;
                    purchaseSuccessful = true;
                } else {
                    message = `ليس لديك ما يكفي من المفاتيح لشراء توسيع السفينة (${formatNumber(item.price)} مفتاح).`; 
                }
            }
            
            window.showMessage(message);
            window.closeShipSelectionModal(); 
        }

        async function confirmInitialFleetName() {
            const name = initialFleetNameInput.value.trim();
            if (name) {
                fleetName = name;
                initialFleetNameModal.style.display = 'none';
                updatePlayerStats(); 
                await updateOnlineStatus(true);
                window.showSection('mainMenu');
            } else {
                window.showMessage('الرجاء إدخال اسم صالح لأسطولك!');
            }
        }

        window.showSection = function(sectionId) {
            const sections = [mainMenuSection, myFleetSection, storeSection, onlineSection, rouletteSection, developmentsSection, challengeLogSection, attackSection, onlinePlayersSection];
            sections.forEach(section => {
                section.classList.remove('animate-fade-in-up');
                section.classList.add('hidden');
            });

            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('animate-fade-in-up');
            }

            if (sectionId === 'mainMenu') {
                resourceCollectionBtnWrapper.classList.remove('hidden');
            } else {
                resourceCollectionBtnWrapper.classList.add('hidden');
            }

            if (sectionId === 'developmentsSection') {
                populateShipFormsList();
            }
            if (sectionId === 'attackSection') {
                if (db) {
                    const playersRef = ref(db, `artifacts/${appId}/public/onlinePlayers`);
                    get(playersRef).then(snapshot => {
                        const data = snapshot.val();
                        const allPlayers = [];
                        if (data) {
                            for (const key in data) {
                                allPlayers.push(data[key]);
                            }
                        }
                        renderAttackablePlayers(allPlayers);
                    }).catch(error => {
                        console.error("Error loading attackable players for section:", error);
                        window.showMessage("حدث خطأ أثناء تحميل قائمة اللاعبين للهجوم.");
                    });
                }
            }
        }

        function updateRouletteCooldownUI() {
            const currentTime = Date.now();
            const remainingTime = rouletteCooldownEndTime - currentTime;

            if (remainingTime > 0) {
                rouletteGameElements.classList.add('hidden'); 
                rouletteCooldownDisplay.classList.remove('hidden'); 
                rouletteCooldownDisplay.textContent = `الجولة القادمة بعد: ${formatTime(remainingTime)}`;
            } else {
                rouletteGameElements.classList.remove('hidden'); 
                rouletteCooldownDisplay.classList.add('hidden'); 

                if (!gameActive) {
                    startGameBtn.classList.remove('hidden');
                    betAmountInput.disabled = false;
                    cashOutBtn.classList.add('hidden');
                    cashOutBtn.disabled = true;
                    multiplierDisplay.textContent = '1.00x'; 
                    potentialWinningsEl.textContent = '0'; 
                    rouletteResult.classList.add('hidden'); 
                    rouletteDisplayArea.classList.remove('crashed'); 
                    
                    const currentDisplayAreaHeight = rouletteDisplayArea.clientHeight;
                    const planeHeight = planeSvg.offsetHeight;
                    planeSvg.style.transform = `translate(10px, ${currentDisplayAreaHeight - planeHeight - 15}px)`;
                }
            }
        }

        function generateCrashPoint() {
            const rand = Math.random();
            if (rand < 0.60) { 
                return 1.01 + Math.random() * (4.0 - 1.01);
            } else if (rand < 0.80) { 
                return 4.1 + Math.random() * (7.7 - 4.1);
            } else { 
                return 10.0 + Math.random() * (25.5 - 10.0);
            }
        }

        function animatePlane(timestamp) {
            if (!lastFrameTime) {
                lastFrameTime = timestamp;
            }
            const deltaTime = timestamp - lastFrameTime;
            lastFrameTime = timestamp;

            const multiplierIncreaseRate = 0.007;
            currentMultiplier += multiplierIncreaseRate * (deltaTime / 100);

            multiplierDisplay.textContent = currentMultiplier.toFixed(2) + 'x';
            potentialWinningsEl.textContent = Math.round(betAmount * currentMultiplier); 

            const displayAreaWidth = rouletteDisplayArea.clientWidth;
            const displayAreaHeight = rouletteDisplayArea.clientHeight;
            const planeWidth = planeSvg.offsetWidth; 
            const planeHeight = planeSvg.offsetHeight; 
            
            const maxVisualMultiplier = 30; 
            const minMultiplierForVisual = 1.0; 

            let normalizedMultiplier = (currentMultiplier - minMultiplierForVisual) / (maxVisualMultiplier - minMultiplierForVisual);
            normalizedMultiplier = Math.max(0, Math.min(normalizedMultiplier, 1)); 

            const paddingX = 20; 
            const paddingY = 15; 

            let planeX = normalizedMultiplier * (displayAreaWidth - planeWidth - (2 * paddingX)) + paddingX;

            let planeY = (1 - normalizedMultiplier) * (displayAreaHeight - planeHeight - (2 * paddingY)) + paddingY;

            planeSvg.style.transform = `translate(${planeX}px, ${planeY}px)`;

            if (currentMultiplier < crashPoint && gameActive && !hasCashedOut) {
                animationFrameId = requestAnimationFrame(animatePlane);
            } else if (gameActive && !hasCashedOut) {
                handleCrash();
            }
        }

        function startPlaneGame() {
            if (Date.now() < rouletteCooldownEndTime) {
                window.showMessage(`الرجاء الانتظار حتى انتهاء فترة التهدئة: ${formatTime(rouletteCooldownEndTime - Date.now())}`);
                return;
            }

            betAmount = parseInt(betAmountInput.value);

            if (isNaN(betAmount) || betAmount < 20 || betAmount > 2000) {
                window.showMessage('الرجاء إدخال مبلغ رهان صالح بين 20 و 2000.');
                return;
            }
            if (playerMoney < betAmount) {
                window.showMessage('ليس لديك ما يكفي من الأموال للرهان!');
                return;
            }

            playerMoney -= betAmount; 
            updatePlayerStats(); 

            gameActive = true;
            currentMultiplier = 1.00;
            hasCashedOut = false;
            rouletteDisplayArea.classList.remove('crashed');
            rouletteResult.classList.add('hidden');
            multiplierDisplay.textContent = '1.00x';
            potentialWinningsEl.textContent = '0';

            crashPoint = generateCrashPoint(); 

            startGameBtn.classList.add('hidden'); 
            betAmountInput.disabled = true;
            cashOutBtn.classList.remove('hidden'); 
            cashOutBtn.disabled = false;

            const currentDisplayAreaHeight = rouletteDisplayArea.clientHeight;
            const planeHeight = planeSvg.offsetHeight;
            planeSvg.style.transform = `translate(10px, ${currentDisplayAreaHeight - planeHeight - 15}px)`;

            lastFrameTime = 0;
            animationFrameId = requestAnimationFrame(animatePlane);
        }

        function cashOut() {
            if (!gameActive || hasCashedOut) {
                return;
            }

            hasCashedOut = true;
            cancelAnimationFrame(animationFrameId);

            const winnings = Math.round(betAmount * currentMultiplier); 
            playerMoney += winnings;
            updatePlayerStats(); 

            rouletteResult.textContent = `لقد استلمت ${winnings} أموال عند ${currentMultiplier.toFixed(2)}x!`;
            rouletteResult.classList.remove('hidden');
            window.showMessage(`تهانينا! لقد استلمت ${winnings} أموال عند ${currentMultiplier.toFixed(2)}x!`);

            endRound();
        }

        function handleCrash() {
            if (!gameActive || hasCashedOut) {
                return;
            }
            
            cancelAnimationFrame(animationFrameId);

            rouletteDisplayArea.classList.add('crashed');
            rouletteResult.textContent = `تحطمت الطائرة عند ${currentMultiplier.toFixed(2)}x! لقد خسرت ${betAmount} أموال.`; 
            rouletteResult.classList.remove('hidden');
            window.showMessage(`تحطمت الطائرة عند ${currentMultiplier.toFixed(2)}x! لقد خسرت ${betAmount} أموال.`);

            endRound();
        }

        async function endRound() {
            gameActive = false;
            cashOutBtn.classList.add('hidden');
            cashOutBtn.disabled = true;
            
            rouletteCooldownEndTime = Date.now() + ROULETTE_COOLDOWN_MS;
            updateRouletteCooldownUI(); 
            saveUserData(); 
        }

        function handleUpgradeShip1Click() { upgradeShip(ship1); }
        function handleUpgradeShip2Click() { upgradeShip(ship2); }
        function handleUpgradeShip3Click() { upgradeShip(ship3); }
        function handleCollectResourcesClick() { collectAccumulatedResources(); }
        function handleConfirmInitialFleetNameClick() { confirmInitialFleetName(); }
        function handleBuyStoreItemClick() { buyStoreItem(); }
        function handleConfirmShipExpansionClick() { confirmShipExpansion(); }
        function handleStartGameClick() { startPlaneGame(); }
        function handleCashOutClick() { cashOut(); }
        function handleLogoutClick() { logoutUser(); }


        document.addEventListener('DOMContentLoaded', async () => {
            playerPowerEl = document.getElementById('playerPower');
            playerMoneyEl = document.getElementById('playerMoney');
            playerKeysEl = document.getElementById('playerKeys');
            fleetNameEl = document.getElementById('fleetName');
            fleetStarIconEl = document.getElementById('fleetStarIcon');
            logoutBtn = document.getElementById('logoutBtn');

            ship1PowerEl = document.getElementById('ship1Power'); 
            ship1LevelEl = document.getElementById('ship1Level');
            ship1ProgressEl = document.getElementById('ship1Progress');
            ship1MaxPowerEl = document.getElementById('ship1MaxPower');
            upgradeShip1Btn = document.getElementById('upgradeShip1');
            ship1CooldownDisplay = document.getElementById('ship1CooldownDisplay');
            ship1IconContainerEl = document.querySelector('#myFleet > div > div:nth-child(1) > .icon-container');
            ship1IconIEl = ship1IconContainerEl.querySelector('i');
            ship1IconImgEl = ship1IconContainerEl.querySelector('img');

            ship2Container = document.getElementById('ship2Container');
            ship2PowerEl = document.getElementById('ship2Power');
            ship2LevelEl = document.getElementById('ship2Level');
            ship2ProgressEl = document.getElementById('ship2Progress');
            ship2MaxPowerEl = document.getElementById('ship2MaxPower');
            upgradeShip2Btn = document.getElementById('upgradeShip2');
            ship2CooldownDisplay = document.getElementById('ship2CooldownDisplay');
            ship2IconContainerEl = document.querySelector('#ship2Container > .icon-container');
            ship2IconIEl = ship2IconContainerEl.querySelector('i');
            ship2IconImgEl = ship2IconContainerEl.querySelector('img');

            ship3Container = document.getElementById('ship3Container');
            ship3PowerEl = document.getElementById('ship3Power');
            ship3LevelEl = document.getElementById('ship3Level');
            ship3ProgressEl = document.getElementById('ship3Progress');
            ship3MaxPowerEl = document.getElementById('ship3MaxPower');
            upgradeShip3Btn = document.getElementById('upgradeShip3'); 
            ship3CooldownDisplay = document.getElementById('ship3CooldownDisplay');
            ship3IconContainerEl = document.querySelector('#ship3Container > .icon-container');
            ship3IconIEl = ship3IconContainerEl.querySelector('i');
            ship3IconImgEl = ship3IconContainerEl.querySelector('img');

            mainMenuSection = document.getElementById('mainMenu');
            myFleetSection = document.getElementById('myFleet');
            storeSection = document.getElementById('store');
            onlineSection = document.getElementById('onlineSection');
            rouletteSection = document.getElementById('rouletteSection');
            developmentsSection = document.getElementById('developmentsSection'); 
            challengeLogSection = document.getElementById('challengeLog');
            attackSection = document.getElementById('attackSection');
            onlinePlayersSection = document.getElementById('onlinePlayersSection');

            messageModal = document.getElementById('messageModal');
            modalMessage = document.getElementById('modalMessage');

            authModal = document.getElementById('authModal');
            authEmailInput = document.getElementById('authEmailInput');
            authPasswordInput = document.getElementById('authPasswordInput');
            loginBtn = document.getElementById('loginBtn');
            registerBtn = document.getElementById('registerBtn');

            initialFleetNameModal = document.getElementById('initialFleetNameModal');
            initialFleetNameInput = document.getElementById('initialFleetNameInput');
            confirmInitialFleetNameBtn = document.getElementById('confirmInitialFleetNameBtn');

            resourceCollectionBtnWrapper = document.getElementById('resourceCollectionBtnWrapper');
            resourceCollectionBtn = document.getElementById('resourceCollectionBtn');
            accumulatedResourcesDisplay = document.getElementById('accumulatedResourcesDisplay');
            circleProgress = document.querySelector('.circle-progress');
            resourceBtnTextEl = document.querySelector('.resource-btn-text'); 
            resourceBtnIconEl = resourceCollectionBtn.querySelector('.resource-content i'); 

            storeItemDetailModal = document.getElementById('storeItemDetailModal');
            storeItemTitle = document.getElementById('storeItemTitle');
            storeItemIcon = document.getElementById('storeItemIcon');
            storeItemDescription = document.getElementById('storeItemDescription');
            storeItemPrice = document.getElementById('storeItemPrice');
            buyStoreItemBtn = document.getElementById('buyStoreItemBtn');

            rouletteGameElements = document.getElementById('rouletteGameElements'); 
            rouletteDisplayArea = document.getElementById('rouletteDisplayArea');
            multiplierDisplay = document.getElementById('multiplierDisplay');
            betAmountInput = document.getElementById('betAmountInput');
            startGameBtn = document.getElementById('startGameBtn');
            cashOutBtn = document.getElementById('cashOutBtn');
            potentialWinningsEl = document.getElementById('potentialWinnings');
            rouletteResult = document.getElementById('rouletteResult');
            rouletteCooldownDisplay = document.getElementById('rouletteCooldownDisplay');
            planeSvg = document.getElementById('planeSvg');

            shipFormsList = document.getElementById('shipFormsList'); 

            onlinePlayersListEl = document.getElementById('onlinePlayersList');
            offlinePlayersListEl = document.getElementById('offlinePlayersList');
            challengeLogListEl = document.getElementById('challengeLogList');
            attackablePlayersListEl = document.getElementById('attackablePlayersList');


            upgradeShip1Btn.addEventListener('click', handleUpgradeShip1Click);
            upgradeShip2Btn.addEventListener('click', handleUpgradeShip2Click);
            upgradeShip3Btn.addEventListener('click', handleUpgradeShip3Click);
            resourceCollectionBtnWrapper.addEventListener('click', handleCollectResourcesClick);
            confirmInitialFleetNameBtn.addEventListener('click', handleConfirmInitialFleetNameClick);
            buyStoreItemBtn.addEventListener('click', handleBuyStoreItemClick);
            document.getElementById('confirmShipExpansionBtn').addEventListener('click', handleConfirmShipExpansionClick); 
            startGameBtn.addEventListener('click', handleStartGameClick);
            cashOutBtn.addEventListener('click', handleCashOutClick);
            logoutBtn.addEventListener('click', handleLogoutClick); // Add event listener for logout button

            loginBtn.addEventListener('click', loginUser);
            registerBtn.addEventListener('click', registerUser);

            setInterval(updateAllShipCooldowns, 1000);
            setInterval(autoAccumulateResources, RESOURCE_ACCUMULATION_INTERVAL_MS);
            setInterval(updateResourceButtonState, 1000); 
            setInterval(updateRouletteCooldownUI, 1000); 
            setInterval(updateAttackCooldownsUI, 1000); 

            await initializeFirebase();

            document.addEventListener('contextmenu', event => event.preventDefault());
            document.addEventListener('dragstart', event => event.preventDefault());
            document.addEventListener('selectstart', event => event.preventDefault());
        });

        window.addEventListener('beforeunload', async () => {
            if (userId) {
                await saveUserData(); 
            }
        });
    </script>
</body>
</html>
