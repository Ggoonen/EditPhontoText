<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق جوال</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            direction: rtl;
            background: #1a202c;
            background-image: radial-gradient(circle at center, rgba(100, 116, 139, 0.1) 0%, transparent 70%);
            background-size: 300% 300%;
            animation: moveGradient 15s ease infinite alternate;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        @keyframes moveGradient {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }
        .menu-item {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }
        .view {
            transition: transform 0.3s ease-in-out;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            padding: 1.5rem;
        }
        .view-content {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 1rem;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.hidden {
            display: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #6366f1;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #6366f1;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }
        .popup-content {
            background: linear-gradient(135deg, #2d3748, #1a202c);
            border: 2px solid #4a5568;
            border-radius: 1.5rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            padding: 2.5rem;
            animation: fadeInScale 0.3s ease-out forwards;
        }
        @keyframes fadeInScale {
            from {
                transform: scale(0.9) translateY(20px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        .popup-number {
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
        }
        .message-modal-content {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            border: 2px solid #6366f1;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            padding: 2rem;
            animation: fadeInScale 0.3s ease-out forwards;
        }
        .store-item {
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #2d3748;
            border-radius: 1.5rem;
            padding: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .store-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.3);
        }
        .buy-button {
            background: #4a5568;
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: background 0.2s ease-in-out;
        }
        .buy-button:hover {
            background: #6366f1;
        }
        .house-container {
            position: relative;
            width: 8rem;
            height: 8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border-radius: 0.75rem;
            background: transparent;
            color: #fff;
            border: 0px solid transparent;
        }
        .house-container.locked-house {
            opacity: 0.5;
            filter: grayscale(100%);
        }
        .house-container img {
            width: 5rem;
            height: 5rem;
            object-fit: contain;
            margin-bottom: 0.25rem;
        }
        @keyframes glowing-border {
            0% { border-color: #FFD700; box-shadow: 0 0 10px #FFD700; }
            50% { border-color: #FFEA00; box-shadow: 0 0 20px #FFEA00; }
            100% { border-color: #FFD700; box-shadow: 0 0 10px #FFD700; }
        }
        @keyframes subtle-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .house-container.active-house {
            border: 2px solid;
            animation: glowing-border 2s infinite alternate, subtle-bounce 2s infinite ease-in-out;
        }
        .timer-digit-animation {
            display: inline-block;
            animation: digitFadeIn 0.5s ease-out;
        }
        @keyframes digitFadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #innovation-button {
            border-radius: 1.5rem;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease-in-out;
            font-size: 1rem;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 120px;
        }
        #innovation-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4);
        }
        #innovation-button:disabled {
            background: #4a5568;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #innovation-button-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.2;
        }
        #innovation-button-text .price-display {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            margin-top: 0.25rem;
        }
        .task-item {
            background: #2d3748;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: right;
            position: relative;
        }
        .task-progress-bar {
            height: 6px;
            background-color: #4a5568;
            border-radius: 3px;
            margin-top: 0.5rem;
        }
        .task-progress-fill {
            height: 100%;
            background-color: #6366f1;
            border-radius: 3px;
            transition: width 0.5s ease-in-out;
        }
        .task-completed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
            backdrop-filter: blur(3px);
        }
        #toast-notification {
            position: fixed;
            top: 1rem;
            left: 1/2;
            transform: translateX(-50%);
            background-color: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s ease-out;
            z-index: 1000;
            text-align: center;
            white-space: nowrap;
        }
        #toast-notification.info {
            background-color: rgba(33, 150, 243, 0.9);
        }
        #tasks-modal .modal-content-inner {
            max-height: 80vh;
            overflow-y: auto;
            padding-right: 1rem;
        }
        #tasks-modal .bg-gray-700 {
            max-width: 320px;
            padding: 1.5rem;
        }
        #player-name-display {
            cursor: default;
            color: #f9fafb;
            text-decoration: none;
            font-weight: bold;
            transition: none;
        }
        #player-name-display:hover {
            color: #f9fafb;
        }
        .locked-menu-item {
            position: relative;
            opacity: 0.6;
            cursor: not-allowed;
        }
        .locked-menu-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .locked-menu-item .lock-icon {
            position: absolute;
            z-index: 10;
            color: white;
            font-size: 2rem;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .locked-menu-item .lock-text {
            position: absolute;
            z-index: 10;
            color: white;
            font-size: 0.875rem;
            bottom: 0.5rem;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }
        .icon-lg {
            height: 2.25rem;
            width: 2.25rem;
        }
        .reward-animation-text {
            display: inline-block;
            animation: digitFadeIn 0.5s ease-out;
        }
        #level-up-toast {
            position: fixed;
            top: 1rem;
            left: 1/2;
            transform: translateX(-50%) translateY(-100px);
            background-color: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            z-index: 1000;
            text-align: center;
            white-space: nowrap;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 200px;
        }
        #level-up-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        #level-up-toast .level-message {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        #level-up-toast .rewards-text {
            font-size: 0.9rem;
        }
        #level-up-toast .rewards-text span {
            font-weight: bold;
        }
        .quantity-input-container {
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        .quantity-input-container .quantity-buttons-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .quantity-input-container input[type="number"] {
            -moz-appearance: textfield;
            text-align: center;
            background-color: #2d3748;
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem;
            width: 4rem;
            border: none;
        }
        .quantity-input-container input[type="number"]::-webkit-inner-spin-button,
        .quantity-input-container input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .quantity-button {
            background-color: #4a5568;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .quantity-button:hover:not(:disabled) {
            background-color: #6366f1;
        }
        .quantity-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
            padding-bottom: 1rem;
        }
        .chat-message {
            background-color: #2d3748;
            padding: 0.75rem;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
            max-width: 90%;
            align-self: flex-start;
        }
        .chat-message.self {
            background-color: #4a5568;
            align-self: flex-end;
        }
        .chat-sender {
            font-weight: bold;
            color: #6366f1;
            margin-bottom: 0.25rem;
            display: block;
        }
        .chat-timestamp {
            font-size: 0.75rem;
            color: #a0aec0;
            text-align: left;
            margin-top: 0.25rem;
        }
        #chat-input-container {
            display: flex;
            padding-top: 1rem;
            gap: 0.5rem;
        }
        #chat-input {
            flex-grow: 1;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.75rem;
            padding: 0.75rem;
            color: white;
            outline: none;
        }
        #chat-send-button {
            background-color: #6366f1;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }
        #chat-send-button:hover {
            background-color: #5a5fe0;
        }
        .online-user-item {
            background-color: #2d3748;
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .online-user-item .user-info {
            text-align: right;
        }
        .online-user-item .status-dot {
            width: 10px;
            height: 10px;
            background-color: #4CAF50;
            border-radius: 50%;
            margin-left: 0.5rem;
        }
        .online-user-item.offline .status-dot {
            background-color: #a0aec0;
        }
        .challenge-player-item {
            position: relative;
            background-color: #2d3748;
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .challenge-player-item .attack-button {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }
        .challenge-player-item .attack-button:hover:not(:disabled) {
            background-color: #dc2626;
        }
        .challenge-player-item .attack-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .challenge-player-item.can-defeat {
            border: 2px solid #4CAF50; /* Green border */
        }
        .challenge-player-item.cannot-defeat {
            border: 2px solid #ef4444; /* Red border */
        }
        .global-attack-log-entry {
            background-color: #1f2937;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.4rem;
            font-size: 0.8rem;
            color: #e2e8f0;
            text-align: right;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .global-attack-log-entry.win {
            border-right: 3px solid #4CAF50;
        }
        .global-attack-log-entry.loss {
            border-right: 3px solid #ef4444;
        }
        .attack-outcome-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s ease-out;
            border-radius: 1rem;
            pointer-events: none;
        }
        .attack-outcome-overlay.show {
            opacity: 1;
            transform: scale(1);
        }
        .attack-outcome-overlay.win {
            background-color: rgba(76, 175, 80, 0.7);
        }
        .attack-outcome-overlay.loss {
            background-color: rgba(239, 68, 68, 0.7);
        }
        /* Smaller dollar collector styles */
        #dollar-collector {
            padding: 0.75rem;
            border-radius: 0.75rem;
            position: relative; /* Added for progress bar positioning */
            overflow: hidden; /* Hide overflow of progress bar */
        }
        #dollar-collector h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        #dollar-collector .flex {
            margin-bottom: 0.5rem;
            position: relative; /* Ensure text is above progress */
            z-index: 1;
        }
        #dollar-collector .text-2xl {
            font-size: 1.5rem;
        }
        #collect-dollars-button {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            position: relative; /* Ensure button is above progress */
            z-index: 1;
        }
        #dollar-collector-progress {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(to right, #22c55e, #16a34a); /* Green gradient */
            width: 0%;
            transition: width 0.5s ease-out;
            z-index: 0; /* Behind content */
            border-radius: 0.75rem; /* Match parent */
        }
    </style>
</head>
<body oncontextmenu="return false;" ondragstart="return false;">
    <div class="w-full max-w-md mx-auto h-screen relative overflow-hidden rounded-3xl shadow-2xl bg-gray-800">
        <div id="main-menu-view" class="view transform translate-x-0">
            <div id="updates-icon" class="absolute top-4 right-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon-lg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <!-- Removed tasks-icon -->

            <div class="bg-gray-700 p-4 rounded-xl mb-6 shadow-md text-center">
                <h2 class="text-xl font-bold text-gray-100 mb-3" id="player-name-display">تعيين اسم</h2>
                <div class="flex items-center justify-center gap-x-4 mb-3">
                    <div class="flex items-center text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm.5 4.75a.75.75 0 00-1.5 0v.625H9.75a.75.75 0 000 1.5h1.25v.625a.75.75 0 001.5 0v-.625h1.25a.75.75 0 000-1.5h-1.25V7a.75.75 0 00-.75-.75zM12 18a.75.75 0 00.75-.75v-1.5a.75.75 0 00-1.5 0v1.5c0 .414.336.75.75.75zM12 13.5a.75.75 0 00.75-.75V9.75a.75.75 0 00-1.5 0v3c0 .414.336.75.75.75z" clip-rule="evenodd" />
                        </svg>
                        <span class="text-base" id="player-points-display">0</span>
                    </div>
                    <div class="flex items-center text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V3m0 9v3m0 3.545c-1.472 0-2.688-.475-3.463-1.249A3.987 3.987 0 018 18a4 4 0 00-4 4h16c0-2.209-1.791-4-4-4a4 4 0 01-3.463-1.249C14.688 17.07 13.472 16.545 12 16.545z" />
                        </svg>
                        <span class="text-base" id="player-dollars-display">$0</span>
                    </div>
                    <div class="flex items-center text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        <span class="text-base" id="player-total-power-display-main">0</span>
                    </div>
                </div>
            </div>

            <h1 class="text-3xl font-bold text-center text-gray-100 mb-8">القائمة الرئيسية</h1>
            <div class="grid grid-cols-2 gap-6 view-content">
                <div id="chat-menu-item" class="menu-item bg-gradient-to-br from-purple-600 to-indigo-700 text-white p-6 rounded-2xl flex flex-col items-center justify-center text-center shadow-lg cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                    </svg>
                    <span class="text-lg font-semibold">اخبار التحديثات</span>
                </div>
                <div id="play-menu-item" class="menu-item bg-gradient-to-br from-green-600 to-teal-700 text-white p-6 rounded-2xl flex flex-col items-center justify-center text-center shadow-lg cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17.25L15 12l-5.25-5.25M12 21a9 9 0 110-18 9 9 0 010 18z" />
                    </svg>
                    <span class="text-lg font-semibold">العب</span>
                </div>
                <div id="attack-log-menu-item" class="menu-item bg-gradient-to-br from-orange-600 to-red-700 text-white p-6 rounded-2xl flex flex-col items-center justify-center text-center shadow-lg cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                    <span class="text-lg font-semibold">سجل التحدي</span>
                </div>
                <div id="store-menu-item" class="menu-item bg-gradient-to-br from-blue-600 to-cyan-700 text-white p-6 rounded-2xl flex flex-col items-center justify-center text-center shadow-lg cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                    </svg>
                    <span class="text-lg font-semibold">متجر</span>
                </div>
                <div id="online-menu-item" class="menu-item bg-gradient-to-br from-yellow-600 to-amber-700 text-white p-6 rounded-2xl flex flex-col items-center justify-center text-center shadow-lg cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span class="text-lg font-semibold">اونلاين</span>
                </div>
                <div id="challenge-menu-item" class="menu-item bg-gradient-to-br from-gray-600 to-gray-700 text-white p-6 rounded-2xl flex flex-col items-center justify-center text-center shadow-lg cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h2v-2a3 3 0 00-3-3H8a3 3 0 00-3 3v2H3m10-9a4 4 0 11-8 0 4 4 0 018 0zM7 10h.01M12 12h.01M17 12h.01M12 15h.01M12 18h.01M12 21h.01" />
                    </svg>
                    <span class="text-lg font-semibold">تحدي اللاعبون</span>
                </div>
            </div>
            <div id="dollar-collector" class="bg-gray-700 p-3 rounded-xl shadow-md text-center mt-auto">
                <div id="dollar-collector-progress"></div>
                <h3 class="text-base font-semibold text-gray-100 mb-1">دولارات متراكمة</h3>
                <div class="flex items-center justify-center gap-1 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V3m0 9v3m0 3.545c-1.472 0-2.688-.475-3.463-1.249A3.987 3.987 0 018 18a4 4 0 00-4 4h16c0-2.209-1.791-4-4-4a4 4 0 01-3.463-1.249C14.688 17.07 13.472 16.545 12 16.545z" />
                        </svg>
                    <span class="text-xl font-bold text-green-300" id="accumulated-dollars-display">$0</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm.5 4.75a.75.75 0 00-1.5 0v.625H9.75a.75.75 0 000 1.5h1.25v.625a.75.75 0 001.5 0v-.625h1.25a.75.75 0 000-1.5h-1.25V7a.75.75 0 00-.75-.75zM12 18a.75.75 0 00.75-.75v-1.5a.75.75 0 00-1.5 0v1.5c0 .414.336.75.75.75zM12 13.5a.75.75 0 00.75-.75V9.75a.75.75 0 00-1.5 0v3c0 .414.336.75.75.75z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-xl font-bold text-yellow-300" id="accumulated-points-display">0</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span class="text-xl font-bold text-red-300" id="accumulated-power-display">0</span>
                </div>
                <button id="collect-dollars-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-4 rounded-lg shadow-md transition duration-200 ease-in-out w-full text-sm">
                    استلام الموارد
                </button>
            </div>
        </div>

        <div id="attack-log-view" class="view transform translate-x-full">
            <div id="back-to-main-from-attack-log" class="absolute top-4 left-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-center text-gray-100 mb-8">سجل التحدي</h1>

            <div class="view-content">
                <div class="bg-gray-700 p-6 rounded-xl mb-6 shadow-md">
                    <h2 class="text-xl font-semibold text-gray-100 mb-4">سجل الهجمات العالمية (آخر 5)</h2>
                    <div id="global-attacks-list" class="flex flex-col gap-2">
                        <p class="text-gray-400 text-center">لا توجد هجمات عالمية حالياً.</p>
                    </div>
                </div>
                <button id="delete-account-button" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out mt-8 w-full">
                    حذف الحساب
                </button>
            </div>
        </div>

        <div id="game-view" class="view transform translate-x-full">
            <div id="back-to-main-from-game" class="absolute top-4 left-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-center text-gray-100 mb-8">العب</h1>

            <div id="game-info-icon" class="absolute top-4 right-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>

            <div id="inventory-icon" class="absolute top-4 left-12 text-gray-400 hover:text-gray-200 cursor-pointer flex items-center p-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon-lg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4m0-10h.01" />
                </svg>
                <span id="inventory-count" class="bg-red-500 text-white text-xs font-bold rounded-full px-2 py-0.5 -mt-2 -mr-2">0</span>
            </div>

            <div class="flex items-center justify-center mb-6">
                <button id="innovation-prev-button" class="text-gray-400 hover:text-gray-200 p-2 rounded-full transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <button id="innovation-button" class="text-white font-bold flex items-center mx-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17H21l-9-15-9 15h11.337z" />
                    </svg>
                    <span id="innovation-button-text">
                        <span>تفعيل الابتكار</span>
                        <span class="price-display">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V3m0 9v3m0 3.545c-1.472 0-2.688-.475-3.463-1.249A3.987 3.987 0 018 18a4 4 0 00-4 4h16c0-2.209-1.791-4-4-4a4 4 0 01-3.463-1.249C14.688 17.07 13.472 16.545 12 16.545z" />
                        </svg>
                            <span>مجاني</span>
                        </span>
                    </span>
                </button>
                <button id="innovation-next-button" class="text-gray-400 hover:text-gray-200 p-2 rounded-full transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
            <div id="innovation-timer" class="text-gray-300 text-lg text-center mb-6 hidden">
                الوقت المتبقي: <span id="timer-display-value">5:00</span>
            </div>

            <div id="game-total-power-display" class="text-gray-200 text-lg text-center mb-4">
                القوة الإجمالية: <span id="player-total-power-display-game" class="font-bold text-red-400">0</span>
            </div>

            <div id="next-house-info" class="text-gray-300 text-center text-base mb-6 hidden">
            </div>

            <div id="houses-container" class="grid grid-cols-2 gap-4 justify-items-center view-content">
            </div>
        </div>

        <div id="store-view" class="view transform translate-x-full">
            <div id="back-to-main-from-store" class="absolute top-4 left-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-center text-gray-100 mb-8">المتجر</h1>

            <div class="flex items-center justify-center gap-x-4 mb-6 bg-gray-700 p-3 rounded-xl shadow-md">
                <div class="flex items-center text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm.5 4.75a.75.75 0 00-1.5 0v.625H9.75a.75.75 0 000 1.5h1.25v.625a.75.75 0 001.5 0v-.625h1.25a.75.75 0 000-1.5h-1.25V7a.75.75 0 00-.75-.75zM12 18a.75.75 0 00.75-.75v-1.5a.75.75 0 00-1.5 0v1.5c0 .414.336.75.75.75zM12 13.5a.75.75 0 00.75-.75V9.75a.75.75 0 00-1.5 0v3c0 .414.336.75.75.75z" clip-rule="evenodd" />
                        </svg>
                    <span class="text-base" id="store-player-points-display">0</span>
                </div>
                <div class="flex items-center text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V3m0 9v3m0 3.545c-1.472 0-2.688-.475-3.463-1.249A3.987 3.987 0 018 18a4 4 0 00-4 4h16c0-2.209-1.791-4-4-4a4 4 0 01-3.463-1.249C14.688 17.07 13.472 16.545 12 16.545z" />
                        </svg>
                    <span class="text-base" id="store-player-dollars-display">$0</span>
                </div>
                <div class="flex items-center text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span class="text-base" id="store-player-total-power-display">0</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 view-content">
                <div id="store-item-reduce-time" class="store-item">
                    
                    <span class="text-lg font-semibold text-white">تقليل وقت الابتكار</span>
                    <span class="text-sm text-gray-300 mt-1">يقلل دقيقتين</span>
                    <button class="buy-button mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V3m0 9v3m0 3.545c-1.472 0-2.688-.475-3.463-1.249A3.987 3.987 0 018 18a4 4 0 00-4 4h16c0-2.209-1.791-4-4-4a4 4 0 01-3.463-1.249C14.688 17.07 13.472 16.545 12 16.545z" />
                        </svg>
                        <span>200</span>
                    </button>
                </div>
                <div id="store-item-convert-points" class="store-item">
                    
                    <span class="text-lg font-semibold text-white">تحويل النقاط</span>
                    <span class="text-sm text-gray-300 mt-1">يحول النقاط إلى دولارات</span>
                    <button class="buy-button mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm.5 4.75a.75.75 0 00-1.5 0v.625H9.75a.75.75 0 000 1.5h1.25v.625a.75.75 0 001.5 0v-.625h1.25a.75.75 0 000-1.5h-1.25V7a.75.75 0 00-.75-.75zM12 18a.75.75 0 00.75-.75v-1.5a.75.75 0 00-1.5 0v1.5c0 .414.336.75.75.75zM12 13.5a.75.75 0 00.75-.75V9.75a.75.75 0 00-1.5 0v3c0 .414.336.75.75.75z" clip-rule="evenodd" />
                        </svg>
                        <span>500</span>
                    </button>
                </div>
                <div id="store-item-buy-innovation3" class="store-item">
                    
                    <span class="text-lg font-semibold text-white">شراء ابتكار ثالث</span>
                    <span class="text-sm text-gray-300 mt-1">يفتح ابتكارًا جديدًا</span>
                    <button class="buy-button mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm.5 4.75a.75.75 0 00-1.5 0v.625H9.75a.75.75 0 000 1.5h1.25v.625a.75.75 0 001.5 0v-.625h1.25a.75.75 0 000-1.5h-1.25V7a.75.75 0 00-.75-.75zM12 18a.75.75 0 00.75-.75v-1.5a.75.75 0 00-1.5 0v1.5c0 .414.336.75.75.75zM12 13.5a.75.75 0 00.75-.75V9.75a.75.75 0 00-1.5 0v3c0 .414.336.75.75.75z" clip-rule="evenodd" />
                        </svg>
                        <span>3000</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="challenge-view" class="view transform translate-x-full">
            <div id="back-to-main-from-challenge" class="absolute top-4 left-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-center text-gray-100 mb-8">تحدي اللاعبون</h1>
            <div id="global-attack-cooldown-display" class="text-gray-300 text-lg text-center mb-6 hidden">
                يمكنك الهجوم <span id="attacks-remaining-display" class="font-bold text-yellow-400">0</span> مرات. وقت التهدئة العالمي: <span id="global-cooldown-timer-display" class="font-bold">0:00</span>
            </div>
            <div id="challenge-players-list" class="view-content flex flex-col gap-4">
            </div>
        </div>

        <div id="chat-view" class="view transform translate-x-full">
            <div id="back-to-main-from-chat" class="absolute top-4 left-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-center text-gray-100 mb-8">اخبار التحديثات</h1>
            <div id="chat-messages" class="view-content flex flex-col-reverse">
            </div>
            <div id="chat-input-container" class="flex p-4 bg-gray-800 rounded-b-3xl">
                <input type="text" id="chat-input" placeholder="اكتب رسالتك..." class="flex-grow p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="chat-send-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out">
                    إرسال
                </button>
            </div>
        </div>

        <div id="online-view" class="view transform translate-x-full">
            <div id="back-to-main-from-online" class="absolute top-4 left-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-center text-gray-100 mb-8">اونلاين</h1>
            
            <div class="view-content">
                <div class="bg-gray-700 p-4 rounded-xl mb-6 shadow-md">
                    <h2 class="text-xl font-semibold text-gray-100 mb-4">اللاعبون المتصلون</h2>
                    <div id="online-players-list" class="flex flex-col gap-3">
                        <p class="text-gray-400 text-center">لا يوجد لاعبون متصلون حالياً.</p>
                    </div>
                </div>

                <div class="bg-gray-700 p-4 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold text-gray-100 mb-4">اللاعبون غير المتصلين</h2>
                    <div id="recently-offline-players-list" class="flex flex-col gap-3">
                        <p class="text-gray-400 text-center">لا يوجد لاعبون غير متصلين.</p>
                    </div>
                </div>
            </div>

            <div id="online-player-total-power-display" class="text-gray-200 text-lg text-center mt-4">
                قوتك الإجمالية: <span class="font-bold text-red-400" id="player-total-power-display-online">0</span>
            </div>
        </div>
    </div>

    <div id="popup-modal" class="modal-overlay hidden">
        <div class="popup-content text-center max-w-sm w-full transform scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">تم الترقية!</h3>
            <p class="text-gray-200 text-lg mb-2">القوة المرتفعة: <span id="power-increase-display" class="popup-number text-yellow-300"></span></p>
            <p class="text-gray-200 text-lg mb-6">القوة الإجمالية: <span id="total-power-display" class="popup-number text-green-300"></span></p>
            <button id="popup-close-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                حسناً
            </button>
        </div>
    </div>

    <div id="house-info-modal" class="modal-overlay hidden">
        <div class="bg-gray-700 p-8 rounded-xl shadow-2xl text-center max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300 ease-out">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">معلومات البيت والترقيات</h3>
            <div class="text-gray-200 text-lg mb-6 text-right">
                <p class="font-bold mb-2">جوائز ترقية البيت:</p>
                <ul id="house-upgrade-rewards-list" class="list-none p-0 m-0">
                </ul>
            </div>
            <button id="house-info-close-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                حسناً
            </button>
        </div>
    </div>

    <div id="message-modal" class="modal-overlay hidden">
        <div class="message-modal-content text-center max-w-sm w-full transform scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-gray-100 mb-4" id="message-modal-title"></h3>
            <p class="text-gray-200 text-lg mb-6" id="message-modal-text"></p>
            <button id="message-modal-close-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                حسناً
            </button>
        </div>
    </div>

    <div id="password-input-modal" class="modal-overlay hidden">
        <div class="message-modal-content text-center max-w-sm w-full transform scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">أدخل كلمة المرور</h3>
            <input type="password" id="password-input" class="w-full p-3 rounded-lg bg-gray-800 text-white placeholder-gray-400 mb-6 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="كلمة المرور..." maxlength="20">
            <div class="flex justify-center gap-4">
                <button id="password-confirm-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                    تأكيد
                </button>
                <button id="password-cancel-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <div id="store-detail-modal" class="modal-overlay hidden">
        <div class="bg-gray-700 p-8 rounded-xl shadow-2xl text-center max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300 ease-out">
            <img id="store-detail-image" src="" alt="Item Image" class="h-24 w-24 object-contain mx-auto mb-4">
            <h3 id="store-detail-title" class="text-2xl font-bold text-gray-100 mb-2"></h3>
            <p id="store-detail-description" class="text-gray-300 text-base mb-4"></p>
            
            <div id="quantity-selection" class="flex items-center justify-center gap-4 mb-6">
                <button id="store-detail-quantity-minus" class="quantity-button">-</button>
                <span id="store-detail-quantity-display" class="text-white text-lg font-bold">1</span>
                <button id="store-detail-quantity-plus" class="quantity-button">+</button>
            </div>
            <p class="text-gray-200 text-lg mb-6">التكلفة الإجمالية: <span class="text-green-400 font-bold" id="store-detail-total-cost"></span></p>

            <div class="flex justify-center gap-4">
                <button id="store-detail-confirm-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                    تأكيد الشراء
                </button>
                <button id="store-detail-cancel-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <div id="inventory-modal" class="modal-overlay hidden">
        <div class="bg-gray-700 p-8 rounded-xl shadow-2xl text-center max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300 ease-out">
            <h3 class="text-2xl font-bold text-gray-100 mb-6">حقيبتي</h3>
            <div id="inventory-items-list" class="flex flex-col gap-4">
            </div>
            <button id="inventory-close-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out mt-6">
                إغلاق
            </button>
        </div>
    </div>

    <div id="updates-modal" class="modal-overlay hidden">
        <div class="bg-gray-700 p-8 rounded-xl shadow-2xl text-center max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300 ease-out">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">إضافات التحديث</h3>
            <p class="text-gray-200 text-lg mb-6">تم اضافة سجل الهجوم رقم التحديث ١.٢</p>
            <button id="updates-close-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                حسناً
            </button>
        </div>
    </div>

    <div id="auth-flow-modal" class="modal-overlay hidden">
        <div class="bg-gray-700 p-8 rounded-xl shadow-2xl text-center max-w-sm w-full transform scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-gray-100 mb-4" id="auth-modal-title"></h3>
            
            <div id="set-name-section">
                <input type="text" id="player-name-input" class="w-full p-3 rounded-lg bg-gray-800 text-white placeholder-gray-400 mb-6 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="أدخل اسمك هنا..." maxlength="15">
                <div class="flex justify-center gap-4">
                    <button id="set-name-confirm-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                        تأكيد الاسم
                    </button>
                    <button id="set-name-continue-guest-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                        المتابعة كضيف
                    </button>
                </div>
                <p class="text-gray-400 mt-4">أو سجل دخول/أنشئ حساب لحفظ تقدمك:</p>
                <button id="show-email-auth-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out mt-2 w-full">
                    تسجيل دخول / إنشاء حساب
                </button>
                <button id="auth-flow-cancel-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out mt-2 w-full hidden">
                    إلغاء
                </button>
            </div>

            <div id="email-auth-section" class="hidden">
                <input type="email" id="auth-email-input" class="w-full p-3 rounded-lg bg-gray-800 text-white placeholder-gray-400 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="البريد الإلكتروني">
                <input type="password" id="auth-password-input" class="w-full p-3 rounded-lg bg-gray-800 text-white placeholder-gray-400 mb-6 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="كلمة المرور" maxlength="20">
                <div class="flex justify-center gap-4">
                    <button id="auth-signup-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                        إنشاء حساب
                    </button>
                    <button id="auth-signin-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                        تسجيل دخول
                    </button>
                </div>
                <button id="back-to-name-section-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out mt-4 w-full">
                    العودة
                </button>
            </div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal-overlay hidden">
        <div class="message-modal-content text-center max-w-sm w-full transform scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">تأكيد حذف الحساب</h3>
            <p class="text-gray-200 text-lg mb-6">هل أنت متأكد أنك تريد حذف حسابك؟ هذا الإجراء لا يمكن التراجع عنه.</p>
            <div class="flex justify-center gap-4">
                <button id="delete-confirm-yes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                    نعم، احذف
                </button>
                <button id="delete-confirm-no" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <div id="reset-countdown-modal" class="modal-overlay hidden">
        <div class="message-modal-content text-center max-w-sm w-full transform scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">جاري حذف الحساب...</h3>
            <p class="text-gray-200 text-lg mb-6">سيتم إعادة تشغيل التطبيق في <span id="countdown-display" class="text-yellow-400 font-bold text-3xl">10</span> ثوانٍ.</p>
        </div>
    </div>

    <div id="toast-notification" class="fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            linkWithCredential,
            EmailAuthProvider,
            signOut // Added signOut for potential future use or debugging
        } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, remove, push, serverTimestamp, query, orderByChild, limitToLast, onDisconnect } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgmDkMKcfMG3r_16t_6rcjZQJOUFVpVOo",
            authDomain: "kingb7ar-935b8.firebaseapp.com",
            databaseURL: "https://kingb7ar-935b8-default-rtdb.firebaseio.com",
            projectId: "kingb7ar-935b8",
            storageBucket: "kingb7ar-935b8.firebase storage.app",
            messagingSenderId: "157617641483",
            appId: "1:157617641483:web:f8a0e51c1cd1bc4199cf0e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let userId = 'anonymous';
        let isFirebaseLoaded = false;
        let totalPlayerPower = 0;

        const attackLogMenuItem = document.getElementById('attack-log-menu-item');
        const playMenuItem = document.getElementById('play-menu-item');
        const storeMenuItem = document.getElementById('store-menu-item');
        const challengeMenuItem = document.getElementById('challenge-menu-item');
        const chatMenuItem = document.getElementById('chat-menu-item');
        const onlineMenuItem = document.getElementById('online-menu-item');

        const housesContainer = document.getElementById('houses-container');
        const innovationButton = document.getElementById('innovation-button');
        const innovationButtonText = document.getElementById('innovation-button-text');
        const innovationPrevButton = document.getElementById('innovation-prev-button');
        const innovationNextButton = document.getElementById('innovation-next-button');
        const innovationTimer = document.getElementById('innovation-timer');
        const timerDisplayValue = document.getElementById('timer-display-value');
        const nextHouseInfoDisplay = document.getElementById('next-house-info');
        const popupModal = document.getElementById('popup-modal');
        const powerIncreaseDisplay = document.getElementById('power-increase-display');
        const totalPowerDisplay = document.getElementById('total-power-display');
        const popupCloseButton = document.getElementById('popup-close-button');

        const gameInfoIcon = document.getElementById('game-info-icon');
        const houseInfoModal = document.getElementById('house-info-modal');
        const houseUpgradeRewardsList = document.getElementById('house-upgrade-rewards-list');
        const houseInfoCloseButton = document.getElementById('house-info-close-button');

        const messageModal = document.getElementById('message-modal');
        const messageModalTitle = document.getElementById('message-modal-title');
        const messageModalText = document.getElementById('message-modal-text');
        const messageModalCloseButton = document.getElementById('message-modal-close-button');

        const passwordInputModal = document.getElementById('password-input-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordConfirmButton = document.getElementById('password-confirm-button');
        const passwordCancelButton = document.getElementById('password-cancel-button');
        const CHAT_PASSWORD = "Max@2468";

        const storeItemReduceTime = document.getElementById('store-item-reduce-time');
        const storeItemConvertPoints = document.getElementById('store-item-convert-points');
        const storeItemBuyInnovation3 = document.getElementById('store-item-buy-innovation3');

        const storeDetailModal = document.getElementById('store-detail-modal');
        const storeDetailImage = document.getElementById('store-detail-image');
        const storeDetailTitle = document.getElementById('store-detail-title');
        const storeDetailDescription = document.getElementById('store-detail-description');
        const storeDetailQuantityMinus = document.getElementById('store-detail-quantity-minus');
        const storeDetailQuantityDisplay = document.getElementById('store-detail-quantity-display');
        const storeDetailQuantityPlus = document.getElementById('store-detail-quantity-plus');
        const storeDetailTotalCost = document.getElementById('store-detail-total-cost');
        const storeDetailConfirmButton = document.getElementById('store-detail-confirm-button');
        const storeDetailCancelButton = document.getElementById('store-detail-cancel-button');

        const inventoryIcon = document.getElementById('inventory-icon');
        const inventoryCountDisplay = document.getElementById('inventory-count');
        const inventoryModal = document.getElementById('inventory-modal');
        const inventoryItemsList = document.getElementById('inventory-items-list');
        const inventoryCloseButton = document.getElementById('inventory-close-button');

        const updatesIcon = document.getElementById('updates-icon');
        const updatesModal = document.getElementById('updates-modal');
        const updatesCloseButton = document.getElementById('updates-close-button');

        const authFlowModal = document.getElementById('auth-flow-modal');
        const authModalTitle = document.getElementById('auth-modal-title');
        const setNameSection = document.getElementById('set-name-section');
        const emailAuthSection = document.getElementById('email-auth-section');
        const playerNameInput = document.getElementById('player-name-input');
        const setNameConfirmButton = document.getElementById('set-name-confirm-button');
        const setNameContinueGuestButton = document.getElementById('set-name-continue-guest-button');
        const showEmailAuthButton = document.getElementById('show-email-auth-button');
        const authFlowCancelButton = document.getElementById('auth-flow-cancel-button');

        const authEmailInput = document.getElementById('auth-email-input');
        const authPasswordInput = document.getElementById('auth-password-input');
        const authSignupButton = document.getElementById('auth-signup-button');
        const authSigninButton = document.getElementById('auth-signin-button');
        const backToNameSectionButton = document.getElementById('back-to-name-section-button');

        const playerNameDisplay = document.getElementById('player-name-display');

        const deleteAccountButton = document.getElementById('delete-account-button');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteConfirmYes = document.getElementById('delete-confirm-yes');
        const deleteConfirmNo = document.getElementById('delete-confirm-no');
        const resetCountdownModal = document.getElementById('reset-countdown-modal');
        const countdownDisplay = document.getElementById('countdown-display');

        const storePlayerPointsDisplay = document.getElementById('store-player-points-display');
        const storePlayerDollarsDisplay = document.getElementById('store-player-dollars-display');
        const storePlayerTotalPowerDisplay = document.getElementById('store-player-total-power-display');

        const playerTotalPowerDisplayMain = document.getElementById('player-total-power-display-main');
        const playerTotalPowerDisplayGame = document.getElementById('player-total-power-display-game');
        const playerTotalPowerDisplayOnline = document.getElementById('player-total-power-display-online');

        const toastNotification = document.getElementById('toast-notification');

        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send-button');

        const onlinePlayersListDiv = document.getElementById('online-players-list');
        const recentlyOfflinePlayersListDiv = document.getElementById('recently-offline-players-list');

        const challengePlayersList = document.getElementById('challenge-players-list');
        const globalAttacksList = document.getElementById('global-attacks-list');

        const globalAttackCooldownDisplay = document.getElementById('global-attack-cooldown-display');
        const attacksRemainingDisplay = document.getElementById('attacks-remaining-display');
        const globalCooldownTimerDisplay = document.getElementById('global-cooldown-timer-display');

        const accumulatedDollarsDisplay = document.getElementById('accumulated-dollars-display');
        const accumulatedPointsDisplay = document.getElementById('accumulated-points-display'); // New display for accumulated points
        const accumulatedPowerDisplay = document.getElementById('accumulated-power-display');   // New display for accumulated power
        const dollarCollectorProgressBar = document.getElementById('dollar-collector-progress'); // New progress bar element
        const collectDollarsButton = document.getElementById('collect-dollars-button');


        let houses = [
            { id: 1, power: 1, unlocked: true, threshold: 5000, rewardedThresholds: [] },
            { id: 2, power: 1, unlocked: false, threshold: 5000, rewardedThresholds: [] },
            { id: 3, power: 1, unlocked: false, threshold: 5000, rewardedThresholds: [] },
            { id: 4, power: 1, unlocked: false, threshold: 5000, rewardedThresholds: [] },
            { id: 5, power: 1, unlocked: false, threshold: 5000, rewardedThresholds: [] },
            { id: 6, power: 1, unlocked: false, threshold: 25000, rewardedThresholds: [] }
        ];
        let activeHouseIndex = 0;
        let globalCooldownUpdater = null;
        let onlineStatusUpdater = null;
        let globalAttackCooldownInterval = null;
        let dollarCollectionInterval = null;

        let playerPoints = 0;
        let playerDollars = 0;
        let accumulatedDollars = 0;
        let accumulatedPoints = 0;
        let accumulatedPower = 0;
        const MAX_ACCUMULATION = 150; // Max for dollars, points, and power
        const ACCUMULATION_RATE = 3; // Amount gained every 5 seconds

        let playerName = "تعيين اسم";
        let isNameSetPermanently = false;
        let lastPlayerNameChangeTimestamp = 0;
        let attackCooldowns = {};
        let attackedTargetsInCooldown = [];
        let globalAttackCooldownEndTime = 0;
        let attacksMadeInCurrentCooldown = 0;
        const MAX_GLOBAL_ATTACKS = 5;
        const GLOBAL_ATTACK_COOLDOWN_DURATION = 10 * 60; // 10 minutes
        const NAME_CHANGE_COOLDOWN_DURATION = 3 * 24 * 60 * 60 * 1000;
        const ONLINE_ACTIVE_DURATION = 60 * 1000; // 1 minute for truly "online" status
        const OFFLINE_RECENT_DURATION = 10 * 60 * 60 * 1000; // 10 hours for "recently offline" display

        let playerInventory = { reduceTime: 0 };

        const housePowerTiers = [
            { minPower: 1, imageUrl: "https://d.top4top.io/p_347985vd10.png" },
            { minPower: 2500, imageUrl: "https://l.top4top.io/p_3479h0oa70.png" },
            { minPower: 7000, imageUrl: "https://a.top4top.io/p_3479npbk21.png" },
            { minPower: 10000, imageUrl: "https://b.top4top.io/p_3479hfhop2.png" },
            { minPower: 15000, imageUrl: "https://b.top4top.io/p_3479hfhop2.png" },
            { minPower: 25000, imageUrl: "https://d.top4top.io/p_34798y7o83.png" }
        ];

        const houseUpgradeRewards = [
            { power: 1000, points: 200, dollars: 100 },
            { power: 5000, points: 350, dollars: 150 },
            { power: 7000, points: 500, dollars: 200 },
            { power: 10000, points: 1000, dollars: 300 },
            { power: 15000, points: 2000, dollars: 500 },
            { power: 25000, points: 5000, dollars: 1000 }
        ];

        const innovationTypes = [
            { id: 'innovation1', name: 'ابتكار 1', cooldownEndTime: 0, initialCooldown: 4 * 60, colorClass: 'from-purple-600 to-indigo-700' },
            { id: 'innovation2', name: 'ابتكار 2', cooldownEndTime: 0, initialCooldown: 4 * 60, colorClass: 'from-orange-600 to-amber-700' },
            { id: 'innovation3', name: 'ابتكار 3', cooldownEndTime: 0, initialCooldown: 4 * 60, colorClass: 'from-green-600 to-emerald-700', isOwned: false }
        ];
        let currentInnovationTypeIndex = 0;

        let lastChatClearDate = null;

        // Define storeItems object here to ensure it's accessible
        const storeItems = {
            reduceTime: {
                name: 'تقليل وقت الابتكار',
                description: 'يقلل دقيقتين من وقت تهدئة الابتكار الحالي.',
                image: 'https://f.top4top.io/p_3479ijdcl0.png',
                cost: 200,
                costType: 'dollars',
                directUse: false, // This is an inventory item
                useEffect: (quantity) => {
                    const currentInnovation = innovationTypes[currentInnovationTypeIndex];
                    if (currentInnovation) {
                        const timeReductionPerItem = 120; // 2 minutes
                        const cooldownRemaining = Math.max(0, Math.floor((currentInnovation.cooldownEndTime - Date.now()) / 1000));
                        const actualReduction = Math.min(cooldownRemaining, quantity * timeReductionPerItem);
                        currentInnovation.cooldownEndTime = Math.max(Date.now(), currentInnovation.cooldownEndTime - (actualReduction * 1000));
                        saveInnovationTypes();
                        updateInnovationTimerDisplay();
                        showToast(`تم تقليل وقت التهدئة بـ ${actualReduction / 60} دقيقة!`, 'success');
                    } else {
                        showToast('لا يوجد ابتكار نشط لتقليل وقته.', 'info');
                    }
                }
            },
            convertPoints: {
                name: 'تحويل النقاط',
                description: 'يحول 500 نقطة إلى 100 دولار.',
                image: 'https://i.top4top.io/s_34795cyi20.png',
                cost: 500,
                costType: 'points',
                directUse: true, // This item is used directly upon purchase
                useEffect: (quantity) => {
                    const dollarsGained = quantity * 100;
                    playerDollars += dollarsGained;
                    updatePlayerInfoDisplay();
                    savePlayerData();
                    showToast(`تم تحويل ${quantity * 500} نقطة إلى ${dollarsGained}$!`, 'success');
                }
            },
            buyInnovation3: {
                name: 'شراء ابتكار ثالث',
                description: 'يفتح الابتكار الثالث بشكل دائم.',
                image: 'https://f.top4top.io/s_34796x9520.png',
                cost: 3000,
                costType: 'points',
                directUse: true, // This item is used directly upon purchase
                useEffect: () => {
                    const innovation3 = innovationTypes.find(inv => inv.id === 'innovation3');
                    if (innovation3) {
                        innovation3.isOwned = true;
                        saveInnovationTypes();
                        updateInnovationButtonText();
                        showMessageModal('تم الشراء', 'تم فتح الابتكار الثالث بنجاح!');
                    }
                }
            }
        };

        function formatPower(num) {
            if (num >= 10000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            const pad = (num) => num < 10 ? '0' + num : num;
            return `${pad(hours)}:${pad(minutes)}:${pad(remainingSeconds)}`;
        }

        function timeAgo(timestamp) {
            const now = Date.now();
            const seconds = Math.floor((now - timestamp) / 1000);

            if (seconds < 60) {
                return `منذ ${seconds} ثانية`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                return `منذ ${minutes} دقيقة`;
            } else if (seconds < 86400) {
                const hours = Math.floor(seconds / 3600);
                return `منذ ${hours} ساعة`;
            } else {
                const days = Math.floor(seconds / 86400);
                return `منذ ${days} يوم`;
            }
        }

        function closeModal(modalElement) {
            if (modalElement && modalElement.querySelector('div')) {
                modalElement.querySelector('div').classList.remove('scale-100', 'opacity-100');
                modalElement.querySelector('div').classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modalElement.classList.add('hidden');
                }, 300);
            }
        }

        function showToast(message, type = 'success') {
            if (!toastNotification) return;

            toastNotification.textContent = message;
            toastNotification.className = `fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50`;
            if (type === 'success') {
                toastNotification.classList.add('bg-green-600');
            } else if (type === 'info') {
                toastNotification.classList.add('bg-blue-600');
            } else if (type === 'error') {
                toastNotification.classList.add('bg-red-600');
            }
            toastNotification.classList.remove('opacity-0');
            toastNotification.classList.add('opacity-100');

            setTimeout(() => {
                toastNotification.classList.remove('opacity-100');
                toastNotification.classList.add('opacity-0');
            }, 2000);
        }

        function calculateTotalPower() {
            let total = 0;
            houses.forEach(house => {
                total += house.power;
            });
            totalPlayerPower = total;
            return total;
        }

        function updatePlayerInfoDisplay() {
            calculateTotalPower();
            if (document.getElementById('player-points-display')) document.getElementById('player-points-display').textContent = formatPower(playerPoints);
            if (document.getElementById('player-dollars-display')) document.getElementById('player-dollars-display').textContent = `$${formatPower(playerDollars)}`;
            if (inventoryCountDisplay) inventoryCountDisplay.textContent = playerInventory.reduceTime;
            if (playerNameDisplay) playerNameDisplay.textContent = playerName;
            
            if (playerTotalPowerDisplayMain) playerTotalPowerDisplayMain.textContent = formatPower(totalPlayerPower);
            if (playerTotalPowerDisplayGame) playerTotalPowerDisplayGame.textContent = formatPower(totalPlayerPower);
            if (playerTotalPowerDisplayOnline) playerTotalPowerDisplayOnline.textContent = formatPower(totalPlayerPower);

            if (storePlayerPointsDisplay) storePlayerPointsDisplay.textContent = formatPower(playerPoints);
            if (storePlayerDollarsDisplay) storePlayerDollarsDisplay.textContent = `$${formatPower(playerDollars)}`;
            if (storePlayerTotalPowerDisplay) storePlayerTotalPowerDisplay.textContent = formatPower(totalPlayerPower);

            if (isFirebaseLoaded && userId && playerName !== "تعيين اسم") {
                set(ref(db, `artifacts/${appId}/public/playerProfiles/${userId}`), {
                    name: playerName,
                    totalPower: totalPlayerPower
                });
            }
        }

        function navigateTo(targetViewId, direction = 'right') {
            const currentView = document.querySelector('.view.translate-x-0');
            const targetView = document.getElementById(targetViewId);

            if (currentView === targetView) return;

            if (currentView) {
                if (direction === 'right') {
                    currentView.classList.add('-translate-x-full');
                } else {
                    currentView.classList.add('translate-x-full');
                }
                currentView.classList.remove('translate-x-0');
            }
            
            if (targetView) {
                if (direction === 'right') {
                    targetView.classList.remove('-translate-x-full');
                    targetView.classList.add('translate-x-full');
                } else {
                    targetView.classList.remove('translate-x-full');
                    targetView.classList.add('-translate-x-full');
                }
                
                setTimeout(() => {
                    targetView.classList.remove('translate-x-full', '-translate-x-full');
                    targetView.classList.add('translate-x-0');
                    const targetViewContent = targetView.querySelector('.view-content');
                    if (targetViewContent) {
                        targetViewContent.scrollTop = 0;
                    }
                }, 10);
            }
            if (targetViewId === 'store-view') {
                updatePlayerInfoDisplay();
            }
            if (targetViewId === 'online-view') {
                listenForOnlineUsers();
            }
            if (targetViewId === 'challenge-view') {
                renderChallengePlayers();
                startGlobalAttackCooldownUpdater();
            } else {
                clearInterval(globalAttackCooldownInterval);
            }
            if (targetViewId === 'attack-log-view') {
                listenForGlobalAttackLog();
            }
        }

        function getHouseImage(power) {
            for (let i = housePowerTiers.length - 1; i >= 0; i--) {
                if (power >= housePowerTiers[i].minPower) {
                    return housePowerTiers[i].imageUrl;
                }
            }
            return housePowerTiers[0].imageUrl;
        }

        function renderHouses() {
            if (!housesContainer) return;

            housesContainer.innerHTML = '';
            houses.forEach( (house, index) => {
                const houseElement = document.createElement('div');
                const houseImageUrl = getHouseImage(house.power);
                houseElement.className = `house-container ${!house.unlocked ? 'locked-house' : ''} cursor-pointer`;
                if (index === activeHouseIndex) {
                    houseElement.classList.add('active-house');
                }
                houseElement.dataset.houseIndex = index;
                houseElement.innerHTML = `
                    <img src="${houseImageUrl}" alt="House">
                    <div class="text-sm font-bold mt-1">القوة: ${formatPower(house.power)}</div>
                    ${!house.unlocked ? '<div class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center rounded-xl"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v3.06M16 17H8"></path></svg></div>' : ''}
                `;
                housesContainer.appendChild(houseElement);

                if (house.unlocked) {
                    houseElement.addEventListener('click', () => {
                        activeHouseIndex = index;
                        renderHouses();
                        saveHouses();
                    });
                }
            });

            updateNextHouseInfo();
        }

        function updateNextHouseInfo() {
            if (!nextHouseInfoDisplay) return;

            const currentHouse = houses[activeHouseIndex];
            const nextHouse = houses[activeHouseIndex + 1];

            if (nextHouse && !nextHouse.unlocked) {
                const remainingPower = nextHouse.threshold - currentHouse.power;
                nextHouseInfoDisplay.textContent = `لفتح البيت التالي: ${formatPower(Math.max(0, remainingPower))} قوة متبقية`;
                nextHouseInfoDisplay.classList.remove('hidden');
            } else {
                nextHouseInfoDisplay.classList.add('hidden');
            }
        }

        function showMessageModal(title, text) {
            if (!messageModal || !messageModalTitle || !messageModalText) return;

            messageModal.classList.remove('hidden');
            messageModalTitle.innerHTML = title;
            messageModalText.innerHTML = text;
            setTimeout(() => {
                if (messageModal.querySelector('.message-modal-content')) {
                    messageModal.querySelector('.message-modal-content').classList.remove('scale-95', 'opacity-0');
                    messageModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                }
            }, 10);
        }

        if (attackLogMenuItem) attackLogMenuItem.addEventListener('click', () => navigateTo('attack-log-view', 'right'));
        if (playMenuItem) playMenuItem.addEventListener('click', () => navigateTo('game-view', 'right'));
        if (storeMenuItem) storeMenuItem.addEventListener('click', () => navigateTo('store-view', 'right'));
        if (challengeMenuItem) {
            challengeMenuItem.addEventListener('click', () => {
                navigateTo('challenge-view', 'right');
            });
        }
        if (chatMenuItem) chatMenuItem.addEventListener('click', () => navigateTo('chat-view', 'right'));
        if (onlineMenuItem) onlineMenuItem.addEventListener('click', () => navigateTo('online-view', 'right'));
        
        document.addEventListener('click', (event) => {
            if (event.target.closest('#back-to-main-from-attack-log')) {
                navigateTo('main-menu-view', 'left');
            } else if (event.target.closest('#back-to-main-from-game')) {
                navigateTo('main-menu-view', 'left');
            } else if (event.target.closest('#back-to-main-from-store')) {
                navigateTo('main-menu-view', 'left');
            } else if (event.target.closest('#back-to-main-from-challenge')) {
                navigateTo('main-menu-view', 'left');
            } else if (event.target.closest('#back-to-main-from-chat')) {
                navigateTo('main-menu-view', 'left');
            } else if (event.target.closest('#back-to-main-from-online')) {
                navigateTo('main-menu-view', 'left');
            }
        });

        if (innovationPrevButton) innovationPrevButton.addEventListener('click', () => {
            currentInnovationTypeIndex = (currentInnovationTypeIndex - 1 + innovationTypes.length) % innovationTypes.length;
            updateInnovationButtonText();
            updateInnovationTimerDisplay();
        });

        if (innovationNextButton) innovationNextButton.addEventListener('click', () => {
            currentInnovationTypeIndex = (currentInnovationTypeIndex + 1) % innovationTypes.length;
            updateInnovationButtonText();
            updateInnovationTimerDisplay();
        });

        function updateInnovationButtonText() {
            if (!innovationButton || !innovationButtonText) return;

            const currentType = innovationTypes[currentInnovationTypeIndex];
            innovationButton.className = `text-white font-bold flex items-center mx-2 bg-gradient-to-br ${currentType.colorClass}`;
            innovationButtonText.innerHTML = `<span>تفعيل ${currentType.name}</span><span class="price-display"><span>مجاني</span></span>`;
            
            const cooldownRemaining = Math.max(0, Math.floor((currentType.cooldownEndTime - Date.now()) / 1000));
            
            if (currentType.id === 'innovation3' && !currentType.isOwned) {
                innovationButton.disabled = true;
                innovationButton.classList.add('opacity-50', 'cursor-not-allowed');
                innovationButtonText.innerHTML = `<span>شراء ${currentType.name}</span><span class="price-display">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm.5 4.75a.75.75 0 00-1.5 0v.625H9.75a.75.75 0 000 1.5h1.25v.625a.75.75 0 001.5 0v-.625h1.25a.75.75 0 000-1.5h-1.25V7a.75.75 0 00-.75-.75zM12 18a.75.75 0 00.75-.75v-1.5a.75.75 0 00-1.5 0v1.5c0 .414.336.75.75.75zM12 13.5a.75.75 0 00.75-.75V9.75a.75.75 0 00-1.5 0v3c0 .414.336.75.75.75z" clip-rule="evenodd" />
                    </svg>
                    <span>3000</span>
                </span>`;
                return;
            }

            if (cooldownRemaining > 0) {
                innovationButton.disabled = true;
                innovationButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                innovationButton.disabled = false;
                innovationButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function updateInnovationTimerDisplay() {
            if (!innovationTimer || !timerDisplayValue) return;

            const currentInnovation = innovationTypes[currentInnovationTypeIndex];
            const cooldownRemaining = Math.max(0, Math.floor((currentInnovation.cooldownEndTime - Date.now()) / 1000));

            if (cooldownRemaining > 0) {
                innovationTimer.classList.remove('hidden');
                timerDisplayValue.textContent = formatTime(cooldownRemaining);
                timerDisplayValue.classList.add('timer-digit-animation');
            } else {
                innovationTimer.classList.add('hidden');
                timerDisplayValue.classList.remove('timer-digit-animation');
            }
            updateInnovationButtonText();
        }

        if (innovationButton) {
            innovationButton.addEventListener('click', () => {
                const currentInnovation = innovationTypes[currentInnovationTypeIndex];

                if (currentInnovation.id === 'innovation3' && !currentInnovation.isOwned) { // Corrected from currentType.isOwned
                    const item = storeItems['buyInnovation3'];
                    if (playerPoints >= item.cost) {
                        playerPoints -= item.cost;
                        currentInnovation.isOwned = true;
                        saveInnovationTypes();
                        updatePlayerInfoDisplay();
                        updateInnovationButtonText();
                        showMessageModal('تم الشراء', 'تم فتح الابتكار الثالث بنجاح!');
                    } else {
                        showMessageModal('فشل الشراء', `ليس لديك نقاط كافية لشراء هذا الابتكار. تحتاج ${item.cost} نقطة.`);
                    }
                    return;
                }

                if (!houses[activeHouseIndex].unlocked) {
                    showMessageModal('بيت مقفول', 'لا يمكنك استخدام الابتكار على بيت مقفول. يرجى اختيار بيت مفتوح.');
                    return;
                }

                const cooldownRemaining = Math.max(0, Math.floor((currentInnovation.cooldownEndTime - Date.now()) / 1000));

                if (cooldownRemaining > 0) {
                    showMessageModal('الابتكار قيد الانتظار', `هذا الابتكار لا يزال في فترة التهدئة. الوقت المتبقي: ${formatTime(cooldownRemaining)}`);
                    return;
                }

                const currentHouse = houses[activeHouseIndex];
                const oldPower = currentHouse.power;

                const powerIncrease = Math.floor(Math.random() * (300 - 25 + 1)) + 25;
                currentHouse.power += powerIncrease;
                
                const pointsRewardForInnovation = Math.floor(Math.random() * (100 - 20 + 1)) + 20;
                playerPoints += pointsRewardForInnovation;

                houseUpgradeRewards.forEach(reward => {
                    if (currentHouse.power >= reward.power && oldPower < reward.power && !currentHouse.rewardedThresholds.includes(reward.power)) {
                        playerPoints += reward.points;
                        playerDollars += reward.dollars;
                        currentHouse.rewardedThresholds.push(reward.power);
                        updatePlayerInfoDisplay();
                    }
                });

                renderHouses();
                saveHouses();

                if (powerIncreaseDisplay) powerIncreaseDisplay.textContent = formatPower(powerIncrease);
                if (totalPowerDisplay) totalPowerDisplay.textContent = formatPower(currentHouse.power);
                
                if (popupModal) {
                    popupModal.classList.remove('hidden');
                    setTimeout(() => {
                        if (popupModal.querySelector('.popup-content')) {
                            popupModal.querySelector('.popup-content').classList.remove('scale-95', 'opacity-0');
                            popupModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                        }
                    }, 10);
                }

                if (currentHouse.id !== houses[houses.length - 1].id && currentHouse.power >= currentHouse.threshold) {
                    const nextHouseIndex = houses.findIndex(h => h.id === currentHouse.id + 1);
                    if (nextHouseIndex !== -1 && !houses[nextHouseIndex].unlocked) {
                        houses[nextHouseIndex].unlocked = true;
                        showMessageModal('بيت جديد مفتوح!', `تهانينا! لقد فتحت البيت رقم ${houses[nextHouseIndex].id}!`);
                    }
                }
                renderHouses();
                saveHouses();

                if (currentInnovation) {
                    currentInnovation.cooldownEndTime = Date.now() + (currentInnovation.initialCooldown * 1000);
                    updateInnovationTimerDisplay();
                    startGlobalCooldownUpdater();
                }

                updatePlayerInfoDisplay();
            });
        }

        if (popupCloseButton) {
            popupCloseButton.addEventListener('click', () => {
                closeModal(popupModal);
            });
        }

        if (gameInfoIcon) {
            gameInfoIcon.addEventListener('click', () => {
                if (!houseUpgradeRewardsList || !houseInfoModal) return;

                houseUpgradeRewardsList.innerHTML = '';
                houseUpgradeRewards.forEach(reward => {
                    const houseImageUrl = getHouseImage(reward.power);
                    const listItem = document.createElement('li');
                    listItem.className = 'mb-2 flex items-center justify-end';
                    listItem.innerHTML = `
                        <div class="text-left flex-grow">
                            <p class="font-bold">قوة ${formatPower(reward.power)}:</p>
                            <p><span class="text-yellow-300">${formatPower(reward.points)} نقطة</span>, <span class="text-green-300">${formatPower(reward.dollars)}$</span></p>
                        </div>
                        <img src="${houseImageUrl}" alt="House Tier ${formatPower(reward.power)}" class="w-16 h-16 object-contain rounded-md mr-3">
                    `;
                    houseUpgradeRewardsList.appendChild(listItem);
                });

                houseInfoModal.classList.remove('hidden');
                setTimeout(() => {
                    if (houseInfoModal.querySelector('div')) {
                        houseInfoModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                        houseInfoModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                    }
                }, 10);
            });
        }

        if (houseInfoCloseButton) {
            houseInfoCloseButton.addEventListener('click', () => {
                closeModal(houseInfoModal);
            });
        }

        if (messageModalCloseButton) {
            messageModalCloseButton.addEventListener('click', () => {
                closeModal(messageModal);
            });
        }

        let passwordCallback = null;

        function showPasswordInputModal(callback) {
            passwordCallback = callback;
            if (passwordInputModal && passwordInput) {
                passwordInput.value = '';
                passwordInputModal.classList.remove('hidden');
                setTimeout(() => {
                    if (passwordInputModal.querySelector('div')) {
                        passwordInputModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                        passwordInputModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                    }
                }, 10);
            }
        }

        if (passwordConfirmButton) {
            passwordConfirmButton.addEventListener('click', () => {
                if (passwordInput && passwordCallback) {
                    const enteredPassword = passwordInput.value;
                    closeModal(passwordInputModal);
                    passwordCallback(enteredPassword);
                }
            });
        }

        if (passwordCancelButton) {
            passwordCancelButton.addEventListener('click', () => {
                closeModal(passwordInputModal);
                passwordCallback(null);
            });
        }

        if (storeItemReduceTime) storeItemReduceTime.addEventListener('click', () => {
            showStoreItemDetail('reduceTime');
        });

        if (storeItemConvertPoints) storeItemConvertPoints.addEventListener('click', () => {
            showStoreItemDetail('convertPoints');
        });

        if (storeItemBuyInnovation3) storeItemBuyInnovation3.addEventListener('click', () => {
            showStoreItemDetail('buyInnovation3');
        });

        let currentStoreItem = null;
        let currentStoreQuantity = 1;

        function updateStoreDetailQuantityDisplay() {
            if (!storeDetailQuantityDisplay || !storeDetailTotalCost || !storeDetailQuantityPlus || !storeDetailQuantityMinus) {
                return;
            }

            const item = storeItems[currentStoreItem];
            if (!item) {
                storeDetailTotalCost.textContent = "N/A";
                return;
            }

            storeDetailQuantityDisplay.textContent = currentStoreQuantity;
            storeDetailTotalCost.textContent = `${formatPower(item.cost * currentStoreQuantity)}${item.costType === 'dollars' ? '$' : ' نقطة'}`;

            if (item.directUse) {
                storeDetailQuantityPlus.disabled = true;
                storeDetailQuantityMinus.disabled = true;
            } else {
                let maxQuantity = item.costType === 'dollars' ? Math.floor(playerDollars / item.cost) : Math.floor(playerPoints / item.cost);

                if (currentStoreItem === 'reduceTime') {
                    const currentInnovation = innovationTypes[currentInnovationTypeIndex];
                    const timeReductionPerItem = 120;
                    const cooldownRemaining = Math.max(0, Math.floor((currentInnovation.cooldownEndTime - Date.now()) / 1000));
                    if (currentInnovation && cooldownRemaining > 0) {
                        const maxItemsToReduceToZero = Math.ceil(cooldownRemaining / timeReductionPerItem);
                        maxQuantity = Math.min(maxQuantity, maxItemsToReduceToZero);
                    } else {
                        maxQuantity = 0;
                    }
                }
                
                storeDetailQuantityPlus.disabled = currentStoreQuantity >= maxQuantity;
                storeDetailQuantityMinus.disabled = currentStoreQuantity <= 1;
            }
        }

        if (storeDetailQuantityMinus) {
            storeDetailQuantityMinus.addEventListener('click', () => {
                if (currentStoreQuantity > 1) {
                    currentStoreQuantity--;
                    updateStoreDetailQuantityDisplay();
                }
            });
        }

        if (storeDetailQuantityPlus) {
            storeDetailQuantityPlus.addEventListener('click', () => {
                const item = storeItems[currentStoreItem];
                if (item) {
                    let maxQuantity = item.costType === 'dollars' ? Math.floor(playerDollars / item.cost) : Math.floor(playerPoints / item.cost);

                    if (currentStoreItem === 'reduceTime') {
                        const currentInnovation = innovationTypes[currentInnovationTypeIndex];
                        const timeReductionPerItem = 120;
                        const cooldownRemaining = Math.max(0, Math.floor((currentInnovation.cooldownEndTime - Date.now()) / 1000));
                        if (currentInnovation && cooldownRemaining > 0) {
                            const maxItemsToReduceToZero = Math.ceil(cooldownRemaining / timeReductionPerItem);
                            maxQuantity = Math.min(maxQuantity, maxItemsToReduceToZero);
                        } else {
                            maxQuantity = 0;
                        }
                    }

                    if (currentStoreQuantity < maxQuantity) {
                        currentStoreQuantity++;
                        updateStoreDetailQuantityDisplay();
                    }
                }
            });
        }

        function showStoreItemDetail(itemId) {
            currentStoreItem = itemId;
            currentStoreQuantity = 1;
            const item = storeItems[itemId];

            if (!item || !storeDetailImage || !storeDetailTitle || !storeDetailDescription || !storeDetailModal || !document.getElementById('quantity-selection')) {
                return;
            }

            storeDetailImage.src = item.image;
            storeDetailTitle.textContent = item.name;
            storeDetailDescription.textContent = item.description;
            
            if (item.directUse) {
                document.getElementById('quantity-selection').classList.add('hidden');
            } else {
                document.getElementById('quantity-selection').classList.remove('hidden');
            }

            let isItemOwned = false;
            if (itemId === 'buyInnovation3') {
                const innovation3 = innovationTypes.find(inv => inv.id === 'innovation3');
                if (innovation3 && innovation3.isOwned) {
                    isItemOwned = true;
                }
            }

            if (isItemOwned) {
                if (storeDetailConfirmButton) {
                    storeDetailConfirmButton.disabled = true;
                    storeDetailConfirmButton.textContent = 'مملوك';
                    storeDetailConfirmButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } else {
                if (storeDetailConfirmButton) {
                    storeDetailConfirmButton.disabled = false;
                    storeDetailConfirmButton.textContent = 'تأكيد الشراء';
                    storeDetailConfirmButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            updateStoreDetailQuantityDisplay();

            storeDetailModal.classList.remove('hidden');
            setTimeout(() => {
                if (storeDetailModal.querySelector('div')) {
                    storeDetailModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                    storeDetailModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                }
            }, 10);

            if (storeDetailConfirmButton) {
                storeDetailConfirmButton.onclick = () => {
                    if (storeDetailConfirmButton.disabled) return;

                    const quantityToBuy = currentStoreQuantity;
                    const totalCost = item.cost * quantityToBuy;
                    let canAfford = false;
                    if (item.costType === 'dollars') {
                        if (playerDollars >= totalCost) {
                            playerDollars -= totalCost;
                            canAfford = true;
                        }
                    } else if (item.costType === 'points') {
                        if (playerPoints >= totalCost) {
                            playerPoints -= totalCost;
                            canAfford = true;
                        }
                    }

                    if (canAfford) {
                        if (item.directUse) {
                            item.useEffect(quantityToBuy);
                        } else {
                            playerInventory[itemId] += quantityToBuy;
                            showMessageModal('نجاح الشراء', `لقد اشتريت ${quantityToBuy} من ${item.name}. لديك الآن ${playerInventory[itemId]} في حقيبتك.`);
                        }
                        updatePlayerInfoDisplay();
                        savePlayerData();
                        savePlayerInventory();
                    } else {
                        showMessageModal('فشل الشراء', `ليس لديك ${item.costType === 'dollars' ? 'دولارات' : 'نقاط'} كافية لشراء ${quantityToBuy} من هذا العنصر.`);
                    }
                    closeModal(storeDetailModal);
                };
            }
        }

        if (storeDetailCancelButton) {
            storeDetailCancelButton.addEventListener('click', () => {
                closeModal(storeDetailModal);
            });
        }

        if (inventoryIcon) {
            inventoryIcon.addEventListener('click', () => {
                renderInventoryItems();
                if (inventoryModal) {
                    inventoryModal.classList.remove('hidden');
                    setTimeout(() => {
                        if (inventoryModal.querySelector('div')) {
                            inventoryModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                            inventoryModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                        }
                    }, 10);
                }
            });
        }

        if (inventoryCloseButton) {
            inventoryCloseButton.addEventListener('click', () => {
                closeModal(inventoryModal);
            });
        }

        function renderInventoryItems() {
            if (!inventoryItemsList) return;

            inventoryItemsList.innerHTML = '';
            let hasItems = false;

            for (const itemId in playerInventory) {
                if (playerInventory[itemId] > 0) {
                    hasItems = true;
                    const item = storeItems[itemId];
                    if (!item) continue;

                    const inventoryItemElement = document.createElement('div');
                    inventoryItemElement.className = 'flex flex-col items-center justify-between bg-gray-600 p-4 rounded-xl shadow-md';
                    inventoryItemElement.innerHTML = `
                        <div class="flex items-center justify-between w-full mb-2">
                            <div class="flex items-center">
                                <img src="${item.image}" alt="${item.name}" class="h-12 w-12 object-contain mr-4">
                                <div>
                                    <p class="text-lg font-semibold text-white">${item.name}</p>
                                    <p class="text-sm text-gray-300">الكمية: ${playerInventory[itemId]}</p>
                                </div>
                            </div>
                            <button data-item-id="${itemId}" class="use-inventory-item-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out">
                                استخدام
                            </button>
                        </div>
                        <div class="flex items-center gap-2 quantity-buttons-row">
                            <button class="quantity-button inventory-quantity-minus" data-item-id="${itemId}">-</button>
                            <span class="inventory-item-quantity-display text-white text-lg font-bold">1</span>
                            <button class="quantity-button inventory-quantity-plus" data-item-id="${itemId}">+</button>
                        </div>
                    `;
                    inventoryItemsList.appendChild(inventoryItemElement);
                }
            }

            if (!hasItems) {
                inventoryItemsList.innerHTML = '<p class="text-gray-300">حقيبتك فارغة.</p>';
            }

            document.querySelectorAll('.inventory-quantity-minus').forEach(button => {
                button.removeEventListener('click', handleInventoryQuantityChange);
                button.addEventListener('click', handleInventoryQuantityChange);
            });

            document.querySelectorAll('.inventory-quantity-plus').forEach(button => {
                button.removeEventListener('click', handleInventoryQuantityChange);
                button.addEventListener('click', handleInventoryQuantityChange);
            });

            document.querySelectorAll('.use-inventory-item-button').forEach(button => {
                button.removeEventListener('click', handleUseItemClick);
                button.addEventListener('click', handleUseItemClick);
            });

            document.querySelectorAll('.quantity-buttons-row').forEach(container => {
                const itemId = container.querySelector('.inventory-quantity-minus').dataset.itemId;
                if (itemId) {
                    updateInventoryQuantityButtons(container, itemId);
                }
            });
        }

        function handleInventoryQuantityChange(event) {
            const itemId = event.target.dataset.itemId;
            const parentContainer = event.target.closest('.quantity-buttons-row');
            if (!parentContainer) return;

            const quantityDisplay = parentContainer.querySelector('.inventory-item-quantity-display');
            let current = parseInt(quantityDisplay.textContent, 10);
            const max = playerInventory[itemId];

            if (event.target.classList.contains('inventory-quantity-minus')) {
                if (current > 1) {
                    quantityDisplay.textContent = current - 1;
                }
            } else if (event.target.classList.contains('inventory-quantity-plus')) {
                if (current < max) {
                    quantityDisplay.textContent = current + 1;
                }
            }
            updateInventoryQuantityButtons(parentContainer, itemId);
        }

        function updateInventoryQuantityButtons(container, itemId) {
            const quantityDisplay = container.querySelector('.inventory-item-quantity-display');
            const minusButton = container.querySelector('.inventory-quantity-minus');
            const plusButton = container.querySelector('.inventory-quantity-plus');
            
            if (!quantityDisplay || !minusButton || !plusButton) {
                return;
            }

            const currentQuantity = parseInt(quantityDisplay.textContent, 10);
            const maxAvailable = playerInventory[itemId];

            minusButton.disabled = currentQuantity <= 1;
            plusButton.disabled = currentQuantity >= maxAvailable;
        }

        function handleUseItemClick(event) {
            const itemId = event.target.dataset.itemId;
            const item = storeItems[itemId];
            const parentContainer = event.target.closest('.flex.flex-col');
            if (!parentContainer) return;

            const quantityDisplay = parentContainer.querySelector('.inventory-item-quantity-display');
            const quantityToUse = parseInt(quantityDisplay.textContent, 10);

            if (isNaN(quantityToUse) || quantityToUse < 1) {
                showMessageModal('خطأ', 'الكمية غير صالحة.');
                return;
            }

            if (playerInventory[itemId] >= quantityToUse) {
                playerInventory[itemId] -= quantityToUse;
                updatePlayerInfoDisplay();
                savePlayerInventory();
                if (item && typeof item.useEffect === 'function') {
                    item.useEffect(quantityToUse);
                }
                closeModal(inventoryModal);
                navigateTo('game-view');
            } else {
                showMessageModal('لا يوجد عناصر', `ليس لديك ${quantityToUse} من هذا العنصر. لديك فقط ${playerInventory[itemId]}.`);
            }
        }

        function getSaudiTime() {
            const now = new Date();
            const localTime = now.getTime();
            const localOffset = now.getTimezoneOffset() * 60000;
            const utc = localTime + localOffset;
            const saudiOffset = 3 * 60 * 60 * 1000;
            return new Date(utc + saudiOffset);
        }

        function clearChatHistory() {
            if (!isFirebaseLoaded) return;
            const chatClearRef = ref(db, `artifacts/${appId}/public/chatManagement/lastChatClearDate`);
            onValue(chatClearRef, (snapshot) => {
                const storedLastClearDate = snapshot.val();
                const now = getSaudiTime();
                const todaySaudiDate = now.toDateString();

                if (storedLastClearDate !== todaySaudiDate) {
                    const chatRef = ref(db, `artifacts/${appId}/public/chat`);
                    remove(chatRef)
                        .then(() => {
                            set(chatClearRef, todaySaudiDate);
                            showToast('تم مسح سجل الدردشة!', 'info');
                        })
                        .catch(error => {
                            console.error("Error clearing chat history:", error);
                        });
                }
            }, { once: true });
        }

        if (updatesIcon) {
            updatesIcon.addEventListener('click', () => {
                if (updatesModal) {
                    updatesModal.classList.remove('hidden');
                    setTimeout(() => {
                        if (updatesModal.querySelector('div')) {
                            updatesModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                            updatesModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                        }
                    }, 10);
                }
            });
        }

        if (updatesCloseButton) {
            updatesCloseButton.addEventListener('click', () => {
                closeModal(updatesModal);
            });
        }

        if (playerNameDisplay) {
            playerNameDisplay.addEventListener('click', () => {
                showAuthFlowModal(true);
            });
        }

        if (setNameConfirmButton) {
            setNameConfirmButton.addEventListener('click', async () => {
                const newName = playerNameInput.value.trim();
                if (!newName) {
                    showMessageModal('خطأ', 'الاسم لا يمكن أن يكون فارغاً.');
                    return;
                }

                if (isNameSetPermanently && (Date.now() - lastPlayerNameChangeTimestamp < NAME_CHANGE_COOLDOWN_DURATION)) {
                    const remainingTimeMs = NAME_CHANGE_COOLDOWN_DURATION - (Date.now() - lastPlayerNameChangeTimestamp);
                    const remainingDays = Math.ceil(remainingTimeMs / (1000 * 60 * 60 * 24));
                    showMessageModal('لا يمكن تغيير الاسم', `لا يمكنك تغيير اسمك إلا بعد مرور ${remainingDays} يوم(أيام) أخرى.`);
                    return;
                }

                playerName = newName;
                isNameSetPermanently = true;
                lastPlayerNameChangeTimestamp = Date.now();
                savePlayerData();
                updatePlayerInfoDisplay();
                showToast(`تم تعيين اسمك إلى ${playerName}!`, 'success');
                closeModal(authFlowModal);
            });
        }

        if (setNameContinueGuestButton) {
            setNameContinueGuestButton.addEventListener('click', () => {
                closeModal(authFlowModal);
                showToast('تستمر كضيف. قد تفقد بياناتك إذا مسحت بيانات المتصفح.', 'info');
            });
        }

        if (showEmailAuthButton) {
            showEmailAuthButton.addEventListener('click', () => {
                setNameSection.classList.add('hidden');
                emailAuthSection.classList.remove('hidden');
                authModalTitle.textContent = "تسجيل الدخول / إنشاء حساب";
                authFlowCancelButton.classList.remove('hidden');
            });
        }

        if (backToNameSectionButton) {
            backToNameSectionButton.addEventListener('click', () => {
                emailAuthSection.classList.add('hidden');
                setNameSection.classList.remove('hidden');
                authModalTitle.textContent = "تعيين اسم اللاعب";
                authFlowCancelButton.classList.add('hidden');
            });
        }

        if (authFlowCancelButton) {
            authFlowCancelButton.addEventListener('click', () => {
                closeModal(authFlowModal);
            });
        }

        if (authSignupButton) {
            authSignupButton.addEventListener('click', async () => {
                const email = authEmailInput.value.trim();
                const password = authPasswordInput.value.trim();

                if (!email || !password) {
                    showMessageModal('خطأ', 'البريد الإلكتروني وكلمة المرور مطلوبان.');
                    return;
                }
                if (password.length < 6) {
                    showMessageModal('خطأ', 'يجب أن تكون كلمة المرور 6 أحرف على الأقل.');
                    return;
                }

                try {
                    if (auth.currentUser && auth.currentUser.isAnonymous) {
                        const credential = EmailAuthProvider.credential(email, password);
                        await linkWithCredential(auth.currentUser, credential);
                        isNameSetPermanently = true;
                        lastPlayerNameChangeTimestamp = Date.now();
                        savePlayerData();
                        showToast('تم ربط حسابك المجهول بحساب جديد!', 'success');
                    } else {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        userId = userCredential.user.uid;
                        isNameSetPermanently = true;
                        lastPlayerNameChangeTimestamp = Date.now();
                        savePlayerData();
                        showToast('تم إنشاء حساب جديد وتسجيل الدخول!', 'success');
                    }
                    closeModal(authFlowModal);
                } catch (error) {
                    console.error("Error signing up:", error);
                    let errorMessage = 'فشل إنشاء الحساب.';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'هذا البريد الإلكتروني مستخدم بالفعل.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'صيغة البريد الإلكتروني غير صحيحة.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'كلمة المرور ضعيفة جداً.';
                    }
                    showMessageModal('خطأ', errorMessage, 'error'); // Use error type for toast
                }
            });
        }

        if (authSigninButton) {
            authSigninButton.addEventListener('click', async () => {
                const email = authEmailInput.value.trim();
                const password = authPasswordInput.value.trim();

                if (!email || !password) {
                    showMessageModal('خطأ', 'البريد الإلكتروني وكلمة المرور مطلوبان.');
                    return;
                }

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    closeModal(authFlowModal);
                    showToast('تم تسجيل الدخول بنجاح!', 'success');
                } catch (error) {
                    console.error("Error signing in:", error);
                    let errorMessage = 'فشل تسجيل الدخول.';
                    if (error.code === 'auth/invalid-credential') {
                        errorMessage = 'البريد الإلكتروني أو كلمة المرور غير صحيحة.';
                    } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = 'البريد الإلكتروني أو كلمة المرور غير صحيحة.';
                    }
                    showMessageModal('خطأ', errorMessage, 'error'); // Use error type for toast
                }
            });
        }

        if (deleteAccountButton) {
            deleteAccountButton.addEventListener('click', () => {
                if (deleteConfirmModal) {
                    deleteConfirmModal.classList.remove('hidden');
                    setTimeout(() => {
                        if (deleteConfirmModal.querySelector('div')) {
                            deleteConfirmModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                            deleteConfirmModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                        }
                    }, 10);
                }
            });
        }

        if (deleteConfirmYes) {
            deleteConfirmYes.addEventListener('click', async () => {
                if (!isFirebaseLoaded) {
                    showMessageModal('خطأ', 'البيانات غير جاهزة للحذف.');
                    return;
                }
                try {
                    await remove(ref(db, `artifacts/${appId}/public/playerProfiles/${userId}`));
                    await remove(ref(db, `artifacts/${appId}/public/onlineUsers/${userId}`));
                    await remove(ref(db, `artifacts/${appId}/users/${userId}`));
                    
                    if (auth.currentUser) {
                        await auth.currentUser.delete();
                    }

                    localStorage.clear();
                    closeModal(deleteConfirmModal);
                    if (resetCountdownModal && countdownDisplay) {
                        resetCountdownModal.classList.remove('hidden');
                        setTimeout(() => {
                            if (resetCountdownModal.querySelector('div')) {
                                resetCountdownModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                                resetCountdownModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                            }
                        }, 10);

                        let countdown = 10;
                        countdownDisplay.textContent = countdown;
                        const countdownInterval = setInterval(() => {
                            countdown--;
                            if (countdownDisplay) countdownDisplay.textContent = countdown;
                            if (countdown <= 0) {
                                clearInterval(countdownInterval);
                                location.reload();
                            }
                        }, 1000);
                    }
                } catch (error) {
                    console.error("Error deleting user data from Firebase:", error);
                    showMessageModal('خطأ في الحذف', 'فشل حذف بيانات الحساب. يرجى المحاولة مرة أخرى.');
                }
            });
        }

        if (deleteConfirmNo) {
            deleteConfirmNo.addEventListener('click', () => {
                closeModal(deleteConfirmModal);
            });
        }

        function loadInnovationTypes() {
            if (!isFirebaseLoaded) return;
            const innovationRef = ref(db, `artifacts/${appId}/users/${userId}/innovationTypes`);
            onValue(innovationRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    data.forEach(savedType => {
                        const existingType = innovationTypes.find(type => type.id === savedType.id);
                        if (existingType) {
                            existingType.cooldownEndTime = savedType.cooldownEndTime || 0;
                            if (savedType.id === 'innovation3') {
                                existingType.isOwned = savedType.isOwned || false;
                            }
                        } else {
                            if (savedType.id === 'innovation3') { // Ensure new innovation3 is added if not present
                                innovationTypes.push({ id: 'innovation3', name: 'ابتكار 3', cooldownEndTime: savedType.cooldownEndTime || 0, initialCooldown: 4 * 60, colorClass: 'from-green-600 to-emerald-700', isOwned: savedType.isOwned || false });
                            }
                        }
                    });
                } else {
                    saveInnovationTypes();
                }
                updateInnovationButtonText();
                updateInnovationTimerDisplay();
                let anyActiveCooldown = innovationTypes.some(type => type.cooldownEndTime > Date.now());
                if (anyActiveCooldown && !globalCooldownUpdater) {
                    startGlobalCooldownUpdater();
                }
            }, { once: true });
        }

        function saveInnovationTypes() {
            if (!isFirebaseLoaded) return;
            set(ref(db, `artifacts/${appId}/users/${userId}/innovationTypes`), innovationTypes.map(type => {
                const savedData = {
                    id: type.id,
                    cooldownEndTime: type.cooldownEndTime
                };
                if (type.id === 'innovation3') {
                    savedData.isOwned = type.isOwned;
                }
                return savedData;
            }));
        }

        function startGlobalCooldownUpdater() {
            if (globalCooldownUpdater) clearInterval(globalCooldownUpdater);

            globalCooldownUpdater = setInterval(() => {
                let anyInnovationOnCooldown = false;
                innovationTypes.forEach(type => {
                    const cooldownRemaining = Math.max(0, Math.floor((type.cooldownEndTime - Date.now()) / 1000));
                    if (cooldownRemaining > 0) {
                        anyInnovationOnCooldown = true;
                    } else {
                        type.cooldownEndTime = 0;
                    }
                });
                updateInnovationTimerDisplay(); 

                if (!anyInnovationOnCooldown) {
                    clearInterval(globalCooldownUpdater);
                    globalCooldownUpdater = null;
                }
                saveInnovationTypes();
            }, 1000);
        }

        async function loadPlayerData() {
            if (!isFirebaseLoaded) return;
            const playerRef = ref(db, `artifacts/${appId}/users/${userId}/playerData`);
            const snapshot = await get(playerRef);
            if (snapshot.exists()) {
                const data = snapshot.val();
                playerPoints = data.playerPoints || 0;
                playerDollars = data.playerDollars || 0;
                accumulatedDollars = data.accumulatedDollars || 0;
                accumulatedPoints = data.accumulatedPoints || 0;
                accumulatedPower = data.accumulatedPower || 0;
                playerName = data.playerName || "تعيين اسم";
                isNameSetPermanently = data.isNameSetPermanently || false;
                lastPlayerNameChangeTimestamp = data.lastPlayerNameChangeTimestamp || 0;
                globalAttackCooldownEndTime = data.globalAttackCooldownEndTime || 0;
                attacksMadeInCurrentCooldown = data.attacksMadeInCurrentCooldown || 0;
                attackedTargetsInCooldown = data.attackedTargetsInCooldown || [];
            } else {
                savePlayerData(); // Initialize and save default data if not found
            }
        }

        function savePlayerData() {
            if (!isFirebaseLoaded) return;
            set(ref(db, `artifacts/${appId}/users/${userId}/playerData`), {
                playerPoints: playerPoints,
                playerDollars: playerDollars,
                accumulatedDollars: accumulatedDollars,
                accumulatedPoints: accumulatedPoints,
                accumulatedPower: accumulatedPower,
                playerName: playerName,
                isNameSetPermanently: isNameSetPermanently,
                lastPlayerNameChangeTimestamp: lastPlayerNameChangeTimestamp,
                globalAttackCooldownEndTime: globalAttackCooldownEndTime,
                attacksMadeInCurrentCooldown: attacksMadeInCurrentCooldown,
                attackedTargetsInCooldown: attackedTargetsInCooldown
            });
        }

        async function loadHouses() {
            if (!isFirebaseLoaded) return;
            const housesRef = ref(db, `artifacts/${appId}/users/${userId}/houses`);
            const snapshot = await get(housesRef);
            if (snapshot.exists()) {
                houses = snapshot.val();
                const firstUnlockedIndex = houses.findIndex(h => h.unlocked);
                if (firstUnlockedIndex !== -1) {
                    activeHouseIndex = firstUnlockedIndex;
                } else {
                    activeHouseIndex = 0;
                }
            } else {
                saveHouses(); // Initialize and save default houses if not found
            }
        }

        function saveHouses() {
            if (!isFirebaseLoaded) return;
            set(ref(db, `artifacts/${appId}/users/${userId}/houses`), houses);
        }

        async function loadPlayerInventory() {
            if (!isFirebaseLoaded) return;
            const inventoryRef = ref(db, `artifacts/${appId}/users/${userId}/playerInventory`);
            const snapshot = await get(inventoryRef);
            if (snapshot.exists()) {
                playerInventory = snapshot.val();
            } else {
                playerInventory = { reduceTime: 0 };
                savePlayerInventory(); // Initialize and save default inventory if not found
            }
        }

        function savePlayerInventory() {
            if (!isFirebaseLoaded) return;
            set(ref(db, `artifacts/${appId}/users/${userId}/playerInventory`), playerInventory);
        }

        async function loadAttackCooldowns() {
            if (!isFirebaseLoaded) return;
            const cooldownsRef = ref(db, `artifacts/${appId}/users/${userId}/attackCooldowns`);
            onValue(cooldownsRef, (snapshot) => {
                attackCooldowns = snapshot.val() || {};
                renderChallengePlayers();
            }, { once: true });
        }

        function saveAttackCooldowns() {
            if (!isFirebaseLoaded) return;
            set(ref(db, `artifacts/${appId}/users/${userId}/attackCooldowns`), attackCooldowns);
        }

        async function migrateLocalStorageToFirebase() {
            const localStorageKeys = [
                'playerPoints', 'playerDollars',
                'playerInventory', 'playerName', 'isNameSetPermanently', 'lastPlayerNameChangeTimestamp',
                'houses', 'innovationTypes',
                'globalAttackCooldownEndTime', 'attacksMadeInCurrentCooldown', 'attackedTargetsInCooldown',
                'accumulatedDollars', 'accumulatedPoints', 'accumulatedPower'
            ];

            let hasLocalStorageData = false;
            for (const key of localStorageKeys) {
                if (localStorage.getItem(key) !== null) {
                    hasLocalStorageData = true;
                    break;
                }
            }

            if (hasLocalStorageData) {
                showMessageModal('نقل البيانات', 'جاري نقل بياناتك القديمة إلى السحابة. قد يستغرق هذا بضع لحظات.');
                try {
                    const migratedPoints = parseInt(localStorage.getItem('playerPoints') || '0');
                    const migratedDollars = parseInt(localStorage.getItem('playerDollars') || '0');
                    const migratedAccumulatedDollars = parseInt(localStorage.getItem('accumulatedDollars') || '0');
                    const migratedAccumulatedPoints = parseInt(localStorage.getItem('accumulatedPoints') || '0');
                    const migratedAccumulatedPower = parseInt(localStorage.getItem('accumulatedPower') || '0');
                    const migratedPlayerName = localStorage.getItem('playerName') || "تعيين اسم";
                    const migratedIsNameSetPermanently = localStorage.getItem('isNameSetPermanently') === 'true';
                    const migratedLastPlayerNameChangeTimestamp = parseInt(localStorage.getItem('lastPlayerNameChangeTimestamp') || '0');
                    const migratedGlobalAttackCooldownEndTime = parseInt(localStorage.getItem('globalAttackCooldownEndTime') || '0');
                    const migratedAttacksMadeInCurrentCooldown = parseInt(localStorage.getItem('attacksMadeInCurrentCooldown') || '0');
                    const migratedAttackedTargetsInCooldown = JSON.parse(localStorage.getItem('attackedTargetsInCooldown') || '[]');

                    const migratedHouses = JSON.parse(localStorage.getItem('houses'));
                    const migratedInnovationTypes = JSON.parse(localStorage.getItem('innovationTypes'));
                    const migratedPlayerInventory = JSON.parse(localStorage.getItem('playerInventory'));

                    playerPoints = migratedPoints;
                    playerDollars = migratedDollars;
                    accumulatedDollars = migratedAccumulatedDollars;
                    accumulatedPoints = migratedAccumulatedPoints;
                    accumulatedPower = migratedAccumulatedPower;
                    playerName = migratedPlayerName;
                    isNameSetPermanently = migratedIsNameSetPermanently;
                    lastPlayerNameChangeTimestamp = migratedLastPlayerNameChangeTimestamp;
                    globalAttackCooldownEndTime = migratedGlobalAttackCooldownEndTime;
                    attacksMadeInCurrentCooldown = migratedAttacksMadeInCurrentCooldown;
                    attackedTargetsInCooldown = migratedAttackedTargetsInCooldown;

                    if (migratedHouses) houses = migratedHouses;
                    if (migratedInnovationTypes) {
                        migratedInnovationTypes.forEach(savedType => {
                            const existingType = innovationTypes.find(type => type.id === savedType.id);
                            if (existingType) {
                                existingType.cooldownEndTime = savedType.cooldownEndTime || 0;
                                if (savedType.id === 'innovation3') {
                                    existingType.isOwned = savedType.isOwned || false;
                                }
                            } else {
                                if (savedType.id === 'innovation3') {
                                    innovationTypes.push({ id: 'innovation3', name: 'ابتكار 3', cooldownEndTime: savedType.cooldownEndTime || 0, initialCooldown: 4 * 60, colorClass: 'from-green-600 to-emerald-700', isOwned: savedType.isOwned || false });
                                }
                            }
                        });
                    }
                    playerInventory = migratedPlayerInventory || { reduceTime: 0 };

                    await savePlayerData();
                    await saveHouses();
                    await saveInnovationTypes();
                    await savePlayerInventory();
                    await saveAttackCooldowns();

                    localStorage.clear();
                    showMessageModal('نقل البيانات', 'تم نقل بياناتك بنجاح إلى السحابة!');
                } catch (error) {
                    console.error("Error migrating data:", error);
                    showMessageModal('خطأ في النقل', 'فشل نقل البيانات. يرجى تحديث الصفحة والمحاولة مرة أخرى.');
                }
            }
        }

        if (chatSendButton) {
            chatSendButton.addEventListener('click', () => {
                showPasswordInputModal((enteredPassword) => {
                    if (enteredPassword === CHAT_PASSWORD) {
                        sendMessage();
                    } else if (enteredPassword !== null) {
                        showMessageModal('خطأ', 'كلمة المرور غير صحيحة.');
                    }
                });
            });
        }
        if (chatInput) {
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    showPasswordInputModal((enteredPassword) => {
                        if (enteredPassword === CHAT_PASSWORD) {
                            sendMessage();
                        } else if (enteredPassword !== null) {
                            showMessageModal('خطأ', 'كلمة المرور غير صحيحة.');
                        }
                    });
                }
            });
        }

        function sendMessage() {
            if (!isFirebaseLoaded || !userId || !playerName || playerName === "تعيين اسم") {
                showMessageModal('خطأ', 'يجب تسجيل الدخول وتعيين اسم اللاعب قبل الدردشة.');
                return;
            }
            const messageText = chatInput.value.trim();
            if (messageText === '') return;

            const chatRef = ref(db, `artifacts/${appId}/public/chat`);
            push(chatRef, {
                senderId: userId,
                senderName: playerName,
                senderPower: totalPlayerPower,
                message: messageText,
                timestamp: serverTimestamp()
            }).then(() => {
                chatInput.value = '';
            }).catch(error => {
                console.error("Error sending message:", error);
                showMessageModal('خطأ', 'فشل إرسال الرسالة.');
            });
        }

        function listenForChatMessages() {
            if (!isFirebaseLoaded) return;
            const chatRef = ref(db, `artifacts/${appId}/public/chat`);
            onValue(chatRef, (snapshot) => {
                if (!chatMessagesDiv) return;
                chatMessagesDiv.innerHTML = '';
                const messages = [];
                snapshot.forEach(childSnapshot => {
                    const message = childSnapshot.val();
                    messages.push(message);
                });

                messages.sort((a, b) => a.timestamp - b.timestamp);

                messages.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `chat-message ${message.senderId === userId ? 'self' : ''}`;
                    const date = message.timestamp ? new Date(message.timestamp) : new Date();
                    messageElement.innerHTML = `
                        <span class="chat-sender">${message.senderName}:</span>
                        <p class="text-gray-100">${message.message}</p>
                        <p class="text-xs text-gray-400 mt-1">القوة: ${formatPower(message.senderPower || 0)}</p>
                        <span class="chat-timestamp">${date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</span>
                    `;
                    chatMessagesDiv.prepend(messageElement);
                });
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
            });
        }

        function updateOnlineStatus() {
            if (!isFirebaseLoaded || !userId || playerName === "تعيين اسم") return;

            const onlineRef = ref(db, `artifacts/${appId}/public/onlineUsers/${userId}`);
            set(onlineRef, {
                name: playerName,
                totalPower: totalPlayerPower,
                lastOnline: serverTimestamp()
            }).catch(error => {
                console.error("Error updating online status:", error);
            });
        }

        async function listenForOnlineUsers() {
            if (!isFirebaseLoaded) return;
            
            if (onlinePlayersListDiv) onlinePlayersListDiv.innerHTML = '';
            if (recentlyOfflinePlayersListDiv) recentlyOfflinePlayersListDiv.innerHTML = '';

            const playerProfilesRef = ref(db, `artifacts/${appId}/public/playerProfiles`);
            const onlineUsersRef = ref(db, `artifacts/${appId}/public/onlineUsers`);

            const profilesSnapshot = await get(playerProfilesRef);
            const allPlayers = {};
            profilesSnapshot.forEach(childSnapshot => {
                allPlayers[childSnapshot.key] = { ...childSnapshot.val(), isOnline: false, lastOnline: 0 };
            });

            onValue(onlineUsersRef, async (onlineSnapshot) => {
                const now = Date.now();

                const activeOnlinePlayers = [];
                const allOfflinePlayers = [];

                onlineSnapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    const userUid = childSnapshot.key;
                    if (allPlayers[userUid]) {
                        allPlayers[userUid].lastOnline = user.lastOnline || 0;
                        if (user.lastOnline && (now - user.lastOnline < ONLINE_ACTIVE_DURATION)) {
                            allPlayers[userUid].isOnline = true;
                        }
                    }
                });

                for (const uid in allPlayers) {
                    if (uid === userId) continue;

                    const player = allPlayers[uid];
                    // Filter for online players
                    if (player.isOnline) {
                        activeOnlinePlayers.push(player);
                    } 
                    // Filter for recently offline players (within 10 hours)
                    else if (player.lastOnline && (now - player.lastOnline < OFFLINE_RECENT_DURATION)) {
                        allOfflinePlayers.push(player);
                    }
                }

                activeOnlinePlayers.sort((a, b) => {
                    if (b.totalPower !== a.totalPower) return b.totalPower - a.totalPower;
                    return a.name.localeCompare(b.name);
                });

                allOfflinePlayers.sort((a, b) => b.lastOnline - a.lastOnline);
                
                if (onlinePlayersListDiv) {
                    onlinePlayersListDiv.innerHTML = '';
                    if (activeOnlinePlayers.length === 0) {
                        onlinePlayersListDiv.innerHTML = '<p class="text-gray-400 text-center">لا يوجد لاعبون متصلون حالياً.</p>';
                    } else {
                        activeOnlinePlayers.forEach(user => {
                            const userElement = document.createElement('div');
                            userElement.className = `online-user-item text-white`;
                            userElement.innerHTML = `
                                <div class="user-info">
                                    <p class="font-bold text-lg">${user.name}</p>
                                    <p class="text-sm text-gray-300">القوة الإجمالية: ${formatPower(user.totalPower)}</p>
                                </div>
                                <div class="status-dot"></div>
                            `;
                            onlinePlayersListDiv.appendChild(userElement);
                        });
                    }
                }

                if (recentlyOfflinePlayersListDiv) {
                    recentlyOfflinePlayersListDiv.innerHTML = '';
                    if (allOfflinePlayers.length === 0) {
                        recentlyOfflinePlayersListDiv.innerHTML = '<p class="text-gray-400 text-center">لا يوجد لاعبون غير متصلين.</p>';
                    } else {
                        allOfflinePlayers.forEach(user => {
                            const userElement = document.createElement('div');
                            userElement.className = `online-user-item text-white offline`;
                            const lastOnlineText = user.lastOnline ? timeAgo(user.lastOnline) : 'غير معروف'; // Use timeAgo function

                            userElement.innerHTML = `
                                <div class="user-info">
                                    <p class="font-bold text-lg">${user.name}</p>
                                    <p class="text-sm text-gray-300">القوة الإجمالية: ${formatPower(user.totalPower)}</p>
                                    <p class="text-xs text-gray-400 mt-1">آخر ظهور: ${lastOnlineText}</p>
                                </div>
                                <div class="status-dot"></div>
                            `;
                            recentlyOfflinePlayersListDiv.appendChild(userElement);
                        });
                    }
                }
            });
        }


        async function renderChallengePlayers() {
            if (!isFirebaseLoaded || !challengePlayersList) return;

            const playerProfilesRef = ref(db, `artifacts/${appId}/public/playerProfiles`);
            const onlineUsersRef = ref(db, `artifacts/${appId}/public/onlineUsers`);

            const [profilesSnapshot, onlineSnapshot] = await Promise.all([
                get(playerProfilesRef),
                get(onlineUsersRef)
            ]);

            const allPlayers = {};
            profilesSnapshot.forEach(childSnapshot => {
                allPlayers[childSnapshot.key] = { ...childSnapshot.val(), lastOnline: 0 };
            });

            onlineSnapshot.forEach(childSnapshot => {
                const user = childSnapshot.val();
                const userUid = childSnapshot.key;
                if (allPlayers[userUid]) {
                    allPlayers[userUid].lastOnline = user.lastOnline || 0;
                }
            });

            challengePlayersList.innerHTML = '';
            const playersToChallenge = [];
            const now = Date.now();

            for (const uid in allPlayers) {
                if (uid === userId) continue; // Don't show self

                const player = allPlayers[uid];
                // Only show players online in the last 10 hours
                if (player.lastOnline && (now - player.lastOnline < OFFLINE_RECENT_DURATION)) {
                    playersToChallenge.push(player);
                }
            }

            if (playersToChallenge.length === 0) {
                challengePlayersList.innerHTML = '<p class="text-gray-300 text-center">لا يوجد لاعبون آخرون متاحون للتحدي حالياً.</p>';
            } else {
                playersToChallenge.forEach(player => {
                    const attackCooldownRemaining = getAttackCooldownRemaining(player.uid);
                    const isAttackReady = attackCooldownRemaining <= 0;
                    const hasAttackedThisCooldown = attackedTargetsInCooldown.includes(player.uid);

                    const canDefeat = totalPlayerPower >= (player.totalPower + 3000);
                    const borderColorClass = canDefeat ? 'can-defeat' : 'cannot-defeat';

                    const playerElement = document.createElement('div');
                    playerElement.className = `challenge-player-item text-white ${borderColorClass}`;
                    playerElement.innerHTML = `
                        <div class="player-info text-right">
                            <p class="font-bold text-lg">${player.name}</p>
                            <p class="text-sm text-gray-300">القوة الإجمالية: ${formatPower(player.totalPower)}</p>
                        </div>
                        <button data-target-id="${player.uid}" data-target-name="${player.name}" data-target-power="${player.totalPower}"
                            class="attack-button ${isAttackReady && attacksMadeInCurrentCooldown < MAX_GLOBAL_ATTACKS && !hasAttackedThisCooldown ? '' : 'opacity-50 cursor-not-allowed'}" ${isAttackReady && attacksMadeInCurrentCooldown < MAX_GLOBAL_ATTACKS && !hasAttackedThisCooldown ? '' : 'disabled'}>
                            ${isAttackReady ? (attacksMadeInCurrentCooldown < MAX_GLOBAL_ATTACKS ? (hasAttackedThisCooldown ? 'تم الهجوم' : 'هجوم') : 'تهدئة عالمية') : formatTime(attackCooldownRemaining)}
                        </button>
                    `;
                    challengePlayersList.appendChild(playerElement);
                });

                document.querySelectorAll('.attack-button').forEach(button => {
                    button.removeEventListener('click', handleAttackClick);
                    button.addEventListener('click', handleAttackClick);
                });
            }
        }

        function getAttackCooldownRemaining(targetId) {
            const lastAttackTime = attackCooldowns[targetId];
            if (!lastAttackTime) return 0;
            const cooldownDuration = 5 * 60; // 5 minutes for individual cooldown
            const elapsed = (Date.now() - lastAttackTime) / 1000;
            return Math.max(0, Math.floor(cooldownDuration - elapsed));
        }

        function updateGlobalAttackCooldownDisplay() {
            if (!globalAttackCooldownDisplay || !attacksRemainingDisplay || !globalCooldownTimerDisplay) return;

            const remainingTime = Math.max(0, Math.floor((globalAttackCooldownEndTime - Date.now()) / 1000));

            if (remainingTime > 0) {
                globalAttackCooldownDisplay.classList.remove('hidden');
                attacksRemainingDisplay.textContent = MAX_GLOBAL_ATTACKS - attacksMadeInCurrentCooldown;
                globalCooldownTimerDisplay.textContent = formatTime(remainingTime);
            } else {
                globalAttackCooldownDisplay.classList.add('hidden');
                attacksMadeInCurrentCooldown = 0;
                attackedTargetsInCooldown = [];
                savePlayerData();
            }
            renderChallengePlayers();
        }

        function startGlobalAttackCooldownUpdater() {
            clearInterval(globalAttackCooldownInterval);
            globalAttackCooldownInterval = setInterval(updateGlobalAttackCooldownDisplay, 1000);
            updateGlobalAttackCooldownDisplay();
        }

        async function handleAttackClick(event) {
            const targetId = event.target.dataset.targetId;
            const targetName = event.target.dataset.targetName;
            const targetPower = parseInt(event.target.dataset.targetPower, 10);

            if (!targetId || !targetName || isNaN(targetPower)) {
                showMessageModal('خطأ', 'بيانات اللاعب المستهدف غير صالحة.');
                return;
            }

            if (getAttackCooldownRemaining(targetId) > 0) {
                showMessageModal('مؤقت التهدئة', `لا يمكنك الهجوم على ${targetName} الآن. يرجى الانتظار: ${formatTime(getAttackCooldownRemaining(targetId))}`);
                return;
            }

            if (attacksMadeInCurrentCooldown >= MAX_GLOBAL_ATTACKS) {
                showMessageModal('تهدئة الهجوم العالمي', `لقد وصلت إلى الحد الأقصى للهجمات (${MAX_GLOBAL_ATTACKS}) في فترة التهدئة الحالية. يرجى الانتظار: ${formatTime(Math.max(0, Math.floor((globalAttackCooldownEndTime - Date.now()) / 1000)))}`);
                return;
            }

            if (attackedTargetsInCooldown.includes(targetId)) {
                showMessageModal('تم الهجوم بالفعل', `لقد هاجمت هذا اللاعب بالفعل خلال فترة التهدئة الحالية.`);
                return;
            }

            let didWin = false;
            if (totalPlayerPower >= (targetPower + 3000)) {
                didWin = true;
            }

            const pointsReward = 50;
            const dollarsReward = 30;
            const powerReward = 70;

            let attackerPointsChange = 0;
            let attackerDollarsChange = 0;
            let attackerPowerChange = 0;
            let defenderPointsChange = 0;
            let defenderDollarsChange = 0;
            let defenderPowerChange = 0;

            if (didWin) {
                attackerPointsChange = pointsReward;
                attackerDollarsChange = dollarsReward;
                attackerPowerChange = powerReward;
                showMessageModal('فوز!', `لقد هاجمت ${targetName} بنجاح وحصلت على ${pointsReward} نقطة و ${dollarsReward}$ و ${powerReward} قوة!`);
            } else {
                attackerPointsChange = -pointsReward;
                attackerDollarsChange = 0;
                attackerPowerChange = 0;
                showMessageModal('خسارة!', `فشلت في الهجوم على ${targetName} وخسرت ${pointsReward} نقطة.`);
            }

            playerPoints += attackerPointsChange;
            playerDollars += attackerDollarsChange;
            houses[activeHouseIndex].power += attackerPowerChange;
            playerPoints = Math.max(0, playerPoints);
            playerDollars = Math.max(0, playerDollars);
            houses[activeHouseIndex].power = Math.max(1, houses[activeHouseIndex].power);

            const playerElement = event.target.closest('.challenge-player-item');
            if (playerElement) {
                let overlay = playerElement.querySelector('.attack-outcome-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.className = 'attack-outcome-overlay';
                    playerElement.style.position = 'relative';
                    playerElement.appendChild(overlay);
                }

                overlay.textContent = didWin ? 'فوز!' : 'خسارة!';
                overlay.classList.remove('win', 'loss');
                overlay.classList.add(didWin ? 'win' : 'loss');
                overlay.classList.add('show');

                setTimeout(() => {
                    overlay.classList.remove('show');
                    setTimeout(() => {
                        if (overlay.parentNode) {
                            overlay.parentNode.removeChild(overlay);
                        }
                    }, 300);
                }, 1500);
            }

            push(ref(db, `artifacts/${appId}/users/${userId}/attackLog/outgoing`), {
                targetId: targetId,
                targetName: targetName,
                timestamp: serverTimestamp(),
                outcome: didWin ? 'win' : 'loss',
                pointsChange: attackerPointsChange,
                dollarsChange: attackerDollarsChange,
                powerChange: attackerPowerChange
            }).catch(error => console.error("Error saving outgoing attack log:", error));

            const targetPlayerRef = ref(db, `artifacts/${appId}/users/${targetId}/playerData`);
            const targetHousesRef = ref(db, `artifacts/${appId}/users/${targetId}/houses`);
            const targetAttackLogRef = ref(db, `artifacts/${appId}/users/${targetId}/attackLog/incoming`);

            await get(targetPlayerRef).then(async snapshot => {
                if (snapshot.exists()) {
                    const targetData = snapshot.val();
                    if (didWin) {
                        defenderPointsChange = -pointsReward;
                        defenderDollarsChange = -dollarsReward;
                        defenderPowerChange = -powerReward;
                    } else {
                        defenderPointsChange = 0;
                        defenderDollarsChange = 0;
                        defenderPowerChange = 0;
                    }

                    const newTargetPoints = Math.max(0, (targetData.playerPoints || 0) + defenderPointsChange);
                    const newTargetDollars = Math.max(0, (targetData.playerDollars || 0) + defenderDollarsChange);
                    
                    set(targetPlayerRef, {
                        ...targetData,
                        playerPoints: newTargetPoints,
                        playerDollars: newTargetDollars
                    });

                    await get(targetHousesRef).then(houseSnapshot => {
                        if (houseSnapshot.exists()) {
                            const targetHouses = houseSnapshot.val();
                            const targetActiveHouseIndex = targetHouses.findIndex(h => h.unlocked);
                            if (targetActiveHouseIndex !== -1) {
                                targetHouses[targetActiveHouseIndex].power = Math.max(1, (targetHouses[targetActiveHouseIndex].power || 0) + defenderPowerChange);
                                set(targetHousesRef, targetHouses);
                            }
                        }
                    }).catch(error => console.error("Error updating target house data:", error));


                    push(targetAttackLogRef, {
                        attackerId: userId,
                        attackerName: playerName,
                        timestamp: serverTimestamp(),
                        outcome: didWin ? 'loss' : 'win',
                        pointsChange: defenderPointsChange,
                        dollarsChange: defenderDollarsChange,
                        powerChange: defenderPowerChange
                    }).catch(error => console.error("Error saving incoming attack log:", error));

                }
            }).catch(error => {
                console.error("Error updating target player data:", error);
            });

            push(ref(db, `artifacts/${appId}/public/globalAttackLog`), {
                attackerId: userId,
                attackerName: playerName,
                targetId: targetId,
                targetName: targetName,
                outcome: didWin ? 'win' : 'loss',
                timestamp: serverTimestamp()
            }).catch(error => console.error("Error saving global attack log:", error));

            attackCooldowns[targetId] = Date.now();
            attackedTargetsInCooldown.push(targetId);
            saveAttackCooldowns();

            attacksMadeInCurrentCooldown++;
            if (attacksMadeInCurrentCooldown >= MAX_GLOBAL_ATTACKS && globalAttackCooldownEndTime === 0) {
                globalAttackCooldownEndTime = Date.now() + (GLOBAL_ATTACK_COOLDOWN_DURATION * 1000);
            }
            savePlayerData();
            renderHouses();
            updatePlayerInfoDisplay();
            renderChallengePlayers();
        }

        function listenForGlobalAttackLog() {
            if (!isFirebaseLoaded || !globalAttacksList) return;
            const globalAttackLogRef = query(ref(db, `artifacts/${appId}/public/globalAttackLog`), orderByChild('timestamp'), limitToLast(5));
            onValue(globalAttackLogRef, (snapshot) => {
                globalAttacksList.innerHTML = '';
                const globalAttacks = [];
                snapshot.forEach(childSnapshot => {
                    globalAttacks.push(childSnapshot.val());
                });
                globalAttacks.sort((a, b) => b.timestamp - a.timestamp);

                if (globalAttacks.length === 0) {
                    globalAttacksList.innerHTML = '<p class="text-gray-400 text-center">لا توجد هجمات عالمية حالياً.</p>';
                } else {
                    globalAttacks.forEach(attack => {
                        const attackElement = document.createElement('div');
                        attackElement.className = `global-attack-log-entry ${attack.outcome === 'win' ? 'win' : 'loss'}`;
                        const date = attack.timestamp ? new Date(attack.timestamp) : new Date();
                        const outcomeText = attack.outcome === 'win' ? 'فاز على' : 'خسر أمام';
                        attackElement.innerHTML = `
                            <span>${attack.attackerName} ${outcomeText} ${attack.targetName}</span>
                            <span class="timestamp">${date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</span>
                        `;
                        globalAttacksList.appendChild(attackElement);
                    });
                }
            });
        }

        function startDollarCollection() {
            if (dollarCollectionInterval) clearInterval(dollarCollectionInterval);
            dollarCollectionInterval = setInterval(() => {
                // Increment each accumulated resource, capping at MAX_ACCUMULATION
                accumulatedDollars = Math.min(MAX_ACCUMULATION, accumulatedDollars + ACCUMULATION_RATE);
                accumulatedPoints = Math.min(MAX_ACCUMULATION, accumulatedPoints + ACCUMULATION_RATE);
                accumulatedPower = Math.min(MAX_ACCUMULATION, accumulatedPower + ACCUMULATION_RATE);
                
                updateAccumulatedDollarsDisplay(); // Update display for all three
                updateDollarCollectorVisuals(); // Update the progress bar
                savePlayerData();
            }, 5 * 1000); // Every 5 seconds
        }

        function updateAccumulatedDollarsDisplay() {
            if (accumulatedDollarsDisplay) {
                accumulatedDollarsDisplay.textContent = `$${formatPower(accumulatedDollars)}`;
            }
            if (accumulatedPointsDisplay) {
                accumulatedPointsDisplay.textContent = formatPower(accumulatedPoints);
            }
            if (accumulatedPowerDisplay) {
                accumulatedPowerDisplay.textContent = formatPower(accumulatedPower);
            }
        }

        function updateDollarCollectorVisuals() {
            if (dollarCollectorProgressBar) {
                // Calculate progress based on the highest accumulated value relative to MAX_ACCUMULATION
                const maxCurrentAccumulation = Math.max(accumulatedDollars, accumulatedPoints, accumulatedPower);
                const percentage = (maxCurrentAccumulation / MAX_ACCUMULATION) * 100;
                dollarCollectorProgressBar.style.width = `${percentage}%`;
            }
        }

        function collectDollars() {
            if (accumulatedDollars > 0 || accumulatedPoints > 0 || accumulatedPower > 0) {
                playerDollars += accumulatedDollars;
                playerPoints += accumulatedPoints;
                houses[activeHouseIndex].power += accumulatedPower;
                
                showToast(`لقد جمعت $${formatDollars(accumulatedDollars)} و ${formatPower(accumulatedPoints)} نقطة و ${formatPower(accumulatedPower)} قوة!`, 'success');
                
                accumulatedDollars = 0;
                accumulatedPoints = 0;
                accumulatedPower = 0;

                updatePlayerInfoDisplay();
                updateAccumulatedDollarsDisplay();
                updateDollarCollectorVisuals(); // Reset progress bar
                renderHouses();
                savePlayerData();
                saveHouses();
            } else {
                showToast('لا توجد مكافآت لجمعها بعد.', 'info');
            }
        }

        function formatDollars(num) {
            return formatPower(num);
        }

        if (collectDollarsButton) {
            collectDollarsButton.addEventListener('click', collectDollars);
        }

        function showAuthFlowModal(isLinkingExistingAccount = false) {
            if (!authFlowModal || !authModalTitle || !setNameSection || !emailAuthSection || !playerNameInput) return;

            setNameSection.classList.remove('hidden');
            emailAuthSection.classList.add('hidden');

            if (isLinkingExistingAccount) {
                authModalTitle.textContent = "ربط الحساب";
                playerNameInput.value = playerName === "تعيين اسم" ? "" : playerName;
                setNameConfirmButton.textContent = "تأكيد الاسم";
                setNameContinueGuestButton.classList.add('hidden');
                authFlowCancelButton.classList.remove('hidden');
                showEmailAuthButton.textContent = "ربط بحساب بريد إلكتروني";
            } else {
                authModalTitle.textContent = "تعيين اسم اللاعب";
                playerNameInput.value = playerName === "تعيين اسم" ? "" : playerName;
                setNameConfirmButton.textContent = "تأكيد الاسم";
                setNameContinueGuestButton.classList.remove('hidden');
                authFlowCancelButton.classList.add('hidden');
                showEmailAuthButton.textContent = "تسجيل دخول / إنشاء حساب";
            }

            authFlowModal.classList.remove('hidden');
            setTimeout(() => {
                if (authFlowModal.querySelector('div')) {
                    authFlowModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                    authFlowModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                }
            }, 10);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            let authAttemptPromise;
            if (initialAuthToken) {
                authAttemptPromise = signInWithCustomToken(auth, initialAuthToken)
                    .catch(async (error) => {
                        console.warn("Custom token sign-in failed, attempting anonymous:", error);
                        return signInAnonymously(auth).catch((anonError) => {
                            console.error("Anonymous sign-in failed:", anonError);
                            showMessageModal('خطأ في المصادقة', 'فشل تسجيل الدخول المجهول. يرجى تحديث الصفحة.');
                            return null;
                        });
                    });
            } else {
                authAttemptPromise = signInAnonymously(auth).catch((error) => {
                    console.error("Anonymous sign-in failed:", error);
                    showMessageModal('خطأ في المصادقة', 'فشل تسجيل الدخول المجهول. يرجى تحديث الصفحة.');
                    return null;
                });
            }

            await authAttemptPromise;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isFirebaseLoaded = true;

                    try {
                        await loadPlayerData();
                        await loadHouses();
                        await loadInnovationTypes();
                        await loadPlayerInventory();
                        await loadAttackCooldowns();

                        await migrateLocalStorageToFirebase();

                        updatePlayerInfoDisplay();
                        updateAccumulatedDollarsDisplay();
                        updateDollarCollectorVisuals(); // Initial update for visuals
                        renderHouses();
                        updateInnovationButtonText();
                        updateInnovationTimerDisplay();
                        renderInventoryItems();

                        listenForChatMessages();
                        clearChatHistory();
                        startDollarCollection();

                        if (onlineStatusUpdater) clearInterval(onlineStatusUpdater);
                        onlineStatusUpdater = setInterval(updateOnlineStatus, 30 * 1000);
                        updateOnlineStatus();

                        const onlineRef = ref(db, `artifacts/${appId}/public/onlineUsers/${userId}`);
                        onDisconnect(onlineRef).remove().catch(error => {
                            console.error("Could not establish onDisconnect for online status:", error);
                        });

                        let anyActiveCooldown = innovationTypes.some(type => type.cooldownEndTime > Date.now());
                        if (anyActiveCooldown && !globalCooldownUpdater) {
                            startGlobalCooldownUpdater();
                        }

                        if (!isNameSetPermanently && (!playerName || playerName === "تعيين اسم")) {
                            showAuthFlowModal(false);
                        }

                    } catch (e) {
                        console.error("Error during data loading/setup:", e);
                        showMessageModal('خطأ في التحميل', 'حدث خطأ أثناء تحميل بياناتك. يرجى تحديث الصفحة.');
                    }
                } else {
                    console.log("Firebase Auth State Changed: No user signed in.");
                }
            });
        });
    </script>
</body>
</html>
