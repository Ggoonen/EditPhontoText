<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الأسطول</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Arabic', sans-serif;
            background-color: #0d1117;
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        body::-webkit-scrollbar {
            display: none;
        }
        body {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .btn {
            @apply px-6 py-3 rounded-full font-bold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-600 text-gray-100 hover:bg-gray-700;
        }
        .btn-success {
            @apply bg-green-600 text-white hover:bg-green-700;
        }
        .btn-warning {
            @apply bg-yellow-600 text-white hover:bg-yellow-700;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700;
        }
        .resource-btn-wrapper {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            background-color: #21262d;
            border-radius: 50px;
            padding: 5px 10px 5px 5px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            z-index: 1000;
            border: 2px solid #30363d;
            margin-top: 20px;
        }
        .resource-btn-wrapper:hover {
            background-color: #2b323b;
            transform: translateX(-50%) scale(1.05);
        }
        .resource-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .resource-btn::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 1;
        }
        .resource-btn .progress-circle {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        .resource-btn .circle-bg {
            fill: none;
            stroke: #3b4554;
            stroke-width: 8;
        }
        .resource-btn .circle-progress {
            fill: none;
            stroke: #f39c12;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s ease-out;
        }
        .resource-btn .resource-content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }
        .resource-btn .resource-content i {
            font-size: 1.5rem;
            margin-bottom: 0px;
        }
        .resource-btn .resource-content span {
            font-size: 0.8rem;
        }
        .resource-btn-text {
            font-size: 0.9rem;
            font-weight: bold;
            color: #e2e8f0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #161b22;
            color: #e2e8f0;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.7);
            width: 90%;
            max-width: 450px;
            text-align: center;
            border: 1px solid #30363d;
        }
        .close-button {
            color: #a0aec0;
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }
        .close-button:hover,
        .close-button:focus {
            color: #cbd5e0;
            text-decoration: none;
            cursor: pointer;
        }
        .section-container {
            position: relative;
            background-color: #161b22;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #30363d;
        }
        .header-container {
            background-color: #161b22;
            border-bottom: 4px solid #f39c12;
            padding: 12px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            position: relative;
            z-index: 10;
        }
        .header-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            padding: 0 16px;
        }
        .header-item {
            background-color: #21262d;
            border-radius: 10px;
            padding: 10px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            min-width: 70px;
        }
        .header-item i {
            font-size: 1.6rem;
            margin-bottom: 2px;
        }
        .header-item span {
            font-size: 0.85rem;
            font-weight: 700;
            color: #cbd5e0;
            text-align: center;
        }
        .header-fleet-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e2e8f0;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 16px;
            text-align: center;
            background-color: #21262d;
            border-radius: 10px;
            padding: 8px 15px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            max-width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .header-fleet-name #fleetName {
            margin-left: 8px;
            margin-right: 8px;
        }
        .header-fleet-name #fleetStarIcon {
            font-size: 1.2rem;
        }
        .header-logout-btn {
            background-color: #dc2626;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            transition: background-color 0.2s ease;
            margin-right: 16px;
        }
        .header-logout-btn:hover {
            background-color: #ef4444;
        }
        .change-name-btn {
            background-color: #4a5568;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-right: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .change-name-btn:hover {
            background-color: #6b7280;
        }

        .pill-style-item {
            border-radius: 50px;
            padding: 1rem 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), inset 0 2px 5px rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            min-height: 120px;
        }

        .pill-style-item::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 1;
        }

        .pill-style-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.6), inset 0 2px 5px rgba(255, 255, 255, 0.3);
        }

        .pill-style-item .content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .pill-style-item i {
            font-size: 4rem;
            margin-bottom: 0.5rem;
            color: white;
        }

        .pill-style-item span {
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .pill-style-item .notification-dot {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 15px;
            height: 15px;
            background-color: #f39c12;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            z-index: 3;
        }


        .main-menu-item-bg-1 {
            background: linear-gradient(to bottom, #A0522D, #8B4513);
        }
        .main-menu-item-bg-2 {
            background: linear-gradient(to bottom, #8BC34A, #6B8E23);
        }
        .main-menu-item-bg-3 {
            background: linear-gradient(to bottom, #9370DB, #8A2BE2);
        }
        .main-menu-item-bg-4 {
            background: linear-gradient(to bottom, #FF8C00, #FF4500);
        }
        .main-menu-item-bg-5 {
            background: linear-gradient(to bottom, #4682B4, #4169E1);
        }
        .main-menu-item-bg-6 {
            background: linear-gradient(to bottom, #20B2AA, #008B8B);
        }
        .main-menu-item-bg-roulette {
            background: linear-gradient(to bottom, #DC143C, #8B0000);
        }
        .main-menu-item-bg-developments {
            background: linear-gradient(to bottom, #00BFFF, #1E90FF);
        }


        .store-item {
            background-color: #21262d;
            border-radius: 30px;
            padding: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 3px rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 100px;
            position: relative;
            overflow: hidden;
        }
        .store-item::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }

        .store-item:hover {
            transform: translateY(-3px);
        }

        .store-item i {
            font-size: 2.5rem;
            margin-bottom: 0.2rem;
            position: relative;
            z-index: 2;
        }
        .store-item img { /* For image icons in store */
            width: 2.5rem;
            height: 2.5rem;
            margin-bottom: 0.2rem;
            position: relative;
            z-index: 2;
        }

        .store-item h3 {
            font-size: 0.9rem;
            font-weight: bold;
            color: #e2e8f0;
            position: relative;
            z-index: 2;
        }
        .store-item .price-display {
            font-size: 0.7rem; /* Smaller font size */
            font-weight: bold;
            color: #cbd5e0;
            margin-top: 0.2rem;
            display: flex;
            align-items: center;
            gap: 2px;
            position: relative;
            z-index: 2;
        }
        .store-item .price-display i {
            font-size: 0.8rem; /* Smaller icon size */
        }
        .store-item .price-display i.fa-dollar-sign {
            color: #4CAF50;
        }
        .store-item .price-display i.fa-key {
            color: #FFD700;
        }

        @keyframes gold-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes pink-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes fiery-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background: position: 0% 50%; }
        }
        @keyframes silver-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes blue-glow-animation {
            0% { text-shadow: 0 0 5px #3b82f6, 0 0 10px #3b82f6, 0 0 15px #3b82f6; }
            50% { text-shadow: 0 0 10px #2563eb, 0 0 20px #2563eb, 0 0 30px #2563eb; }
            100% { text-shadow: 0 0 5px #3b82f6, 0 0 10px #3b82f6, 0 0 15px #3b82f6; }
        }
        @keyframes emerald-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes royal-crimson-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes crown-animation {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            25% { transform: scale(1.1) rotate(5deg); opacity: 0.9; }
            50% { transform: scale(1) rotate(0deg); opacity: 1; }
            75% { transform: scale(1.1) rotate(-5deg); opacity: 0.9; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        @keyframes lion-animation { /* New animation for lion icon */
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.05) rotate(3deg); opacity: 0.95; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .golden-text {
            background: linear-gradient(90deg, #ffd700, #ffec8b, #ffd700, #ffec8b);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: gold-animation 3s linear infinite;
        }
        .pink-text {
            background: linear-gradient(90deg, #ff69b4, #ffb6c1, #ff69b4, #ffb6c1);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: pink-animation 3s linear infinite;
        }
        .fiery-text {
            background: linear-gradient(90deg, #ff4500, #ffa500, #ff4500, #ffa500);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: fiery-animation 3s linear infinite;
        }
        .silver-text {
            background: linear-gradient(90deg, #c0c0c0, #e0e0e0, #c0c0c0, #e0e0e0);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: silver-animation 3s linear infinite;
        }
        .blue-glow-text {
            color: #3b82f6;
            animation: blue-glow-animation 2s ease-in-out infinite;
        }
        .emerald-text {
            background: linear-gradient(90deg, #00c9a7, #00e0b7, #00c9a7, #00e0b7);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: emerald-animation 3s linear infinite;
        }
        .royal-crimson-text {
            background: linear-gradient(90deg, #8b0000, #dc143c, #8b0000, #dc143c);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: royal-crimson-animation 3s linear infinite;
        }
        .animated-crown-icon {
            animation: crown-animation 2s ease-in-out infinite;
        }
        .animated-lion-icon { /* New class for animated lion */
            animation: lion-animation 1.5s ease-in-out infinite;
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.5s ease-out forwards;
        }

        #storeItemDetailModal .modal-content {
            max-width: 500px;
            padding: 30px;
        }
        #storeItemDetailModal h2 {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }
        #storeItemDetailModal .item-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }
        #storeItemDetailModal .item-icon-img { /* For image icons in modal */
            width: 5rem;
            height: 5rem;
            margin: 0 auto 20px auto; /* Center the image */
        }
        #storeItemDetailModal .item-description {
            font-size: 1.1rem;
            color: #a0aec0;
            margin-bottom: 25px;
        }
        #storeItemDetailModal .item-price {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #storeItemDetailModal .item-price i.fa-dollar-sign {
            color: #4CAF50;
            margin-left: 10px;
            font-size: 1.8rem;
        }
        #storeItemDetailModal .item-price i.fa-key {
            color: #FFD700;
            margin-left: 10px;
            font-size: 1.8rem;
        }
        #storeItemDetailModal .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .modal-actions .pill-modal-btn {
            min-width: 120px; /* Ensure buttons are wide enough for "Activate/Deactivate" */
        }

        .pill-modal-btn {
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 3px rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
            color: white;
        }
        .pill-modal-btn::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        .pill-modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), inset 0 1px 3px rgba(255, 255, 255, 0.25);
        }
        .pill-modal-btn.bg-blue-600 {
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
        }
        .pill-modal-btn.bg-gray-600 {
            background: linear-gradient(to bottom, #6b7280, #4b5563);
        }

        .ship-item-card {
            background-color: #21262d;
            border-radius: 50px;
            padding: 1rem 1.5rem;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4), inset 0 2px 5px rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        .ship-item-card::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 50px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 1;
        }
        .ship-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.6), inset 0 2px 5px rgba(255, 255, 255, 0.3);
        }
        .ship-item-card .icon-container {
            position: relative;
            z-index: 2;
            margin-right: 1.5rem;
            padding-left: 10px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ship-item-card .icon-container i {
            font-size: 3.5rem;
            color: #60a5fa;
            position: absolute;
        }
        .ship-item-card .icon-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .ship-item-card .info-container {
            position: relative;
            z-index: 2;
            flex-grow: 1;
        }
        .ship-item-card h3 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e2e8f0;
            margin-bottom: 0.25rem;
        }
        .ship-item-card p {
            font-size: 1rem;
            color: #a0aec0;
        }
        .ship-item-card .progress-bar-wrapper {
            background-color: #4a5568;
            border-radius: 5px;
            height: 8px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .ship-item-card .progress-bar {
            background-color: #3b82f6;
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease-out;
        }
        .ship-item-card .level-text {
            font-size: 0.85rem;
            color: #cbd5e0;
            margin-top: 0.25rem;
        }
        .ship-item-card .upgrade-btn-container {
            position: relative;
            z-index: 2;
            margin-left: 1.5rem;
        }
        .ship-item-card .upgrade-btn {
            @apply px-5 py-2 rounded-full font-bold text-base transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg;
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
        }
        .ship-item-card .upgrade-btn::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        .ship-item-card .upgrade-btn:hover {
            transform: translateY(-2px);
        }

        @keyframes fall-and-fade {
            0% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(5px); opacity: 0.5; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .cooldown-active {
            animation: fall-and-fade 1.5s infinite ease-in-out;
        }

        .roulette-container {
            background-color: #21262d;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #30363d;
            max-width: 450px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .roulette-display-area {
            width: 100%;
            height: 200px;
            border-radius: 12px;
            background-color: #1a202c;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 1.5rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.7);
            border: 5px solid #30363d;
            overflow: hidden;
            font-size: 3.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            background-image: linear-gradient(to right, #2d3748 1px, transparent 1px), linear-gradient(to bottom, #2d3748 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .multiplier-display-bottom-right {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            z-index: 3;
        }

        .plane-path {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .plane-path svg {
            position: absolute;
            width: 32px;
            height: 32px;
            color: #FFD700;
            transition: transform linear;
            transform-origin: center center;
        }

        @keyframes crash-shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .roulette-display-area.crashed {
            background-color: #FF0000 !important;
            border-color: #CC0000 !important;
            box-shadow: 0 0 25px rgba(255,0,0,0.9) !important;
            animation: crash-shake 0.3s ease-in-out;
        }

        .roulette-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            margin-top: 1.5rem;
        }
        .roulette-controls input {
            background-color: #3b4554;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 0.75rem;
            color: #e2e8f0;
            text-align: center;
            font-size: 1.1rem;
        }
        .roulette-controls .spin-btn-style {
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 3px rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
            color: white;
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
        }
        .roulette-controls .spin-btn-style:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), inset 0 1px 3px rgba(255, 255, 255, 0.25);
        }
        .roulette-controls .cash-out-btn-style {
            background: linear-gradient(to bottom, #FFD700, #DAA520);
            color: #333;
            border: 2px solid rgba(255, 255, 255, 0.15);
        }
        .roulette-controls .cash-out-btn-style:hover {
            background: linear-gradient(to bottom, #FFEB3B, #FFC107);
        }

        .roulette-result {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 1.5rem;
            color: #e2e8f0;
        }
        .roulette-cooldown-display {
            font-size: 1rem;
            color: #a0aec0;
            margin-top: 0.5rem;
        }

        .ship-selection-option {
            background-color: #21262d;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .ship-selection-option:hover {
            background-color: #2b323b;
        }
        .ship-selection-option.selected {
            border-color: #f39c12;
            box-shadow: 0 0 10px rgba(243,156,18,0.5);
        }
        .ship-selection-option input[type="radio"] {
            margin-left: 10px;
            accent-color: #f39c12;
        }
        .ship-selection-option label {
            flex-grow: 1;
            text-align: right;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .ship-form-item {
            display: flex;
            align-items: center;
            background-color: #21262d;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 1px solid #30363d;
        }
        .ship-form-item .icon-wrapper {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            flex-shrink: 0;
        }
        .ship-form-item .icon-wrapper i {
            font-size: 2.5rem;
            color: #60a5fa;
        }
        .ship-form-item .icon-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .ship-form-item .text-content {
            flex-grow: 1;
            text-align: right;
        }
        .ship-form-item h4 {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e2e8f0;
        }
        .ship-form-item p {
            font-size: 0.9rem;
            color: #a0aec0;
        }
        .attack-player-item {
            background-color: #21262d;
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .attack-player-item .player-info {
            display: flex;
            flex-direction: column;
            text-align: right;
            flex-grow: 1;
        }
        .attack-player-item .player-info h3 {
            font-size: 1.2rem;
            font-weight: bold;
            color: #e2e8f0;
        }
        .attack-player-item .player-info p {
            font-size: 0.9rem;
            color: #a0aec0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }
        .attack-player-item .attack-btn-wrapper {
            margin-left: 15px;
            flex-shrink: 0;
        }
        .attack-player-btn {
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 3px rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
            color: white;
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
            min-width: 80px;
            text-align: center;
        }
        .attack-player-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), inset 0 1px 3px rgba(255, 255, 255, 0.25);
        }
        .attack-player-btn:disabled {
            background: linear-gradient(to bottom, #6b7280, #4b5563);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .online-player-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer; /* Make list items clickable */
        }
        .online-player-list-item.online {
            background-color: #21262d;
        }
        .online-player-list-item.offline {
            background-color: #1a202c;
            opacity: 0.7;
        }
        .online-player-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .online-player-ships {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        .online-player-ship-icon {
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .online-player-ship-icon i {
            font-size: 1.2rem;
            position: absolute;
        }
        .online-player-ship-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: absolute;
        }
        .online-player-ship-icon.unlocked i, .online-player-ship-icon.unlocked img {
            filter: none; /* No grayscale for unlocked */
        }
        .online-player-ship-icon.locked i, .online-player-ship-icon.locked img {
            filter: grayscale(100%); /* Grayscale for locked */
            opacity: 0.6;
        }
        .player-profile-modal-content {
            max-width: 600px;
            text-align: right;
        }
        .player-profile-modal-content .profile-header {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 1.5rem;
        }
        .player-profile-modal-content .profile-header h2 {
            margin-left: 10px;
            font-size: 2.5rem;
        }
        .player-profile-modal-content .profile-header .status-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .player-profile-modal-content .profile-header .status-dot.online {
            background-color: #22c55e;
        }
        .player-profile-modal-content .profile-header .status-dot.offline {
            background-color: #ef4444;
        }
        .player-profile-modal-content .profile-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .player-profile-modal-content .profile-stat-item {
            background-color: #21262d;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }
        .player-profile-modal-content .profile-stat-item i {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        .player-profile-modal-content .profile-stat-item span {
            font-size: 1rem;
            font-weight: bold;
        }
        .player-profile-modal-content .profile-ships-section {
            margin-top: 1.5rem;
        }
        .player-profile-modal-content .profile-ship-card {
            background-color: #21262d;
            border-radius: 15px;
            padding: 1rem;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .player-profile-modal-content .profile-ship-card .icon-container {
            width: 50px;
            height: 50px;
            margin-left: 1rem;
            position: relative;
        }
        .player-profile-modal-content .profile-ship-card .icon-container i {
            font-size: 2.5rem;
            position: absolute;
        }
        .player-profile-modal-content .profile-ship-card .icon-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: absolute;
        }
        .player-profile-modal-content .profile-ship-card .info {
            flex-grow: 1;
            text-align: right;
        }
        .player-profile-modal-content .profile-ship-card .info h4 {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .player-profile-modal-content .profile-ship-card .info p {
            font-size: 0.9rem;
            color: #a0aec0;
        }
        .player-profile-modal-content .profile-footer {
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: #a0aec0;
        }
        #authModal .modal-content {
            background-color: #161b22; /* Same as section-container */
            border-radius: 12px; /* Same as section-container */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); /* Same as section-container */
            border: 1px solid #30363d; /* Same as section-container */
            width: 90%;
            max-width: 400px; /* Smaller max-width */
            padding: 24px;
            text-align: center;
        }
        #changeFleetNameModal .modal-content {
            max-width: 400px;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col" oncontextmenu="return false;">

    <div id="authModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">تسجيل الدخول / التسجيل</h2>
            <input type="email" id="authEmailInput" placeholder="البريد الإلكتروني" class="w-full p-3 rounded bg-gray-700 text-white border border-gray-600 mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="authPasswordInput" placeholder="كلمة المرور" class="w-full p-3 rounded bg-gray-700 text-white border border-gray-600 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="loginBtn" class="btn btn-primary w-full mb-3">تسجيل الدخول</button>
            <button id="registerBtn" class="btn btn-secondary w-full">تسجيل جديد</button>
        </div>
    </div>

    <div id="changeFleetNameModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeChangeFleetNameModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-4">تغيير اسم الأسطول</h2>
            <input type="text" id="changeFleetNameInput" placeholder="اسم الأسطول الجديد" class="w-full p-3 rounded bg-gray-700 text-white border border-gray-600 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="confirmChangeFleetNameBtn" class="btn btn-primary w-full">تأكيد التغيير</button>
        </div>
    </div>

    <header class="header-container w-full">
        <div class="header-stats-grid w-full max-w-4xl mx-auto">
            <div class="header-item">
                <i class="fas fa-fist-raised text-red-500"></i>
                <span id="playerPower">0</span>
            </div>
            <div class="header-item">
                <i class="fas fa-dollar-sign text-green-400"></i>
                <span id="playerMoney">0</span>
            </div>
            <div class="header-item">
                <i class="fas fa-key text-yellow-400"></i>
                <span id="playerKeys">0</span>
            </div>
        </div>
        <div class="header-fleet-name flex justify-between items-center px-4">
            <span id="fleetName">أسطولي العظيم</span>
            <i id="fleetStarIcon" class="fas fa-star text-yellow-300 hidden"></i>
            <i id="fleetCrownIcon" class="fas fa-chess-king text-yellow-400 hidden"></i>
            <img id="fleetLionIcon" src="https://d.top4top.io/p_3482hpjya1.png" alt="Lion Icon" class="w-6 h-6 ml-1 hidden animated-lion-icon" draggable="false">
            <span id="lionCountDisplay" class="text-xs text-gray-400 ml-1 hidden">x0</span>
            <button id="changeNameBtn" class="change-name-btn">تغيير الاسم</button>
        </div>
        <div class="text-center mt-2">
            <button id="logoutBtn" class="header-logout-btn">تسجيل الخروج</button>
        </div>
    </header>

    <main class="flex-grow p-4 flex flex-col items-center justify-center relative">
        <section id="mainMenu" class="grid grid-cols-2 md:grid-cols-3 gap-6 mb-8 w-full max-w-4xl hidden">
            <div class="pill-style-item main-menu-item-bg-1" onclick="showSection('myFleet')">
                <div class="content">
                    <i class="fas fa-ship"></i>
                    <span>أسطولي</span>
                </div>
            </div>
            <div class="pill-style-item main-menu-item-bg-2" onclick="showSection('store')">
                <div class="content">
                    <i class="fas fa-store"></i>
                    <span>المتجر</span>
                </div>
            </div>
            <div class="pill-style-item main-menu-item-bg-3" onclick="showSection('onlineSection')">
                <div class="content">
                    <i class="fas fa-globe"></i>
                    <span>اونلاين</span>
                </div>
            </div>
            <div class="pill-style-item main-menu-item-bg-roulette" onclick="showSection('rouletteSection')">
                <div class="content">
                    <i class="fas fa-dice"></i>
                    <span>روليت</span>
                </div>
            </div>
            <div class="pill-style-item main-menu-item-bg-developments" onclick="showSection('developmentsSection')">
                <div class="content">
                    <i class="fas fa-rocket"></i> 
                    <span>التطورات</span>
                </div>
            </div>
        </section>

        <section id="myFleet" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">أسطولي</h2>
            <div class="space-y-6">
                <div class="ship-item-card">
                    <div class="icon-container">
                        <i class="fas fa-ship"></i>
                        <img id="ship1IconImg" src="" alt="Ship Icon" class="w-full h-full object-contain" style="display: none;" draggable="false">
                    </div>
                    <div class="info-container">
                        <h3>السفينة الأساسية</h3>
                        <p>القوة: <span id="ship1Power">0</span></p>
                        <div class="progress-bar-wrapper">
                            <div id="ship1Progress" class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <p class="level-text">المستوى: <span id="ship1Level">0</span> / <span id="ship1MaxPower">10000</span></p>
                        <p id="ship1CooldownDisplay" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    <div class="upgrade-btn-container">
                        <button id="upgradeShip1" class="upgrade-btn">تطوير</button>
                    </div>
                </div>

                <div id="ship2Container" class="ship-item-card opacity-50 pointer-events-none">
                    <div class="icon-container">
                        <i class="fas fa-ship text-gray-500"></i>
                        <img id="ship2IconImg" src="" alt="Image of Ship Icon" style="display: none;" draggable="false">
                    </div>
                    <div class="info-container">
                        <h3 class="text-gray-400">السفينة الثانية</h3>
                        <p class="text-gray-300">القوة: <span id="ship2Power">0</span></p>
                        <div class="progress-bar-wrapper">
                            <div id="ship2Progress" class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <p class="level-text">المستوى: <span id="ship2Level">0</span> / <span id="ship2MaxPower">10000</span></p>
                        <p id="ship2CooldownDisplay" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    <div class="upgrade-btn-container">
                        <button id="upgradeShip2" class="upgrade-btn" disabled>تطوير</button>
                    </div>
                </div>

                <div id="ship3Container" class="ship-item-card opacity-50 pointer-events-none">
                    <div class="icon-container">
                        <i class="fas fa-ship text-gray-500"></i>
                        <img id="ship3IconImg" src="" alt="Image of Ship Icon" style="display: none;" draggable="false">
                    </div>
                    <div class="info-container">
                        <h3 class="text-gray-400">السفينة الثالثة</h3>
                        <p class="text-gray-300">القوة: <span id="ship3Power">0</span></p>
                        <div class="progress-bar-wrapper">
                            <div id="ship3Progress" class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <p class="level-text">المستوى: <span id="ship3Level">0</span> / <span id="ship3MaxPower">10000</span></p>
                        <p id="ship3CooldownDisplay" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    <div class="upgrade-btn-container">
                        <button id="upgradeShip3" class="upgrade-btn" disabled>تطوير</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="store" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">المتجر</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                <!-- Essential Items -->
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('completeUpgrade')">
                    <img src="https://c.top4top.io/p_3482irls40.png" alt="Image of Complete Upgrade Icon" draggable="false">
                    <h3>إكمال التطوير</h3>
                    <div class="price-display">
                        <span>2</span> <i class="fas fa-key"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('shipExpansion')">
                    <i class="fas fa-expand-arrows-alt text-blue-400"></i>
                    <h3>توسيع السفينة</h3>
                    <div class="price-display">
                        <span>50</span> <i class="fas fa-key"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('buyKeys')">
                    <i class="fas fa-key text-yellow-400"></i>
                    <h3>شراء مفاتيح</h3>
                    <div class="price-display">
                        <span>150</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <!-- Lucky Box -->
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('luckyBox')">
                    <img src="https://e.top4top.io/p_348281x7t0.png" alt="Image of Lucky Box" draggable="false">
                    <h3>صندوق الحظ</h3>
                    <div class="price-display">
                        <span>3500</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <!-- Free Box -->
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('freeBox')">
                    <img src="https://a.top4top.io/p_3483uplj00.png" alt="Image of Free Box" draggable="false">
                    <h3>صندوق مجاني</h3>
                    <div class="price-display">
                        <span>مجاني</span>
                    </div>
                </div>
                <!-- Cosmetic Items -->
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('goldenName')">
                    <i class="fas fa-crown text-yellow-400"></i>
                    <h3>اسم ذهبي متحرك</h3>
                    <div class="price-display">
                        <span>3000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('pinkName')">
                    <i class="fas fa-heart text-pink-500"></i>
                    <h3>اسم وردي متحرك</h3>
                    <div class="price-display">
                        <span>1500</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('fieryName')">
                    <i class="fas fa-fire text-orange-500"></i>
                    <h3>اسم ناري ملتهب</h3>
                    <div class="price-display">
                        <span>2000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <!-- New Name Cosmetics -->
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('silverName')">
                    <i class="fas fa-gem text-gray-300"></i>
                    <h3>اسم فضي لامع</h3>
                    <div class="price-display">
                        <span>2500</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('blueGlowName')">
                    <i class="fas fa-lightbulb text-blue-400"></i>
                    <h3>اسم أزرق متوهج</h3>
                    <div class="price-display">
                        <span>4000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('emeraldName')">
                    <i class="fas fa-leaf text-green-500"></i>
                    <h3>اسم أخضر زمردي</h3>
                    <div class="price-display">
                        <span>6000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('royalCrimsonName')">
                    <i class="fas fa-shield-alt text-red-600"></i>
                    <h3>اسم قرمزي ملكي</h3>
                    <div class="price-display">
                        <span>9000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>

                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('starIcon')">
                    <i class="fas fa-star text-yellow-300"></i>
                    <h3>أيقونة النجمة</h3>
                    <div class="price-display">
                        <span>3000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('crownIcon')">
                    <i class="fas fa-chess-king text-yellow-400"></i>
                    <h3>أيقونة تاج ذهبي</h3>
                    <div class="price-display">
                        <span>5000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <!-- Lion Icon -->
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('lionIcon')">
                    <img src="https://d.top4top.io/p_3482hpjya1.png" alt="Image of Lion Icon" draggable="false">
                    <h3>أيقونة الأسد المتوهج</h3>
                    <div class="price-display">
                        <span>-</span> <i class="fas fa-dollar-sign"></i> <!-- Price handled by lucky box -->
                    </div>
                </div>
            </div>
            <p class="text-center text-gray-300 mt-6">المزيد من العناصر قريباً!</p>
        </section>

        <section id="onlineSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">اونلاين</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="pill-style-item main-menu-item-bg-4" onclick="showSection('challengeLog')">
                    <div class="content">
                        <i class="fas fa-scroll"></i>
                        <span>سجل التحدي</span>
                    </div>
                </div>
                <div class="pill-style-item main-menu-item-bg-5" onclick="showSection('attackSection')">
                    <div class="content">
                        <i class="fas fa-crosshairs"></i>
                        <span>الهجوم</span>
                    </div>
                </div>
                <div class="pill-style-item main-menu-item-bg-6" onclick="showSection('onlinePlayersSection')">
                    <div class="content">
                        <i class="fas fa-users"></i>
                    <span>المتصلون حاليا</span>
                </div>
            </div>
        </section>

        <section id="rouletteSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">لعبة الطائرة</h2>
            <div class="roulette-container">
                <div id="rouletteGameElements">
                    <div id="rouletteDisplayArea" class="roulette-display-area">
                        <div class="plane-path">
                            <svg id="planeSvg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9L2 14v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1V20.5L13 19v-2.5l8 2.5z"/>
                            </svg>
                        </div>
                        <span id="multiplierDisplay" class="multiplier-display-bottom-right">1.00x</span>
                    </div>

                    <div class="roulette-controls">
                        <input type="number" id="betAmountInput" placeholder="مبلغ الرهان (20-2000)" min="20" max="2000" class="w-full">
                        <button id="startGameBtn" class="spin-btn-style">ابدأ الجولة</button>
                        <button id="cashOutBtn" class="spin-btn-style cash-out-btn-style hidden" disabled>استلام الأرباح (<span id="potentialWinnings">0</span>)</button>
                        <p id="rouletteResult" class="roulette-result hidden">النتيجة: </p>
                    </div>
                </div>
                <p id="rouletteCooldownDisplay" class="roulette-cooldown-display hidden">الجولة القادمة بعد: </p>
            </div>
        </section>

        <section id="developmentsSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">التطورات</h2>
            <div id="shipFormsList" class="text-right">
            </div>
        </section>

        <section id="challengeLog" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('onlineSection')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">سجل التحدي</h2>
            <ul id="challengeLogList" class="space-y-3">
            </ul>
        </section>

        <section id="attackSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('onlineSection')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">الهجوم</h2>
            <div id="attackablePlayersList" class="space-y-3">
            </div>
            <p class="text-center text-sm text-gray-500 mt-4">الفوز يمنحك 200-800 دولار وفرصة 15% للحصول على مفتاح. الخسارة لا تكلفك شيئاً.</p>
        </section>

        <section id="onlinePlayersSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('onlineSection')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">المتصلون حاليا</h2>
            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3 text-green-300">متصلون</h3>
                <ul id="onlinePlayersList" class="space-y-2">
                </ul>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-3 text-gray-400">غير متصلون</h3>
                <ul id="offlinePlayersList" class="space-y-2">
                </ul>
            </div>
        </section>
    </main>

    <div id="resourceCollectionBtnWrapper" class="resource-btn-wrapper hidden">
        <div id="resourceCollectionBtn" class="resource-btn">
            <svg class="progress-circle" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" class="circle-bg"></circle>
                <circle cx="50" cy="50" r="40" class="circle-progress"></circle>
            </svg>
            <div class="resource-content">
                <i class="fas fa-box-open"></i>
                <span id="accumulatedResourcesDisplay" class="text-lg font-bold">0/200</span>
            </div>
        </div>
        <span class="resource-btn-text">استلام</span>
    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <p id="modalMessage" class="text-lg font-semibold"></p>
            <button class="pill-modal-btn bg-blue-600 mt-4" onclick="closeModal()">حسناً</button>
        </div>
    </div>

    <div id="storeItemDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeStoreItemDetailModal(true)">&times;</span>
            <h2 id="storeItemTitle"></h2>
            <i id="storeItemIcon" class="item-icon hidden"></i>
            <img id="storeItemIconImg" src="" alt="Item Icon" class="item-icon-img hidden" draggable="false">
            <p id="storeItemDescription" class="item-description"></p>
            <p id="storeItemPrice" class="item-price"></p>
            <div class="modal-actions">
                <button id="buyStoreItemBtn" class="pill-modal-btn bg-blue-600">شراء</button>
                <button class="pill-modal-btn bg-gray-600" onclick="closeStoreItemDetailModal(true)">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="shipSelectionModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeShipSelectionModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-4" id="shipExpansionModalTitle">توسيع السفينة</h2>
            <i id="shipExpansionModalIcon" class="item-icon fas fa-expand-arrows-alt text-blue-400"></i>
            <p id="shipExpansionModalDescription" class="item-description">يزيد الحد الأقصى لقوة السفينة المختارة بمقدار 5000 نقطة قوة إضافية. يمكن شراء هذا التوسيع عدة مرات لأي سفينة.</p>
            <p id="shipExpansionModalPrice" class="item-price">10000 <i class="fas fa-dollar-sign text-green-400"></i></p>
            
            <h3 class="text-xl font-bold mb-3">اختر سفينة للتوسيع:</h3>
            <div id="shipSelectionOptions" class="flex flex-col gap-3 mb-6">
            </div>
            <div class="modal-actions">
                <button id="confirmShipExpansionBtn" class="pill-modal-btn bg-blue-600">تأكيد التوسيع</button>
                <button class="pill-modal-btn bg-gray-600" onclick="closeShipSelectionModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Player Profile Modal -->
    <div id="playerProfileModal" class="modal">
        <div class="modal-content player-profile-modal-content">
            <span class="close-button" onclick="closePlayerProfileModal()">&times;</span>
            <div class="profile-header">
                <h2 id="profileFleetName"></h2>
                <i id="profileStarIcon" class="fas fa-star text-yellow-300 hidden"></i>
                <i id="profileCrownIcon" class="fas fa-chess-king text-yellow-400 hidden"></i>
                <img id="profileLionIcon" src="https://d.top4top.io/p_3482hpjya1.png" alt="Lion Icon" class="w-6 h-6 ml-1 hidden animated-lion-icon" draggable="false">
                <span id="profileLionCountDisplay" class="text-xs text-gray-400 ml-1 hidden">x0</span>
                <div id="profileStatusDot" class="status-dot"></div>
            </div>
            <div class="profile-stats-grid">
                <div class="profile-stat-item">
                    <i class="fas fa-fist-raised text-red-500"></i>
                    <span id="profileTotalPower">0</span>
                    <p class="text-xs text-gray-400">القوة الكلية</p>
                </div>
            </div>
            <div class="profile-ships-section">
                <h3 class="text-xl font-bold mb-3 text-right">السفن:</h3>
                <div id="profileShipsList" class="space-y-3">
                    <!-- Ship cards will be inserted here -->
                </div>
            </div>
            <div class="profile-footer">
                <p>معرف المستخدم: <span id="profileUserId"></span></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, push, query, orderByChild, onDisconnect, serverTimestamp, limitToLast } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBAepZChU6qfWGTQDrzEpJm_TRIrr6vhq8",
            authDomain: "mygame-7c747.firebaseapp.com",
            databaseURL: "https://mygame-7c747-default-rtdb.firebaseio.com",
            projectId: "mygame-7c747",
            storageBucket: "mygame-7c747.firebasestorage.app",
            messagingSenderId: "191691681571",
            appId: "1:191691681571:web:8dbc3991cb550b5e026696",
            measurementId: "G-XDP3YKZGH3"
        };
        
        const appId = firebaseConfig.projectId; 

        let app;
        let db;
        let auth;
        let userId = null;
        let userDbRef = null; 
        let onlinePlayersListener = null; 
        let attackLogListener = null; 
        let currentActiveSectionId = null; 

        let playerPower = 0;
        let playerMoney = 0;
        let playerKeys = 0;
        let fleetName = null; 
        let isGoldenNameOwned = false;
        let isGoldenNameActive = false;
        let isPinkNameOwned = false; 
        let isPinkNameActive = false;
        let isFieryNameOwned = false; 
        let isFieryNameActive = false;
        let isSilverNameOwned = false; // New name cosmetic
        let isSilverNameActive = false; // New name cosmetic
        let isBlueGlowNameOwned = false; // New name cosmetic
        let isBlueGlowNameActive = false; // New name cosmetic
        let isEmeraldNameOwned = false; // New name cosmetic
        let isEmeraldNameActive = false; // New name cosmetic
        let isRoyalCrimsonNameOwned = false; // New name cosmetic
        let isRoyalCrimsonNameActive = false; // New name cosmetic
        let isStarIconOwned = false;
        let isStarIconActive = false;
        let isCrownIconOwned = false; 
        let isCrownIconActive = false;
        let lionCount = 0; 
        let isLionActive = false; 

        const INITIAL_SHIP_MAX_POWER = 10000;
        const UPGRADE_COOLDOWN_MS = 3 * 60 * 1000;
        const ATTACK_COOLDOWN_GLOBAL_MS = 5 * 60 * 1000;

        let globalAttackCooldownEndTime = 0;
        let lastAttackedOpponentId = null; 
        let lastGlobalCooldownState = false; 

        let ship1 = { power: 0, level: 0, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };
        let ship2 = { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };
        let ship3 = { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };

        let accumulatedResources = 0;
        const MAX_ACCUMULATED_RESOURCES = 200;
        const RESOURCE_ACCUMULATION_INTERVAL_MS = 3000;

        const FREE_BOX_COOLDOWN_MS = 1 * 60 * 60 * 1000; // 1 hour
        let freeBoxCooldownEndTime = 0;

        const storeItems = {
            completeUpgrade: {
                title: 'إكمال التطوير',
                iconType: 'image', 
                icon: 'https://c.top4top.io/p_3482irls40.png',
                description: 'ينهي وقت انتظار تطوير السفن.',
                price: 2,
                currency: 'key',
                type: 'utility'
            },
            shipExpansion: {
                title: 'توسيع السفينة',
                iconType: 'font-awesome', 
                icon: 'fas fa-expand-arrows-alt text-blue-400',
                description: 'يزيد الحد الأقصى لقوة السفينة المختارة بمقدار 5000 نقطة قوة إضافية. يمكن شراء هذا التوسيع عدة مرات لأي سفينة.',
                price: 50, 
                currency: 'key',
                type: 'utility'
            },
            buyKeys: { 
                title: 'شراء مفاتيح',
                iconType: 'font-awesome', 
                icon: 'fas fa-key text-yellow-400',
                description: 'احصل على المزيد من المفاتيح لفتح الميزات أو إكمال التطوير.',
                price: 150, 
                currency: 'money',
                amount: 1,
                type: 'utility'
            },
            luckyBox: { 
                title: 'صندوق الحظ',
                iconType: 'image',
                icon: 'https://e.top4top.io/p_348281x7t0.png',
                description: 'جرب حظك واحصل على جوائز قيمة!',
                price: 3500,
                currency: 'money',
                type: 'lucky_box'
            },
            freeBox: { // New Free Box item
                title: 'صندوق مجاني',
                iconType: 'image',
                icon: 'https://a.top4top.io/p_3483uplj00.png',
                description: 'احصل على مكافآت مجانية كل ساعة!',
                price: 0,
                currency: 'none',
                type: 'free_box'
            },
            goldenName: {
                title: 'اسم ذهبي متحرك',
                iconType: 'font-awesome', 
                icon: 'fas fa-crown text-yellow-400',
                description: 'اجعل اسم أسطولك يتوهج بالذهب.',
                price: 3000,
                currency: 'money',
                type: 'name_cosmetic',
                ownedKey: 'isGoldenNameOwned',
                activeKey: 'isGoldenNameActive',
                cssClass: 'golden-text'
            },
            pinkName: { 
                title: 'اسم وردي متحرك',
                iconType: 'font-awesome', 
                icon: 'fas fa-heart text-pink-500',
                description: 'اجعل اسم أسطولك يتوهج باللون الوردي.',
                price: 1500,
                currency: 'money',
                type: 'name_cosmetic',
                ownedKey: 'isPinkNameOwned',
                activeKey: 'isPinkNameActive',
                cssClass: 'pink-text'
            },
            fieryName: { 
                title: 'اسم ناري ملتهب',
                iconType: 'font-awesome', 
                icon: 'fas fa-fire text-orange-500',
                description: 'اجعل اسم أسطولك يتوهج بالنار.',
                price: 2000,
                currency: 'money',
                type: 'name_cosmetic',
                ownedKey: 'isFieryNameOwned',
                activeKey: 'isFieryNameActive',
                cssClass: 'fiery-text'
            },
            silverName: { // New name cosmetic
                title: 'اسم فضي لامع',
                iconType: 'font-awesome',
                icon: 'fas fa-gem text-gray-300',
                description: 'اجعل اسم أسطولك يتوهج بالفضة.',
                price: 2500,
                currency: 'money',
                type: 'name_cosmetic',
                ownedKey: 'isSilverNameOwned',
                activeKey: 'isSilverNameActive',
                cssClass: 'silver-text'
            },
            blueGlowName: { // New name cosmetic
                title: 'اسم أزرق متوهج',
                iconType: 'font-awesome',
                icon: 'fas fa-lightbulb text-blue-400',
                description: 'اجعل اسم أسطولك يتوهج باللون الأزرق.',
                price: 4000,
                currency: 'money',
                type: 'name_cosmetic',
                ownedKey: 'isBlueGlowNameOwned',
                activeKey: 'isBlueGlowNameActive',
                cssClass: 'blue-glow-text'
            },
            emeraldName: { // New name cosmetic
                title: 'اسم أخضر زمردي',
                iconType: 'font-awesome',
                icon: 'fas fa-leaf text-green-500',
                description: 'اجعل اسم أسطولك يتوهج باللون الأخضر الزمردي.',
                price: 6000,
                currency: 'money',
                type: 'name_cosmetic',
                ownedKey: 'isEmeraldNameOwned',
                activeKey: 'isEmeraldNameActive',
                cssClass: 'emerald-text'
            },
            royalCrimsonName: { // New name cosmetic
                title: 'اسم قرمزي ملكي',
                iconType: 'font-awesome',
                icon: 'fas fa-shield-alt text-red-600',
                description: 'اجعل اسم أسطولك يتوهج باللون القرمزي الملكي.',
                price: 9000,
                currency: 'money',
                type: 'name_cosmetic',
                ownedKey: 'isRoyalCrimsonNameOwned',
                activeKey: 'isRoyalCrimsonNameActive',
                cssClass: 'royal-crimson-text'
            },
            starIcon: {
                title: 'أيقونة النجمة',
                iconType: 'font-awesome', 
                icon: 'fas fa-star text-yellow-300',
                description: 'أضف نجمة لامعة بجانب اسمك.',
                price: 3000,
                currency: 'money',
                type: 'icon_cosmetic',
                ownedKey: 'isStarIconOwned',
                activeKey: 'isStarIconActive'
            },
            crownIcon: { 
                title: 'أيقونة تاج ذهبي',
                iconType: 'font-awesome', 
                icon: 'fas fa-chess-king text-yellow-400',
                description: 'أضف تاجاً ذهبياً متحركاً بجانب اسمك.',
                price: 5000,
                currency: 'money',
                type: 'icon_cosmetic',
                ownedKey: 'isCrownIconOwned',
                activeKey: 'isCrownIconActive'
            },
            lionIcon: { 
                title: 'أيقونة الأسد المتوهج',
                iconType: 'image',
                icon: 'https://d.top4top.io/p_3482hpjya1.png',
                description: 'أيقونة أسد متوهجة تمنح 7000 قوة إضافية لأسطولك. يمكن الحصول عليها من صندوق الحظ.',
                price: '-', 
                currency: 'none',
                type: 'icon_cosmetic',
                ownedKey: 'lionCount', 
                activeKey: 'isLionActive'
            }
        };

        const ROULETTE_COOLDOWN_MS = 1 * 60 * 1000;
        let rouletteCooldownEndTime = 0;

        let gameActive = false;
        let currentMultiplier = 1.00;
        let crashPoint = 0;
        let betAmount = 0;
        let hasCashedOut = false;
        let animationFrameId;
        let lastFrameTime = 0;

        let playerPowerEl;
        let playerMoneyEl;
        let playerKeysEl;
        let fleetNameEl;
        let fleetStarIconEl;
        let fleetCrownIconEl; 
        let fleetLionIconEl;
        let lionCountDisplayEl; 
        let logoutBtn;
        let changeNameBtn; 

        let ship1PowerEl;
        let ship1LevelEl;
        let ship1ProgressEl;
        let ship1MaxPowerEl;
        let upgradeShip1Btn;
        let ship1CooldownDisplay;
        let ship1IconContainerEl; 
        let ship1IconIEl;
        let ship1IconImgEl;

        let ship2Container;
        let ship2PowerEl;
        let ship2LevelEl;
        let ship2ProgressEl;
        let ship2MaxPowerEl;
        let upgradeShip2Btn;
        let ship2CooldownDisplay;
        let ship2IconContainerEl; 
        let ship2IconImgEl;
        let ship2IconIEl;

        let ship3Container;
        let ship3PowerEl;
        let ship3LevelEl;
        let ship3ProgressEl;
        let ship3MaxPowerEl;
        let upgradeShip3Btn;
        let ship3CooldownDisplay;
        let ship3IconContainerEl; 
        let ship3IconImgEl;
        let ship3IconIEl;

        let mainMenuSection;
        let myFleetSection;
        let storeSection;
        let onlineSection;
        let rouletteSection;
        let developmentsSection; 
        let challengeLogSection;
        let attackSection;
        let onlinePlayersSection;

        let messageModal;
        let modalMessage;

        let authModal;
        let authEmailInput;
        let authPasswordInput;
        let loginBtn;
        let registerBtn;

        let changeFleetNameModal; 
        let changeFleetNameInput;
        let confirmChangeFleetNameBtn;

        let resourceCollectionBtnWrapper;
        let resourceCollectionBtn;
        let accumulatedResourcesDisplay;
        let circleProgress;
        let resourceBtnTextEl; 
        let resourceBtnIconEl; 
        const radius = 40;
        const circumference = 2 * Math.PI * radius;

        let storeItemDetailModal;
        let storeItemTitle;
        let storeItemIcon;
        let storeItemIconImg; 
        let storeItemDescription;
        let storeItemPrice;
        let buyStoreItemBtn;
        let currentStoreItemKey = null;

        let rouletteGameElements; 
        let rouletteDisplayArea;
        let multiplierDisplay;
        let betAmountInput;
        let startGameBtn;
        let cashOutBtn;
        let potentialWinningsEl;
        let rouletteResult;
        let rouletteCooldownDisplay;
        let planeSvg;

        let shipFormsList; 

        let onlinePlayersListEl;
        let offlinePlayersListEl;
        let challengeLogListEl;
        let attackablePlayersListEl;

        let playerProfileModal; 
        let profileFleetNameEl; 
        let profileStarIconEl; 
        let profileCrownIconEl; 
        let profileLionIconEl;
        let profileLionCountDisplayEl; 
        let profileStatusDotEl; 
        let profileTotalPowerEl; 
        let profileShipsListEl; 
        let profileUserIdEl; 

        const shipFormsData = [
            { levelRange: '1 - 1000', iconType: 'font-awesome', iconClass: 'fas fa-ship', imgSrc: '' },
            { levelRange: '1001 - 4000', iconType: 'image', iconClass: '', imgSrc: 'https://l.top4top.io/p_3482en0id0.png' },
            { levelRange: '4001 - 9999', iconType: 'image', iconClass: '', imgSrc: 'https://b.top4top.io/p_3482vv1ax2.png' },
            { levelRange: '10000+', iconType: 'image', iconClass: '', imgSrc: 'https://c.top4top.io/p_3482878s83.png' }
        ];

        // Formats a number for display (e.g., 10000 -> 10k, 1000000 -> 1m)
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'm';
            }
            if (num >= 10000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        // Displays a message in a modal
        window.showMessage = function(message) {
            modalMessage.textContent = message;
            modalMessage.classList.remove('hidden');
            messageModal.style.display = 'flex';
        }

        // Closes the message modal
        window.closeModal = function() {
            messageModal.style.display = 'none';
        }

        // Initializes Firebase and sets up authentication listener
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                auth = getAuth(app);

                // Set Firebase Auth persistence to LOCAL to remember user login
                setPersistence(auth, browserLocalPersistence)
                    .catch((error) => {
                        console.error("Error setting persistence:", error);
                        window.showMessage(`خطأ في إعدادات الحفظ: ${error.message}`);
                    });

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userDbRef = ref(db, `artifacts/${appId}/users/${userId}/playerData`);
                        
                        // Set up user presence in public database
                        const presenceRef = ref(db, `artifacts/${appId}/public/onlinePlayers/${userId}/isOnline`);
                        const lastSeenRef = ref(db, `artifacts/${appId}/public/onlinePlayers/${userId}/lastSeen`);
                        await set(ref(db, `artifacts/${appId}/public/onlinePlayers/${userId}/userId`), userId); 
                        onDisconnect(presenceRef).set(false);
                        onDisconnect(lastSeenRef).set(serverTimestamp());

                        // Fetch or create user data from Firebase
                        await fetchOrCreateUserData(); 

                        // Update online status and set up public data listeners
                        await updateOnlineStatus(true); 
                        setupPublicDataListeners(); 

                        // Hide auth modal and show main menu
                        authModal.style.display = 'none'; 
                        window.showSection('mainMenu'); 

                        // Periodically update online status
                        setInterval(() => {
                            if (userId) {
                                updateOnlineStatus(true);
                            }
                        }, 30 * 1000); 

                    } else {
                        // If no user is logged in, show auth modal and hide game sections
                        userId = null;
                        clearPublicDataListeners(); 
                        authModal.style.display = 'flex';
                        showSection('hidden'); 
                        resourceCollectionBtnWrapper.classList.add('hidden');
                    }
                });

            } catch (initializationError) {
                window.showMessage(`حدث خطأ حرج في تهيئة Firebase: ${initializationError.message}. يرجى التحقق من إعدادات مشروع Firebase الخاص بك.`);
            }
        }

        // Handles user login
        async function handleLogin() {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                window.showMessage('تم تسجيل الدخول بنجاح!');
            } catch (error) {
                window.showMessage(`خطأ في تسجيل الدخول: ${error.message}`);
            }
        }

        // Handles new user registration
        async function handleRegister() {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                window.showMessage('تم التسجيل بنجاح! يمكنك الآن تسجيل الدخول.');
            } catch (error) {
                window.showMessage(`خطأ في التسجيل: ${error.message}`);
            }
        }

        // Handles user logout
        async function logoutUser() {
            try {
                if (userId) {
                    await updateOnlineStatus(false);
                }

                await signOut(auth);
                window.showMessage('تم تسجيل الخروج بنجاح!');

                // Reset all local player data to default values
                playerMoney = 0;
                playerKeys = 0;
                playerPower = 0; 
                fleetName = null; 
                isGoldenNameOwned = false;
                isGoldenNameActive = false;
                isPinkNameOwned = false; 
                isPinkNameActive = false;
                isFieryNameOwned = false; 
                isFieryNameActive = false;
                isSilverNameOwned = false;
                isSilverNameActive = false;
                isBlueGlowNameOwned = false;
                isBlueGlowNameActive = false;
                isEmeraldNameOwned = false;
                isEmeraldNameActive = false;
                isRoyalCrimsonNameOwned = false;
                isRoyalCrimsonNameActive = false;
                isStarIconOwned = false;
                isStarIconActive = false;
                isCrownIconOwned = false; 
                isCrownIconActive = false;
                lionCount = 0; 
                isLionActive = false; 
                freeBoxCooldownEndTime = 0; // Reset free box cooldown
                ship1 = { power: 0, level: 0, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };
                ship2 = { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };
                ship3 = { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };
                globalAttackCooldownEndTime = 0;
                rouletteCooldownEndTime = 0;
                accumulatedResources = 0;
                lastAttackedOpponentId = null;
                currentActiveSectionId = null; 

                // Update UI with reset stats
                updatePlayerStats(); 
                updateAllShipCooldowns();
                updateResourceCircle();
                updateResourceButtonState();
                updateRouletteCooldownUI();
                updateAttackCooldownsUI(); 

            } catch (error) {
                window.showMessage(`خطأ في تسجيل الخروج: ${error.message}`);
            }
        }

        // Fetches user data from Firebase or initializes new data if none exists
        async function fetchOrCreateUserData() {
            if (!userId) {
                return;
            }
            try {
                const snapshot = await get(userDbRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    playerMoney = data.money !== undefined ? data.money : 0;
                    playerKeys = data.keys !== undefined ? data.keys : 0;
                    fleetName = data.fleetName !== undefined ? data.fleetName : "قائد جديد"; 
                    isGoldenNameOwned = data.isGoldenNameOwned !== undefined ? data.isGoldenNameOwned : false;
                    isGoldenNameActive = data.isGoldenNameActive !== undefined ? data.isGoldenNameActive : false;
                    isPinkNameOwned = data.isPinkNameOwned !== undefined ? data.isPinkNameOwned : false; 
                    isPinkNameActive = data.isPinkNameActive !== undefined ? data.isPinkNameActive : false;
                    isFieryNameOwned = data.isFieryNameOwned !== undefined ? data.isFieryNameOwned : false; 
                    isFieryNameActive = data.isFieryNameActive !== undefined ? data.isFieryNameActive : false; 
                    isSilverNameOwned = data.isSilverNameOwned !== undefined ? data.isSilverNameOwned : false;
                    isSilverNameActive = data.isSilverNameActive !== undefined ? data.isSilverNameActive : false;
                    isBlueGlowNameOwned = data.isBlueGlowNameOwned !== undefined ? data.isBlueGlowNameOwned : false;
                    isBlueGlowNameActive = data.isBlueGlowNameActive !== undefined ? data.isBlueGlowNameActive : false;
                    isEmeraldNameOwned = data.isEmeraldNameOwned !== undefined ? data.isEmeraldNameOwned : false;
                    isEmeraldNameActive = data.isEmeraldNameActive !== undefined ? data.isEmeraldNameActive : false;
                    isRoyalCrimsonNameOwned = data.isRoyalCrimsonNameOwned !== undefined ? data.isRoyalCrimsonNameOwned : false;
                    isRoyalCrimsonNameActive = data.isRoyalCrimsonNameActive !== undefined ? data.isRoyalCrimsonNameActive : false;
                    isStarIconOwned = data.isStarIconOwned !== undefined ? data.isStarIconOwned : false;
                    isStarIconActive = data.isStarIconActive !== undefined ? data.isStarIconActive : false;
                    isCrownIconOwned = data.isCrownIconOwned !== undefined ? data.isCrownIconOwned : false; 
                    isCrownIconActive = data.isCrownIconActive !== undefined ? data.isCrownIconActive : false; 
                    lionCount = data.lionCount !== undefined ? data.lionCount : 0; 
                    isLionActive = data.isLionActive !== undefined ? data.isLionActive : false; 
                    freeBoxCooldownEndTime = data.freeBoxCooldownEndTime !== undefined ? data.freeBoxCooldownEndTime : 0;

                    ship1 = { 
                        power: (data.ship1 && data.ship1.power !== undefined) ? data.ship1.power : 0,
                        level: (data.ship1 && data.ship1.level !== undefined) ? data.ship1.level : 0,
                        cooldownEndTime: (data.ship1 && data.ship1.cooldownEndTime !== undefined) ? data.ship1.cooldownEndTime : 0,
                        maxPower: (data.ship1 && data.ship1.maxPower !== undefined) ? data.ship1.maxPower : INITIAL_SHIP_MAX_POWER
                    };
                    ship2 = { 
                        power: (data.ship2 && data.ship2.power !== undefined) ? data.ship2.power : 0,
                        level: (data.ship2 && data.ship2.level !== undefined) ? data.ship2.level : 0,
                        unlocked: (data.ship2 && data.ship2.unlocked !== undefined) ? data.ship2.unlocked : false,
                        cooldownEndTime: (data.ship2 && data.ship2.cooldownEndTime !== undefined) ? data.ship2.cooldownEndTime : 0,
                        maxPower: (data.ship2 && data.ship2.maxPower !== undefined) ? data.ship2.maxPower : INITIAL_SHIP_MAX_POWER
                    };
                    ship3 = { 
                        power: (data.ship3 && data.ship3.power !== undefined) ? data.ship3.power : 0,
                        level: (data.ship3 && data.ship3.level !== undefined) ? data.ship3.level : 0,
                        unlocked: (data.ship3 && data.ship3.unlocked !== undefined) ? data.ship3.unlocked : false,
                        cooldownEndTime: (data.ship3 && data.ship3.cooldownEndTime !== undefined) ? data.ship3.cooldownEndTime : 0,
                        maxPower: (data.ship3 && data.ship3.maxPower !== undefined) ? data.ship3.maxPower : INITIAL_SHIP_MAX_POWER
                    };

                    globalAttackCooldownEndTime = data.globalAttackCooldownEndTime !== undefined ? data.globalAttackCooldownEndTime : 0;
                    rouletteCooldownEndTime = data.rouletteCooldownEndTime !== undefined ? data.rouletteCooldownEndTime : 0;
                    accumulatedResources = data.accumulatedResources !== undefined ? data.accumulatedResources : 0; 

                } else {
                    // Initialize with default values if no data exists
                    fleetName = "قائد جديد"; 
                    playerMoney = 100;
                    playerKeys = 1;
                    isGoldenNameOwned = false;
                    isGoldenNameActive = false;
                    isPinkNameOwned = false;
                    isPinkNameActive = false;
                    isFieryNameOwned = false;
                    isFieryNameActive = false;
                    isSilverNameOwned = false;
                    isSilverNameActive = false;
                    isBlueGlowNameOwned = false;
                    isBlueGlowNameActive = false;
                    isEmeraldNameOwned = false;
                    isEmeraldNameActive = false;
                    isRoyalCrimsonNameOwned = false;
                    isRoyalCrimsonNameActive = false;
                    isStarIconOwned = false;
                    isStarIconActive = false;
                    isCrownIconOwned = false;
                    isCrownIconActive = false;
                    lionCount = 0; 
                    isLionActive = false; 
                    freeBoxCooldownEndTime = 0;
                    ship1 = { power: 0, level: 0, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };
                    ship2 = { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };
                    ship3 = { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER };
                    globalAttackCooldownEndTime = 0;
                    rouletteCooldownEndTime = 0;
                    accumulatedResources = 0; 

                    await set(userDbRef, {
                        money: playerMoney,
                        keys: playerKeys,
                        fleetName: fleetName,
                        isGoldenNameOwned: isGoldenNameOwned,
                        isGoldenNameActive: isGoldenNameActive,
                        isPinkNameOwned: isPinkNameOwned, 
                        isPinkNameActive: isPinkNameActive,
                        isFieryNameOwned: isFieryNameOwned, 
                        isFieryNameActive: isFieryNameActive,
                        isSilverNameOwned: isSilverNameOwned,
                        isSilverNameActive: isSilverNameActive,
                        isBlueGlowNameOwned: isBlueGlowNameOwned,
                        isBlueGlowNameActive: isBlueGlowNameActive,
                        isEmeraldNameOwned: isEmeraldNameOwned,
                        isEmeraldNameActive: isEmeraldNameActive,
                        isRoyalCrimsonNameOwned: isRoyalCrimsonNameOwned,
                        isRoyalCrimsonNameActive: isRoyalCrimsonNameActive,
                        isStarIconOwned: isStarIconOwned,
                        isStarIconActive: isStarIconActive,
                        isCrownIconOwned: isCrownIconOwned, 
                        isCrownIconActive: isCrownIconActive,
                        lionCount: lionCount, 
                        isLionActive: isLionActive, 
                        freeBoxCooldownEndTime: freeBoxCooldownEndTime,
                        ship1: ship1,
                        ship2: ship2,
                        ship3: ship3,
                        globalAttackCooldownEndTime: globalAttackCooldownEndTime,
                        rouletteCooldownEndTime: rouletteCooldownEndTime,
                        accumulatedResources: accumulatedResources 
                    });
                }
            } catch (error) {
                window.showMessage("حدث خطأ أثناء تحميل بياناتك. يرجى المحاولة لاحقاً.");
            }
            // Update UI after loading or initializing data
            updatePlayerStats();
            updateAllShipCooldowns();
            updateResourceCircle();
            updateResourceButtonState();
            updateRouletteCooldownUI();
            updateAttackCooldownsUI();
        }

        // Saves current player data to Firebase
        async function saveUserData() {
            if (!userDbRef || !userId) {
                return;
            }
            try {
                await set(userDbRef, {
                    money: playerMoney,
                    keys: playerKeys,
                    fleetName: fleetName,
                    isGoldenNameOwned: isGoldenNameOwned,
                    isGoldenNameActive: isGoldenNameActive,
                    isPinkNameOwned: isPinkNameOwned, 
                    isPinkNameActive: isPinkNameActive,
                    isFieryNameOwned: isFieryNameOwned, 
                    isFieryNameActive: isFieryNameActive,
                    isSilverNameOwned: isSilverNameOwned,
                    isSilverNameActive: isSilverNameActive,
                    isBlueGlowNameOwned: isBlueGlowNameOwned,
                    isBlueGlowNameActive: isBlueGlowNameActive,
                    isEmeraldNameOwned: isEmeraldNameOwned,
                    isEmeraldNameActive: isEmeraldNameActive,
                    isRoyalCrimsonNameOwned: isRoyalCrimsonNameOwned,
                    isRoyalCrimsonNameActive: isRoyalCrimsonNameActive,
                    isStarIconOwned: isStarIconOwned,
                    isStarIconActive: isStarIconActive,
                    isCrownIconOwned: isCrownIconOwned, 
                    isCrownIconActive: isCrownIconActive,
                    lionCount: lionCount, 
                    isLionActive: isLionActive, 
                    freeBoxCooldownEndTime: freeBoxCooldownEndTime,
                    ship1: ship1,
                    ship2: ship2,
                    ship3: ship3,
                    globalAttackCooldownEndTime: globalAttackCooldownEndTime, 
                    rouletteCooldownEndTime: rouletteCooldownEndTime,
                    accumulatedResources: accumulatedResources 
                });
            } catch (error) {
                window.showMessage("حدث خطأ أثناء حفظ بياناتك. يرجى المحاولة لاحقاً.");
            }
        }

        // Updates player's online status in public database
        async function updateOnlineStatus(isOnline) {
            if (!userId || !fleetName) return;
            try {
                const playerStatusRef = ref(db, `artifacts/${appId}/public/onlinePlayers/${userId}`);
                const dataToSave = {
                    userId: userId,
                    fleetName: fleetName,
                    power: playerPower, 
                    isOnline: isOnline,
                    lastSeen: Date.now(),
                    ship1: { power: ship1.power, level: ship1.level, unlocked: true, maxPower: ship1.maxPower }, 
                    ship2: { power: ship2.power, level: ship2.level, unlocked: ship2.unlocked, maxPower: ship2.maxPower },
                    ship3: { power: ship3.power, level: ship3.level, unlocked: ship3.unlocked, maxPower: ship3.maxPower },
                    isGoldenNameActive: isGoldenNameActive,
                    isPinkNameActive: isPinkNameActive, 
                    isFieryNameActive: isFieryNameActive, 
                    isSilverNameActive: isSilverNameActive, // New
                    isBlueGlowNameActive: isBlueGlowNameActive, // New
                    isEmeraldNameActive: isEmeraldNameActive, // New
                    isRoyalCrimsonNameActive: isRoyalCrimsonNameActive, // New
                    isStarIconActive: isStarIconActive,
                    isCrownIconActive: isCrownIconActive,
                    isLionActive: isLionActive, 
                    lionCount: lionCount 
                };
                await set(playerStatusRef, dataToSave);
            } catch (error) {
            }
        }

        // Sets up listeners for public data (online players, attack log)
        function setupPublicDataListeners() {
            if (!db) return;

            const playersRef = ref(db, `artifacts/${appId}/public/onlinePlayers`);
            onlinePlayersListener = onValue(playersRef, (snapshot) => {
                const data = snapshot.val();
                const allPlayers = [];
                if (data) {
                    for (const key in data) {
                        allPlayers.push(data[key]);
                    }
                }
                updateOnlinePlayersUI(allPlayers);
                if (document.getElementById('attackSection').classList.contains('animate-fade-in-up')) {
                    renderAttackablePlayers(allPlayers);
                }
            }, (error) => {
            });

            const attackLogRef = ref(db, `artifacts/${appId}/public/attackLog`);
            const attackLogQuery = query(attackLogRef, orderByChild('timestamp'), limitToLast(5));
            attackLogListener = onValue(attackLogQuery, (snapshot) => {
                const data = snapshot.val();
                const attacks = [];
                if (data) {
                    for (const key in data) {
                        attacks.push(data[key]);
                    }
                }
                attacks.sort((a, b) => b.timestamp - a.timestamp); 
                updateChallengeLogUI(attacks);
            }, (error) => {
            });
        }

        // Clears public data listeners when user logs out
        function clearPublicDataListeners() {
            if (onlinePlayersListener) {
                onlinePlayersListener(); 
                onlinePlayersListener = null;
            }
            if (attackLogListener) {
                attackLogListener();
                attackLogListener = null;
            }
        }

        // Updates the UI for online and offline players
        function updateOnlinePlayersUI(players) {
            if (!onlinePlayersListEl || !offlinePlayersListEl) return;

            onlinePlayersListEl.innerHTML = '';
            offlinePlayersListEl.innerHTML = '';

            const online = players.filter(p => p.isOnline && p.userId !== userId);
            const offline = players.filter(p => !p.isOnline && p.userId !== userId);

            // Calculates total power for a player, including lion power
            const getPlayerTotalPower = (playerData) => {
                let totalPower = 0;
                if (playerData.ship1 && playerData.ship1.power !== undefined) totalPower += playerData.ship1.power;
                if (playerData.ship2 && playerData.ship2.unlocked && playerData.ship2.power !== undefined) totalPower += playerData.ship2.power;
                if (playerData.ship3 && playerData.ship3.unlocked && playerData.ship3.power !== undefined) totalPower += playerData.ship3.power;
                if (playerData.lionCount !== undefined) totalPower += (playerData.lionCount * 7000); 
                return totalPower;
            };

            // Renders a single player list item
            const renderPlayerListItem = (player, isOnlineStatus) => {
                const li = document.createElement('li');
                li.className = `online-player-list-item ${isOnlineStatus ? 'online' : 'offline'}`;
                li.dataset.userId = player.userId; 

                // Determine fleet name cosmetic class
                let fleetNameClass = '';
                if (player.isGoldenNameActive) fleetNameClass = 'golden-text';
                else if (player.isPinkNameActive) fleetNameClass = 'pink-text';
                else if (player.isFieryNameActive) fleetNameClass = 'fiery-text';
                else if (player.isSilverNameActive) fleetNameClass = 'silver-text'; // New
                else if (player.isBlueGlowNameActive) fleetNameClass = 'blue-glow-text'; // New
                else if (player.isEmeraldNameActive) fleetNameClass = 'emerald-text'; // New
                else if (player.isRoyalCrimsonNameActive) fleetNameClass = 'royal-crimson-text'; // New

                const textColor = isOnlineStatus ? 'text-gray-300' : 'text-gray-500';

                let fleetNameHtml = `<span class="font-bold ${fleetNameClass}">${player.fleetName}</span>`;
                if (player.isStarIconActive) {
                    fleetNameHtml += `<i class="fas fa-star text-yellow-300 ml-1"></i>`;
                }
                if (player.isCrownIconActive) { 
                    fleetNameHtml += `<i class="fas fa-chess-king text-yellow-400 ml-1 animated-crown-icon"></i>`;
                }
                if (player.isLionActive && player.lionCount > 0) {
                    fleetNameHtml += `<img src="https://d.top4top.io/p_3482hpjya1.png" alt="Lion Icon" class="w-4 h-4 ml-1 animated-lion-icon" draggable="false">`;
                    fleetNameHtml += `<span class="text-xs text-gray-400 ml-1">x${player.lionCount}</span>`;
                }

                const totalPower = getPlayerTotalPower(player);

                let shipsHtml = `<div class="online-player-ships">`;
                const playerShips = [player.ship1, player.ship2, player.ship3];
                playerShips.forEach((shipData, index) => {
                    const shipLevel = shipData ? shipData.level : 0;
                    const shipUnlocked = (index === 0) || (shipData ? shipData.unlocked : false); 
                    const iconSrc = getShipIcon(shipLevel);
                    const iconClass = shipUnlocked ? 'unlocked' : 'locked';

                    if (iconSrc === 'font-awesome') {
                        shipsHtml += `
                            <div class="online-player-ship-icon ${iconClass}">
                                <i class="fas fa-ship ${shipUnlocked ? 'text-blue-400' : 'text-gray-500'}"></i>
                            </div>
                        `;
                    } else {
                        shipsHtml += `
                            <div class="online-player-ship-icon ${iconClass}">
                                <img src="${iconSrc}" alt="Ship ${index + 1} Icon" onerror="this.onerror=null;this.src='https://placehold.co/25x25/21262d/e2e8f0?text=X';" draggable="false" />
                            </div>
                        `;
                    }
                });
                shipsHtml += `</div>`;

                li.innerHTML = `
                    <div class="online-player-info">
                        ${fleetNameHtml}
                        <span class="text-sm ${textColor} mr-2">
                            <i class="fas fa-fist-raised text-red-500 ml-1"></i> ${formatNumber(totalPower)}
                        </span>
                    </div>
                    ${shipsHtml}
                `;
                li.addEventListener('click', () => showPlayerProfile(player)); 
                return li;
            };

            if (online.length === 0) {
                onlinePlayersListEl.innerHTML = '<p class="text-center text-gray-400">لا يوجد لاعبون متصلون حالياً غيرك.</p>';
            } else {
                online.forEach(player => {
                    const listItem = renderPlayerListItem(player, true);
                    onlinePlayersListEl.appendChild(listItem);
                });
            }

            if (offline.length === 0) {
                offlinePlayersListEl.innerHTML = '<p class="text-center text-gray-400">لا يوجد لاعبون غير متصلين حالياً.</p>';
            } else {
                offline.forEach(player => {
                    const listItem = renderPlayerListItem(player, false);
                    offlinePlayersListEl.appendChild(listItem);
                });
            }
        }

        // Updates the UI for the challenge log
        function updateChallengeLogUI(attacks) {
            if (!challengeLogListEl) return;

            challengeLogListEl.innerHTML = '';
            if (attacks.length === 0) {
                challengeLogListEl.innerHTML = '<p class="text-center text-gray-400">لا يوجد سجلات هجوم حالياً.</p>';
                return;
            }

            attacks.forEach(attack => {
                const li = document.createElement('li');
                li.className = 'bg-gray-700 p-3 rounded-md mb-2';
                let resultText = '';
                let resultColor = '';
                let winningsText = '';

                if (attack.attackerId === userId) {
                    if (attack.result === 'win') {
                        resultText = 'فزت';
                        resultColor = 'text-green-400';
                        if (attack.winnings && attack.winnings.money !== undefined) { 
                            winningsText = ` +${formatNumber(attack.winnings.money)} <i class="fas fa-dollar-sign"></i>`;
                        }
                        if (attack.winnings && attack.winnings.key !== undefined) { 
                            winningsText += ` +${attack.winnings.key} <i class="fas fa-key"></i>`;
                        }
                    } else {
                        resultText = 'خسرت';
                        resultColor = 'text-red-400';
                    }
                    li.innerHTML = `<span class="font-bold ${resultColor}">أنت</span> ${resultText} ضد <span class="font-bold">${attack.defenderFleetName}</span>. ${winningsText}`;
                } else if (attack.defenderId === userId) {
                    if (attack.result === 'win') {
                        resultText = 'فاز';
                        resultColor = 'text-green-400';
                    } else {
                        resultText = 'خسر';
                        resultColor = 'text-red-400';
                    }
                    li.innerHTML = `<span class="font-bold">${attack.attackerFleetName}</span> ${resultText} ضد <span class="font-bold ${resultColor}">أسطولك</span>.`;
                } else {
                    if (attack.result === 'win') {
                        resultText = 'فاز';
                        resultColor = 'text-green-400';
                    } else {
                        resultText = 'خسر';
                        resultColor = 'text-red-400';
                    }
                    li.innerHTML = `<span class="font-bold">${attack.attackerFleetName}</span> ${resultText} ضد <span class="font-bold">${attack.defenderFleetName}</span>.`;
                }
                
                const timestamp = typeof attack.timestamp === 'number' ? attack.timestamp : Date.now();
                li.innerHTML += `<p class="text-xs text-gray-500 mt-1">${new Date(timestamp).toLocaleString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>`;
                challengeLogListEl.appendChild(li);
            });
        }

        // Renders the list of players available to attack
        function renderAttackablePlayers(allPlayers) {
            if (!attackablePlayersListEl || !userId) return;

            attackablePlayersListEl.innerHTML = '';
            let otherPlayers = allPlayers.filter(p => p.userId !== userId);

            const cooldownActive = globalAttackCooldownEndTime > Date.now();
            if (cooldownActive && lastAttackedOpponentId) {
                const lastOpponent = otherPlayers.find(p => p.userId === lastAttackedOpponentId);
                if (lastOpponent) {
                    otherPlayers = [lastOpponent];
                } else {
                    otherPlayers = [];
                }
            }

            if (otherPlayers.length === 0) {
                attackablePlayersListEl.innerHTML = '<p class="text-center text-gray-400">لا يوجد لاعبون آخرون للهجوم عليهم حالياً.</p>';
                return;
            }

            otherPlayers.forEach(opponent => {
                const li = document.createElement('div');
                li.className = 'attack-player-item';

                let opponentTotalPower = (opponent.ship1?.power || 0) + (opponent.ship2?.unlocked ? opponent.ship2.power : 0) + (opponent.ship3?.unlocked ? opponent.ship3.power : 0);
                if (opponent.lionCount !== undefined) opponentTotalPower += (opponent.lionCount * 7000);
                
                const cooldownRemaining = globalAttackCooldownEndTime - Date.now();
                const isOnCooldown = cooldownRemaining > 0;
                const buttonText = isOnCooldown ? formatTime(cooldownRemaining) : 'هجوم';
                const buttonDisabled = isOnCooldown ? 'disabled' : '';

                // Determine opponent's fleet name cosmetic class
                let fleetNameClass = '';
                if (opponent.isGoldenNameActive) fleetNameClass = 'golden-text';
                else if (opponent.isPinkNameActive) fleetNameClass = 'pink-text';
                else if (opponent.isFieryNameActive) fleetNameClass = 'fiery-text';
                else if (opponent.isSilverNameActive) fleetNameClass = 'silver-text'; // New
                else if (opponent.isBlueGlowNameActive) fleetNameClass = 'blue-glow-text'; // New
                else if (opponent.isEmeraldNameActive) fleetNameClass = 'emerald-text'; // New
                else if (opponent.isRoyalCrimsonNameActive) fleetNameClass = 'royal-crimson-text'; // New
                
                let fleetNameHtml = `<h3 class="${fleetNameClass}">${opponent.fleetName}</h3>`;
                if (opponent.isStarIconActive) {
                    fleetNameHtml += `<i class="fas fa-star text-yellow-300 ml-1"></i>`;
                }
                if (opponent.isCrownIconActive) { 
                    fleetNameHtml += `<i class="fas fa-chess-king text-yellow-400 ml-1 animated-crown-icon"></i>`;
                }
                if (opponent.isLionActive && opponent.lionCount > 0) {
                    fleetNameHtml += `<img src="https://d.top4top.io/p_3482hpjya1.png" alt="Lion Icon" class="w-4 h-4 ml-1 animated-lion-icon" draggable="false">`;
                    fleetNameHtml += `<span class="text-xs text-gray-400 ml-1">x${opponent.lionCount}</span>`;
                }

                let shipsHtml = `<div class="online-player-ships">`;
                const opponentShips = [opponent.ship1, opponent.ship2, opponent.ship3];
                opponentShips.forEach((shipData, index) => {
                    const shipLevel = shipData ? shipData.level : 0;
                    const shipUnlocked = (index === 0) || (shipData ? shipData.unlocked : false); 
                    const iconSrc = getShipIcon(shipLevel);
                    const iconClass = shipUnlocked ? 'unlocked' : 'locked';

                    if (iconSrc === 'font-awesome') {
                        shipsHtml += `
                            <div class="online-player-ship-icon ${iconClass}">
                                <i class="fas fa-ship ${shipUnlocked ? 'text-blue-400' : 'text-gray-500'}"></i>
                            </div>
                        `;
                    } else {
                        shipsHtml += `
                            <div class="online-player-ship-icon ${iconClass}">
                                <img src="${iconSrc}" alt="Ship ${index + 1} Icon" onerror="this.onerror=null;this.src='https://placehold.co/25x25/21262d/e2e8f0?text=X';" draggable="false" />
                            </div>
                        `;
                    }
                });
                shipsHtml += `</div>`;

                li.innerHTML = `
                    <div class="player-info">
                        ${fleetNameHtml}
                        <p>
                            <i class="fas fa-fist-raised text-red-500"></i> ${formatNumber(opponentTotalPower)}
                        </p>
                    </div>
                    <div class="attack-btn-wrapper">
                        <button class="attack-player-btn" data-opponent-id="${opponent.userId}" ${buttonDisabled}>
                            ${buttonText}
                        </button>
                    </div>
                `;
                attackablePlayersListEl.appendChild(li);

                const attackButton = li.querySelector('.attack-player-btn');
                attackButton.addEventListener('click', () => performAttack(opponent));

                li.querySelector('.player-info').addEventListener('click', (event) => {
                    event.stopPropagation();
                    showPlayerProfile(opponent);
                });
            });
        }

        // Performs an attack on an opponent
        async function performAttack(opponent) {
            if (!opponent) {
                window.showMessage("الرجاء اختيار خصم أولاً.");
                return;
            }
            if (globalAttackCooldownEndTime > Date.now()) {
                window.showMessage(`لا يمكنك الهجوم الآن. يرجى الانتظار ${formatTime(globalAttackCooldownEndTime - Date.now())}.`);
                return;
            }

            let win = false;
            let opponentTotalPower = (opponent.ship1?.power || 0) + (opponent.ship2?.unlocked ? opponent.ship2.power : 0) + (opponent.ship3?.unlocked ? opponent.ship3.power : 0);
            if (opponent.lionCount !== undefined) opponentTotalPower += (opponent.lionCount * 7000);

            if (playerPower > opponentTotalPower) {
                win = Math.random() < 0.9; 
            } else {
                win = Math.random() < 0.4; 
            }

            let winnings = { money: 0, key: 0 };
            let resultText = '';

            if (win) {
                const moneyGain = Math.floor(Math.random() * (800 - 200 + 1)) + 200;
                playerMoney += moneyGain;
                winnings.money = moneyGain;
                resultText = `لقد فزت! حصلت على ${formatNumber(moneyGain)} أموال.`;

                if (Math.random() < 0.15) {
                    playerKeys += 1;
                    winnings.key = 1;
                    resultText += " وحصلت على مفتاح!";
                }
            } else {
                resultText = "لقد خسرت الهجوم. لم تخسر شيئاً.";
            }

            window.showMessage(resultText);
            updatePlayerStats();

            globalAttackCooldownEndTime = Date.now() + ATTACK_COOLDOWN_GLOBAL_MS;
            lastAttackedOpponentId = opponent.userId; 
            await saveUserData();
            
            if (document.getElementById('attackSection').classList.contains('animate-fade-in-up')) {
                const playersRef = ref(db, `artifacts/${appId}/public/onlinePlayers`);
                get(playersRef).then(snapshot => {
                    const data = snapshot.val();
                    const allPlayers = [];
                    if (data) {
                        for (const key in data) {
                            allPlayers.push(data[key]);
                        }
                    }
                    renderAttackablePlayers(allPlayers);
                }).catch(error => {
                    window.showMessage("حدث خطأ أثناء تحميل قائمة اللاعبين للهجوم.");
                });
            }

            try {
                const attackLogRef = ref(db, `artifacts/${appId}/public/attackLog`);
                await push(attackLogRef, {
                    attackerId: userId,
                    attackerFleetName: fleetName,
                    defenderId: opponent.userId,
                    defenderFleetName: opponent.fleetName,
                    result: win ? 'win' : 'loss',
                    winnings: winnings,
                    timestamp: serverTimestamp() 
                });
            } catch (error) {
            }
        }

        // Updates the cooldown display for attack buttons
        function updateAttackCooldownsUI() {
            const cooldownRemaining = globalAttackCooldownEndTime - Date.now();
            const isOnCooldown = cooldownRemaining > 0;

            const attackButtons = attackablePlayersListEl.querySelectorAll('.attack-player-btn');
            attackButtons.forEach(button => {
                if (isOnCooldown) {
                    button.disabled = true;
                    button.textContent = formatTime(cooldownRemaining);
                } else {
                    button.disabled = false;
                    button.textContent = 'هجوم';
                }
            });

            if (lastGlobalCooldownState && !isOnCooldown) {
                lastAttackedOpponentId = null; 
                if (document.getElementById('attackSection').classList.contains('animate-fade-in-up')) {
                    if (db) {
                        const playersRef = ref(db, `artifacts/${appId}/public/onlinePlayers`);
                        get(playersRef).then(snapshot => {
                            const data = snapshot.val();
                            const allPlayers = [];
                            if (data) {
                                for (const key in data) {
                                    allPlayers.push(data[key]);
                                }
                            }
                            renderAttackablePlayers(allPlayers);
                        }).catch(error => {
                            window.showMessage("حدث خطأ أثناء تحميل قائمة اللاعبين للهجوم.");
                        });
                    }
                }
            }
            lastGlobalCooldownState = isOnCooldown; 
        }

        // Populates the ship forms list in the Developments section
        function populateShipFormsList() {
            if (!shipFormsList) return;
            shipFormsList.innerHTML = '';
            shipFormsData.forEach(form => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('ship-form-item');

                let iconHtml = '';
                if (form.iconType === 'font-awesome') {
                    iconHtml = `<i class="${form.iconClass} text-blue-400"></i>`;
                } else {
                    iconHtml = `<img src="${form.imgSrc}" alt="Image of Ship Form" onerror="this.onerror=null;this.src='https://placehold.co/50x50/21262d/e2e8f0?text=X';" draggable="false" />`;
                }

                itemDiv.innerHTML = `
                    <div class="icon-wrapper">
                        ${iconHtml}
                    </div>
                    <div class="text-content">
                        <h4>المستوى: ${form.levelRange}</h4>
                        <p>شكل السفينة</p>
                    </div>
                `;
                shipFormsList.appendChild(itemDiv);
            });
        }

        // Updates player stats and UI elements
        function updatePlayerStats() {
            let baseShipPower = ship1.power + (ship2.unlocked ? ship2.power : 0) + (ship3.unlocked ? ship3.power : 0);
            playerPower = baseShipPower + (lionCount * 7000); 

            playerPowerEl.textContent = formatNumber(playerPower);
            playerMoneyEl.textContent = formatNumber(playerMoney);
            playerKeysEl.textContent = formatNumber(playerKeys);
            fleetNameEl.textContent = fleetName;
            
            // Remove all existing name cosmetic classes
            fleetNameEl.classList.remove('golden-text', 'pink-text', 'fiery-text', 'silver-text', 'blue-glow-text', 'emerald-text', 'royal-crimson-text');
            
            // Apply the active name cosmetic class
            if (isGoldenNameActive) {
                fleetNameEl.classList.add('golden-text');
            } else if (isPinkNameActive) { 
                fleetNameEl.classList.add('pink-text');
            } else if (isFieryNameActive) { 
                fleetNameEl.classList.add('fiery-text');
            } else if (isSilverNameActive) { 
                fleetNameEl.classList.add('silver-text');
            } else if (isBlueGlowNameActive) { 
                fleetNameEl.classList.add('blue-glow-text');
            } else if (isEmeraldNameActive) { 
                fleetNameEl.classList.add('emerald-text');
            } else if (isRoyalCrimsonNameActive) { 
                fleetNameEl.classList.add('royal-crimson-text');
            }

            // Handle icon visibility and animation
            fleetStarIconEl.classList.toggle('hidden', !isStarIconActive);
            fleetCrownIconEl.classList.toggle('hidden', !isCrownIconActive);
            fleetCrownIconEl.classList.toggle('animated-crown-icon', isCrownIconActive);
            
            fleetLionIconEl.classList.toggle('hidden', lionCount === 0 || !isLionActive); 
            fleetLionIconEl.classList.toggle('animated-lion-icon', isLionActive); 
            lionCountDisplayEl.classList.toggle('hidden', lionCount === 0 || !isLionActive); 
            lionCountDisplayEl.textContent = `x${lionCount}`;

            saveUserData(); 
        }

        // Formats milliseconds into MM:SS string
        function formatTime(ms) {
            if (ms <= 0) return 'جاهز';
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Gets the appropriate ship icon based on level
        function getShipIcon(level) {
            if (level >= 10000) {
                return 'https://c.top4top.io/p_3482878s83.png'; 
            } else if (level >= 4001) {
                return 'https://b.top4top.io/p_3482vv1ax2.png'; 
            } else if (level >= 1001) {
                return 'https://l.top4top.io/p_3482en0id0.png'; 
            } else {
                return 'font-awesome'; 
            }
        }

        // Updates the UI for a single ship
        function updateShipUI(ship, powerEl, levelEl, progressEl, upgradeBtn, containerEl, cooldownDisplayEl, maxPowerEl, iconContainerEl, iconIEl, iconImgEl) {
            powerEl.textContent = formatNumber(ship.power);
            levelEl.textContent = formatNumber(ship.level);
            maxPowerEl.textContent = formatNumber(ship.maxPower);
            const progress = (ship.power / ship.maxPower) * 100;
            progressEl.style.width = `${progress}%`;

            const currentTime = Date.now();
            const isOnCooldown = ship.cooldownEndTime > currentTime;

            if (ship.power >= ship.maxPower) {
                upgradeBtn.disabled = true;
                upgradeBtn.textContent = 'مطور بالكامل';
                upgradeBtn.classList.remove('btn-primary');
                upgradeBtn.classList.add('btn-success');
                cooldownDisplayEl.textContent = '';
                cooldownDisplayEl.classList.remove('cooldown-active');
            } else if (isOnCooldown) {
                upgradeBtn.disabled = true;
                upgradeBtn.textContent = 'في انتظار';
                upgradeBtn.classList.remove('btn-primary');
                cooldownDisplayEl.textContent = `متاح بعد: ${formatTime(ship.cooldownEndTime - currentTime)}`;
                cooldownDisplayEl.classList.add('cooldown-active');
            } else {
                upgradeBtn.disabled = false;
                upgradeBtn.textContent = 'تطوير';
                upgradeBtn.classList.remove('btn-success');
                upgradeBtn.classList.add('btn-primary');
                cooldownDisplayEl.textContent = 'جاهز للتطوير';
                cooldownDisplayEl.classList.remove('cooldown-active');
            }

            if (containerEl) {
                if (ship.unlocked) {
                    containerEl.classList.remove('opacity-50', 'pointer-events-none');
                    containerEl.querySelector('h3').classList.remove('text-gray-400');
                    containerEl.querySelector('h3').classList.add('text-blue-400');
                } else {
                    containerEl.classList.add('opacity-50', 'pointer-events-none');
                    containerEl.querySelector('h3').classList.remove('text-blue-400');
                    containerEl.querySelector('h3').classList.add('text-gray-400');
                }
            }

            const iconSrc = getShipIcon(ship.level);

            if (iconSrc === 'font-awesome') {
                if (iconIEl) {
                    iconIEl.style.display = '';
                    iconIEl.className = 'fas fa-ship';
                    if (ship.unlocked || ship === ship1) {
                        iconIEl.classList.remove('text-gray-500');
                        iconIEl.classList.add('text-blue-400');
                    } else {
                        iconIEl.classList.remove('text-blue-400');
                        iconIEl.classList.add('text-gray-500');
                    }
                }
                if (iconImgEl) {
                    iconImgEl.style.display = 'none';
                }
            } else {
                if (iconIEl) {
                    iconIEl.style.display = 'none';
                }
                if (iconImgEl) {
                    iconImgEl.style.display = '';
                    iconImgEl.src = iconSrc;
                }
            }
        }

        // Upgrades a ship
        function upgradeShip(ship) {
            const currentTime = Date.now();
            if (ship.power >= ship.maxPower) {
                window.showMessage('هذه السفينة مطورة بالكامل بالفعل!');
                return;
            }
            if (ship.cooldownEndTime > currentTime) {
                window.showMessage(`هذه السفينة في فترة انتظار. يرجى الانتظار ${formatTime(ship.cooldownEndTime - currentTime)}.`);
                return;
            }

            const powerGain = Math.floor(Math.random() * (325 - 45 + 1)) + 45;
            ship.power += powerGain;
            ship.level = Math.min(ship.maxPower, ship.power);

            if (ship.power > ship.maxPower) {
                ship.power = ship.maxPower;
            }

            ship.cooldownEndTime = currentTime + UPGRADE_COOLDOWN_MS;

            updatePlayerStats(); 
            updateShipUI(ship,
                ship === ship1 ? ship1PowerEl : (ship === ship2 ? ship2PowerEl : ship3PowerEl),
                ship === ship1 ? ship1LevelEl : (ship === ship2 ? ship2LevelEl : ship3LevelEl),
                ship === ship1 ? ship1ProgressEl : (ship === ship2 ? ship2ProgressEl : ship3ProgressEl),
                ship === ship1 ? upgradeShip1Btn : (ship === ship2 ? upgradeShip2Btn : upgrade3Btn),
                ship === ship1 ? null : (ship === ship2 ? ship2Container : ship3Container),
                ship === ship1 ? ship1CooldownDisplay : (ship === ship2 ? ship2CooldownDisplay : ship3CooldownDisplay),
                ship === ship1 ? ship1MaxPowerEl : (ship === ship2 ? ship2MaxPowerEl : ship3MaxPowerEl),
                ship === ship1 ? ship1IconContainerEl : (ship === ship2 ? ship2IconContainerEl : ship3IconContainerEl),
                ship === ship1 ? ship1IconIEl : (ship === ship2 ? ship2IconIEl : ship3IconIEl),
                ship === ship1 ? ship1IconImgEl : (ship === ship2 ? ship2IconImgEl : ship3IconImgEl)
            );
            
            if (ship === ship1 && ship1.power >= ship1.maxPower && !ship2.unlocked) {
                ship2.unlocked = true;
                updateShipUI(ship2, ship2PowerEl, ship2LevelEl, ship2ProgressEl, upgradeShip2Btn, ship2Container, ship2CooldownDisplay, ship2MaxPowerEl, ship2IconContainerEl, ship2IconIEl, ship2IconImgEl);
                window.showMessage('تم فتح السفينة الثانية!');
            } else if (ship === ship2 && ship2.power >= ship2.maxPower && !ship3.unlocked) {
                ship3.unlocked = true;
                updateShipUI(ship3, ship3PowerEl, ship3LevelEl, ship3ProgressEl, upgradeShip3Btn, ship3Container, ship3CooldownDisplay, ship3MaxPowerEl, ship3IconContainerEl, ship3IconIEl, ship3IconImgEl);
                window.showMessage('تم فتح السفينة الثالثة!');
            }
        }

        // Updates cooldowns for all ships
        function updateAllShipCooldowns() {
            updateShipUI(ship1, ship1PowerEl, ship1LevelEl, ship1ProgressEl, upgradeShip1Btn, null, ship1CooldownDisplay, ship1MaxPowerEl, ship1IconContainerEl, ship1IconIEl, ship1IconImgEl);
            if (ship2.unlocked) {
                updateShipUI(ship2, ship2PowerEl, ship2LevelEl, ship2ProgressEl, upgradeShip2Btn, ship2Container, ship2CooldownDisplay, ship2MaxPowerEl, ship2IconContainerEl, ship2IconIEl, ship2IconImgEl);
            }
            if (ship3.unlocked) {
                updateShipUI(ship3, ship3PowerEl, ship3LevelEl, ship3ProgressEl, upgradeShip3Btn, ship3Container, ship3CooldownDisplay, ship3MaxPowerEl, ship3IconContainerEl, ship3IconIEl, ship3IconImgEl);
            }
            saveUserData(); 
        }

        // Updates the resource collection circle UI
        function updateResourceCircle() {
            const percentage = (accumulatedResources / MAX_ACCUMULATED_RESOURCES) * 100;
            const offset = circumference - (percentage / 100) * circumference;
            circleProgress.style.strokeDashoffset = offset;
            accumulatedResourcesDisplay.textContent = `${accumulatedResources}/${MAX_ACCUMULATED_RESOURCES}`;
        }

        // Updates the state of the resource collection button
        function updateResourceButtonState() {
            if (resourceBtnTextEl && resourceBtnIconEl && circleProgress) { 
                if (accumulatedResources > 0) {
                    resourceCollectionBtnWrapper.classList.remove('opacity-50', 'pointer-events-none');
                    resourceBtnTextEl.textContent = 'استلام';
                    resourceBtnIconEl.classList.remove('text-gray-400');
                    resourceBtnIconEl.classList.add('text-white');
                    circleProgress.style.stroke = '#f39c12'; 
                } else {
                    resourceCollectionBtnWrapper.classList.add('opacity-50', 'pointer-events-none');
                    resourceBtnTextEl.textContent = 'لا توجد موارد';
                    resourceBtnIconEl.classList.add('text-gray-400');
                    resourceBtnIconEl.classList.remove('text-white');
                    circleProgress.style.stroke = '#3b4554'; 
                }
            }
        }

        // Automatically accumulates resources over time
        function autoAccumulateResources() {
            if (accumulatedResources < MAX_ACCUMULATED_RESOURCES) {
                const collectedAmount = Math.floor(Math.random() * 6) + 1;
                accumulatedResources = Math.min(MAX_ACCUMULATED_RESOURCES, accumulatedResources + collectedAmount);
                updateResourceCircle();
            }
            updateResourceButtonState(); 
        }

        // Collects accumulated resources
        function collectAccumulatedResources() {
            if (accumulatedResources > 0) {
                playerMoney += accumulatedResources;
                window.showMessage(`لقد استلمت ${accumulatedResources} من الموارد!`);
                accumulatedResources = 0;
                updatePlayerStats(); 
                updateResourceCircle();
                updateResourceButtonState(); 
            } else {
                window.showMessage('لا توجد موارد لتجميعها حالياً!');
            }
        }

        // Shows details for a store item
        window.showStoreItemDetail = function(itemKey) {
            currentStoreItemKey = itemKey;
            const item = storeItems[itemKey];

            if (itemKey === 'shipExpansion') {
                window.openShipSelectionModal();
                return;
            }

            storeItemTitle.textContent = item.title;
            
            if (item.iconType === 'font-awesome') {
                storeItemIcon.className = `item-icon ${item.icon}`;
                storeItemIcon.classList.remove('hidden');
                storeItemIconImg.classList.add('hidden');
            } else {
                storeItemIconImg.src = item.icon;
                storeItemIconImg.classList.remove('hidden');
                storeItemIcon.classList.add('hidden');
            }

            storeItemDescription.textContent = item.description;
            
            let priceHtml = '';
            if (item.currency === 'none') {
                priceHtml = item.price;
            } else {
                priceHtml = `${item.price} `;
                if (item.currency === 'key') {
                    priceHtml += `<i class="fas fa-key text-yellow-400"></i>`;
                } else if (item.currency === 'money') {
                    priceHtml += `<i class="fas fa-dollar-sign text-green-400"></i>`;
                }
            }
            storeItemPrice.innerHTML = priceHtml;

            // Remove all existing name cosmetic classes from title
            storeItemTitle.classList.remove('golden-text', 'pink-text', 'fiery-text', 'silver-text', 'blue-glow-text', 'emerald-text', 'royal-crimson-text');
            // Apply specific cosmetic class if available
            if (item.cssClass) {
                storeItemTitle.classList.add(item.cssClass);
            }

            const buyBtn = document.getElementById('buyStoreItemBtn');
            const currentTime = Date.now();

            if (item.type === 'name_cosmetic' || item.type === 'icon_cosmetic') {
                const isOwned = (item.ownedKey === 'lionCount') ? (lionCount > 0) : window[item.ownedKey];
                const isActive = window[item.activeKey];

                if (isOwned) {
                    if (!isActive) { 
                        buyBtn.textContent = 'تفعيل';
                        buyBtn.classList.remove('bg-gray-600');
                        buyBtn.classList.add('bg-blue-600');
                    } else { 
                        buyBtn.textContent = 'إلغاء تفعيل';
                        buyBtn.classList.remove('bg-blue-600');
                        buyBtn.classList.add('bg-gray-600');
                    }
                    buyBtn.disabled = false; 
                } else {
                    buyBtn.textContent = 'شراء';
                    buyBtn.classList.remove('bg-gray-600');
                    buyBtn.classList.add('bg-blue-600');
                    if (itemKey === 'lionIcon') {
                        buyBtn.disabled = true;
                        buyBtn.textContent = 'يمكن الحصول عليه من صندوق الحظ';
                    } else {
                        buyBtn.disabled = false;
                    }
                }
            } else if (item.type === 'free_box') {
                if (freeBoxCooldownEndTime > currentTime) {
                    buyBtn.disabled = true;
                    buyBtn.textContent = `متاح بعد: ${formatTime(freeBoxCooldownEndTime - currentTime)}`;
                } else {
                    buyBtn.disabled = false;
                    buyBtn.textContent = 'افتح الصندوق';
                }
            } else { 
                buyBtn.textContent = 'شراء';
                buyBtn.classList.remove('bg-gray-600');
                buyBtn.classList.add('bg-blue-600');
                buyBtn.disabled = false;
            }

            storeItemDetailModal.style.display = 'flex';
        }

        // Closes the store item detail modal
        window.closeStoreItemDetailModal = function(returnToStore = false) {
            storeItemDetailModal.style.display = 'none';
            storeItemTitle.classList.remove('golden-text', 'pink-text', 'fiery-text', 'silver-text', 'blue-glow-text', 'emerald-text', 'royal-crimson-text'); 
            storeItemIcon.classList.add('hidden'); 
            storeItemIconImg.classList.add('hidden'); 
            currentStoreItemKey = null;
            if (returnToStore) {
                window.showSection('store');
            }
        }

        // Handles buying a store item
        async function buyStoreItem() {
            if (!currentStoreItemKey) return;

            const item = storeItems[currentStoreItemKey];
            let canAfford = false;
            let message = '';
            const currentTime = Date.now();

            if (item.type === 'utility') {
                if (item.currency === 'key') {
                    if (playerKeys >= item.price) {
                        playerKeys -= item.price;
                        canAfford = true;
                    } else {
                        message = `ليس لديك ما يكفي من المفاتيح لشراء هذا العنصر (${formatNumber(item.price)} مفتاح).`;
                    }
                } else if (item.currency === 'money') {
                    if (playerMoney >= item.price) {
                        playerMoney -= item.price;
                        canAfford = true;
                    } else {
                        message = `ليس لديك ما يكفي من الأموال لشراء هذا العنصر (${formatNumber(item.price)} أموال).`;
                    }
                }
            } else if (item.type === 'lucky_box') { 
                if (playerMoney >= item.price) {
                    playerMoney -= item.price;
                    canAfford = true;
                    let prizeMessage = "لقد فتحت صندوق الحظ وحصلت على: ";
                    const rand = Math.random() * 100;

                    if (rand < 9) { 
                        lionCount++; 
                        isLionActive = true; 
                        message = prizeMessage + `الأسد المتوهج! (7000 قوة إضافية). لديك الآن ${lionCount} أسد متوهج.`;
                    } else if (rand < (9 + 15)) { 
                        const moneyGain = Math.floor(Math.random() * (1900 - 500 + 1)) + 500;
                        playerMoney += moneyGain;
                        message = prizeMessage + `${formatNumber(moneyGain)} أموال!`;
                    } else if (rand < (9 + 15 + 30)) { 
                        const powerGain = Math.floor(Math.random() * (2500 - 500 + 1)) + 500;
                        ship1.power += powerGain; 
                        ship1.level = Math.min(ship1.maxPower, ship1.power);
                        message = prizeMessage + `${formatNumber(powerGain)} قوة لسفينتك الأساسية!`;
                    } else { 
                        const keysGain = Math.floor(Math.random() * (25 - 14 + 1)) + 14;
                        playerKeys += keysGain;
                        message = prizeMessage + `${keysGain} مفتاح!`;
                    }
                } else {
                    message = `ليس لديك ما يكفي من الأموال لشراء صندوق الحظ (${formatNumber(item.price)} أموال).`;
                }
            } else if (item.type === 'free_box') { // Handle Free Box
                if (freeBoxCooldownEndTime > currentTime) {
                    message = `الصندوق المجاني متاح بعد: ${formatTime(freeBoxCooldownEndTime - currentTime)}.`;
                } else {
                    canAfford = true; // It's free
                    let prizeMessage = "لقد فتحت الصندوق المجاني وحصلت على: ";
                    const rand = Math.random() * 100;

                    if (rand < 90) { // 90% money
                        const moneyGain = Math.floor(Math.random() * (200 - 40 + 1)) + 40;
                        playerMoney += moneyGain;
                        message = prizeMessage + `${formatNumber(moneyGain)} أموال!`;
                    } else { // 10% keys
                        const keysGain = Math.floor(Math.random() * (8 - 2 + 1)) + 2;
                        playerKeys += keysGain;
                        message = prizeMessage + `${keysGain} مفتاح!`;
                    }
                    freeBoxCooldownEndTime = currentTime + FREE_BOX_COOLDOWN_MS;
                }
            } else if (item.type === 'name_cosmetic' || item.type === 'icon_cosmetic') {
                const isOwned = (item.ownedKey === 'lionCount') ? (lionCount > 0) : window[item.ownedKey];
                const isActive = window[item.activeKey];

                if (isOwned) {
                    if (item.type === 'name_cosmetic') {
                        // Deactivate all name cosmetics first
                        isGoldenNameActive = false;
                        isPinkNameActive = false;
                        isFieryNameActive = false;
                        isSilverNameActive = false; // New
                        isBlueGlowNameActive = false; // New
                        isEmeraldNameActive = false; // New
                        isRoyalCrimsonNameActive = false; // New
                        if (!isActive) { 
                            window[item.activeKey] = true;
                            message = `تم تفعيل "${item.title}" بنجاح!`;
                        } else { 
                            message = `تم إلغاء تفعيل "${item.title}".`;
                        }
                    } else if (item.type === 'icon_cosmetic') {
                        // Deactivate all icon cosmetics first
                        isStarIconActive = false;
                        isCrownIconActive = false;
                        isLionActive = false; 
                        if (!isActive) { 
                            window[item.activeKey] = true;
                            message = `تم تفعيل "${item.title}" بنجاح!`;
                        } else { 
                            message = `تم إلغاء تفعيل "${item.title}".`;
                        }
                    }
                    canAfford = true; 
                } else { 
                    if (item.currency === 'key') {
                        if (playerKeys >= item.price) {
                            playerKeys -= item.price;
                            canAfford = true;
                        } else {
                            message = `ليس لديك ما يكفي من المفاتيح لشراء هذا العنصر (${formatNumber(item.price)} مفتاح).`;
                        }
                    } else if (item.currency === 'money') {
                        if (playerMoney >= item.price) {
                            playerMoney -= item.price;
                            canAfford = true;
                        } else {
                            message = `ليس لديك ما يكفي من الأموال لشراء هذا العنصر (${formatNumber(item.price)} أموال).`;
                        }
                    }

                    if (canAfford) {
                        window[item.ownedKey] = true;
                        if (item.type === 'name_cosmetic') {
                            isGoldenNameActive = false;
                            isPinkNameActive = false;
                            isFieryNameActive = false;
                            isSilverNameActive = false; // New
                            isBlueGlowNameActive = false; // New
                            isEmeraldNameActive = false; // New
                            isRoyalCrimsonNameActive = false; // New
                            window[item.activeKey] = true;
                        } else if (item.type === 'icon_cosmetic') {
                            isStarIconActive = false;
                            isCrownIconActive = false;
                            isLionActive = false; 
                            window[item.activeKey] = true;
                        }
                        message = `تهانينا! لقد اشتريت "${item.title}" وتم تفعيله!`;
                    }
                }
            }

            if (canAfford) {
                if (currentStoreItemKey === 'completeUpgrade') {
                    let shipsOnCooldown = 0;
                    if (ship1.cooldownEndTime > currentTime) { ship1.cooldownEndTime = 0; shipsOnCooldown++; }
                    if (ship2.unlocked && ship2.cooldownEndTime > currentTime) { ship2.cooldownEndTime = 0; shipsOnCooldown++; }
                    if (ship3.unlocked && ship3.cooldownEndTime > currentTime) { ship3.cooldownEndTime = 0; shipsOnCooldown++; }

                    if (shipsOnCooldown > 0) {
                        updateAllShipCooldowns(); 
                        message = 'تم إكمال تطوير السفن بنجاح!';
                    } else {
                        if (item.currency === 'key') playerKeys += item.price; 
                        else playerMoney += item.price; 
                        message = 'لا توجد سفن في فترة انتظار حالياً لإكمال تطويرها.';
                        canAfford = false;
                    }
                } 
            }
            
            updatePlayerStats();
            updateAllShipCooldowns(); 
            window.showMessage(message);
            window.closeStoreItemDetailModal(true);
        }

        // Opens the ship selection modal for ship expansion
        window.openShipSelectionModal = function() {
            document.getElementById('shipExpansionModalPrice').innerHTML = `${formatNumber(storeItems.shipExpansion.price)} <i class="fas fa-key text-yellow-400"></i>`;

            let shipSelectionOptions = document.getElementById('shipSelectionOptions');
            shipSelectionOptions.innerHTML = '';
            const ships = [
                { id: 'ship1', name: 'السفينة الأساسية', obj: ship1 },
                { id: 'ship2', name: 'السفينة الثانية', obj: ship2 },
                { id: 'ship3', name: 'السفينة الثالثة', obj: ship3 }
            ];

            ships.forEach(s => {
                if (s.obj.unlocked || s.id === 'ship1') {
                    const optionDiv = document.createElement('div');
                    optionDiv.classList.add('ship-selection-option');
                    optionDiv.innerHTML = `
                        <label for="select-${s.id}">${s.name} (القوة القصوى الحالية: ${formatNumber(s.obj.maxPower)})</label>
                        <input type="radio" id="select-${s.id}" name="selectedShip" value="${s.id}">
                    `;
                    shipSelectionOptions.appendChild(optionDiv);

                    optionDiv.addEventListener('click', () => {
                        document.querySelectorAll('.ship-selection-option').forEach(opt => opt.classList.remove('selected'));
                        optionDiv.classList.add('selected');
                        optionDiv.querySelector('input[type="radio"]').checked = true;
                    });
                }
            });

            document.getElementById('shipSelectionModal').style.display = 'flex';
        }

        // Closes the ship selection modal
        window.closeShipSelectionModal = function() {
            document.getElementById('shipSelectionModal').style.display = 'none';
            window.showSection('store');
        }

        // Confirms and performs ship expansion
        async function confirmShipExpansion() {
            const selectedRadio = document.querySelector('input[name="selectedShip"]:checked');
            let message = '';
            let purchaseSuccessful = false;

            if (!selectedRadio) {
                message = 'الرجاء اختيار سفينة لتوسيعها.';
            } else {
                const selectedShipId = selectedRadio.value;
                let targetShip;
                if (selectedShipId === 'ship1') targetShip = ship1;
                else if (selectedShipId === 'ship2') targetShip = ship2;
                else if (selectedShipId === 'ship3') targetShip = ship3;

                const item = storeItems['shipExpansion'];
                if (playerKeys >= item.price) { 
                    playerKeys -= item.price; 
                    targetShip.maxPower += 5000;
                    updatePlayerStats();
                    updateAllShipCooldowns();
                    message = `تم توسيع ${targetShip.name === ship1.name ? 'السفينة الأساسية' : targetShip.name} بنجاح! الحد الأقصى الجديد: ${formatNumber(targetShip.maxPower)}.`;
                    purchaseSuccessful = true;
                } else {
                    message = `ليس لديك ما يكفي من المفاتيح لشراء توسيع السفينة (${formatNumber(item.price)} مفتاح).`; 
                }
            }
            
            window.showMessage(message);
            window.closeShipSelectionModal();
        }

        // Opens the modal for changing fleet name
        function openChangeFleetNameModal() {
            changeFleetNameInput.value = fleetName;
            changeFleetNameModal.style.display = 'flex';
        }

        // Closes the modal for changing fleet name
        function closeChangeFleetNameModal() {
            changeFleetNameModal.style.display = 'none';
        }

        // Confirms and applies the new fleet name
        async function confirmChangeFleetName() {
            const newName = changeFleetNameInput.value.trim();
            if (newName && newName !== fleetName) {
                fleetName = newName;
                updatePlayerStats();
                window.showMessage('تم تغيير اسم الأسطول بنجاح!');
                closeChangeFleetNameModal();
            } else if (newName === fleetName) {
                window.showMessage('الاسم الجديد هو نفس الاسم الحالي.');
            } else {
                window.showMessage('الرجاء إدخال اسم صالح لأسطولك.');
            }
        }

        // Shows a specific game section and hides others
        window.showSection = function(sectionId) {
            const sections = [mainMenuSection, myFleetSection, storeSection, onlineSection, rouletteSection, developmentsSection, challengeLogSection, attackSection, onlinePlayersSection];

            sections.forEach(section => {
                section.classList.remove('animate-fade-in-up');
                section.classList.add('hidden');
            });

            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('animate-fade-in-up');
            }

            currentActiveSectionId = sectionId;

            if (sectionId === 'mainMenu') {
                resourceCollectionBtnWrapper.classList.remove('hidden');
            } else {
                resourceCollectionBtnWrapper.classList.add('hidden');
            }

            if (sectionId === 'developmentsSection') {
                populateShipFormsList();
            }
            if (sectionId === 'attackSection') {
                if (db) {
                    const playersRef = ref(db, `artifacts/${appId}/public/onlinePlayers`);
                    get(playersRef).then(snapshot => {
                        const data = snapshot.val();
                        const allPlayers = [];
                        if (data) {
                            for (const key in data) {
                                allPlayers.push(data[key]);
                            }
                        }
                        renderAttackablePlayers(allPlayers);
                    }).catch(error => {
                        window.showMessage("حدث خطأ أثناء تحميل قائمة اللاعبين للهجوم.");
                    });
                }
            }
        }

        // Updates the cooldown display for the roulette game
        function updateRouletteCooldownUI() {
            const currentTime = Date.now();
            const remainingTime = rouletteCooldownEndTime - currentTime;

            if (remainingTime > 0) {
                rouletteGameElements.classList.add('hidden');
                rouletteCooldownDisplay.classList.remove('hidden');
                rouletteCooldownDisplay.textContent = `الجولة القادمة بعد: ${formatTime(remainingTime)}`;
            } else {
                rouletteGameElements.classList.remove('hidden');
                rouletteCooldownDisplay.classList.add('hidden');

                if (!gameActive) {
                    startGameBtn.classList.remove('hidden');
                    betAmountInput.disabled = false;
                    cashOutBtn.classList.add('hidden');
                    cashOutBtn.disabled = true;
                    multiplierDisplay.textContent = '1.00x';
                    potentialWinningsEl.textContent = '0';
                    rouletteResult.classList.add('hidden');
                    rouletteDisplayArea.classList.remove('crashed');
                    
                    const currentDisplayAreaHeight = rouletteDisplayArea.clientHeight;
                    const planeHeight = planeSvg.offsetHeight;
                    planeSvg.style.transform = `translate(10px, ${currentDisplayAreaHeight - planeHeight - 15}px)`;
                }
            }
        }

        // Generates a random crash point for the roulette game
        function generateCrashPoint() {
            const rand = Math.random();
            if (rand < 0.60) {
                return 1.01 + Math.random() * (4.0 - 1.01);
            } else if (rand < 0.80) {
                return 4.1 + Math.random() * (7.7 - 4.1);
            } else {
                return 10.0 + Math.random() * (25.5 - 10.0);
            }
        }

        // Animates the plane in the roulette game
        function animatePlane(timestamp) {
            if (!lastFrameTime) {
                lastFrameTime = timestamp;
            }
            const deltaTime = timestamp - lastFrameTime;
            lastFrameTime = timestamp;

            const multiplierIncreaseRate = 0.007;
            currentMultiplier += multiplierIncreaseRate * (deltaTime / 100);

            multiplierDisplay.textContent = currentMultiplier.toFixed(2) + 'x';
            potentialWinningsEl.textContent = Math.round(betAmount * currentMultiplier);

            const displayAreaWidth = rouletteDisplayArea.clientWidth;
            const displayAreaHeight = rouletteDisplayArea.clientHeight;
            const planeWidth = planeSvg.offsetWidth; 
            const planeHeight = planeSvg.offsetHeight; 
            
            const maxVisualMultiplier = 30;
            const minMultiplierForVisual = 1.0;

            let normalizedMultiplier = (currentMultiplier - minMultiplierForVisual) / (maxVisualMultiplier - minMultiplierForVisual);
            normalizedMultiplier = Math.max(0, Math.min(normalizedMultiplier, 1));

            const paddingX = 20;
            const paddingY = 15;

            let planeX = normalizedMultiplier * (displayAreaWidth - planeWidth - (2 * paddingX)) + paddingX;

            let planeY = (1 - normalizedMultiplier) * (displayAreaHeight - planeHeight - (2 * paddingY)) + paddingY;

            planeSvg.style.transform = `translate(${planeX}px, ${planeY}px)`;

            if (currentMultiplier < crashPoint && gameActive && !hasCashedOut) {
                animationFrameId = requestAnimationFrame(animatePlane);
            } else if (gameActive && !hasCashedOut) {
                handleCrash();
            }
        }

        // Starts a new round of the plane game
        function startPlaneGame() {
            if (Date.now() < rouletteCooldownEndTime) {
                window.showMessage(`الرجاء الانتظار حتى انتهاء فترة التهدئة: ${formatTime(rouletteCooldownEndTime - Date.now())}`);
                return;
            }

            betAmount = parseInt(betAmountInput.value);

            if (isNaN(betAmount) || betAmount < 20 || betAmount > 2000) {
                window.showMessage('الرجاء إدخال مبلغ رهان صالح بين 20 و 2000.');
                return;
            }
            if (playerMoney < betAmount) {
                window.showMessage('ليس لديك ما يكفي من الأموال للرهان!');
                return;
            }

            playerMoney -= betAmount;
            updatePlayerStats();

            gameActive = true;
            currentMultiplier = 1.00;
            hasCashedOut = false;
            rouletteDisplayArea.classList.remove('crashed');
            rouletteResult.classList.add('hidden');
            multiplierDisplay.textContent = '1.00x';
            potentialWinningsEl.textContent = '0';

            crashPoint = generateCrashPoint();

            startGameBtn.classList.add('hidden');
            betAmountInput.disabled = true;
            cashOutBtn.classList.remove('hidden');
            cashOutBtn.disabled = false;

            const currentDisplayAreaHeight = rouletteDisplayArea.clientHeight;
            const planeHeight = planeSvg.offsetHeight;
            planeSvg.style.transform = `translate(10px, ${currentDisplayAreaHeight - planeHeight - 15}px)`;

            lastFrameTime = 0;
            animationFrameId = requestAnimationFrame(animatePlane);
        }

        // Cashes out winnings in the plane game
        function cashOut() {
            if (!gameActive || hasCashedOut) {
                return;
            }

            hasCashedOut = true;
            cancelAnimationFrame(animationFrameId);

            const winnings = Math.round(betAmount * currentMultiplier);
            playerMoney += winnings;
            updatePlayerStats();

            rouletteResult.textContent = `لقد استلمت ${winnings} أموال عند ${currentMultiplier.toFixed(2)}x!`;
            rouletteResult.classList.remove('hidden');
            window.showMessage(`تهانينا! لقد استلمت ${winnings} أموال عند ${currentMultiplier.toFixed(2)}x!`);

            endRound();
        }

        // Handles the plane crash event
        function handleCrash() {
            if (!gameActive || hasCashedOut) {
                return;
            }
            
            cancelAnimationFrame(animationFrameId);

            rouletteDisplayArea.classList.add('crashed');
            rouletteResult.textContent = `تحطمت الطائرة عند ${currentMultiplier.toFixed(2)}x! لقد خسرت ${betAmount} أموال.`;
            rouletteResult.classList.remove('hidden');
            window.showMessage(`تحطمت الطائرة عند ${currentMultiplier.toFixed(2)}x! لقد خسرت ${betAmount} أموال.`);

            endRound();
        }

        // Ends the current roulette round
        async function endRound() {
            gameActive = false;
            cashOutBtn.classList.add('hidden');
            cashOutBtn.disabled = true;
            
            rouletteCooldownEndTime = Date.now() + ROULETTE_COOLDOWN_MS;
            updateRouletteCooldownUI();
            saveUserData();
        }

        // Shows a player's profile in a modal
        window.showPlayerProfile = function(playerData) {
            profileFleetNameEl.textContent = playerData.fleetName;
            // Remove all existing name cosmetic classes from profile fleet name
            profileFleetNameEl.classList.remove('golden-text', 'pink-text', 'fiery-text', 'silver-text', 'blue-glow-text', 'emerald-text', 'royal-crimson-text');
            // Apply specific cosmetic class if available
            if (playerData.isGoldenNameActive) {
                profileFleetNameEl.classList.add('golden-text');
            } else if (playerData.isPinkNameActive) {
                profileFleetNameEl.classList.add('pink-text');
            } else if (playerData.isFieryNameActive) {
                profileFleetNameEl.classList.add('fiery-text');
            } else if (playerData.isSilverNameActive) {
                profileFleetNameEl.classList.add('silver-text');
            } else if (playerData.isBlueGlowNameActive) {
                profileFleetNameEl.classList.add('blue-glow-text');
            } else if (playerData.isEmeraldNameActive) {
                profileFleetNameEl.classList.add('emerald-text');
            } else if (playerData.isRoyalCrimsonNameActive) {
                profileFleetNameEl.classList.add('royal-crimson-text');
            }

            profileStarIconEl.classList.toggle('hidden', !playerData.isStarIconActive);
            profileCrownIconEl.classList.toggle('hidden', !playerData.isCrownIconActive);
            profileCrownIconEl.classList.toggle('animated-crown-icon', playerData.isCrownIconActive);
            
            profileLionIconEl.classList.toggle('hidden', playerData.lionCount === 0 || !playerData.isLionActive);
            profileLionIconEl.classList.toggle('animated-lion-icon', playerData.isLionActive);
            profileLionCountDisplayEl.classList.toggle('hidden', playerData.lionCount === 0 || !playerData.isLionActive);
            profileLionCountDisplayEl.textContent = `x${playerData.lionCount}`;


            profileStatusDotEl.classList.remove('online', 'offline');
            profileStatusDotEl.classList.add(playerData.isOnline ? 'online' : 'offline');

            // Calculate total power for profile, including lion power
            let totalProfilePower = (playerData.ship1?.power || 0) + (playerData.ship2?.unlocked ? playerData.ship2.power : 0) + (playerData.ship3?.unlocked ? playerData.ship3.power : 0);
            if (playerData.lionCount !== undefined) totalProfilePower += (playerData.lionCount * 7000);
            profileTotalPowerEl.textContent = formatNumber(totalProfilePower);
            profileUserIdEl.textContent = playerData.userId;

            profileShipsListEl.innerHTML = '';
            const ships = [
                { id: 'ship1', name: 'السفينة الأساسية', data: playerData.ship1 },
                { id: 'ship2', name: 'السفينة الثانية', data: playerData.ship2 },
                { id: 'ship3', name: 'السفينة الثالثة', data: playerData.ship3 }
            ];

            ships.forEach(s => {
                const shipCard = document.createElement('div');
                shipCard.classList.add('profile-ship-card');

                const shipLevel = s.data ? s.data.level : 0;
                const shipPower = s.data ? s.data.power : 0;
                const shipMaxPower = s.data ? s.data.maxPower : INITIAL_SHIP_MAX_POWER;
                const shipUnlocked = (s.id === 'ship1') || (s.data ? s.data.unlocked : false);

                const iconSrc = getShipIcon(shipLevel);
                const iconClass = shipUnlocked ? 'unlocked' : 'locked';

                let iconHtml = '';
                if (iconSrc === 'font-awesome') {
                    iconHtml = `<i class="fas fa-ship ${shipUnlocked ? 'text-blue-400' : 'text-gray-500'}"></i>`;
                } else {
                    iconHtml = `<img src="${iconSrc}" alt="Ship Icon" onerror="this.onerror=null;this.src='https://placehold.co/50x50/21262d/e2e8f0?text=X';" draggable="false" />`;
                }

                shipCard.innerHTML = `
                    <div class="icon-container ${iconClass}">
                        ${iconHtml}
                    </div>
                    <div class="info">
                        <h4>${s.name}</h4>
                        <p>القوة: ${formatNumber(shipPower)} / ${formatNumber(shipMaxPower)}</p>
                        <p>المستوى: ${formatNumber(shipLevel)}</p>
                    </div>
                `;
                profileShipsListEl.appendChild(shipCard);
            });

            playerProfileModal.style.display = 'flex';
        }

        // Closes the player profile modal
        window.closePlayerProfileModal = function() {
            playerProfileModal.style.display = 'none';
        }

        // Event handler functions
        function handleUpgradeShip1Click() { upgradeShip(ship1); }
        function handleUpgradeShip2Click() { upgradeShip(ship2); }
        function handleUpgradeShip3Click() { upgradeShip(ship3); }
        function handleCollectResourcesClick() { collectAccumulatedResources(); }
        function handleBuyStoreItemClick() { buyStoreItem(); }
        function handleConfirmShipExpansionClick() { confirmShipExpansion(); }
        function handleStartGameClick() { startPlaneGame(); }
        function handleCashOutClick() { cashOut(); }
        function handleLogoutClick() { logoutUser(); }
        function handleChangeNameClick() { openChangeFleetNameModal(); }
        function handleConfirmChangeFleetNameClick() { confirmChangeFleetName(); }


        // DOMContentLoaded listener to initialize the game
        document.addEventListener('DOMContentLoaded', async () => {
            // Get references to UI elements
            playerPowerEl = document.getElementById('playerPower');
            playerMoneyEl = document.getElementById('playerMoney');
            playerKeysEl = document.getElementById('playerKeys');
            fleetNameEl = document.getElementById('fleetName');
            fleetStarIconEl = document.getElementById('fleetStarIcon');
            fleetCrownIconEl = document.getElementById('fleetCrownIcon'); 
            fleetLionIconEl = document.getElementById('fleetLionIcon');
            lionCountDisplayEl = document.getElementById('lionCountDisplay');
            logoutBtn = document.getElementById('logoutBtn');
            changeNameBtn = document.getElementById('changeNameBtn');

            ship1PowerEl = document.getElementById('ship1Power'); 
            ship1LevelEl = document.getElementById('ship1Level');
            ship1ProgressEl = document.getElementById('ship1Progress');
            ship1MaxPowerEl = document.getElementById('ship1MaxPower');
            upgradeShip1Btn = document.getElementById('upgradeShip1');
            ship1CooldownDisplay = document.getElementById('ship1CooldownDisplay');
            ship1IconContainerEl = document.querySelector('#myFleet > div > div:nth-child(1) > .icon-container');
            ship1IconIEl = ship1IconContainerEl.querySelector('i');
            ship1IconImgEl = ship1IconContainerEl.querySelector('img');

            ship2Container = document.getElementById('ship2Container');
            ship2PowerEl = document.getElementById('ship2Power');
            ship2LevelEl = document.getElementById('ship2Level');
            ship2ProgressEl = document.getElementById('ship2Progress');
            ship2MaxPowerEl = document.getElementById('ship2MaxPower');
            upgradeShip2Btn = document.getElementById('upgradeShip2');
            ship2CooldownDisplay = document.getElementById('ship2CooldownDisplay');
            ship2IconContainerEl = document.querySelector('#ship2Container > .icon-container');
            ship2IconIEl = ship2IconContainerEl.querySelector('i');
            ship2IconImgEl = ship2IconContainerEl.querySelector('img');

            ship3Container = document.getElementById('ship3Container');
            ship3PowerEl = document.getElementById('ship3Power');
            ship3LevelEl = document.getElementById('ship3Level');
            ship3ProgressEl = document.getElementById('ship3Progress');
            ship3MaxPowerEl = document.getElementById('ship3MaxPower');
            upgradeShip3Btn = document.getElementById('upgradeShip3');
            ship3CooldownDisplay = document.getElementById('ship3CooldownDisplay');
            ship3IconContainerEl = document.querySelector('#ship3Container > .icon-container');
            ship3IconIEl = ship3IconContainerEl.querySelector('i');
            ship3IconImgEl = ship3IconContainerEl.querySelector('img');

            mainMenuSection = document.getElementById('mainMenu');
            myFleetSection = document.getElementById('myFleet');
            storeSection = document.getElementById('store');
            onlineSection = document.getElementById('onlineSection');
            rouletteSection = document.getElementById('rouletteSection');
            developmentsSection = document.getElementById('developmentsSection'); 
            challengeLogSection = document.getElementById('challengeLog');
            attackSection = document.getElementById('attackSection');
            onlinePlayersSection = document.getElementById('onlinePlayersSection');

            messageModal = document.getElementById('messageModal');
            modalMessage = document.getElementById('modalMessage');

            authModal = document.getElementById('authModal');
            authEmailInput = document.getElementById('authEmailInput');
            authPasswordInput = document.getElementById('authPasswordInput');
            loginBtn = document.getElementById('loginBtn');
            registerBtn = document.getElementById('registerBtn');

            changeFleetNameModal = document.getElementById('changeFleetNameModal');
            changeFleetNameInput = document.getElementById('changeFleetNameInput');
            confirmChangeFleetNameBtn = document.getElementById('confirmChangeFleetNameBtn');

            resourceCollectionBtnWrapper = document.getElementById('resourceCollectionBtnWrapper');
            resourceCollectionBtn = document.getElementById('resourceCollectionBtn');
            accumulatedResourcesDisplay = document.getElementById('accumulatedResourcesDisplay');
            circleProgress = document.querySelector('.circle-progress');
            resourceBtnTextEl = document.querySelector('.resource-btn-text'); 
            resourceBtnIconEl = resourceCollectionBtn.querySelector('.resource-content i'); 

            storeItemDetailModal = document.getElementById('storeItemDetailModal');
            storeItemTitle = document.getElementById('storeItemTitle');
            storeItemIcon = document.getElementById('storeItemIcon');
            storeItemIconImg = document.getElementById('storeItemIconImg'); 
            storeItemDescription = document.getElementById('storeItemDescription');
            storeItemPrice = document.getElementById('storeItemPrice');
            buyStoreItemBtn = document.getElementById('buyStoreItemBtn');

            rouletteGameElements = document.getElementById('rouletteGameElements'); 
            rouletteDisplayArea = document.getElementById('rouletteDisplayArea');
            multiplierDisplay = document.getElementById('multiplierDisplay');
            betAmountInput = document.getElementById('betAmountInput');
            startGameBtn = document.getElementById('startGameBtn');
            cashOutBtn = document.getElementById('cashOutBtn');
            potentialWinningsEl = document.getElementById('potentialWinnings');
            rouletteResult = document.getElementById('rouletteResult');
            rouletteCooldownDisplay = document.getElementById('rouletteCooldownDisplay');
            planeSvg = document.getElementById('planeSvg');

            shipFormsList = document.getElementById('shipFormsList'); 

            onlinePlayersListEl = document.getElementById('onlinePlayersList');
            offlinePlayersListEl = document.getElementById('offlinePlayersList');
            challengeLogListEl = document.getElementById('challengeLogList');
            attackablePlayersListEl = document.getElementById('attackablePlayersList');

            playerProfileModal = document.getElementById('playerProfileModal'); 
            profileFleetNameEl = document.getElementById('profileFleetName'); 
            profileStarIconEl = document.getElementById('profileStarIcon');
            profileCrownIconEl = document.getElementById('profileCrownIcon');
            profileLionIconEl = document.getElementById('profileLionIcon');
            profileLionCountDisplayEl = document.getElementById('profileLionCountDisplay');
            profileStatusDotEl = document.getElementById('profileStatusDot');
            profileTotalPowerEl = document.getElementById('profileTotalPower');
            profileShipsListEl = document.getElementById('profileShipsList');
            profileUserIdEl = document.getElementById('profileUserId');

            // Add event listeners
            upgradeShip1Btn.addEventListener('click', handleUpgradeShip1Click);
            upgradeShip2Btn.addEventListener('click', handleUpgradeShip2Click);
            upgradeShip3Btn.addEventListener('click', handleUpgradeShip3Click);
            resourceCollectionBtnWrapper.addEventListener('click', handleCollectResourcesClick);
            buyStoreItemBtn.addEventListener('click', handleBuyStoreItemClick);
            document.getElementById('confirmShipExpansionBtn').addEventListener('click', handleConfirmShipExpansionClick); 
            startGameBtn.addEventListener('click', handleStartGameClick);
            cashOutBtn.addEventListener('click', handleCashOutClick);
            logoutBtn.addEventListener('click', handleLogoutClick); 
            loginBtn.addEventListener('click', handleLogin);
            registerBtn.addEventListener('click', handleRegister);
            changeNameBtn.addEventListener('click', handleChangeNameClick);
            confirmChangeFleetNameBtn.addEventListener('click', handleConfirmChangeFleetNameClick);

            // Set up recurring timers for UI updates and game mechanics
            setInterval(updateAllShipCooldowns, 1000);
            setInterval(autoAccumulateResources, RESOURCE_ACCUMULATION_INTERVAL_MS);
            setInterval(updateResourceButtonState, 1000);
            setInterval(updateRouletteCooldownUI, 1000);
            setInterval(updateAttackCooldownsUI, 1000);

            // Initialize Firebase
            await initializeFirebase();

            // Disable right-click, drag, and text selection for better game feel
            document.addEventListener('contextmenu', event => event.preventDefault());
            document.addEventListener('dragstart', event => event.preventDefault());
            document.addEventListener('selectstart', event => event.preventDefault());
        });

        // Save user data and update online status before page unload
        window.addEventListener('beforeunload', async () => {
            if (userId) {
                await updateOnlineStatus(false);
                await saveUserData();
            }
        });
    </script>
</body>
</html>
