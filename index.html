<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الأسطول</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Arabic', sans-serif;
            background-color: #0d1117;
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        body::-webkit-scrollbar {
            display: none;
        }
        body {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .btn {
            @apply px-6 py-3 rounded-full font-bold transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-600 text-gray-100 hover:bg-gray-700;
        }
        .btn-success {
            @apply bg-green-600 text-white hover:bg-green-700;
        }
        .btn-warning {
            @apply bg-yellow-600 text-white hover:bg-yellow-700;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700;
        }
        .resource-btn-wrapper {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            background-color: #21262d;
            border-radius: 50px;
            padding: 5px 10px 5px 5px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            z-index: 1000;
            border: 2px solid #30363d;
            margin-top: 20px;
        }
        .resource-btn-wrapper:hover {
            background-color: #2b323b;
            transform: translateX(-50%) scale(1.05);
        }
        .resource-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .resource-btn::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 1;
        }
        .resource-btn .progress-circle {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        .resource-btn .circle-bg {
            fill: none;
            stroke: #3b4554;
            stroke-width: 8;
        }
        .resource-btn .circle-progress {
            fill: none;
            stroke: #f39c12;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s ease-out;
        }
        .resource-btn .resource-content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }
        .resource-btn .resource-content i {
            font-size: 1.5rem;
            margin-bottom: 0px;
        }
        .resource-btn .resource-content span {
            font-size: 0.8rem;
        }
        .resource-btn-text {
            font-size: 0.9rem;
            font-weight: bold;
            color: #e2e8f0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #161b22;
            color: #e2e8f0;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.7);
            width: 90%;
            max-width: 450px;
            text-align: center;
            border: 1px solid #30363d;
        }
        .close-button {
            color: #a0aec0;
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }
        .close-button:hover,
        .close-button:focus {
            color: #cbd5e0;
            text-decoration: none;
            cursor: pointer;
        }
        .section-container {
            position: relative;
            background-color: #161b22;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #30363d;
        }
        .header-container {
            background-color: #161b22;
            border-bottom: 4px solid #f39c12;
            padding: 12px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            position: relative;
            z-index: 10;
        }
        .header-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            padding: 0 16px;
        }
        .header-item {
            background-color: #21262d;
            border-radius: 10px;
            padding: 10px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            min-width: 70px;
        }
        .header-item i {
            font-size: 1.6rem;
            margin-bottom: 2px;
        }
        .header-item span {
            font-size: 0.85rem;
            font-weight: 700;
            color: #cbd5e0;
            text-align: center;
        }
        .header-fleet-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e2e8f0;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 16px;
            text-align: center;
            background-color: #21262d;
            border-radius: 10px;
            padding: 8px 15px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.08);
            max-width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .header-fleet-name #fleetName {
            margin-left: 8px;
            margin-right: 8px;
        }
        .header-fleet-name #fleetStarIcon {
            font-size: 1.2rem;
        }
        .header-logout-btn {
            background-color: #dc2626;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            transition: background-color 0.2s ease;
            margin-right: 16px;
        }
        .header-logout-btn:hover {
            background-color: #ef4444;
        }
        .change-name-btn {
            background-color: #4a5568;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            margin-right: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .change-name-btn:hover {
            background-color: #6b7280;
        }

        .pill-style-item {
            border-radius: 50px;
            padding: 1rem 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), inset 0 2px 5px rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            min-height: 120px;
        }

        .pill-style-item::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 1;
        }

        .pill-style-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.6), inset 0 2px 5px rgba(255, 255, 255, 0.3);
        }

        .pill-style-item .content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .pill-style-item i {
            font-size: 4rem;
            margin-bottom: 0.5rem;
            color: white;
        }

        .pill-style-item span {
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .pill-style-item .notification-dot {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 15px;
            height: 15px;
            background-color: #f39c12;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            z-index: 3;
        }


        .main-menu-item-bg-1 {
            background: linear-gradient(to bottom, #A0522D, #8B4513);
        }
        .main-menu-item-bg-2 {
            background: linear-gradient(to bottom, #8BC34A, #6B8E23);
        }
        .main-menu-item-bg-3 {
            background: linear-gradient(to bottom, #9370DB, #8A2BE2);
        }
        .main-menu-item-bg-4 {
            background: linear-gradient(to bottom, #FF8C00, #FF4500);
        }
        .main-menu-item-bg-5 {
            background: linear-gradient(to bottom, #4682B4, #4169E1);
        }
        .main-menu-item-bg-6 {
            background: linear-gradient(to bottom, #20B2AA, #008B8B);
        }
        .main-menu-item-bg-roulette {
            background: linear-gradient(to bottom, #DC143C, #8B0000);
        }
        .main-menu-item-bg-developments {
            background: linear-gradient(to bottom, #00BFFF, #1E90FF);
        }
        .main-menu-item-bg-account {
            background: linear-gradient(to bottom, #6C7A89, #4B525F);
        }


        .store-item {
            background-color: #21262d;
            border-radius: 30px;
            padding: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 3px rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 100px;
            position: relative;
            overflow: hidden;
        }
        .store-item::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }

        .store-item:hover {
            transform: translateY(-3px);
        }

        .store-item i {
            font-size: 2.5rem;
            margin-bottom: 0.2rem;
            position: relative;
            z-index: 2;
        }
        .store-item img { /* For image icons in store */
            width: 2.5rem;
            height: 2.5rem;
            margin-bottom: 0.2rem;
            position: relative;
            z-index: 2;
        }

        .store-item h3 {
            font-size: 0.9rem;
            font-weight: bold;
            color: #e2e8f0;
            position: relative;
            z-index: 2;
        }
        .store-item .price-display {
            font-size: 0.7rem; /* Smaller font size */
            font-weight: bold;
            color: #cbd5e0;
            margin-top: 0.2rem;
            display: flex;
            align-items: center;
            gap: 2px;
            position: relative;
            z-index: 2;
        }
        .store-item .price-display i {
            font-size: 0.8rem; /* Smaller icon size */
        }
        .store-item .price-display i.fa-dollar-sign {
            color: #4CAF50;
        }
        .store-item .price-display i.fa-key {
            color: #FFD700;
        }

        @keyframes gold-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes pink-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes fiery-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background: position: 0% 50%; }
        }
        @keyframes silver-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes blue-glow-animation {
            0% { text-shadow: 0 0 5px #3b82f6, 0 0 10px #3b82f6, 0 0 15px #3b82f6; }
            50% { text-shadow: 0 0 10px #2563eb, 0 0 20px #2563eb, 0 0 30px #2563eb; }
            100% { text-shadow: 0 0 5px #3b82f6, 0 0 10px #3b82f6, 0 0 15px #3b82f6; }
        }
        @keyframes emerald-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes royal-crimson-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes crown-animation {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            25% { transform: scale(1.1) rotate(5deg); opacity: 0.9; }
            50% { transform: scale(1) rotate(0deg); opacity: 1; }
            75% { transform: scale(1.1) rotate(-5deg); opacity: 0.9; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        @keyframes lion-animation { 
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.05) rotate(3deg); opacity: 0.95; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        @keyframes glowing-icon {
            0% { filter: drop-shadow(0 0 5px rgba(255,255,255,0.7)); }
            50% { filter: drop-shadow(0 0 15px rgba(255,255,255,1)); }
            100% { filter: drop-shadow(0 0 5px rgba(255,255,255,0.7)); }
        }

        .golden-text {
            background: linear-gradient(90deg, #ffd700, #ffec8b, #ffd700, #ffec8b);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: gold-animation 3s linear infinite;
        }
        .pink-text {
            background: linear-gradient(90deg, #ff69b4, #ffb6c1, #ff69b4, #ffb6c1);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: pink-animation 3s linear infinite;
        }
        .fiery-text {
            background: linear-gradient(90deg, #ff4500, #ffa500, #ff4500, #ffa500);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: fiery-animation 3s linear infinite;
        }
        .silver-text {
            background: linear-gradient(90deg, #c0c0c0, #e0e0e0, #c0c0c0, #e0e0e0);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: silver-animation 3s linear infinite;
        }
        .blue-glow-text {
            color: #3b82f6;
            animation: blue-glow-animation 2s ease-in-out infinite;
        }
        .emerald-text {
            background: linear-gradient(90deg, #00c9a7, #00e0b7, #00c9a7, #00e0b7);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: emerald-animation 3s linear infinite;
        }
        .royal-crimson-text {
            background: linear-gradient(90deg, #8b0000, #dc143c, #8b0000, #dc143c);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: royal-crimson-animation 3s linear infinite;
        }
        .animated-crown-icon {
            animation: crown-animation 2s ease-in-out infinite;
        }
        .animated-lion-icon { 
            animation: lion-animation 1.5s ease-in-out infinite;
        }
        .glowing-icon {
            animation: glowing-icon 2s ease-in-out infinite;
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.5s ease-out forwards;
        }

        #storeItemDetailModal .modal-content {
            max-width: 500px;
            padding: 30px;
        }
        #storeItemDetailModal h2 {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }
        #storeItemDetailModal .item-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }
        #storeItemDetailModal .item-icon-img { 
            width: 5rem;
            height: 5rem;
            margin: 0 auto 20px auto; 
        }
        #storeItemDetailModal .item-description {
            font-size: 1.1rem;
            color: #a0aec0;
            margin-bottom: 25px;
        }
        #storeItemDetailModal .item-price {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #storeItemDetailModal .item-price i.fa-dollar-sign {
            color: #4CAF50;
            margin-left: 10px;
            font-size: 1.8rem;
        }
        #storeItemDetailModal .item-price i.fa-key {
            color: #FFD700;
            margin-left: 10px;
            font-size: 1.8rem;
        }
        #storeItemDetailModal .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .modal-actions .pill-modal-btn {
            min-width: 120px; 
        }

        .pill-modal-btn {
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 3px rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
            color: white;
        }
        .pill-modal-btn::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        .pill-modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), inset 0 1px 3px rgba(255, 255, 255, 0.25);
        }
        .pill-modal-btn.bg-blue-600 {
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
        }
        .pill-modal-btn.bg-gray-600 {
            background: linear-gradient(to bottom, #6b7280, #4b5563);
        }

        .ship-item-card {
            background-color: #21262d;
            border-radius: 50px;
            padding: 1rem 1.5rem;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4), inset 0 2px 5px rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        .ship-item-card::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border-radius: 50px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            z-index: 1;
        }
        .ship-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.6), inset 0 2px 5px rgba(255, 255, 255, 0.3);
        }
        .ship-item-card .icon-container {
            position: relative;
            z-index: 2;
            margin-right: 1.5rem;
            padding-left: 10px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ship-item-card .icon-container i {
            font-size: 3.5rem;
            color: #60a5fa;
            position: absolute;
        }
        .ship-item-card .icon-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .ship-item-card .info-container {
            position: relative;
            z-index: 2;
            flex-grow: 1;
        }
        .ship-item-card h3 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e2e8f0;
            margin-bottom: 0.25rem;
        }
        .ship-item-card p {
            font-size: 1rem;
            color: #a0aec0;
        }
        .ship-item-card .progress-bar-wrapper {
            background-color: #4a5568;
            border-radius: 5px;
            height: 8px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .ship-item-card .progress-bar {
            background-color: #3b82f6;
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease-out;
        }
        .ship-item-card .level-text {
            font-size: 0.85rem;
            color: #cbd5e0;
            margin-top: 0.25rem;
        }
        .ship-item-card .upgrade-btn-container {
            position: relative;
            z-index: 2;
            margin-left: 1.5rem;
        }
        .ship-item-card .upgrade-btn {
            @apply px-5 py-2 rounded-full font-bold text-base transition-all duration-300 ease-in-out transform hover:scale-105 shadow-lg;
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
        }
        .ship-item-card .upgrade-btn::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        .ship-item-card .upgrade-btn:hover {
            transform: translateY(-2px);
        }

        @keyframes fall-and-fade {
            0% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(5px); opacity: 0.5; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .cooldown-active {
            animation: fall-and-fade 1.5s infinite ease-in-out;
        }

        .roulette-container {
            background-color: #21262d;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #30363d;
            max-width: 450px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .roulette-display-area {
            width: 100%;
            height: 200px;
            border-radius: 12px;
            background-color: #1a202c;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 1.5rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.7);
            border: 5px solid #30363d;
            overflow: hidden;
            font-size: 3.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            background-image: linear-gradient(to right, #2d3748 1px, transparent 1px), linear-gradient(to bottom, #2d3748 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .multiplier-display-bottom-right {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            z-index: 3;
        }

        .plane-path {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .plane-path svg {
            position: absolute;
            width: 32px;
            height: 32px;
            color: #FFD700;
            transition: transform linear;
            transform-origin: center center;
        }

        @keyframes crash-shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        .roulette-display-area.crashed {
            background-color: #FF0000 !important;
            border-color: #CC0000 !important;
            box-shadow: 0 0 25px rgba(255,0,0,0.9) !important;
            animation: crash-shake 0.3s ease-in-out;
        }

        .roulette-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            margin-top: 1.5rem;
        }
        .roulette-controls input {
            background-color: #3b4554;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 0.75rem;
            color: #e2e8f0;
            text-align: center;
            font-size: 1.1rem;
        }
        .roulette-controls .spin-btn-style {
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 3px rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
            color: white;
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
        }
        .roulette-controls .spin-btn-style:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), inset 0 1px 3px rgba(255, 255, 255, 0.25);
        }
        .roulette-controls .cash-out-btn-style {
            background: linear-gradient(to bottom, #FFD700, #DAA520);
            color: #333;
            border: 2px solid rgba(255, 255, 255, 0.15);
        }
        .roulette-controls .cash-out-btn-style:hover {
            background: linear-gradient(to bottom, #FFEB3B, #FFC107);
        }

        .roulette-result {
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 1.5rem;
            color: #e2e8f0;
        }
        .roulette-cooldown-display {
            font-size: 1rem;
            color: #a0aec0;
            margin-top: 0.5rem;
        }

        .ship-selection-option {
            background-color: #21262d;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .ship-selection-option:hover {
            background-color: #2b323b;
        }
        .ship-selection-option.selected {
            border-color: #f39c12;
            box-shadow: 0 0 10px rgba(243,156,18,0.5);
        }
        .ship-selection-option input[type="radio"] {
            margin-left: 10px;
            accent-color: #f39c12;
        }
        .ship-selection-option label {
            flex-grow: 1;
            text-align: right;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .ship-form-item {
            display: flex;
            align-items: center;
            background-color: #21262d;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 1px solid #30363d;
        }
        .ship-form-item .icon-wrapper {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            flex-shrink: 0;
        }
        .ship-form-item .icon-wrapper i {
            font-size: 2.5rem;
            color: #60a5fa;
        }
        .ship-form-item .icon-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .ship-form-item .text-content {
            flex-grow: 1;
            text-align: right;
        }
        .ship-form-item h4 {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e2e8f0;
        }
        .ship-form-item p {
            font-size: 0.9rem;
            color: #a0aec0;
        }
        .attack-player-item {
            background-color: #21262d;
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .attack-player-item .player-info {
            display: flex;
            flex-direction: column;
            text-align: right;
            flex-grow: 1;
        }
        .attack-player-item .player-info h3 {
            font-size: 1.2rem;
            font-weight: bold;
            color: #e2e8f0;
        }
        .attack-player-item .player-info p {
            font-size: 0.9rem;
            color: #a0aec0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }
        .attack-player-item .attack-btn-wrapper {
            margin-left: 15px;
            flex-shrink: 0;
        }
        .attack-player-btn {
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3), inset 0 1px 3px rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
            color: white;
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
            min-width: 80px;
            text-align: center;
        }
        .attack-player-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), inset 0 1px 3px rgba(255, 255, 255, 0.25);
        }
        .attack-player-btn:disabled {
            background: linear-gradient(to bottom, #6b7280, #4b5563);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .online-player-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer; 
        }
        .online-player-list-item.online {
            background-color: #21262d;
        }
        .online-player-list-item.offline {
            background-color: #1a202c;
            opacity: 0.7;
        }
        .online-player-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .online-player-ships {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        .online-player-ship-icon {
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .online-player-ship-icon i {
            font-size: 1.2rem;
            position: absolute;
        }
        .online-player-ship-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: absolute;
        }
        .online-player-ship-icon.unlocked i, .online-player-ship-icon.unlocked img {
            filter: none; 
        }
        .online-player-ship-icon.locked i, .online-player-ship-icon.locked img {
            filter: grayscale(100%); 
            opacity: 0.6;
        }
        .player-profile-modal-content {
            max-width: 600px;
            text-align: right;
        }
        .player-profile-modal-content .profile-header {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 1.5rem;
        }
        .player-profile-modal-content .profile-header h2 {
            margin-left: 10px;
            font-size: 2.5rem;
        }
        .player-profile-modal-content .profile-header .status-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .player-profile-modal-content .profile-header .status-dot.online {
            background-color: #22c55e;
        }
        .player-profile-modal-content .profile-header .status-dot.offline {
            background-color: #ef4444;
        }
        .player-profile-modal-content .profile-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .player-profile-modal-content .profile-stat-item {
            background-color: #21262d;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }
        .player-profile-modal-content .profile-stat-item i {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        .player-profile-modal-content .profile-stat-item span {
            font-size: 1rem;
            font-weight: bold;
        }
        .player-profile-modal-content .profile-ships-section {
            margin-top: 1.5rem;
        }
        .player-profile-modal-content .profile-ship-card {
            background-color: #21262d;
            border-radius: 15px;
            padding: 1rem;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .player-profile-modal-content .profile-ship-card .icon-container {
            width: 50px;
            height: 50px;
            margin-left: 1rem;
            position: relative;
        }
        .player-profile-modal-content .profile-ship-card .icon-container i {
            font-size: 2.5rem;
            position: absolute;
        }
        .player-profile-modal-content .profile-ship-card .icon-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            position: absolute;
        }
        .player-profile-modal-content .profile-ship-card .info {
            flex-grow: 1;
            text-align: right;
        }
        .player-profile-modal-content .profile-ship-card .info h4 {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .player-profile-modal-content .profile-ship-card .info p {
            font-size: 0.9rem;
            color: #a0aec0;
        }
        .player-profile-modal-content .profile-footer {
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: #a0aec0;
        }
        #authModal .modal-content {
            background-color: #161b22; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); 
            border: 1px solid #30363d; 
            width: 90%;
            max-width: 400px; 
            padding: 24px;
            text-align: center;
        }
        #changeFleetNameModal .modal-content {
            max-width: 400px;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col" oncontextmenu="return false;">

    <div id="authModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">مرحباً أيها القائد!</h2>
            <p class="text-gray-300 mb-6">ابدأ مغامرتك الآن!</p>
            <button id="startGameBtnAuth" class="btn btn-primary w-full">ابدأ اللعب</button>
        </div>
    </div>

    <div id="changeFleetNameModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeChangeFleetNameModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-4">تغيير اسم الأسطول</h2>
            <input type="text" id="changeFleetNameInput" placeholder="اسم الأسطول الجديد" class="w-full p-3 rounded bg-gray-700 text-white border border-gray-600 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="confirmChangeFleetNameBtn" class="btn btn-primary w-full">تأكيد التغيير</button>
        </div>
    </div>

    <header class="header-container w-full">
        <div class="header-stats-grid w-full max-w-4xl mx-auto">
            <div class="header-item">
                <i class="fas fa-fist-raised text-red-500"></i>
                <span id="playerPower">0</span>
            </div>
            <div class="header-item">
                <i class="fas fa-dollar-sign text-green-400"></i>
                <span id="playerMoney">0</span>
            </div>
            <div class="header-item">
                <i class="fas fa-key text-yellow-400"></i>
                <span id="playerKeys">0</span>
            </div>
        </div>
        <div class="header-fleet-name flex justify-between items-center px-4">
            <span id="fleetName">أسطولي العظيم</span>
            <i id="fleetStarIcon" class="fas fa-star text-yellow-300 hidden"></i>
            <i id="fleetCrownIcon" class="fas fa-chess-king text-yellow-400 hidden"></i>
            <img id="fleetLionIcon" src="https://d.top4top.io/p_3482hpjya1.png" alt="Lion Icon" class="w-6 h-6 ml-1 hidden animated-lion-icon" draggable="false">
            <span id="lionCountDisplay" class="text-xs text-gray-400 ml-1 hidden">x0</span>
            <button id="changeNameBtn" class="change-name-btn">تغيير الاسم</button>
        </div>
        <div class="text-center mt-2">
            <button id="logoutBtn" class="header-logout-btn">تسجيل الخروج</button>
        </div>
    </header>

    <main class="flex-grow p-4 flex flex-col items-center justify-center relative">
        <section id="mainMenu" class="grid grid-cols-2 md:grid-cols-3 gap-6 mb-8 w-full max-w-4xl hidden">
            <div class="pill-style-item main-menu-item-bg-1" onclick="showSection('myFleet')">
                <div class="content">
                    <i class="fas fa-ship"></i>
                    <span>أسطولي</span>
                </div>
            </div>
            <div class="pill-style-item main-menu-item-bg-2" onclick="showSection('store')">
                <div class="content">
                    <i class="fas fa-store"></i>
                    <span>المتجر</span>
                </div>
            </div>
            <div class="pill-style-item main-menu-item-bg-3" onclick="showSection('onlineSection')">
                <div class="content">
                    <i class="fas fa-globe"></i>
                    <span>اونلاين</span>
                </div>
            </div>
            <div class="pill-style-item main-menu-item-bg-roulette" onclick="showSection('rouletteSection')">
                <div class="content">
                    <i class="fas fa-dice"></i>
                    <span>روليت</span>
                </div>
            </div>
            <div class="pill-style-item main-menu-item-bg-developments" onclick="showSection('developmentsSection')">
                <div class="content">
                    <i class="fas fa-rocket"></i> 
                    <span>التطورات</span>
                </div>
            </div>
            <div class="pill-style-item main-menu-item-bg-account" onclick="showSection('accountSection')">
                <div class="content">
                    <i class="fas fa-user-circle"></i> 
                    <span>الحساب</span>
                </div>
            </div>
        </section>

        <section id="myFleet" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">أسطولي</h2>
            <div class="space-y-6">
                <div class="ship-item-card">
                    <div class="icon-container">
                        <i id="ship1IconI" class="fas fa-ship"></i>
                        <img id="ship1IconImg" src="" alt="Ship Icon" class="w-full h-full object-contain" style="display: none;" draggable="false">
                    </div>
                    <div class="info-container">
                        <h3>السفينة الأساسية</h3>
                        <p>القوة: <span id="ship1Power">0</span></p>
                        <div class="progress-bar-wrapper">
                            <div id="ship1Progress" class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <p class="level-text">المستوى: <span id="ship1Level">0</span> / <span id="ship1MaxPower">10000</span></p>
                        <p id="ship1CooldownDisplay" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    <div class="upgrade-btn-container">
                        <button id="upgradeShip1" class="upgrade-btn">تطوير</button>
                    </div>
                </div>

                <div id="ship2Container" class="ship-item-card opacity-50 pointer-events-none">
                    <div class="icon-container">
                        <i id="ship2IconI" class="fas fa-ship text-gray-500"></i>
                        <img id="ship2IconImg" src="" alt="Image of Ship Icon" style="display: none;" draggable="false">
                    </div>
                    <div class="info-container">
                        <h3 class="text-gray-400">السفينة الثانية</h3>
                        <p class="text-gray-300">القوة: <span id="ship2Power">0</span></p>
                        <div class="progress-bar-wrapper">
                            <div id="ship2Progress" class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <p class="level-text">المستوى: <span id="ship2Level">0</span> / <span id="ship2MaxPower">10000</span></p>
                        <p id="ship2CooldownDisplay" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    <div class="upgrade-btn-container">
                        <button id="upgradeShip2" class="upgrade-btn" disabled>تطوير</button>
                    </div>
                </div>

                <div id="ship3Container" class="ship-item-card opacity-50 pointer-events-none">
                    <div class="icon-container">
                        <i id="ship3IconI" class="fas fa-ship text-gray-500"></i>
                        <img id="ship3IconImg" src="" alt="Image of Ship Icon" style="display: none;" draggable="false">
                    </div>
                    <div class="info-container">
                        <h3 class="text-gray-400">السفينة الثالثة</h3>
                        <p class="text-gray-300">القوة: <span id="ship3Power">0</span></p>
                        <div class="progress-bar-wrapper">
                            <div id="ship3Progress" class="progress-bar" style="width: 0%;"></div>
                        </div>
                        <p class="level-text">المستوى: <span id="ship3Level">0</span> / <span id="ship3MaxPower">10000</span></p>
                        <p id="ship3CooldownDisplay" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    <div class="upgrade-btn-container">
                        <button id="upgradeShip3" class="upgrade-btn" disabled>تطوير</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="store" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">المتجر</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                <!-- Essential Items -->
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('completeUpgrade')">
                    <img src="https://c.top4top.io/p_3482irls40.png" alt="Image of Complete Upgrade Icon" draggable="false">
                    <h3>إكمال التطوير</h3>
                    <div class="price-display">
                        <span>2</span> <i class="fas fa-key"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('shipExpansion')">
                    <i class="fas fa-expand-arrows-alt text-blue-400"></i>
                    <h3>توسيع السفينة</h3>
                    <div class="price-display">
                        <span>50</span> <i class="fas fa-key"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('buyKeys')">
                    <i class="fas fa-key text-yellow-400"></i>
                    <h3>شراء مفاتيح</h3>
                    <div class="price-display">
                        <span>150</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <!-- Lucky Box -->
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('luckyBox')">
                    <img src="https://e.top4top.io/p_348281x7t0.png" alt="Image of Lucky Box" draggable="false">
                    <h3>صندوق الحظ</h3>
                    <div class="price-display">
                        <span>3500</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <!-- Free Box -->
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('freeBox')">
                    <img src="https://a.top4top.io/p_3483uplj00.png" alt="Image of Free Box" draggable="false">
                    <h3>صندوق مجاني</h3>
                    <div class="price-display">
                        <span>مجاني</span>
                    </div>
                </div>
                <!-- Cosmetic Items -->
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('goldenName')">
                    <i class="fas fa-crown text-yellow-400"></i>
                    <h3>اسم ذهبي متحرك</h3>
                    <div class="price-display">
                        <span>3000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('pinkName')">
                    <i class="fas fa-heart text-pink-500"></i>
                    <h3>اسم وردي متحرك</h3>
                    <div class="price-display">
                        <span>1500</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('fieryName')">
                    <i class="fas fa-fire text-orange-500"></i>
                    <h3>اسم ناري ملتهب</h3>
                    <div class="price-display">
                        <span>2000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <!-- New Name Cosmetics -->
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('silverName')">
                    <i class="fas fa-gem text-gray-300"></i>
                    <h3>اسم فضي لامع</h3>
                    <div class="price-display">
                        <span>2500</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('blueGlowName')">
                    <i class="fas fa-lightbulb text-blue-400"></i>
                    <h3>اسم أزرق متوهج</h3>
                    <div class="price-display">
                        <span>4000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('emeraldName')">
                    <i class="fas fa-leaf text-green-500"></i>
                    <h3>اسم أخضر زمردي</h3>
                    <div class="price-display">
                        <span>6000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('royalCrimsonName')">
                    <i class="fas fa-shield-alt text-red-600"></i>
                    <h3>اسم قرمزي ملكي</h3>
                    <div class="price-display">
                        <span>9000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>

                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('starIcon')">
                    <i class="fas fa-star text-yellow-300"></i>
                    <h3>أيقونة النجمة</h3>
                    <div class="price-display">
                        <span>3000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('crownIcon')">
                    <i class="fas fa-chess-king text-yellow-400"></i>
                    <h3>أيقونة تاج ذهبي</h3>
                    <div class="price-display">
                        <span>5000</span> <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <!-- Lion Icon -->
                <div class="store-item bg-gray-700" onclick="showStoreItemDetail('lionIcon')">
                    <img src="https://d.top4top.io/p_3482hpjya1.png" alt="Image of Lion Icon" draggable="false">
                    <h3>أيقونة الأسد المتوهج</h3>
                    <div class="price-display">
                        <span>-</span> <i class="fas fa-dollar-sign"></i> 
                    </div>
                </div>
            </div>
            <p class="text-center text-gray-300 mt-6">المزيد من العناصر قريباً!</p>
        </section>

        <section id="onlineSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">اونلاين</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="pill-style-item main-menu-item-bg-4" onclick="showSection('challengeLog')">
                    <div class="content">
                        <i class="fas fa-scroll"></i>
                        <span>سجل التحدي</span>
                    </div>
                </div>
                <div class="pill-style-item main-menu-item-bg-5" onclick="showSection('attackSection')">
                    <div class="content">
                        <i class="fas fa-crosshairs"></i>
                        <span>الهجوم</span>
                    </div>
                </div>
                <div class="pill-style-item main-menu-item-bg-6" onclick="showSection('onlinePlayersSection')">
                    <div class="content">
                        <i class="fas fa-users"></i>
                    <span>المتصلون حاليا</span>
                </div>
            </div>
        </section>

        <section id="rouletteSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">لعبة الطائرة</h2>
            <div class="roulette-container">
                <div id="rouletteGameElements">
                    <div id="rouletteDisplayArea" class="roulette-display-area">
                        <div class="plane-path">
                            <svg id="planeSvg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9L2 14v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1V20.5L13 19v-2.5l8 2.5z"/>
                            </svg>
                        </div>
                        <span id="multiplierDisplay" class="multiplier-display-bottom-right">1.00x</span>
                    </div>

                    <div class="roulette-controls">
                        <input type="number" id="betAmountInput" placeholder="مبلغ الرهان (20-2000)" min="20" max="2000" class="w-full">
                        <button id="startGameBtn" class="spin-btn-style">ابدأ الجولة</button>
                        <button id="cashOutBtn" class="spin-btn-style cash-out-btn-style hidden" disabled>استلام الأرباح (<span id="potentialWinnings">0</span>)</button>
                        <p id="rouletteResult" class="roulette-result hidden">النتيجة: </p>
                    </div>
                </div>
                <p id="rouletteCooldownDisplay" class="roulette-cooldown-display hidden">الجولة القادمة بعد: </p>
            </div>
        </section>

        <section id="developmentsSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">التطورات</h2>
            <div id="shipFormsList" class="text-right">
            </div>
        </section>

        <section id="challengeLog" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('onlineSection')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">سجل التحدي</h2>
            <ul id="challengeLogList" class="space-y-3">
            </ul>
        </section>

        <section id="attackSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('onlineSection')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">الهجوم</h2>
            <div id="attackablePlayersList" class="space-y-3">
            </div>
            <p class="text-center text-sm text-gray-500 mt-4">الفوز يمنحك 200-800 دولار وفرصة 15% للحصول على مفتاح. الخسارة لا تكلفك شيئاً.</p>
        </section>

        <section id="onlinePlayersSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('onlineSection')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">المتصلون حاليا</h2>
            <div class="mb-6">
                <h3 class="text-xl font-bold mb-3 text-green-300">متصلون</h3>
                <ul id="onlinePlayersList" class="space-y-2">
                </ul>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-3 text-gray-400">غير متصلون</h3>
                <ul id="offlinePlayersList" class="space-y-2">
                </ul>
            </div>
        </section>

        <section id="accountSection" class="hidden p-6 rounded-xl shadow-xl w-full max-w-2xl text-gray-100 section-container">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200" onclick="showSection('mainMenu')">
                <i class="fas fa-arrow-right text-3xl"></i>
            </button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-100">الحساب</h2>
            
            <div id="accountInfo" class="text-center mb-6">
                <p class="text-lg mb-2">معرف المستخدم: <span id="currentUserId" class="font-bold"></span></p>
                <p class="text-lg">نوع الحساب: <span id="accountType" class="font-bold">مجهول</span></p>
            </div>

            <div id="linkAccountSection" class="bg-gray-700 p-6 rounded-xl shadow-inner mb-6">
                <h3 class="text-xl font-bold text-center mb-4">ربط الحساب الدائم</h3>
                <p class="text-gray-300 mb-4 text-center">اربط حسابك المجهول ببريد إلكتروني وكلمة مرور لحفظ تقدمك بشكل دائم والوصول إليه من أي جهاز.</p>
                <input type="email" id="linkEmailInput" placeholder="البريد الإلكتروني" class="w-full p-3 rounded bg-gray-800 text-white border border-gray-600 mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="linkPasswordInput" placeholder="كلمة المرور" class="w-full p-3 rounded bg-gray-800 text-white border border-gray-600 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="linkAccountBtn" class="btn btn-primary w-full">ربط الحساب</button>
            </div>

            <div id="permanentAccountOptions" class="bg-gray-700 p-6 rounded-xl shadow-inner hidden">
                <h3 class="text-xl font-bold text-center mb-4">خيارات الحساب الدائم</h3>
                <p class="text-gray-300 mb-4 text-center">لقد قمت بربط حسابك. يمكنك الآن استرداد البيانات من هذا المتصفح.</p>
                <button id="restoreDataBtn" class="btn btn-success w-full">استرداد البيانات من هذا المتصفح</button>
            </div>
        </section>

    </main>

    <div id="resourceCollectionBtnWrapper" class="resource-btn-wrapper hidden">
        <div id="resourceCollectionBtn" class="resource-btn">
            <svg class="progress-circle" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" class="circle-bg"></circle>
                <circle cx="50" cy="50" r="40" class="circle-progress"></circle>
            </svg>
            <div class="resource-content">
                <i class="fas fa-box-open"></i>
                <span id="accumulatedResourcesDisplay" class="text-lg font-bold">0/200</span>
            </div>
        </div>
        <span class="resource-btn-text">استلام</span>
    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <p id="modalMessage" class="text-lg font-semibold"></p>
            <button class="pill-modal-btn bg-blue-600 mt-4" onclick="closeModal()">حسناً</button>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <p id="confirmMessage" class="text-lg font-semibold mb-4"></p>
            <div class="modal-actions">
                <button id="confirmYesBtn" class="pill-modal-btn bg-blue-600">نعم</button>
                <button id="confirmNoBtn" class="pill-modal-btn bg-gray-600">لا</button>
            </div>
        </div>
    </div>

    <div id="storeItemDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeStoreItemDetailModal(true)">&times;</span>
            <h2 id="storeItemTitle"></h2>
            <i id="storeItemIcon" class="item-icon hidden"></i>
            <img id="storeItemIconImg" src="" alt="Item Icon" class="item-icon-img hidden" draggable="false">
            <p id="storeItemDescription" class="item-description"></p>
            <p id="storeItemPrice" class="item-price"></p>
            <div class="modal-actions">
                <button id="buyStoreItemBtn" class="pill-modal-btn bg-blue-600">شراء</button>
                <button class="pill-modal-btn bg-gray-600" onclick="closeStoreItemDetailModal(true)">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="shipSelectionModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeShipSelectionModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-4" id="shipExpansionModalTitle">توسيع السفينة</h2>
            <i id="shipExpansionModalIcon" class="item-icon fas fa-expand-arrows-alt text-blue-400"></i>
            <p id="shipExpansionModalDescription" class="item-description">يزيد الحد الأقصى لقوة السفينة المختارة بمقدار 5000 نقطة قوة إضافية. يمكن شراء هذا التوسيع عدة مرات لأي سفينة.</p>
            <p id="shipExpansionModalPrice" class="item-price">10000 <i class="fas fa-dollar-sign text-green-400"></i></p>
            
            <h3 class="text-xl font-bold mb-3">اختر سفينة للتوسيع:</h3>
            <div id="shipSelectionOptions" class="flex flex-col gap-3 mb-6">
            </div>
            <div class="modal-actions">
                <button id="confirmShipExpansionBtn" class="pill-modal-btn bg-blue-600">تأكيد التوسيع</button>
                <button class="pill-modal-btn bg-gray-600" onclick="closeShipSelectionModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Player Profile Modal -->
    <div id="playerProfileModal" class="modal">
        <div class="modal-content player-profile-modal-content">
            <span class="close-button" onclick="closePlayerProfileModal()">&times;</span>
            <div class="profile-header">
                <h2 id="profileFleetName"></h2>
                <i id="profileStarIcon" class="fas fa-star text-yellow-300 hidden"></i>
                <i id="profileCrownIcon" class="fas fa-chess-king text-yellow-400 hidden"></i>
                <img id="profileLionIcon" src="https://d.top4top.io/p_3482hpjya1.png" alt="Lion Icon" class="w-6 h-6 ml-1 hidden animated-lion-icon" draggable="false">
                <span id="profileLionCountDisplay" class="text-xs text-gray-400 ml-1 hidden">x0</span>
                <div id="profileStatusDot" class="status-dot"></div>
            </div>
            <div class="profile-stats-grid">
                <div class="profile-stat-item">
                    <i class="fas fa-fist-raised text-red-500"></i>
                    <span id="profileTotalPower">0</span>
                    <p class="text-xs text-gray-400">القوة الكلية</p>
                </div>
            </div>
            <div class="profile-ships-section">
                <h3 class="text-xl font-bold mb-3 text-right">السفن:</h3>
                <div id="profileShipsList" class="space-y-3">
                    <!-- Ship cards will be inserted here -->
                </div>
            </div>
            <div class="profile-footer">
                <p>معرف المستخدم: <span id="profileUserId"></span></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, push, query, orderByChild, onDisconnect, serverTimestamp, limitToLast } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut, signInAnonymously, EmailAuthProvider, linkWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBAepZChU6qfWGTQDrzEpJm_TRIrr6vhq8",
            authDomain: "mygame-7c747.firebaseapp.com",
            databaseURL: "https://mygame-7c747-default-rtdb.firebaseio.com",
            projectId: "mygame-7c747",
            storageBucket: "mygame-7c747.firebasestorage.app",
            messagingSenderId: "191691681571",
            appId: "1:191691681571:web:8dbc3991cb550b5e026696",
            measurementId: "G-XDP3YKZGH3"
        };
        
        const appId = firebaseConfig.projectId; 

        // Constants for game mechanics
        const INITIAL_SHIP_MAX_POWER = 10000;
        const UPGRADE_COOLDOWN_MS = 3 * 60 * 1000; // 3 minutes
        const ATTACK_COOLDOWN_GLOBAL_MS = 5 * 60 * 1000; // 5 minutes
        const FREE_BOX_COOLDOWN_MS = 1 * 60 * 60 * 1000; // 1 hour
        const ROULETTE_COOLDOWN_MS = 1 * 60 * 1000; // 1 minute
        const MAX_ACCUMULATED_RESOURCES = 200; // Max resources for the collection button
        const RESOURCE_ACCUMULATION_INTERVAL_MS = 10 * 1000; // Accumulate resources every 10 seconds

        let app;
        let db;
        let auth;
        let userId = null;
        let userDbRef = null; 
        let onlinePlayersListener = null; 
        let attackLogListener = null; 
        let currentActiveSectionId = null; 

        let playerData = {
            power: 0,
            money: 0,
            keys: 0,
            fleetName: null, 
            isFleetNameSet: false, // New flag for fleet name
            isGoldenNameOwned: false,
            isGoldenNameActive: false,
            isPinkNameOwned: false, 
            isPinkNameActive: false,
            isFieryNameOwned: false, 
            isFieryNameActive: false,
            isSilverNameOwned: false, 
            isSilverNameActive: false, 
            isBlueGlowNameOwned: false, 
            isBlueGlowNameActive: false, 
            isEmeraldNameOwned: false, 
            isEmeraldNameActive: false, 
            isRoyalCrimsonNameOwned: false, 
            isRoyalCrimsonNameActive: false, 
            isStarIconOwned: false,
            isStarIconActive: false,
            isCrownIconOwned: false, 
            isCrownIconActive: false,
            lionCount: 0, 
            isLionActive: false, 
            freeBoxCooldownEndTime: 0,
            ship1: { power: 0, level: 0, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER },
            ship2: { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER },
            ship3: { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER },
            globalAttackCooldownEndTime: 0,
            rouletteCooldownEndTime: 0,
            accumulatedResources: 0,
            lastAttackedOpponentId: null,
            lastUpdated: 0 
        };

        let gameActive = false;
        let currentMultiplier = 1.00;
        let crashPoint = 0;
        let betAmount = 0;
        let hasCashedOut = false;
        let animationFrameId;
        let lastFrameTime = 0;

        let playerPowerEl;
        let playerMoneyEl;
        let playerKeysEl;
        let fleetNameEl;
        let fleetStarIconEl;
        let fleetCrownIconEl; 
        let fleetLionIconEl;
        let lionCountDisplayEl; 
        let logoutBtn;
        let changeNameBtn; 

        let ship1PowerEl;
        let ship1LevelEl;
        let ship1ProgressEl;
        let ship1MaxPowerEl;
        let upgradeShip1Btn;
        let ship1CooldownDisplay;
        let ship1IconContainerEl; 
        let ship1IconIEl;
        let ship1IconImgEl;

        let ship2Container;
        let ship2PowerEl;
        let ship2LevelEl;
        let ship2ProgressEl;
        let ship2MaxPowerEl;
        let upgradeShip2Btn;
        let ship2CooldownDisplay;
        let ship2IconContainerEl; 
        let ship2IconImgEl;
        let ship2IconIEl;

        let ship3Container;
        let ship3PowerEl;
        let ship3LevelEl;
        let ship3ProgressEl;
        let ship3MaxPowerEl;
        let upgradeShip3Btn;
        let ship3CooldownDisplay;
        let ship3IconContainerEl; 
        let ship3IconImgEl;
        let ship3IconIEl;

        let mainMenuSection;
        let myFleetSection;
        let storeSection;
        let onlineSection;
        let rouletteSection;
        let developmentsSection; 
        let challengeLogSection;
        let attackSection;
        let onlinePlayersSection;
        let accountSection; // New account section

        let messageModal;
        let modalMessage;
        let confirmModal; // New confirm modal
        let confirmMessage;
        let confirmYesBtn;
        let confirmNoBtn;

        let authModal;
        let startGameBtnAuth; // Changed from login/register

        let changeFleetNameModal; 
        let changeFleetNameInput;
        let confirmChangeFleetNameBtn;

        let resourceCollectionBtnWrapper;
        let resourceCollectionBtn;
        let accumulatedResourcesDisplay;
        let circleProgress;
        let resourceBtnTextEl; 
        let resourceBtnIconEl; 
        const radius = 40;
        const circumference = 2 * Math.PI * radius;

        let storeItemDetailModal;
        let storeItemTitle;
        let storeItemIcon;
        let storeItemIconImg; 
        let storeItemDescription;
        let storeItemPrice;
        let buyStoreItemBtn;
        let currentStoreItemKey = null;

        let rouletteGameElements; 
        let rouletteDisplayArea;
        let multiplierDisplay;
        let betAmountInput;
        let startGameBtn;
        let cashOutBtn;
        let potentialWinningsEl;
        let rouletteResult;
        let rouletteCooldownDisplay;
        let planeSvg;

        let shipFormsList; 

        let onlinePlayersListEl;
        let offlinePlayersListEl;
        let challengeLogListEl;
        let attackablePlayersListEl;

        let playerProfileModal; 
        let profileFleetNameEl; 
        let profileStarIconEl; 
        let profileCrownIconEl; 
        let profileLionIconEl;
        let profileLionCountDisplayEl; 
        let profileStatusDotEl; 
        let profileTotalPowerEl; 
        let profileShipsListEl; 
        let profileUserIdEl; 

        // Account section elements
        let currentUserIdEl;
        let accountTypeEl;
        let linkAccountSection;
        let linkEmailInput;
        let linkPasswordInput;
        let linkAccountBtn;
        let permanentAccountOptions;
        let restoreDataBtn;

        const shipFormsData = [
            { levelRange: '1 - 1000', iconType: 'font-awesome', iconClass: 'fas fa-ship', imgSrc: '' },
            { levelRange: '1001 - 4000', iconType: 'image', iconClass: '', imgSrc: 'https://l.top4top.io/p_3482en0id0.png' },
            { levelRange: '4001 - 9999', iconType: 'image', iconClass: '', imgSrc: 'https://b.top4top.io/p_3482vv1ax2.png' },
            { levelRange: '10000+', iconType: 'image', iconClass: '', imgSrc: 'https://c.top4top.io/p_3482878s83.png' }
        ];

        const storeItems = {
            completeUpgrade: {
                title: 'إكمال التطوير',
                iconType: 'image', 
                icon: 'https://c.top4top.io/p_3482irls40.png',
                description: 'ينهي وقت انتظار تطوير السفن.',
                price: 2,
                currency: 'key',
                type: 'utility'
            },
            shipExpansion: {
                title: 'توسيع السفينة',
                iconType: 'font-awesome', 
                icon: 'fas fa-expand-arrows-alt text-blue-400',
                description: 'يزيد الحد الأقصى لقوة السفينة المختارة بمقدار 5000 نقطة قوة إضافية. يمكن شراء هذا التوسيع عدة مرات لأي سفينة.',
                price: 50, 
                currency: 'key',
                type: 'utility'
            },
            buyKeys: { 
                title: 'شراء مفاتيح',
                iconType: 'font-awesome', 
                icon: 'fas fa-key text-yellow-400',
                description: 'احصل على المزيد من المفاتيح لفتح الميزات أو إكمال التطوير.',
                price: 150, 
                currency: 'money',
                amount: 1,
                type: 'utility'
            },
            luckyBox: { 
                title: 'صندوق الحظ',
                iconType: 'image',
                icon: 'https://e.top4top.io/p_348281x7t0.png',
                description: 'جرب حظك واحصل على جوائز قيمة!',
                price: 3500,
                currency: 'money',
                type: 'lucky_box'
            },
            freeBox: { 
                title: 'صندوق مجاني',
                iconType: 'image',
                icon: 'https://a.top4top.io/p_3483uplj00.png',
                description: 'احصل على مكافآت مجانية كل ساعة!',
                price: 0,
                currency: 'none',
                type: 'free_box'
            },
            goldenName: {
                title: 'اسم ذهبي متحرك',
                iconType: 'font-awesome', 
                icon: 'fas fa-crown text-yellow-400',
                description: 'اجعل اسم أسطولك يتوهج بالذهب.',
                price: 3000,
                currency: 'money',
                type: 'name_cosmetic',
                ownedKey: 'isGoldenNameOwned',
                activeKey: 'isGoldenNameActive',
                cssClass: 'golden-text'
            },
            pinkName: { 
                title: 'اسم وردي متحرك',
                iconType: 'font-awesome', 
                icon: 'fas fa-heart text-pink-500',
                description: 'اجعل اسم أسطولك يتوهج باللون الوردي.',
                price: 1500,
                currency: 'money',
                type: 'name_cosmetic',
                ownedKey: 'isPinkNameOwned',
                activeKey: 'isPinkNameActive',
                cssClass: 'pink-text'
            },
            fieryName: { 
                title: 'اسم ناري ملتهب',
                iconType: 'font-awesome', 
                icon: 'fas fa-fire text-orange-500',
                description: 'اجعل اسم أسطولك يتوهج بالنار.',
                price: 2000,
                currency: 'money',
                type: 'name_cosmetic',
                ownedKey: 'isFieryNameOwned',
                activeKey: 'isFieryNameActive',
                cssClass: 'fiery-text'
            },
            silverName: { 
                title: 'اسم فضي لامع',
                iconType: 'font-awesome',
                icon: 'fas fa-gem text-gray-300',
                description: 'اجعل اسم أسطولك يتوهج بالفضة.',
                price: 2500,
                currency: 'money',
                type: 'name_cosmetic',
                ownedKey: 'isSilverNameOwned',
                activeKey: 'isSilverNameActive',
                cssClass: 'silver-text'
            },
            blueGlowName: { 
                title: 'اسم أزرق متوهج',
                iconType: 'font-awesome',
                icon: 'fas fa-lightbulb text-blue-400',
                description: 'اجعل اسم أسطولك يتوهج باللون الأزرق.',
                price: 4000,
                currency: 'money',
                type: 'name_cosmetic',
                ownedKey: 'isBlueGlowNameOwned',
                activeKey: 'isBlueGlowNameActive',
                cssClass: 'blue-glow-text'
            },
            emeraldName: { 
                title: 'اسم أخضر زمردي',
                iconType: 'font-awesome',
                icon: 'fas fa-leaf text-green-500',
                description: 'اجعل اسم أسطولك يتوهج باللون الأخضر الزمردي.',
                price: 6000,
                currency: 'money',
                type: 'name_cosmetic',
                ownedKey: 'isEmeraldNameOwned',
                activeKey: 'isEmeraldNameActive',
                cssClass: 'emerald-text'
            },
            royalCrimsonName: { 
                title: 'اسم قرمزي ملكي',
                iconType: 'font-awesome',
                icon: 'fas fa-shield-alt text-red-600',
                description: 'اجعل اسم أسطولك يتوهج باللون القرمزي الملكي.',
                price: 9000,
                currency: 'money',
                type: 'name_cosmetic',
                ownedKey: 'isRoyalCrimsonNameOwned',
                activeKey: 'isRoyalCrimsonNameActive',
                cssClass: 'royal-crimson-text'
            },
            starIcon: {
                title: 'أيقونة النجمة',
                iconType: 'font-awesome', 
                icon: 'fas fa-star text-yellow-300',
                description: 'أضف نجمة لامعة بجانب اسمك.',
                price: 3000,
                currency: 'money',
                type: 'icon_cosmetic',
                ownedKey: 'isStarIconOwned',
                activeKey: 'isStarIconActive'
            },
            crownIcon: { 
                title: 'أيقونة تاج ذهبي',
                iconType: 'font-awesome', 
                icon: 'fas fa-chess-king text-yellow-400',
                description: 'أضف تاجاً ذهبياً متحركاً بجانب اسمك.',
                price: 5000,
                currency: 'money',
                type: 'icon_cosmetic',
                ownedKey: 'isCrownIconOwned',
                activeKey: 'isCrownIconActive'
            },
            lionIcon: { 
                title: 'أيقونة الأسد المتوهج',
                iconType: 'image',
                icon: 'https://d.top4top.io/p_3482hpjya1.png',
                description: 'أيقونة أسد متوهجة تمنح 7000 قوة إضافية لأسطولك. يمكن الحصول عليها من صندوق الحظ.',
                price: '-', 
                currency: 'none',
                type: 'icon_cosmetic',
                ownedKey: 'lionCount', 
                activeKey: 'isLionActive'
            }
        };

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'm';
            }
            if (num >= 10000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        window.showMessage = function(message) {
            modalMessage.textContent = message;
            modalMessage.classList.remove('hidden');
            messageModal.style.display = 'flex';
        }

        window.closeModal = function() {
            messageModal.style.display = 'none';
        }

        // New confirm dialog function
        window.showConfirm = function(message, onConfirmCallback) {
            confirmMessage.textContent = message;
            confirmModal.style.display = 'flex';

            const handleConfirm = () => {
                onConfirmCallback(true);
                confirmModal.style.display = 'none';
                confirmYesBtn.removeEventListener('click', handleConfirm);
                confirmNoBtn.removeEventListener('click', handleCancel);
            };

            const handleCancel = () => {
                onConfirmCallback(false);
                confirmModal.style.display = 'none';
                confirmYesBtn.removeEventListener('click', handleConfirm);
                confirmNoBtn.removeEventListener('click', handleCancel);
            };

            confirmYesBtn.addEventListener('click', handleConfirm);
            confirmNoBtn.addEventListener('click', handleCancel);
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem(`playerData_${userId}`, JSON.stringify(playerData));
            } catch (e) {
                console.error("Error saving to local storage:", e);
            }
        }

        function loadFromLocalStorage(targetUserId = userId) {
            try {
                const storedData = localStorage.getItem(`playerData_${targetUserId}`);
                if (storedData) {
                    return JSON.parse(storedData);
                }
            } catch (e) {
                console.error("Error loading from local storage:", e);
            }
            return null;
        }

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                auth = getAuth(app);

                // No setPersistence needed for anonymous, but good to keep if other methods are added
                // setPersistence(auth, browserLocalPersistence).catch((error) => {
                //     console.error("Error setting persistence:", error);
                //     window.showMessage(`خطأ في إعدادات الحفظ: ${error.message}`);
                // });

                authModal.style.display = 'flex';

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userDbRef = ref(db, `artifacts/${appId}/users/${userId}/playerData`);
                        
                        const presenceRef = ref(db, `artifacts/${appId}/public/onlinePlayers/${userId}/isOnline`);
                        const lastSeenRef = ref(db, `artifacts/${appId}/public/onlinePlayers/${userId}/lastSeen`);
                        await set(ref(db, `artifacts/${appId}/public/onlinePlayers/${userId}/userId`), userId); 
                        onDisconnect(presenceRef).set(false);
                        onDisconnect(lastSeenRef).set(serverTimestamp());

                        await fetchAndSyncUserData(); 

                        await updateOnlineStatus(true); 
                        setupPublicDataListeners(); 

                        authModal.style.display = 'none'; 
                        window.showSection('mainMenu'); 

                        setInterval(() => {
                            if (userId) {
                                updateOnlineStatus(true);
                            }
                        }, 10 * 1000); 

                    } else {
                        userId = null;
                        userDbRef = null; 
                        clearPublicDataListeners(); 
                        authModal.style.display = 'flex';
                        showSection('hidden'); 
                        resourceCollectionBtnWrapper.classList.add('hidden');
                    }
                });

            } catch (initializationError) {
                window.showMessage(`حدث خطأ حرج في تهيئة Firebase: ${initializationError.message}. يرجى التحقق من إعدادات مشروع Firebase الخاص بك.`);
            }
        }

        async function handleStartGame() {
            try {
                await signInAnonymously(auth);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                window.showMessage(`خطأ في بدء اللعب: ${error.message}`);
            }
        }

        async function logoutUser() {
            try {
                if (userId) {
                    await updateOnlineStatus(false);
                }

                await signOut(auth);
                window.showMessage('تم تسجيل الخروج بنجاح!');

                playerData = { 
                    power: 0, money: 0, keys: 0, fleetName: null, 
                    isFleetNameSet: false,
                    isGoldenNameOwned: false, isGoldenNameActive: false,
                    isPinkNameOwned: false, isPinkNameActive: false,
                    isFieryNameOwned: false, isFieryNameActive: false,
                    isSilverNameOwned: false, isSilverNameActive: false,
                    isBlueGlowNameOwned: false, isBlueGlowNameActive: false,
                    isEmeraldNameOwned: false, isEmeraldNameActive: false,
                    isRoyalCrimsonNameOwned: false, isRoyalCrimsonNameActive: false,
                    isStarIconOwned: false, isStarIconActive: false,
                    isCrownIconOwned: false, isCrownIconActive: false,
                    lionCount: 0, isLionActive: false, 
                    freeBoxCooldownEndTime: 0,
                    ship1: { power: 0, level: 0, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER },
                    ship2: { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER },
                    ship3: { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER },
                    globalAttackCooldownEndTime: 0,
                    rouletteCooldownEndTime: 0,
                    accumulatedResources: 0,
                    lastAttackedOpponentId: null,
                    lastUpdated: 0
                };
                saveToLocalStorage(); 
                updateUIFromPlayerData();

            } catch (error) {
                console.error("Error logging out:", error);
                window.showMessage(`خطأ في تسجيل الخروج: ${error.message}`);
            }
        }

        async function fetchAndSyncUserData() {
            if (!userId) {
                return;
            }
            let localData = loadFromLocalStorage();
            let firebaseData = null;

            try {
                const snapshot = await get(userDbRef);
                if (snapshot.exists()) {
                    firebaseData = snapshot.val();
                }
            } catch (error) {
                console.error("Error fetching Firebase data:", error);
                window.showMessage("حدث خطأ أثناء تحميل بياناتك من السحابة. قد تكون البيانات قديمة.");
            }

            if (localData && firebaseData) {
                if (localData.lastUpdated > firebaseData.lastUpdated) {
                    playerData = localData;
                    await saveUserDataToFirebase(); 
                } else {
                    playerData = firebaseData;
                    saveToLocalStorage(); 
                }
            } else if (localData) {
                playerData = localData;
                await saveUserDataToFirebase(); 
            } else if (firebaseData) {
                playerData = firebaseData;
                saveToLocalStorage(); 
            } else {
                // New user - initialize data
                playerData = { 
                    power: 0, money: 100, keys: 1, fleetName: "قائد جديد", 
                    isFleetNameSet: false, // Default to false for new users
                    isGoldenNameOwned: false, isGoldenNameActive: false,
                    isPinkNameOwned: false, isPinkNameActive: false,
                    isFieryNameOwned: false, isFieryNameActive: false,
                    isSilverNameOwned: false, isSilverNameActive: false,
                    isBlueGlowNameOwned: false, isBlueGlowNameActive: false,
                    isEmeraldNameOwned: false, isEmeraldNameActive: false,
                    isRoyalCrimsonNameOwned: false, isRoyalCrimsonNameActive: false,
                    isStarIconOwned: false, isStarIconActive: false,
                    isCrownIconOwned: false, isCrownIconActive: false,
                    lionCount: 0, isLionActive: false, 
                    freeBoxCooldownEndTime: 0,
                    ship1: { power: 0, level: 0, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER },
                    ship2: { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER },
                    ship3: { power: 0, level: 0, unlocked: false, cooldownEndTime: 0, maxPower: INITIAL_SHIP_MAX_POWER },
                    globalAttackCooldownEndTime: 0,
                    rouletteCooldownEndTime: 0,
                    accumulatedResources: 0,
                    lastAttackedOpponentId: null,
                    lastUpdated: Date.now()
                };
                saveToLocalStorage();
                await saveUserDataToFirebase();
            }
            updateUIFromPlayerData();
        }

        async function saveUserDataToFirebase() {
            if (!userDbRef || !userId) {
                return;
            }
            try {
                playerData.lastUpdated = Date.now(); 
                await set(userDbRef, playerData);
            } catch (error) {
                console.error("Error saving user data to Firebase:", error);
                window.showMessage("حدث خطأ أثناء حفظ بياناتك على السحابة.");
            }
        }

        function updateUIFromPlayerData() {
            if (!userId) return;

            playerData.power = playerData.ship1.power + (playerData.ship2.unlocked ? playerData.ship2.power : 0) + (playerData.ship3.unlocked ? playerData.ship3.power : 0);
            playerData.power += (playerData.lionCount * 7000); 

            playerPowerEl.textContent = formatNumber(playerData.power);
            playerMoneyEl.textContent = formatNumber(playerData.money);
            playerKeysEl.textContent = formatNumber(playerData.keys);
            fleetNameEl.textContent = playerData.fleetName;
            
            fleetNameEl.classList.remove('golden-text', 'pink-text', 'fiery-text', 'silver-text', 'blue-glow-text', 'emerald-text', 'royal-crimson-text');
            
            if (playerData.isGoldenNameActive) {
                fleetNameEl.classList.add('golden-text');
            } else if (playerData.isPinkNameActive) { 
                fleetNameEl.classList.add('pink-text');
            } else if (playerData.isFieryNameActive) { 
                fleetNameEl.classList.add('fiery-text');
            } else if (playerData.isSilverNameActive) { 
                fleetNameEl.classList.add('silver-text');
            } else if (playerData.isBlueGlowNameActive) { 
                fleetNameEl.classList.add('blue-glow-text');
            } else if (playerData.isEmeraldNameActive) { 
                fleetNameEl.classList.add('emerald-text');
            } else if (playerData.isRoyalCrimsonNameActive) { 
                fleetNameEl.classList.add('royal-crimson-text');
            }

            fleetStarIconEl.classList.toggle('hidden', !playerData.isStarIconActive);
            fleetCrownIconEl.classList.toggle('hidden', !playerData.isCrownIconActive);
            fleetCrownIconEl.classList.toggle('animated-crown-icon', playerData.isCrownIconActive);
            
            fleetLionIconEl.classList.toggle('hidden', playerData.lionCount === 0 || !playerData.isLionActive); 
            fleetLionIconEl.classList.toggle('animated-lion-icon', playerData.isLionActive); 
            lionCountDisplayEl.classList.toggle('hidden', playerData.lionCount === 0 || !playerData.isLionActive); 
            lionCountDisplayEl.textContent = `x${playerData.lionCount}`;

            // Handle fleet name change button visibility
            changeNameBtn.classList.toggle('hidden', playerData.isFleetNameSet);

            updateShipUI(playerData.ship1, ship1PowerEl, ship1LevelEl, ship1ProgressEl, upgradeShip1Btn, null, ship1CooldownDisplay, ship1MaxPowerEl, ship1IconContainerEl, ship1IconIEl, ship1IconImgEl);
            updateShipUI(playerData.ship2, ship2PowerEl, ship2LevelEl, ship2ProgressEl, upgradeShip2Btn, ship2Container, ship2CooldownDisplay, ship2MaxPowerEl, ship2IconContainerEl, ship2IconIEl, ship2IconImgEl);
            updateShipUI(playerData.ship3, ship3PowerEl, ship3LevelEl, ship3ProgressEl, upgradeShip3Btn, ship3Container, ship3CooldownDisplay, ship3MaxPowerEl, ship3IconContainerEl, ship3IconIEl, ship3IconImgEl);
            
            updateResourceCircle();
            updateResourceButtonState();
            updateRouletteCooldownUI();
            updateAttackCooldownsUI();
            updateAccountSectionUI(); // Update account section visibility

            saveToLocalStorage();
            saveUserDataToFirebase(); 
            updateOnlineStatus(true); 
        }

        async function updateOnlineStatus(isOnline) {
            if (!userId || !playerData.fleetName || !db) {
                return;
            }
            try {
                const playerStatusRef = ref(db, `artifacts/${appId}/public/onlinePlayers/${userId}`);
                const dataToSave = {
                    userId: userId,
                    fleetName: playerData.fleetName,
                    power: playerData.power, 
                    isOnline: isOnline,
                    lastSeen: Date.now(),
                    ship1: { power: playerData.ship1.power, level: playerData.ship1.level, unlocked: true, maxPower: playerData.ship1.maxPower }, 
                    ship2: { power: playerData.ship2.power, level: playerData.ship2.level, unlocked: playerData.ship2.unlocked, maxPower: playerData.ship2.maxPower },
                    ship3: { power: playerData.ship3.power, level: playerData.ship3.level, unlocked: playerData.ship3.unlocked, maxPower: playerData.ship3.maxPower },
                    isGoldenNameActive: playerData.isGoldenNameActive,
                    isPinkNameActive: playerData.isPinkNameActive, 
                    isFieryNameActive: playerData.isFieryNameActive, 
                    isSilverNameActive: playerData.isSilverNameActive, 
                    isBlueGlowNameActive: playerData.isBlueGlowNameActive, 
                    isEmeraldNameActive: playerData.isEmeraldNameActive, 
                    isRoyalCrimsonNameActive: playerData.isRoyalCrimsonNameActive, 
                    isStarIconActive: playerData.isStarIconActive,
                    isCrownIconActive: playerData.isCrownIconActive,
                    isLionActive: playerData.isLionActive, 
                    lionCount: playerData.lionCount 
                };
                await set(playerStatusRef, dataToSave);
            } catch (error) {
                console.error("Error updating online status:", error);
            }
        }

        function setupPublicDataListeners() {
            if (!db) {
                return;
            }

            const playersRef = ref(db, `artifacts/${appId}/public/onlinePlayers`);
            onlinePlayersListener = onValue(playersRef, (snapshot) => {
                const data = snapshot.val();
                const allPlayers = [];
                if (data) {
                    for (const key in data) {
                        allPlayers.push(data[key]);
                    }
                }
                updateOnlinePlayersUI(allPlayers);
                if (document.getElementById('attackSection').classList.contains('animate-fade-in-up')) {
                    renderAttackablePlayers(allPlayers);
                }
            }, (error) => {
                console.error("Error listening to onlinePlayers:", error);
            });

            const attackLogRef = ref(db, `artifacts/${appId}/public/attackLog`);
            const attackLogQuery = query(attackLogRef, orderByChild('timestamp'), limitToLast(5));
            attackLogListener = onValue(attackLogQuery, (snapshot) => {
                const data = snapshot.val();
                const attacks = [];
                if (data) {
                    for (const key in data) {
                        attacks.push(data[key]);
                    }
                }
                attacks.sort((a, b) => b.timestamp - a.timestamp); 
                updateChallengeLogUI(attacks);
            }, (error) => {
                console.error("Error listening to attackLog:", error);
            });
        }

        function clearPublicDataListeners() {
            if (onlinePlayersListener) {
                onlinePlayersListener(); 
                onlinePlayersListener = null;
            }
            if (attackLogListener) {
                attackLogListener();
                attackLogListener = null;
            }
        }

        function updateOnlinePlayersUI(players) {
            if (!onlinePlayersListEl || !offlinePlayersListEl) return;
            if (!userId) return;

            onlinePlayersListEl.innerHTML = '';
            offlinePlayersListEl.innerHTML = '';

            const online = players.filter(p => p.isOnline && p.userId !== userId);
            const offline = players.filter(p => !p.isOnline && p.userId !== userId);

            const getPlayerTotalPower = (playerData) => {
                let totalPower = 0;
                if (playerData.ship1 && playerData.ship1.power !== undefined) totalPower += playerData.ship1.power;
                if (playerData.ship2 && playerData.ship2.unlocked && playerData.ship2.power !== undefined) totalPower += playerData.ship2.power;
                if (playerData.ship3 && playerData.ship3.unlocked && playerData.ship3.power !== undefined) totalPower += playerData.ship3.power;
                if (playerData.lionCount !== undefined) totalPower += (playerData.lionCount * 7000); 
                return totalPower;
            };

            const renderPlayerListItem = (player, isOnlineStatus) => {
                const li = document.createElement('li');
                li.className = `online-player-list-item ${isOnlineStatus ? 'online' : 'offline'}`;
                li.dataset.userId = player.userId; 

                let fleetNameClass = '';
                if (player.isGoldenNameActive) fleetNameClass = 'golden-text';
                else if (player.isPinkNameActive) fleetNameClass = 'pink-text';
                else if (player.isFieryNameActive) fleetNameClass = 'fiery-text';
                else if (player.isSilverNameActive) fleetNameClass = 'silver-text'; 
                else if (player.isBlueGlowNameActive) fleetNameClass = 'blue-glow-text'; 
                else if (player.isEmeraldNameActive) fleetNameClass = 'emerald-text'; 
                else if (player.isRoyalCrimsonNameActive) fleetNameClass = 'royal-crimson-text'; 

                const textColor = isOnlineStatus ? 'text-gray-300' : 'text-gray-500';

                let fleetNameHtml = `<span class="font-bold ${fleetNameClass}">${player.fleetName}</span>`;
                if (player.isStarIconActive) {
                    fleetNameHtml += `<i class="fas fa-star text-yellow-300 ml-1"></i>`;
                }
                if (player.isCrownIconActive) { 
                    fleetNameHtml += `<i class="fas fa-chess-king text-yellow-400 ml-1 animated-crown-icon"></i>`;
                }
                if (player.isLionActive && player.lionCount > 0) {
                    fleetNameHtml += `<img src="https://d.top4top.io/p_3482hpjya1.png" alt="Lion Icon" class="w-4 h-4 ml-1 animated-lion-icon" draggable="false">`;
                    fleetNameHtml += `<span class="text-xs text-gray-400 ml-1">x${player.lionCount}</span>`;
                }

                const totalPower = getPlayerTotalPower(player);

                let shipsHtml = `<div class="online-player-ships">`;
                const playerShips = [player.ship1, player.ship2, player.ship3];
                playerShips.forEach((shipData, index) => {
                    const shipLevel = shipData ? shipData.level : 0;
                    const shipUnlocked = (index === 0) || (shipData ? shipData.unlocked : false); 
                    const iconSrc = getShipIcon(shipLevel);
                    const iconClass = shipUnlocked ? 'unlocked' : 'locked';

                    if (iconSrc === 'font-awesome') {
                        shipsHtml += `
                            <div class="online-player-ship-icon ${iconClass}">
                                <i class="fas fa-ship ${shipUnlocked ? 'text-blue-400' : 'text-gray-500'}"></i>
                            </div>
                        `;
                    } else {
                        shipsHtml += `
                            <div class="online-player-ship-icon ${iconClass}">
                                <img src="${iconSrc}" alt="Ship ${index + 1} Icon" onerror="this.onerror=null;this.src='https://placehold.co/25x25/21262d/e2e8f0?text=X';" draggable="false" />
                            </div>
                        `;
                    }
                });
                shipsHtml += `</div>`;

                li.innerHTML = `
                    <div class="online-player-info">
                        ${fleetNameHtml}
                        <span class="text-sm ${textColor} mr-2">
                            <i class="fas fa-fist-raised text-red-500 ml-1"></i> ${formatNumber(totalPower)}
                        </span>
                    </div>
                    ${shipsHtml}
                `;
                li.addEventListener('click', () => showPlayerProfile(player)); 
                return li;
            };

            if (online.length === 0) {
                onlinePlayersListEl.innerHTML = '<p class="text-center text-gray-400">لا يوجد لاعبون متصلون حالياً غيرك.</p>';
            } else {
                online.forEach(player => {
                    const listItem = renderPlayerListItem(player, true);
                    onlinePlayersListEl.appendChild(listItem);
                });
            }

            if (offline.length === 0) {
                offlinePlayersListEl.innerHTML = '<p class="text-center text-gray-400">لا يوجد لاعبون غير متصلين حالياً.</p>';
            } else {
                offline.forEach(player => {
                    const listItem = renderPlayerListItem(player, false);
                    offlinePlayersListEl.appendChild(listItem);
                });
            }
        }

        function updateChallengeLogUI(attacks) {
            if (!challengeLogListEl) return;
            if (!userId) return;

            challengeLogListEl.innerHTML = '';
            if (attacks.length === 0) {
                challengeLogListEl.innerHTML = '<p class="text-center text-gray-400">لا يوجد سجلات هجوم حالياً.</p>';
                return;
            }

            attacks.forEach(attack => {
                const li = document.createElement('li');
                li.className = 'bg-gray-700 p-3 rounded-md mb-2';
                let resultText = '';
                let resultColor = '';
                let winningsText = '';

                if (attack.attackerId === userId) {
                    if (attack.result === 'win') {
                        resultText = 'فزت';
                        resultColor = 'text-green-400';
                        if (attack.winnings && attack.winnings.money !== undefined) { 
                            winningsText = ` +${formatNumber(attack.winnings.money)} <i class="fas fa-dollar-sign"></i>`;
                        }
                        if (attack.winnings && attack.winnings.key !== undefined) { 
                            winningsText += ` +${attack.winnings.key} <i class="fas fa-key"></i>`;
                        }
                    } else {
                        resultText = 'خسرت';
                        resultColor = 'text-red-400';
                    }
                    li.innerHTML = `<span class="font-bold ${resultColor}">أنت</span> ${resultText} ضد <span class="font-bold">${attack.defenderFleetName}</span>. ${winningsText}`;
                } else if (attack.defenderId === userId) {
                    if (attack.result === 'win') {
                        resultText = 'فاز';
                        resultColor = 'text-green-400';
                    } else {
                        resultText = 'خسر';
                        resultColor = 'text-red-400';
                    }
                    li.innerHTML = `<span class="font-bold">${attack.attackerFleetName}</span> ${resultText} ضد <span class="font-bold ${resultColor}">أسطولك</span>.`;
                } else {
                    if (attack.result === 'win') {
                        resultText = 'فاز';
                        resultColor = 'text-green-400';
                    } else {
                        resultText = 'خسر';
                        resultColor = 'text-red-400';
                    }
                    li.innerHTML = `<span class="font-bold">${attack.attackerFleetName}</span> ${resultText} ضد <span class="font-bold">${attack.defenderFleetName}</span>.`;
                }
                
                const timestamp = typeof attack.timestamp === 'number' ? attack.timestamp : Date.now();
                li.innerHTML += `<p class="text-xs text-gray-500 mt-1">${new Date(timestamp).toLocaleString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>`;
                challengeLogListEl.appendChild(li);
            });
        }

        function renderAttackablePlayers(allPlayers) {
            if (!attackablePlayersListEl || !userId) return;

            attackablePlayersListEl.innerHTML = '';
            let otherPlayers = allPlayers.filter(p => p.userId !== userId);

            const cooldownActive = playerData.globalAttackCooldownEndTime > Date.now();
            if (cooldownActive && playerData.lastAttackedOpponentId) {
                const lastOpponent = otherPlayers.find(p => p.userId === playerData.lastAttackedOpponentId);
                if (lastOpponent) {
                    otherPlayers = [lastOpponent];
                } else {
                    otherPlayers = [];
                }
            }

            if (otherPlayers.length === 0) {
                attackablePlayersListEl.innerHTML = '<p class="text-center text-gray-400">لا يوجد لاعبون آخرون للهجوم عليهم حالياً.</p>';
                return;
            }

            otherPlayers.forEach(opponent => {
                const li = document.createElement('div');
                li.className = 'attack-player-item';

                let opponentTotalPower = (opponent.ship1?.power || 0) + (opponent.ship2?.unlocked ? opponent.ship2.power : 0) + (opponent.ship3?.unlocked ? opponent.ship3.power : 0);
                if (opponent.lionCount !== undefined) opponentTotalPower += (opponent.lionCount * 7000);
                
                const cooldownRemaining = playerData.globalAttackCooldownEndTime - Date.now();
                const isOnCooldown = cooldownRemaining > 0;
                const buttonText = isOnCooldown ? formatTime(cooldownRemaining) : 'هجوم';
                const buttonDisabled = isOnCooldown ? 'disabled' : '';

                let fleetNameClass = '';
                if (opponent.isGoldenNameActive) fleetNameClass = 'golden-text';
                else if (opponent.isPinkNameActive) fleetNameClass = 'pink-text';
                else if (opponent.isFieryNameActive) fleetNameClass = 'fiery-text';
                else if (opponent.isSilverNameActive) fleetNameClass = 'silver-text'; 
                else if (opponent.isBlueGlowNameActive) fleetNameClass = 'blue-glow-text'; 
                else if (opponent.isEmeraldNameActive) fleetNameClass = 'emerald-text'; 
                else if (opponent.isRoyalCrimsonNameActive) fleetNameClass = 'royal-crimson-text'; 
                
                let fleetNameHtml = `<h3 class="${fleetNameClass}">${opponent.fleetName}</h3>`;
                if (opponent.isStarIconActive) {
                    fleetNameHtml += `<i class="fas fa-star text-yellow-300 ml-1"></i>`;
                }
                if (opponent.isCrownIconActive) { 
                    fleetNameHtml += `<i class="fas fa-chess-king text-yellow-400 ml-1 animated-crown-icon"></i>`;
                }
                if (opponent.isLionActive && opponent.lionCount > 0) {
                    fleetNameHtml += `<img src="https://d.top4top.io/p_3482hpjya1.png" alt="Lion Icon" class="w-4 h-4 ml-1 animated-lion-icon" draggable="false">`;
                    fleetNameHtml += `<span class="text-xs text-gray-400 ml-1">x${opponent.lionCount}</span>`;
                }

                let shipsHtml = `<div class="online-player-ships">`;
                const opponentShips = [opponent.ship1, opponent.ship2, opponent.ship3];
                opponentShips.forEach((shipData, index) => {
                    const shipLevel = shipData ? shipData.level : 0;
                    const shipUnlocked = (index === 0) || (shipData ? shipData.unlocked : false); 
                    const iconSrc = getShipIcon(shipLevel);
                    const iconClass = shipUnlocked ? 'unlocked' : 'locked';

                    if (iconSrc === 'font-awesome') {
                        shipsHtml += `
                            <div class="online-player-ship-icon ${iconClass}">
                                <i class="fas fa-ship ${shipUnlocked ? 'text-blue-400' : 'text-gray-500'}"></i>
                            </div>
                        `;
                    } else {
                        shipsHtml += `
                            <div class="online-player-ship-icon ${iconClass}">
                                <img src="${iconSrc}" alt="Ship ${index + 1} Icon" onerror="this.onerror=null;this.src='https://placehold.co/25x25/21262d/e2e8f0?text=X';" draggable="false" />
                            </div>
                        `;
                    }
                });
                shipsHtml += `</div>`;

                li.innerHTML = `
                    <div class="player-info">
                        ${fleetNameHtml}
                        <p>
                            <i class="fas fa-fist-raised text-red-500"></i> ${formatNumber(opponentTotalPower)}
                        </p>
                    </div>
                    <div class="attack-btn-wrapper">
                        <button class="attack-player-btn" data-opponent-id="${opponent.userId}" ${buttonDisabled}>
                            ${buttonText}
                        </button>
                    </div>
                `;
                attackablePlayersListEl.appendChild(li);

                const attackButton = li.querySelector('.attack-player-btn');
                attackButton.addEventListener('click', () => performAttack(opponent));

                li.querySelector('.player-info').addEventListener('click', (event) => {
                    event.stopPropagation();
                    showPlayerProfile(opponent);
                });
            });
        }

        async function performAttack(opponent) {
            if (!opponent) {
                window.showMessage("الرجاء اختيار خصم أولاً.");
                return;
            }
            if (!userId) {
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }
            if (playerData.globalAttackCooldownEndTime > Date.now()) {
                window.showMessage(`لا يمكنك الهجوم الآن. يرجى الانتظار ${formatTime(playerData.globalAttackCooldownEndTime - Date.now())}.`);
                return;
            }

            let win = false;
            let opponentTotalPower = (opponent.ship1?.power || 0) + (opponent.ship2?.unlocked ? opponent.ship2.power : 0) + (opponent.ship3?.unlocked ? opponent.ship3.power : 0);
            if (opponent.lionCount !== undefined) opponentTotalPower += (opponent.lionCount * 7000);

            if (playerData.power > opponentTotalPower) {
                win = Math.random() < 0.9; 
            } else {
                win = Math.random() < 0.4; 
            }

            let winnings = { money: 0, key: 0 };
            let resultText = '';

            if (win) {
                const moneyGain = Math.floor(Math.random() * (800 - 200 + 1)) + 200;
                playerData.money += moneyGain;
                winnings.money = moneyGain;
                resultText = `لقد فزت! حصلت على ${formatNumber(moneyGain)} أموال.`;

                if (Math.random() < 0.15) {
                    playerData.keys += 1;
                    winnings.key = 1;
                    resultText += " وحصلت على مفتاح!";
                }
            } else {
                resultText = "لقد خسرت الهجوم. لم تخسر شيئاً.";
            }

            window.showMessage(resultText);
            updateUIFromPlayerData();

            playerData.globalAttackCooldownEndTime = Date.now() + ATTACK_COOLDOWN_GLOBAL_MS;
            playerData.lastAttackedOpponentId = opponent.userId; 
            saveToLocalStorage();
            saveUserDataToFirebase();
            
            if (document.getElementById('attackSection').classList.contains('animate-fade-in-up')) {
                const playersRef = ref(db, `artifacts/${appId}/public/onlinePlayers`);
                get(playersRef).then(snapshot => {
                    const data = snapshot.val();
                    const allPlayers = [];
                    if (data) {
                        for (const key in data) {
                            allPlayers.push(data[key]);
                        }
                    }
                    renderAttackablePlayers(allPlayers);
                }).catch(error => {
                    console.error("Error loading attackable players after attack:", error);
                    window.showMessage("حدث خطأ أثناء تحميل قائمة اللاعبين للهجوم.");
                });
            }

            try {
                const attackLogRef = ref(db, `artifacts/${appId}/public/attackLog`);
                await push(attackLogRef, {
                    attackerId: userId,
                    attackerFleetName: playerData.fleetName,
                    defenderId: opponent.userId,
                    defenderFleetName: opponent.fleetName,
                    result: win ? 'win' : 'loss',
                    winnings: winnings,
                    timestamp: serverTimestamp() 
                });
            } catch (error) {
                console.error("Error adding attack log entry:", error);
            }
        }

        function updateAttackCooldownsUI() {
            if (!userId) return;
            const cooldownRemaining = playerData.globalAttackCooldownEndTime - Date.now();
            const isOnCooldown = cooldownRemaining > 0;

            const attackButtons = attackablePlayersListEl.querySelectorAll('.attack-player-btn');
            attackButtons.forEach(button => {
                if (isOnCooldown) {
                    button.disabled = true;
                    button.textContent = formatTime(cooldownRemaining);
                } else {
                    button.disabled = false;
                    button.textContent = 'هجوم';
                }
            });

            if (playerData.lastGlobalCooldownState && !isOnCooldown) {
                playerData.lastAttackedOpponentId = null; 
                if (document.getElementById('attackSection').classList.contains('animate-fade-in-up')) {
                    if (db) {
                        const playersRef = ref(db, `artifacts/${appId}/public/onlinePlayers`);
                        get(playersRef).then(snapshot => {
                            const data = snapshot.val();
                            const allPlayers = [];
                            if (data) {
                                for (const key in data) {
                                    allPlayers.push(data[key]);
                                }
                            }
                            renderAttackablePlayers(allPlayers);
                        }).catch(error => {
                            console.error("Error refreshing attackable players after cooldown:", error);
                            window.showMessage("حدث خطأ أثناء تحميل قائمة اللاعبين للهجوم.");
                        });
                    }
                }
            }
            playerData.lastGlobalCooldownState = isOnCooldown; 
        }

        function populateShipFormsList() {
            if (!shipFormsList) return;
            shipFormsList.innerHTML = '';
            shipFormsData.forEach(form => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('ship-form-item');

                let iconHtml = '';
                if (form.iconType === 'font-awesome') {
                    iconHtml = `<i class="${form.iconClass} text-blue-400 glowing-icon"></i>`;
                } else {
                    iconHtml = `<img src="${form.imgSrc}" alt="Image of Ship Form" class="glowing-icon" onerror="this.onerror=null;this.src='https://placehold.co/50x50/21262d/e2e8f0?text=X';" draggable="false" />`;
                }

                itemDiv.innerHTML = `
                    <div class="icon-wrapper">
                        ${iconHtml}
                    </div>
                    <div class="text-content">
                        <h4>المستوى: ${form.levelRange}</h4>
                        <p>شكل السفينة</p>
                    </div>
                `;
                shipFormsList.appendChild(itemDiv);
            });
        }

        function formatTime(ms) {
            if (ms <= 0) return 'جاهز';
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function getShipIcon(level) {
            if (level >= 10000) {
                return 'https://c.top4top.io/p_3482878s83.png'; 
            } else if (level >= 4001) {
                return 'https://b.top4top.io/p_3482vv1ax2.png'; 
            } else if (level >= 1001) {
                return 'https://l.top4top.io/p_3482en0id0.png'; 
            } else {
                return 'font-awesome'; 
            }
        }

        function updateShipUI(ship, powerEl, levelEl, progressEl, upgradeBtn, containerEl, cooldownDisplayEl, maxPowerEl, iconContainerEl, iconIEl, iconImgEl) {
            if (!userId) return;
            powerEl.textContent = formatNumber(ship.power);
            levelEl.textContent = formatNumber(ship.level);
            maxPowerEl.textContent = formatNumber(ship.maxPower);
            const progress = (ship.power / ship.maxPower) * 100;
            progressEl.style.width = `${progress}%`;

            const currentTime = Date.now();
            const isOnCooldown = ship.cooldownEndTime > currentTime;

            if (ship.power >= ship.maxPower) {
                upgradeBtn.disabled = true;
                upgradeBtn.textContent = 'مطور بالكامل';
                upgradeBtn.classList.remove('btn-primary');
                upgradeBtn.classList.add('btn-success');
                cooldownDisplayEl.textContent = '';
                cooldownDisplayEl.classList.remove('cooldown-active');
            } else if (isOnCooldown) {
                upgradeBtn.disabled = true;
                upgradeBtn.textContent = 'في انتظار';
                upgradeBtn.classList.remove('btn-primary');
                cooldownDisplayEl.textContent = `متاح بعد: ${formatTime(ship.cooldownEndTime - currentTime)}`;
                cooldownDisplayEl.classList.add('cooldown-active');
            } else {
                upgradeBtn.disabled = false;
                upgradeBtn.textContent = 'تطوير';
                upgradeBtn.classList.remove('btn-success');
                upgradeBtn.classList.add('btn-primary');
                cooldownDisplayEl.textContent = 'جاهز للتطوير';
                cooldownDisplayEl.classList.remove('cooldown-active');
            }

            if (containerEl) {
                if (ship.unlocked) {
                    containerEl.classList.remove('opacity-50', 'pointer-events-none');
                    containerEl.querySelector('h3').classList.remove('text-gray-400');
                    containerEl.querySelector('h3').classList.add('text-blue-400');
                } else {
                    containerEl.classList.add('opacity-50', 'pointer-events-none');
                    containerEl.querySelector('h3').classList.remove('text-blue-400');
                    containerEl.querySelector('h3').classList.add('text-gray-400');
                }
            }

            const iconSrc = getShipIcon(ship.level);

            if (iconSrc === 'font-awesome') {
                if (iconIEl) {
                    iconIEl.style.display = '';
                    iconIEl.className = 'fas fa-ship';
                    if (ship.unlocked || ship === playerData.ship1) {
                        iconIEl.classList.remove('text-gray-500');
                        iconIEl.classList.add('text-blue-400');
                        iconIEl.classList.add('glowing-icon'); 
                    } else {
                        iconIEl.classList.remove('text-blue-400');
                        iconIEl.classList.add('text-gray-500');
                        iconIEl.classList.remove('glowing-icon'); 
                    }
                }
                if (iconImgEl) {
                    iconImgEl.style.display = 'none';
                }
            } else {
                if (iconIEl) {
                    iconIEl.style.display = 'none';
                }
                if (iconImgEl) {
                    iconImgEl.style.display = '';
                    iconImgEl.src = iconSrc;
                    if (ship.unlocked || ship === playerData.ship1) {
                        iconImgEl.classList.add('glowing-icon'); 
                    } else {
                        iconImgEl.classList.remove('glowing-icon'); 
                    }
                }
            }
        }

        function upgradeShip(ship) {
            if (!userId) {
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }
            const currentTime = Date.now();
            if (ship.power >= ship.maxPower) {
                window.showMessage('هذه السفينة مطورة بالكامل بالفعل!');
                return;
            }
            if (ship.cooldownEndTime > currentTime) {
                window.showMessage(`هذه السفينة في فترة انتظار. يرجى الانتظار ${formatTime(ship.cooldownEndTime - currentTime)}.`);
                return;
            }

            const powerGain = Math.floor(Math.random() * (325 - 45 + 1)) + 45;
            ship.power += powerGain;
            ship.level = Math.min(ship.maxPower, ship.power);

            if (ship.power > ship.maxPower) {
                ship.power = ship.maxPower;
            }

            ship.cooldownEndTime = currentTime + UPGRADE_COOLDOWN_MS;

            updateUIFromPlayerData();
            
            if (ship === playerData.ship1 && playerData.ship1.power >= playerData.ship1.maxPower && !playerData.ship2.unlocked) {
                playerData.ship2.unlocked = true;
                updateUIFromPlayerData();
                window.showMessage('تم فتح السفينة الثانية!');
            } else if (ship === playerData.ship2 && playerData.ship2.power >= playerData.ship2.maxPower && !playerData.ship3.unlocked) {
                playerData.ship3.unlocked = true;
                updateUIFromPlayerData();
                window.showMessage('تم فتح السفينة الثالثة!');
            }
        }

        function updateResourceCircle() {
            if (!userId) return;
            const percentage = (playerData.accumulatedResources / MAX_ACCUMULATED_RESOURCES) * 100;
            const offset = circumference - (percentage / 100) * circumference;
            circleProgress.style.strokeDashoffset = offset;
            accumulatedResourcesDisplay.textContent = `${playerData.accumulatedResources}/${MAX_ACCUMULATED_RESOURCES}`;
        }

        function updateResourceButtonState() {
            if (!userId) return;
            if (resourceBtnTextEl && resourceBtnIconEl && circleProgress) { 
                if (playerData.accumulatedResources > 0) {
                    resourceCollectionBtnWrapper.classList.remove('opacity-50', 'pointer-events-none');
                    resourceBtnTextEl.textContent = 'استلام';
                    resourceBtnIconEl.classList.remove('text-gray-400');
                    resourceBtnIconEl.classList.add('text-white');
                    resourceBtnIconEl.classList.add('glowing-icon'); 
                    circleProgress.style.stroke = '#f39c12'; 
                } else {
                    resourceCollectionBtnWrapper.classList.add('opacity-50', 'pointer-events-none');
                    resourceBtnTextEl.textContent = 'لا توجد موارد';
                    resourceBtnIconEl.classList.add('text-gray-400');
                    resourceBtnIconEl.classList.remove('text-white');
                    resourceBtnIconEl.classList.remove('glowing-icon'); 
                    circleProgress.style.stroke = '#3b4554'; 
                }
            }
        }

        function autoAccumulateResources() {
            if (!userId) return;
            if (playerData.accumulatedResources < MAX_ACCUMULATED_RESOURCES) {
                const collectedAmount = Math.floor(Math.random() * 6) + 1;
                playerData.accumulatedResources = Math.min(MAX_ACCUMULATED_RESOURCES, playerData.accumulatedResources + collectedAmount);
                updateUIFromPlayerData();
            }
        }

        function collectAccumulatedResources() {
            if (!userId) {
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }
            if (playerData.accumulatedResources > 0) {
                playerData.money += playerData.accumulatedResources;
                window.showMessage(`لقد استلمت ${playerData.accumulatedResources} من الموارد!`);
                playerData.accumulatedResources = 0;
                updateUIFromPlayerData();
            } else {
                window.showMessage('لا توجد موارد لتجميعها حالياً!');
            }
        }

        window.showStoreItemDetail = function(itemKey) {
            if (!userId) {
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }
            currentStoreItemKey = itemKey;
            const item = storeItems[itemKey];

            if (itemKey === 'shipExpansion') {
                window.openShipSelectionModal();
                return;
            }

            storeItemTitle.textContent = item.title;
            
            if (item.iconType === 'font-awesome') {
                storeItemIcon.className = `item-icon ${item.icon}`;
                storeItemIcon.classList.remove('hidden');
                storeItemIconImg.classList.add('hidden');
            } else {
                storeItemIconImg.src = item.icon;
                storeItemIconImg.classList.remove('hidden');
                storeItemIcon.classList.add('hidden');
            }

            storeItemDescription.textContent = item.description;
            
            let priceHtml = '';
            if (item.currency === 'none') {
                priceHtml = item.price;
            } else {
                priceHtml = `${item.price} `;
                if (item.currency === 'key') {
                    priceHtml += `<i class="fas fa-key text-yellow-400"></i>`;
                } else if (item.currency === 'money') {
                    priceHtml += `<i class="fas fa-dollar-sign text-green-400"></i>`;
                }
            }
            storeItemPrice.innerHTML = priceHtml;

            storeItemTitle.classList.remove('golden-text', 'pink-text', 'fiery-text', 'silver-text', 'blue-glow-text', 'emerald-text', 'royal-crimson-text');
            if (item.cssClass) {
                storeItemTitle.classList.add(item.cssClass);
            }

            const buyBtn = document.getElementById('buyStoreItemBtn');
            const currentTime = Date.now();

            if (item.type === 'name_cosmetic' || item.type === 'icon_cosmetic') {
                const isOwned = (item.ownedKey === 'lionCount') ? (playerData.lionCount > 0) : playerData[item.ownedKey];
                const isActive = playerData[item.activeKey];

                if (isOwned) {
                    if (!isActive) { 
                        buyBtn.textContent = 'تفعيل';
                        buyBtn.classList.remove('bg-gray-600');
                        buyBtn.classList.add('bg-blue-600');
                    } else { 
                        buyBtn.textContent = 'إلغاء تفعيل';
                        buyBtn.classList.remove('bg-blue-600');
                        buyBtn.classList.add('bg-gray-600');
                    }
                    buyBtn.disabled = false; 
                } else {
                    buyBtn.textContent = 'شراء';
                    buyBtn.classList.remove('bg-gray-600');
                    buyBtn.classList.add('bg-blue-600');
                    if (itemKey === 'lionIcon') {
                        buyBtn.disabled = true;
                        buyBtn.textContent = 'يمكن الحصول عليه من صندوق الحظ';
                    } else {
                        buyBtn.disabled = false;
                    }
                }
            } else if (item.type === 'free_box') {
                if (playerData.freeBoxCooldownEndTime > currentTime) {
                    buyBtn.disabled = true;
                    buyBtn.textContent = `متاح بعد: ${formatTime(playerData.freeBoxCooldownEndTime - currentTime)}`;
                } else {
                    buyBtn.disabled = false;
                    buyBtn.textContent = 'افتح الصندوق';
                }
            } else { 
                buyBtn.textContent = 'شراء';
                buyBtn.classList.remove('bg-gray-600');
                buyBtn.classList.add('bg-blue-600');
                buyBtn.disabled = false;
            }

            storeItemDetailModal.style.display = 'flex';
        }

        window.closeStoreItemDetailModal = function(returnToStore = false) {
            storeItemDetailModal.style.display = 'none';
            storeItemTitle.classList.remove('golden-text', 'pink-text', 'fiery-text', 'silver-text', 'blue-glow-text', 'emerald-text', 'royal-crimson-text'); 
            storeItemIcon.classList.add('hidden'); 
            storeItemIconImg.classList.add('hidden'); 
            currentStoreItemKey = null;
            if (returnToStore) {
                window.showSection('store');
            }
        }

        async function buyStoreItem() {
            if (!currentStoreItemKey) return;
            if (!userId) {
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }

            const item = storeItems[currentStoreItemKey];
            let canAfford = false;
            let message = '';
            const currentTime = Date.now();

            if (item.type === 'utility') {
                if (item.currency === 'key') {
                    if (playerData.keys >= item.price) {
                        playerData.keys -= item.price;
                        canAfford = true;
                    } else {
                        message = `ليس لديك ما يكفي من المفاتيح لشراء هذا العنصر (${formatNumber(item.price)} مفتاح).`;
                    }
                } else if (item.currency === 'money') {
                    if (playerData.money >= item.price) {
                        playerData.money -= item.price;
                        canAfford = true;
                    } else {
                        message = `ليس لديك ما يكفي من الأموال لشراء هذا العنصر (${formatNumber(item.price)} أموال).`;
                    }
                }
            } else if (item.type === 'lucky_box') { 
                if (playerData.money >= item.price) {
                    playerData.money -= item.price;
                    canAfford = true;
                    let prizeMessage = "لقد فتحت صندوق الحظ وحصلت على: ";
                    const rand = Math.random() * 100;

                    if (rand < 9) { 
                        playerData.lionCount++; 
                        playerData.isLionActive = true; 
                        message = prizeMessage + `الأسد المتوهج! (7000 قوة إضافية). لديك الآن ${playerData.lionCount} أسد متوهج.`;
                    } else if (rand < (9 + 15)) { 
                        const moneyGain = Math.floor(Math.random() * (1900 - 500 + 1)) + 500;
                        playerData.money += moneyGain;
                        message = prizeMessage + `${formatNumber(moneyGain)} أموال!`;
                    } else if (rand < (9 + 15 + 30)) { 
                        const powerGain = Math.floor(Math.random() * (2500 - 500 + 1)) + 500;
                        playerData.ship1.power += powerGain; 
                        playerData.ship1.level = Math.min(playerData.ship1.maxPower, playerData.ship1.power);
                        message = prizeMessage + `${formatNumber(powerGain)} قوة لسفينتك الأساسية!`;
                    } else { 
                        const keysGain = Math.floor(Math.random() * (25 - 14 + 1)) + 14;
                        playerData.keys += keysGain;
                        message = prizeMessage + `${keysGain} مفتاح!`;
                    }
                } else {
                    message = `ليس لديك ما يكفي من الأموال لشراء صندوق الحظ (${formatNumber(item.price)} أموال).`;
                }
            } else if (item.type === 'free_box') { 
                if (playerData.freeBoxCooldownEndTime > currentTime) {
                    message = `الصندوق المجاني متاح بعد: ${formatTime(playerData.freeBoxCooldownEndTime - currentTime)}.`;
                } else {
                    canAfford = true; 
                    let prizeMessage = "لقد فتحت الصندوق المجاني وحصلت على: ";
                    const rand = Math.random() * 100;

                    if (rand < 90) { 
                        const moneyGain = Math.floor(Math.random() * (200 - 40 + 1)) + 40;
                        playerData.money += moneyGain;
                        message = prizeMessage + `${formatNumber(moneyGain)} أموال!`;
                    } else { 
                        const keysGain = Math.floor(Math.random() * (8 - 2 + 1)) + 2;
                        playerData.keys += keysGain;
                        message = prizeMessage + `${keysGain} مفتاح!`;
                    }
                    playerData.freeBoxCooldownEndTime = currentTime + FREE_BOX_COOLDOWN_MS;
                }
            } else if (item.type === 'name_cosmetic' || item.type === 'icon_cosmetic') {
                const isOwned = (item.ownedKey === 'lionCount') ? (playerData.lionCount > 0) : playerData[item.ownedKey];
                const isActive = playerData[item.activeKey];

                if (isOwned) {
                    if (item.type === 'name_cosmetic') {
                        playerData.isGoldenNameActive = false;
                        playerData.isPinkNameActive = false;
                        playerData.isFieryNameActive = false;
                        playerData.isSilverNameActive = false; 
                        playerData.isBlueGlowNameActive = false; 
                        playerData.isEmeraldNameActive = false; 
                        playerData.isRoyalCrimsonNameActive = false; 
                        if (!isActive) { 
                            playerData[item.activeKey] = true;
                            message = `تم تفعيل "${item.title}" بنجاح!`;
                        } else { 
                            message = `تم إلغاء تفعيل "${item.title}".`;
                        }
                    } else if (item.type === 'icon_cosmetic') {
                        playerData.isStarIconActive = false;
                        playerData.isCrownIconActive = false;
                        playerData.isLionActive = false; 
                        if (!isActive) { 
                            playerData[item.activeKey] = true;
                            message = `تم تفعيل "${item.title}" بنجاح!`;
                        } else { 
                            message = `تم إلغاء تفعيل "${item.title}".`;
                        }
                    }
                    canAfford = true; 
                } else { 
                    if (item.currency === 'key') {
                        if (playerData.keys >= item.price) {
                            playerData.keys -= item.price;
                            canAfford = true;
                        } else {
                            message = `ليس لديك ما يكفي من المفاتيح لشراء هذا العنصر (${formatNumber(item.price)} مفتاح).`;
                        }
                    } else if (item.currency === 'money') {
                        if (playerData.money >= item.price) {
                            playerData.money -= item.price;
                            canAfford = true;
                        } else {
                            message = `ليس لديك ما يكفي من الأموال لشراء هذا العنصر (${formatNumber(item.price)} أموال).`;
                        }
                    }

                    if (canAfford) {
                        playerData[item.ownedKey] = true;
                        if (item.type === 'name_cosmetic') {
                            playerData.isGoldenNameActive = false;
                            playerData.isPinkNameActive = false;
                            playerData.isFieryNameActive = false;
                            playerData.isSilverNameActive = false; 
                            playerData.isBlueGlowNameActive = false; 
                            playerData.isEmeraldNameActive = false; 
                            playerData.isRoyalCrimsonNameActive = false; 
                            playerData[item.activeKey] = true;
                        } else if (item.type === 'icon_cosmetic') {
                            playerData.isStarIconActive = false;
                            playerData.isCrownIconActive = false;
                            playerData.isLionActive = false; 
                            playerData[item.activeKey] = true;
                        }
                        message = `تهانينا! لقد اشتريت "${item.title}" وتم تفعيله!`;
                    }
                }
            }

            if (canAfford) {
                if (currentStoreItemKey === 'completeUpgrade') {
                    let shipsOnCooldown = 0;
                    if (playerData.ship1.cooldownEndTime > currentTime) { playerData.ship1.cooldownEndTime = 0; shipsOnCooldown++; }
                    if (playerData.ship2.unlocked && playerData.ship2.cooldownEndTime > currentTime) { playerData.ship2.cooldownEndTime = 0; shipsOnCooldown++; }
                    if (playerData.ship3.unlocked && playerData.ship3.cooldownEndTime > currentTime) { playerData.ship3.cooldownEndTime = 0; shipsOnCooldown++; }

                    if (shipsOnCooldown > 0) {
                        message = 'تم إكمال تطوير السفن بنجاح!';
                    } else {
                        if (item.currency === 'key') playerData.keys += item.price; 
                        else playerData.money += item.price; 
                        message = 'لا توجد سفن في فترة انتظار حالياً لإكمال تطويرها.';
                        canAfford = false;
                    }
                } 
            }
            
            updateUIFromPlayerData();
            window.showMessage(message);
            window.closeStoreItemDetailModal(true);
        }

        window.openShipSelectionModal = function() {
            if (!userId) {
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }
            document.getElementById('shipExpansionModalPrice').innerHTML = `${formatNumber(storeItems.shipExpansion.price)} <i class="fas fa-key text-yellow-400"></i>`;

            let shipSelectionOptions = document.getElementById('shipSelectionOptions');
            shipSelectionOptions.innerHTML = '';
            const ships = [
                { id: 'ship1', name: 'السفينة الأساسية', obj: playerData.ship1 },
                { id: 'ship2', name: 'السفينة الثانية', obj: playerData.ship2 },
                { id: 'ship3', name: 'السفينة الثالثة', obj: playerData.ship3 }
            ];

            ships.forEach(s => {
                if (s.obj.unlocked || s.id === 'ship1') {
                    const optionDiv = document.createElement('div');
                    optionDiv.classList.add('ship-selection-option');
                    optionDiv.innerHTML = `
                        <label for="select-${s.id}">${s.name} (القوة القصوى الحالية: ${formatNumber(s.obj.maxPower)})</label>
                        <input type="radio" id="select-${s.id}" name="selectedShip" value="${s.id}">
                    `;
                    shipSelectionOptions.appendChild(optionDiv);

                    optionDiv.addEventListener('click', () => {
                        document.querySelectorAll('.ship-selection-option').forEach(opt => opt.classList.remove('selected'));
                        optionDiv.classList.add('selected');
                        optionDiv.querySelector('input[type="radio"]').checked = true;
                    });
                }
            });

            document.getElementById('shipSelectionModal').style.display = 'flex';
        }

        window.closeShipSelectionModal = function() {
            document.getElementById('shipSelectionModal').style.display = 'none';
            window.showSection('store');
        }

        async function confirmShipExpansion() {
            if (!userId) {
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }
            const selectedRadio = document.querySelector('input[name="selectedShip"]:checked');
            let message = '';
            let purchaseSuccessful = false;

            if (!selectedRadio) {
                message = 'الرجاء اختيار سفينة لتوسيعها.';
            } else {
                const selectedShipId = selectedRadio.value;
                let targetShip;
                if (selectedShipId === 'ship1') targetShip = playerData.ship1;
                else if (selectedShipId === 'ship2') targetShip = playerData.ship2;
                else if (selectedShipId === 'ship3') targetShip = playerData.ship3;

                const item = storeItems['shipExpansion'];
                if (playerData.keys >= item.price) { 
                    playerData.keys -= item.price; 
                    targetShip.maxPower += 5000;
                    updateUIFromPlayerData();
                    message = `تم توسيع ${targetShip.name === playerData.ship1.name ? 'السفينة الأساسية' : targetShip.name} بنجاح! الحد الأقصى الجديد: ${formatNumber(targetShip.maxPower)}.`;
                    purchaseSuccessful = true;
                } else {
                    message = `ليس لديك ما يكفي من المفاتيح لشراء توسيع السفينة (${formatNumber(item.price)} مفتاح).`; 
                }
            }
            
            window.showMessage(message);
            window.closeShipSelectionModal();
        }

        function openChangeFleetNameModal() {
            if (!userId) {
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }
            if (playerData.isFleetNameSet) {
                window.showMessage("لا يمكن تغيير اسم الأسطول بعد تعيينه.");
                return;
            }
            changeFleetNameInput.value = playerData.fleetName;
            changeFleetNameModal.style.display = 'flex';
        }

        function closeChangeFleetNameModal() {
            changeFleetNameModal.style.display = 'none';
        }

        async function confirmChangeFleetName() {
            if (!userId) {
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }
            const newName = changeFleetNameInput.value.trim();
            if (newName && newName !== playerData.fleetName) {
                playerData.fleetName = newName;
                playerData.isFleetNameSet = true; // Set name as permanent
                updateUIFromPlayerData();
                window.showMessage('تم تغيير اسم الأسطول بنجاح!');
                closeChangeFleetNameModal();
            } else if (newName === playerData.fleetName) {
                window.showMessage('الاسم الجديد هو نفس الاسم الحالي.');
            } else {
                window.showMessage('الرجاء إدخال اسم صالح لأسطولك.');
            }
        }

        window.showSection = function(sectionId) {
            if (!userId && sectionId !== 'hidden' && sectionId !== 'authModal') { // Allow authModal to be shown
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }
            const sections = [mainMenuSection, myFleetSection, storeSection, onlineSection, rouletteSection, developmentsSection, challengeLogSection, attackSection, onlinePlayersSection, accountSection];

            sections.forEach(section => {
                section.classList.remove('animate-fade-in-up');
                section.classList.add('hidden');
            });

            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('animate-fade-in-up');
            }

            currentActiveSectionId = sectionId;

            if (sectionId === 'mainMenu') {
                resourceCollectionBtnWrapper.classList.remove('hidden');
            } else {
                resourceCollectionBtnWrapper.classList.add('hidden');
            }

            if (sectionId === 'developmentsSection') {
                populateShipFormsList();
            }
            if (sectionId === 'attackSection') {
                if (db) {
                    const playersRef = ref(db, `artifacts/${appId}/public/onlinePlayers`);
                    get(playersRef).then(snapshot => {
                        const data = snapshot.val();
                        const allPlayers = [];
                        if (data) {
                            for (const key in data) {
                                allPlayers.push(data[key]);
                            }
                        }
                        renderAttackablePlayers(allPlayers);
                    }).catch(error => {
                        console.error("Error fetching players for attack section:", error);
                        window.showMessage("حدث خطأ أثناء تحميل قائمة اللاعبين للهجوم.");
                    });
                }
            }
            if (sectionId === 'accountSection') {
                updateAccountSectionUI();
            }
        }

        function updateRouletteCooldownUI() {
            if (!userId) return;
            const currentTime = Date.now();
            const remainingTime = playerData.rouletteCooldownEndTime - currentTime;

            if (remainingTime > 0) {
                rouletteGameElements.classList.add('hidden');
                rouletteCooldownDisplay.classList.remove('hidden');
                rouletteCooldownDisplay.textContent = `الجولة القادمة بعد: ${formatTime(remainingTime)}`;
            } else {
                rouletteGameElements.classList.remove('hidden');
                rouletteCooldownDisplay.classList.add('hidden');

                if (!gameActive) {
                    startGameBtn.classList.remove('hidden');
                    betAmountInput.disabled = false;
                    cashOutBtn.classList.add('hidden');
                    cashOutBtn.disabled = true;
                    multiplierDisplay.textContent = '1.00x';
                    potentialWinningsEl.textContent = '0';
                    rouletteResult.classList.add('hidden');
                    rouletteDisplayArea.classList.remove('crashed');
                    
                    const currentDisplayAreaHeight = rouletteDisplayArea.clientHeight;
                    const planeHeight = planeSvg.offsetHeight;
                    planeSvg.style.transform = `translate(10px, ${currentDisplayAreaHeight - planeHeight - 15}px)`;
                }
            }
        }

        function generateCrashPoint() {
            const rand = Math.random();
            if (rand < 0.60) {
                return 1.01 + Math.random() * (4.0 - 1.01);
            } else if (rand < 0.80) {
                return 4.1 + Math.random() * (7.7 - 4.1);
            } else {
                return 10.0 + Math.random() * (25.5 - 10.0);
            }
        }

        function animatePlane(timestamp) {
            if (!lastFrameTime) {
                lastFrameTime = timestamp;
            }
            const deltaTime = timestamp - lastFrameTime;
            lastFrameTime = timestamp;

            const multiplierIncreaseRate = 0.007;
            currentMultiplier += multiplierIncreaseRate * (deltaTime / 100);

            multiplierDisplay.textContent = currentMultiplier.toFixed(2) + 'x';
            potentialWinningsEl.textContent = Math.round(betAmount * currentMultiplier);

            const displayAreaWidth = rouletteDisplayArea.clientWidth;
            const displayAreaHeight = rouletteDisplayArea.clientHeight;
            const planeWidth = planeSvg.offsetWidth; 
            const planeHeight = planeSvg.offsetHeight; 
            
            const maxVisualMultiplier = 30;
            const minMultiplierForVisual = 1.0;

            let normalizedMultiplier = (currentMultiplier - minMultiplierForVisual) / (maxVisualMultiplier - minMultiplierForVisual);
            normalizedMultiplier = Math.max(0, Math.min(normalizedMultiplier, 1));

            const paddingX = 20;
            const paddingY = 15;

            let planeX = normalizedMultiplier * (displayAreaWidth - planeWidth - (2 * paddingX)) + paddingX;

            let planeY = (1 - normalizedMultiplier) * (displayAreaHeight - planeHeight - (2 * paddingY)) + paddingY;

            planeSvg.style.transform = `translate(${planeX}px, ${planeY}px)`;

            if (currentMultiplier < crashPoint && gameActive && !hasCashedOut) {
                animationFrameId = requestAnimationFrame(animatePlane);
            } else if (gameActive && !hasCashedOut) {
                handleCrash();
            }
        }

        function startPlaneGame() {
            if (!userId) {
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }
            if (Date.now() < playerData.rouletteCooldownEndTime) {
                window.showMessage(`الرجاء الانتظار حتى انتهاء فترة التهدئة: ${formatTime(playerData.rouletteCooldownEndTime - Date.now())}`);
                return;
            }

            betAmount = parseInt(betAmountInput.value);

            if (isNaN(betAmount) || betAmount < 20 || betAmount > 2000) {
                window.showMessage('الرجاء إدخال مبلغ رهان صالح بين 20 و 2000.');
                return;
            }
            if (playerData.money < betAmount) {
                window.showMessage('ليس لديك ما يكفي من الأموال للرهان!');
                return;
            }

            playerData.money -= betAmount;
            updateUIFromPlayerData();

            gameActive = true;
            currentMultiplier = 1.00;
            hasCashedOut = false;
            rouletteDisplayArea.classList.remove('crashed');
            rouletteResult.classList.add('hidden');
            multiplierDisplay.textContent = '1.00x';
            potentialWinningsEl.textContent = '0';

            crashPoint = generateCrashPoint();

            startGameBtn.classList.add('hidden');
            betAmountInput.disabled = true;
            cashOutBtn.classList.remove('hidden');
            cashOutBtn.disabled = false;

            const currentDisplayAreaHeight = rouletteDisplayArea.clientHeight;
            const planeHeight = planeSvg.offsetHeight;
            planeSvg.style.transform = `translate(10px, ${currentDisplayAreaHeight - planeHeight - 15}px)`;

            lastFrameTime = 0;
            animationFrameId = requestAnimationFrame(animatePlane);
        }

        function cashOut() {
            if (!userId) {
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }
            if (!gameActive || hasCashedOut) {
                return;
            }

            hasCashedOut = true;
            cancelAnimationFrame(animationFrameId);

            const winnings = Math.round(betAmount * currentMultiplier);
            playerData.money += winnings;
            updateUIFromPlayerData();

            rouletteResult.textContent = `لقد استلمت ${winnings} أموال عند ${currentMultiplier.toFixed(2)}x!`;
            rouletteResult.classList.remove('hidden');
            window.showMessage(`تهانينا! لقد استلمت ${winnings} أموال عند ${currentMultiplier.toFixed(2)}x!`);

            endRound();
        }

        function handleCrash() {
            if (!userId) {
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }
            if (!gameActive || hasCashedOut) {
                return;
            }
            
            cancelAnimationFrame(animationFrameId);

            rouletteDisplayArea.classList.add('crashed');
            rouletteResult.textContent = `تحطمت الطائرة عند ${currentMultiplier.toFixed(2)}x! لقد خسرت ${betAmount} أموال.`;
            rouletteResult.classList.remove('hidden');
            window.showMessage(`تحطمت الطائرة عند ${currentMultiplier.toFixed(2)}x! لقد خسرت ${betAmount} أموال.`);

            endRound();
        }

        async function endRound() {
            if (!userId) return;
            gameActive = false;
            cashOutBtn.classList.add('hidden');
            cashOutBtn.disabled = true;
            
            playerData.rouletteCooldownEndTime = Date.now() + ROULETTE_COOLDOWN_MS;
            updateUIFromPlayerData();
        }

        window.showPlayerProfile = function(playerDataProfile) {
            if (!userId) {
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }
            profileFleetNameEl.textContent = playerDataProfile.fleetName;
            profileFleetNameEl.classList.remove('golden-text', 'pink-text', 'fiery-text', 'silver-text', 'blue-glow-text', 'emerald-text', 'royal-crimson-text');
            if (playerDataProfile.isGoldenNameActive) {
                profileFleetNameEl.classList.add('golden-text');
            } else if (playerDataProfile.isPinkNameActive) {
                profileFleetNameEl.classList.add('pink-text');
            } else if (playerDataProfile.isFieryNameActive) {
                profileFleetNameEl.classList.add('fiery-text');
            } else if (playerDataProfile.isSilverNameActive) {
                profileFleetNameEl.classList.add('silver-text');
            } else if (playerDataProfile.isBlueGlowNameActive) {
                profileFleetNameEl.classList.add('blue-glow-text');
            } else if (playerDataProfile.isEmeraldNameActive) {
                profileFleetNameEl.classList.add('emerald-text');
            } else if (playerDataProfile.isRoyalCrimsonNameActive) {
                profileFleetNameEl.classList.add('royal-crimson-text');
            }

            profileStarIconEl.classList.toggle('hidden', !playerDataProfile.isStarIconActive);
            profileCrownIconEl.classList.toggle('hidden', !playerDataProfile.isCrownIconActive);
            profileCrownIconEl.classList.toggle('animated-crown-icon', playerDataProfile.isCrownIconActive);
            
            profileLionIconEl.classList.toggle('hidden', playerDataProfile.lionCount === 0 || !playerDataProfile.isLionActive);
            profileLionIconEl.classList.toggle('animated-lion-icon', playerDataProfile.isLionActive);
            profileLionCountDisplayEl.classList.toggle('hidden', playerDataProfile.lionCount === 0 || !playerDataProfile.isLionActive);
            profileLionCountDisplayEl.textContent = `x${playerDataProfile.lionCount}`;


            profileStatusDotEl.classList.remove('online', 'offline');
            profileStatusDotEl.classList.add(playerDataProfile.isOnline ? 'online' : 'offline');

            let totalProfilePower = (playerDataProfile.ship1?.power || 0) + (playerDataProfile.ship2?.unlocked ? playerDataProfile.ship2.power : 0) + (playerDataProfile.ship3?.unlocked ? playerDataProfile.ship3.power : 0);
            if (playerDataProfile.lionCount !== undefined) totalProfilePower += (playerDataProfile.lionCount * 7000);
            profileTotalPowerEl.textContent = formatNumber(totalProfilePower);
            profileUserIdEl.textContent = playerDataProfile.userId;

            profileShipsListEl.innerHTML = '';
            const ships = [
                { id: 'ship1', name: 'السفينة الأساسية', data: playerDataProfile.ship1 },
                { id: 'ship2', name: 'السفينة الثانية', data: playerDataProfile.ship2 },
                { id: 'ship3', name: 'السفينة الثالثة', data: playerDataProfile.ship3 }
            ];

            ships.forEach(s => {
                const shipCard = document.createElement('div');
                shipCard.classList.add('profile-ship-card');

                const shipLevel = s.data ? s.data.level : 0;
                const shipPower = s.data ? s.data.power : 0;
                const shipMaxPower = s.data ? s.data.maxPower : INITIAL_SHIP_MAX_POWER;
                const shipUnlocked = (s.id === 'ship1') || (s.data ? s.data.unlocked : false);

                const iconSrc = getShipIcon(shipLevel);
                const iconClass = shipUnlocked ? 'unlocked' : 'locked';

                let iconHtml = '';
                if (iconSrc === 'font-awesome') {
                    iconHtml = `<i class="fas fa-ship ${shipUnlocked ? 'text-blue-400' : 'text-gray-500'}"></i>`;
                } else {
                    iconHtml = `<img src="${iconSrc}" alt="Ship Icon" onerror="this.onerror=null;this.src='https://placehold.co/50x50/21262d/e2e8f0?text=X';" draggable="false" />`;
                }

                shipCard.innerHTML = `
                    <div class="icon-container ${iconClass}">
                        ${iconHtml}
                    </div>
                    <div class="info">
                        <h4>${s.name}</h4>
                        <p>القوة: ${formatNumber(shipPower)} / ${formatNumber(shipMaxPower)}</p>
                        <p>المستوى: ${formatNumber(shipLevel)}</p>
                    </div>
                `;
                profileShipsListEl.appendChild(shipCard);
            });

            playerProfileModal.style.display = 'flex';
        }

        window.closePlayerProfileModal = function() {
            playerProfileModal.style.display = 'none';
        }

        // New Account Section Functions
        function updateAccountSectionUI() {
            if (!userId || !auth.currentUser) return;

            currentUserIdEl.textContent = userId;
            accountTypeEl.textContent = auth.currentUser.isAnonymous ? 'مجهول' : 'دائم (بريد إلكتروني)';

            if (auth.currentUser.isAnonymous) {
                linkAccountSection.classList.remove('hidden');
                permanentAccountOptions.classList.add('hidden');
            } else {
                linkAccountSection.classList.add('hidden');
                permanentAccountOptions.classList.remove('hidden');
            }
        }

        async function handleLinkAccount() {
            if (!userId) {
                window.showMessage("الرجاء تسجيل الدخول أولاً.");
                return;
            }
            const email = linkEmailInput.value.trim();
            const password = linkPasswordInput.value.trim();

            if (!email || !password) {
                window.showMessage("الرجاء إدخال بريد إلكتروني وكلمة مرور صالحين.");
                return;
            }

            try {
                const credential = EmailAuthProvider.credential(email, password);
                await linkWithCredential(auth.currentUser, credential);
                window.showMessage("تم ربط حسابك بنجاح!");
                updateAccountSectionUI(); // Update UI to show permanent options
                // No need to explicitly save data here, Firebase should handle merging automatically
            } catch (error) {
                console.error("Error linking account:", error);
                if (error.code === 'auth/email-already-in-use') {
                    window.showMessage("هذا البريد الإلكتروني مستخدم بالفعل. يرجى تسجيل الدخول بهذا الحساب أولاً ثم محاولة الربط.");
                } else if (error.code === 'auth/invalid-email') {
                    window.showMessage("صيغة البريد الإلكتروني غير صحيحة.");
                } else if (error.code === 'auth/weak-password') {
                    window.showMessage("كلمة المرور ضعيفة جداً. يجب أن تكون 6 أحرف على الأقل.");
                } else {
                    window.showMessage(`خطأ في ربط الحساب: ${error.message}`);
                }
            }
        }

        async function handleRestoreData() {
            if (!userId || auth.currentUser.isAnonymous) {
                window.showMessage("يجب أن يكون حسابك دائماً (غير مجهول) لاستخدام هذه الميزة.");
                return;
            }

            window.showConfirm("هل أنت متأكد أنك تريد استرداد البيانات المحلية؟ هذا سيحل محل أي بيانات محفوظة على السحابة بالبيانات الموجودة في هذا المتصفح.", async (confirmed) => {
                if (confirmed) {
                    try {
                        const localDataToRestore = loadFromLocalStorage(userId); // Load using the current (permanent) UID
                        if (localDataToRestore) {
                            // Ensure the lastUpdated timestamp is updated before saving
                            localDataToRestore.lastUpdated = Date.now();
                            await set(userDbRef, localDataToRestore); // Overwrite cloud data
                            playerData = localDataToRestore; // Update current playerData
                            updateUIFromPlayerData();
                            window.showMessage("تم استرداد البيانات بنجاح من هذا المتصفح!");
                        } else {
                            window.showMessage("لا توجد بيانات محلية لاستردادها.");
                        }
                    } catch (error) {
                        console.error("Error restoring data:", error);
                        window.showMessage(`خطأ في استرداد البيانات: ${error.message}`);
                    }
                } else {
                    window.showMessage("تم إلغاء عملية الاسترداد.");
                }
            });
        }

        function handleUpgradeShip1Click() { upgradeShip(playerData.ship1); }
        function handleUpgradeShip2Click() { upgradeShip(playerData.ship2); }
        function handleUpgradeShip3Click() { upgradeShip(playerData.ship3); }
        function handleCollectResourcesClick() { collectAccumulatedResources(); }
        function handleBuyStoreItemClick() { buyStoreItem(); }
        function handleConfirmShipExpansionClick() { confirmShipExpansion(); }
        function handleStartGameClick() { startPlaneGame(); }
        function handleCashOutClick() { cashOut(); }
        function handleLogoutClick() { logoutUser(); }
        function handleChangeNameClick() { openChangeFleetNameModal(); }
        function handleConfirmChangeFleetNameClick() { confirmChangeFleetName(); }
        function handleStartGameAuthClick() { handleStartGame(); } // New handler for auth modal button
        function handleLinkAccountClick() { handleLinkAccount(); }
        function handleRestoreDataClick() { handleRestoreData(); }


        document.addEventListener('DOMContentLoaded', async () => {
            playerPowerEl = document.getElementById('playerPower');
            playerMoneyEl = document.getElementById('playerMoney');
            playerKeysEl = document.getElementById('playerKeys');
            fleetNameEl = document.getElementById('fleetName');
            fleetStarIconEl = document.getElementById('fleetStarIcon');
            fleetCrownIconEl = document.getElementById('fleetCrownIcon'); 
            fleetLionIconEl = document.getElementById('fleetLionIcon');
            lionCountDisplayEl = document.getElementById('lionCountDisplay');
            logoutBtn = document.getElementById('logoutBtn');
            changeNameBtn = document.getElementById('changeNameBtn');

            ship1PowerEl = document.getElementById('ship1Power'); 
            ship1LevelEl = document.getElementById('ship1Level');
            ship1ProgressEl = document.getElementById('ship1Progress');
            ship1MaxPowerEl = document.getElementById('ship1MaxPower');
            upgradeShip1Btn = document.getElementById('upgradeShip1');
            ship1CooldownDisplay = document.getElementById('ship1CooldownDisplay');
            ship1IconContainerEl = document.querySelector('#myFleet > div > div:nth-child(1) > .icon-container');
            ship1IconIEl = document.getElementById('ship1IconI');
            ship1IconImgEl = document.getElementById('ship1IconImg');

            ship2Container = document.getElementById('ship2Container');
            ship2PowerEl = document.getElementById('ship2Power');
            ship2LevelEl = document.getElementById('ship2Level');
            ship2ProgressEl = document.getElementById('ship2Progress');
            ship2MaxPowerEl = document.getElementById('ship2MaxPower');
            upgradeShip2Btn = document.getElementById('upgradeShip2');
            ship2CooldownDisplay = document.getElementById('ship2CooldownDisplay');
            ship2IconContainerEl = document.querySelector('#ship2Container > .icon-container');
            ship2IconIEl = document.getElementById('ship2IconI');
            ship2IconImgEl = document.getElementById('ship2IconImg');

            ship3Container = document.getElementById('ship3Container');
            ship3PowerEl = document.getElementById('ship3Power');
            ship3LevelEl = document.getElementById('ship3Level');
            ship3ProgressEl = document.getElementById('ship3Progress');
            ship3MaxPowerEl = document.getElementById('ship3MaxPower');
            upgradeShip3Btn = document.getElementById('upgradeShip3'); 
            ship3CooldownDisplay = document.getElementById('ship3CooldownDisplay');
            ship3IconContainerEl = document.querySelector('#ship3Container > .icon-container');
            ship3IconIEl = document.getElementById('ship3IconI');
            ship3IconImgEl = document.getElementById('ship3IconImg');

            mainMenuSection = document.getElementById('mainMenu');
            myFleetSection = document.getElementById('myFleet');
            storeSection = document.getElementById('store');
            onlineSection = document.getElementById('onlineSection');
            rouletteSection = document.getElementById('rouletteSection');
            developmentsSection = document.getElementById('developmentsSection'); 
            challengeLogSection = document.getElementById('challengeLog');
            attackSection = document.getElementById('attackSection');
            onlinePlayersSection = document.getElementById('onlinePlayersSection');
            accountSection = document.getElementById('accountSection'); // Get account section

            messageModal = document.getElementById('messageModal');
            modalMessage = document.getElementById('modalMessage');
            confirmModal = document.getElementById('confirmModal'); // Get confirm modal
            confirmMessage = document.getElementById('confirmMessage');
            confirmYesBtn = document.getElementById('confirmYesBtn');
            confirmNoBtn = document.getElementById('confirmNoBtn');

            authModal = document.getElementById('authModal');
            startGameBtnAuth = document.getElementById('startGameBtnAuth'); // Get new auth button

            changeFleetNameModal = document.getElementById('changeFleetNameModal');
            changeFleetNameInput = document.getElementById('changeFleetNameInput');
            confirmChangeFleetNameBtn = document.getElementById('confirmChangeFleetNameBtn');

            resourceCollectionBtnWrapper = document.getElementById('resourceCollectionBtnWrapper');
            resourceCollectionBtn = document.getElementById('resourceCollectionBtn');
            accumulatedResourcesDisplay = document.getElementById('accumulatedResourcesDisplay');
            circleProgress = document.querySelector('.circle-progress');
            resourceBtnTextEl = document.querySelector('.resource-btn-text'); 
            resourceBtnIconEl = resourceCollectionBtn.querySelector('.resource-content i'); 

            storeItemDetailModal = document.getElementById('storeItemDetailModal');
            storeItemTitle = document.getElementById('storeItemTitle');
            storeItemIcon = document.getElementById('storeItemIcon');
            storeItemIconImg = document.getElementById('storeItemIconImg'); 
            storeItemDescription = document.getElementById('storeItemDescription');
            storeItemPrice = document.getElementById('storeItemPrice');
            buyStoreItemBtn = document.getElementById('buyStoreItemBtn');

            rouletteGameElements = document.getElementById('rouletteGameElements'); 
            rouletteDisplayArea = document.getElementById('rouletteDisplayArea');
            multiplierDisplay = document.getElementById('multiplierDisplay');
            betAmountInput = document.getElementById('betAmountInput');
            startGameBtn = document.getElementById('startGameBtn');
            cashOutBtn = document.getElementById('cashOutBtn');
            potentialWinningsEl = document.getElementById('potentialWinnings');
            rouletteResult = document.getElementById('rouletteResult');
            rouletteCooldownDisplay = document.getElementById('rouletteCooldownDisplay');
            planeSvg = document.getElementById('planeSvg');

            shipFormsList = document.getElementById('shipFormsList'); 

            onlinePlayersListEl = document.getElementById('onlinePlayersList');
            offlinePlayersListEl = document.getElementById('offlinePlayersList');
            challengeLogListEl = document.getElementById('challengeLogList');
            attackablePlayersListEl = document.getElementById('attackablePlayersList');

            playerProfileModal = document.getElementById('playerProfileModal'); 
            profileFleetNameEl = document.getElementById('profileFleetName'); 
            profileStarIconEl = document.getElementById('profileStarIcon');
            profileCrownIconEl = document.getElementById('profileCrownIcon');
            profileLionIconEl = document.getElementById('profileLionIcon');
            profileLionCountDisplayEl = document.getElementById('profileLionCountDisplay');
            profileStatusDotEl = document.getElementById('profileStatusDot');
            profileTotalPowerEl = document.getElementById('profileTotalPower');
            profileShipsListEl = document.getElementById('profileShipsList');
            profileUserIdEl = document.getElementById('profileUserId');

            // Get account section elements
            currentUserIdEl = document.getElementById('currentUserId');
            accountTypeEl = document.getElementById('accountType');
            linkAccountSection = document.getElementById('linkAccountSection');
            linkEmailInput = document.getElementById('linkEmailInput');
            linkPasswordInput = document.getElementById('linkPasswordInput');
            linkAccountBtn = document.getElementById('linkAccountBtn');
            permanentAccountOptions = document.getElementById('permanentAccountOptions');
            restoreDataBtn = document.getElementById('restoreDataBtn');


            upgradeShip1Btn.addEventListener('click', handleUpgradeShip1Click);
            upgradeShip2Btn.addEventListener('click', handleUpgradeShip2Click);
            upgradeShip3Btn.addEventListener('click', handleUpgradeShip3Click);
            resourceCollectionBtnWrapper.addEventListener('click', handleCollectResourcesClick);
            buyStoreItemBtn.addEventListener('click', handleBuyStoreItemClick);
            document.getElementById('confirmShipExpansionBtn').addEventListener('click', handleConfirmShipExpansionClick); 
            startGameBtn.addEventListener('click', handleStartGameClick);
            cashOutBtn.addEventListener('click', handleCashOutClick);
            logoutBtn.addEventListener('click', handleLogoutClick); 
            startGameBtnAuth.addEventListener('click', handleStartGameAuthClick); // Add event listener for new auth button
            changeNameBtn.addEventListener('click', handleChangeNameClick);
            confirmChangeFleetNameBtn.addEventListener('click', handleConfirmChangeFleetNameClick);
            linkAccountBtn.addEventListener('click', handleLinkAccountClick); // New link account button
            restoreDataBtn.addEventListener('click', handleRestoreDataClick); // New restore data button

            setInterval(updateUIFromPlayerData, 1000); 
            setInterval(autoAccumulateResources, RESOURCE_ACCUMULATION_INTERVAL_MS);

            await initializeFirebase();

            document.addEventListener('contextmenu', event => event.preventDefault());
            document.addEventListener('dragstart', event => event.preventDefault());
            document.addEventListener('selectstart', event => event.preventDefault());
        });

        window.addEventListener('beforeunload', async () => {
            if (userId) {
                await updateOnlineStatus(false);
                saveToLocalStorage();
                await saveUserDataToFirebase();
            }
        });
    </script>
</body>
</html>
