<!DOCTYPE html>
<html>
<head>
<title>محرر الأخبار الاحترافي - عرض لقطة الشاشة</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Changa:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Lateef&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Reem+Kufi+Ink&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Katibeh&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Marhey&display=swap" rel="stylesheet">

<style>
  /*
  ** لوحة ألوان جديدة: حيوية ومشرقة
  */
  :root {
    --primary-color: #5E35B1; /* بنفسجي غامق جذاب */
    --secondary-color: #FFC107; /* أصفر ذهبي ساطع */
    --accent-color: #F44336; /* أحمر نابض بالحياة */
    --background-dark: #121212; /* أسود حالك للخلفية */
    --card-background: #1E1E1E; /* رمادي داكن للبطاقات */
    --text-light: #E0E0E0; /* أبيض ساطع للنص */
    --text-muted: #B0B0B0; /* رمادي فاتح للنص الثانوي */
    --border-color: #333333; /* حدود داكنة */
    --input-background: #282828; /* خلفية حقول الإدخال */
    --button-primary: #4CAF50; /* أخضر للأزرار الرئيسية */
    --button-hover: #43A047; /* أخضر أغمق عند التحويم */
    --button-active: #388E3C; /* أخضر أغمق عند النقر */
    --shadow-light: rgba(0, 0, 0, 0.6); /* ظل خفيف */
    --shadow-dark: rgba(0, 0, 0, 0.8); /* ظل أغمق */

    /* ألوان التبديل (Toggle) */
    --toggle-off-bg: #555;
    --toggle-on-bg: var(--button-primary);

    /* ألوان التنبيهات */
    --notification-success: #4CAF50;
    --notification-error: #F44336;
    --notification-info: #2196F3;
  }

  /*
  ** تحديثات لتحسين السلاسة والتمرير والصورة
  */

  /* تطبيق box-sizing على كل العناصر */
  *, *::before, *::after {
    box-sizing: border-box;
  }

  html {
    height: 100%; /* تأكد أن html يغطي الارتفاع بالكامل */
    scroll-behavior: smooth; /* تمرير سلس */
  }

  body {
    margin: 0;
    padding: 20px;
    height: 100%; /* تأكد أن body يغطي الارتفاع بالكامل */
    width: 100vw;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: linear-gradient(135deg, var(--background-dark), #000000); /* تدرج خلفية داكن */
    color: var(--text-light);
    overflow-y: auto; /* السماح بالتمرير العمودي فقط عند الحاجة */
    -webkit-overflow-scrolling: touch; /* لتحسين التمرير على iOS */
  }

  .container {
    width: 100%;
    max-width: 380px;
    background-color: var(--card-background);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 25px var(--shadow-dark); /* ظل أغمق وجذاب */
    margin-bottom: 30px;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    position: relative;
    flex-shrink: 0; /* مهم: منع الانكماش عند توفر مساحة أقل */
    transition: transform 0.3s ease, box-shadow 0.3s ease; /* انيميشن عند التفاعل */
  }
  .container:hover {
      transform: translateY(-5px); /* رفع خفيف عند التحويم */
      box-shadow: 0 12px 30px var(--shadow-dark);
  }

  .image-area {
    width: 100%;
    padding-bottom: 100%; /* نسبة 1:1 لجعلها مربعة */
    position: relative; /* لتمكين وضع الصورة المطلق */
    background-color: var(--input-background); /* لون خلفية يظهر إذا لم يتم تحميل صورة */
    border-radius: 12px 12px 0 0;
    overflow: hidden; /* للحفاظ على الصورة داخل الحواف الدائرية وقص الزوائد */
  }

  .editable-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover; /* مهم: يجعل الصورة تملأ الحاوية وتقص الزوائد للحفاظ على المربع */
    transition: transform 0.3s ease;
  }
  .editable-image:hover {
      transform: scale(1.05); /* تكبير خفيف للصورة عند التحويم */
  }


  .red-fixed-area {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    color: var(--text-light);
    direction: rtl;
    font-size: 1.1em;
    font-weight: 700;
    text-shadow: 1px 1px 3px var(--shadow-light);
    z-index: 1;
    border-radius: 0 0 12px 12px;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 18px 25px;
    min-height: 75px;
    transform: translateY(0.5px);
    gap: 10px;
    background: linear-gradient(to right, var(--accent-color), #D32F2F); /* تدرج جذاب للشريط */
    transition: background 0.3s ease, min-height 0.3s ease, padding 0.3s ease; /* انيميشن للتغييرات */
  }

  /* أشكال حواف الشريط */
  .red-fixed-area.rounded-bottom-banner {
    border-bottom-left-radius: 15px;
    border-bottom-right-radius: 15px;
  }


  #channelIconsContainer {
    display: flex;
    align-items: center;
    gap: 5px;
    order: 1;
  }
  #channelIconsContainer img {
      max-width: 100%;
      max-height: 100%;
      height: auto;
      display: block;
      object-fit: contain;
  }
  #channelIconsContainer span {
      line-height: 1;
  }

  .editable-text {
    font-size: 1em;
    margin: 0;
    line-height: 1.4;
    text-align: center;
    width: 100%;
    word-wrap: break-word;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    order: 2;
  }

  .controls {
    width: 100%;
    max-width: 450px;
    background-color: var(--card-background);
    border-radius: 12px;
    box-shadow: 0 8px 25px var(--shadow-dark); /* ظل أغمق وجذاب */
    border: 1px solid var(--border-color);
    overflow: hidden;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    margin-top: auto;
    margin-bottom: 20px;
    flex-shrink: 0; /* مهم: لمنع انكماش هذا العنصر */
    transition: transform 0.3s ease, box-shadow 0.3s ease; /* انيميشن عند التفاعل */
  }
  .controls:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px var(--shadow-dark);
  }

  .tab-buttons {
    display: flex;
    width: 100%;
    background-color: var(--input-background); /* لون خلفية أغمق للتابات */
    border-bottom: 1px solid var(--border-color);
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    overflow-x: auto;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch;
  }

  .tab-button {
    flex-shrink: 0;
    padding: 16px 10px;
    text-align: center;
    cursor: pointer;
    background-color: var(--input-background); /* لون خلفية أغمق للتابات */
    color: var(--text-muted);
    font-weight: 700;
    font-size: 0.95em;
    border: none;
    border-left: 1px solid var(--border-color);
    transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .tab-button:first-child {
      border-left: none;
  }

  .tab-button:hover {
    background-color: #383838; /* لون أغمق عند التحويم */
    color: var(--text-light);
  }

  .tab-button.active {
    background-color: var(--card-background); /* لون خلفية البطاقة للتاب النشط */
    color: var(--accent-color);
    box-shadow: inset 0 3px 0 0 var(--accent-color);
    border-bottom-color: var(--card-background);
  }

  .tab-content {
    padding: 25px;
    display: none;
    flex-direction: column;
    gap: 20px;
  }

  .tab-content.active {
    display: flex;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .control-group label {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    font-weight: 400;
    color: var(--text-muted);
    font-size: 1em;
  }

  .control-group label .icon {
    margin-left: 8px;
    font-size: 1.3em;
    color: var(--secondary-color); /* أيقونات التحكم بلون أصفر */
  }

  /* تصميم عام لحقول الإدخال */
  .controls input[type="text"],
  .controls textarea,
  .controls select,
  .controls input[type="color"],
  .controls input[type="range"] {
    width: 100%; /* استخدام 100% ثم البادينغ الداخلي */
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.95em;
    background-color: var(--input-background);
    color: var(--text-light);
    transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
  }

  /* تخصيص Select */
  .controls select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url('data:image/svg+xml;utf8,<svg fill="%23E0E0E0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
    background-repeat: no-repeat;
    background-position: left 12px center;
    padding-left: 40px;
  }

  /* تخصيص Color Picker */
  .controls input[type="color"] {
    padding: 5px;
    height: 48px;
    width: 60px;
    border-radius: 8px;
    cursor: pointer;
    border: none; /* إزالة الحدود الافتراضية لـ color picker */
  }

  /* Placeholder color */
  .controls input::placeholder,
  .controls textarea::placeholder {
    color: var(--text-muted);
    opacity: 0.8;
  }

  .controls input[type="text"]:focus,
  .controls textarea:focus,
  .controls select:focus,
  .controls input[type="color"]:focus,
  .controls input[type="range"]:focus {
    border-color: var(--secondary-color); /* لون التركيز الجديد */
    box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.2); /* ظل التركيز الجديد */
    outline: none;
    background-color: #383838;
  }

  /* تحسينات خاصة بـ textarea - جعلها أكبر */
  .controls textarea {
    resize: vertical;
    min-height: 120px;
    line-height: 1.5;
  }

  /* تصميم أفضل لزر اختيار الملف */
  .file-input-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
  }

  .file-input-button {
    background-color: var(--button-primary); /* لون زر أساسي */
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 700;
    width: 100%;
    box-sizing: border-box;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3); /* ظل معزز */
  }

  .file-input-button .icon {
    font-size: 1.2em;
  }

  .file-input-button:hover {
    background-color: var(--button-hover);
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(0,0,0,0.45);
  }
  .file-input-button:active {
    transform: translateY(0);
    background-color: var(--button-active);
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }

  /* إخفاء زر إدخال الملف الافتراضي */
  .controls input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 10;
  }

  /* عداد الأحرف والكلمات */
  .text-info {
    display: flex;
    justify-content: space-between;
    font-size: 0.85em;
    color: var(--text-muted);
    margin-top: 5px;
    direction: rtl;
    width: 100%;
  }
  .char-count.warning, .word-count.warning {
    color: var(--secondary-color); /* تحذير باللون الأصفر */
  }
  .char-count.danger, .word-count.danger {
    color: var(--accent-color); /* خطر باللون الأحمر */
  }

  /* إضافة أزرار التبديل (Toggle Switch) لظل النص */
  .toggle-switch-group {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 15px;
    width: 100%;
  }

  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--toggle-off-bg);
    transition: .4s;
    border-radius: 34px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: var(--toggle-on-bg);
  }

  input:focus + .slider {
    box-shadow: 0 0 1px var(--toggle-on-bg);
  }

  input:checked + .slider:before {
    transform: translateX(26px);
  }

  /* أزرار عرض لقطة الشاشة */
  .screenshot-buttons {
    display: flex;
    gap: 15px;
    margin-top: 25px;
  }
  .screenshot-buttons button {
    flex: 1;
    padding: 15px 25px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.1em;
    font-weight: 700;
    box-sizing: border-box;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
  }

  #viewScreenshotBtn {
    background-color: var(--primary-color); /* لون بنفسجي جذاب */
    color: white;
  }
  #viewScreenshotBtn:hover {
    background-color: #673AB7; /* بنفسجي أغمق */
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(0,0,0,0.45);
  }
  #viewScreenshotBtn:active {
    transform: translateY(0);
    background-color: #512DA8;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }


  .info-note {
    font-size: 0.9em;
    text-align: center;
    margin-top: 20px;
    border-radius: 10px;
    padding: 15px;
    line-height: 1.5;
    border: 1px solid var(--border-color);
    background-color: rgba(74, 74, 106, 0.15); /* لون شفاف */
    color: var(--text-muted);
  }

  /* تصميم النقاط والمستوى */
  .player-stats {
    display: flex;
    justify-content: space-around;
    padding: 15px;
    background-color: var(--background-dark); /* لون داكن لقسم الإحصائيات */
    border-bottom: 1px solid var(--border-color);
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    font-weight: 700;
    font-size: 1em;
    color: var(--secondary-color); /* لون أصفر للنقاط الرئيسية */
  }
  .player-stats div {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  .player-stats div span {
      color: var(--text-light);
      margin-top: 3px;
      font-size: 0.8em;
  }
  .player-stats .main-value {
    font-size: 1.3em;
    color: var(--secondary-color);
  }
  .player-stats .secondary-value {
    font-size: 0.7em;
    color: var(--text-muted);
    margin-top: 2px;
  }


  /* تصميم المتجر */
  .store-section {
    margin-bottom: 25px;
  }
  .store-section h3 {
    color: var(--secondary-color); /* لون أصفر لعناوين الأقسام */
    margin-bottom: 12px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 5px;
    text-align: right;
    font-size: 1.2em;
  }
  .store-items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 15px;
    direction: rtl;
  }
  .store-item {
    background-color: var(--input-background); /* لون خلفية عناصر المتجر */
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    position: relative;
    overflow: hidden;
  }
  .store-item.locked {
    background-color: #222; /* لون أغمق للعناصر المقفلة */
    filter: grayscale(80%) brightness(50%);
    cursor: not-allowed;
  }
  .store-item.unlocked .buy-button {
      background-color: var(--button-hover); /* لون مختلف لزر "تم الشراء" */
      cursor: default;
  }
  .store-item.unlocked .buy-button:hover {
      background-color: var(--button-hover);
      transform: none;
      box-shadow: none;
  }


  .store-item:not(.locked):hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 12px rgba(0,0,0,0.3);
  }
  .store-item-name {
    font-weight: 700;
    margin-bottom: 8px;
    font-size: 1em;
    color: var(--text-light);
  }
  .store-item-preview {
    margin-bottom: 12px;
    font-size: 2em;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    overflow: hidden;
  }
  /* معاينة الألوان والتدرجات */
  .store-item-preview.color-preview {
      height: 25px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
  }
  .store-item-preview.banner-preview {
      height: 40px;
      width: 100%;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 0.8em;
      color: white;
  }
  .store-item-preview.banner-preview.rounded-bottom-banner-preview {
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
  }
  .store-item-preview.text-effect-preview {
    font-size: 1.2em;
    color: var(--text-light);
    text-shadow: none;
    -webkit-text-stroke: none;
  }


  .store-item-details {
    font-size: 0.8em;
    color: var(--text-muted);
    margin-bottom: 12px;
    line-height: 1.3;
  }
  .store-item-details span {
    display: block;
  }
  .buy-button {
    background-color: var(--button-primary); /* لون زر الشراء الأساسي */
    color: white;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
    transition: background-color 0.2s ease;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }
  .buy-button:hover:not(:disabled) {
    background-color: var(--button-hover);
  }
  .buy-button:disabled {
    background-color: var(--toggle-off-bg); /* لون زر معطل */
    color: var(--text-muted);
    cursor: not-allowed;
  }
  .locked-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 1em;
      font-weight: 700;
      pointer-events: none;
      z-index: 10;
      border-radius: 8px;
  }
  .locked-overlay span {
      margin-top: 8px;
      font-size: 0.7em;
      font-weight: 400;
      color: var(--text-muted);
  }

  /* نظام التنبيهات الداخلية */
  #notificationArea {
    position: fixed;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 90%;
    max-width: 320px;
  }
  .notification {
    background-color: var(--notification-info);
    color: var(--text-light);
    padding: 12px 15px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    text-align: center;
    font-size: 0.9em;
    opacity: 0;
    transform: translateY(-15px);
    transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; /* انيميشن للظهور */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .notification.show {
    opacity: 1;
    transform: translateY(0);
  }
  .notification.success {
    background-color: var(--notification-success);
  }
  .notification.error {
    background-color: var(--notification-error);
  }
  .notification .icon {
      font-size: 1.1em;
  }

  /* التنبيه الجديد "تحديث قادم قريبا" */
  #updateNotification {
    position: sticky;
    bottom: 10px;
    margin-top: auto;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 8px 15px;
    border-radius: 8px;
    font-size: 0.85em;
    z-index: 1000;
    white-space: nowrap;
  }

  /* Media Queries لتحسين الاستجابة على الشاشات الصغيرة والكبيرة */
  @media (max-width: 480px) {
    body {
      padding: 15px;
    }
    .controls {
      border-radius: 0;
    }
    .tab-buttons {
      border-top-left-radius: 0;
      border-top-right-radius: 0;
    }
    .container {
      border-radius: 0;
    }
    .image-area {
      border-radius: 0;
    }
    .red-fixed-area {
      border-radius: 0;
    }
  }

  @media (min-width: 768px) {
    body {
      padding: 30px;
    }
    .container {
      max-width: 450px;
      margin-bottom: 40px;
    }
    .controls {
      max-width: 550px;
      margin-bottom: 30px;
    }
    .tab-button {
      padding: 18px 15px;
      font-size: 1em;
    }
    .tab-content {
      padding: 30px;
      gap: 25px;
    }
    .file-input-button,
    .screenshot-buttons button {
      padding: 15px 25px;
      font-size: 1.1em;
    }
    .info-note {
      font-size: 1em;
      padding: 18px;
    }
  }

</style>
</head>
<body>

<div class="container" id="captureArea">
  <div class="image-area">
    <img id="mainImage" class="editable-image" src="" alt="صورة الخبر">
  </div>
  <div class="red-fixed-area" id="redBanner">
    <div id="channelIconsContainer"></div>
    <p id="mainText" class="editable-text">
      النص هنا (يمكنك تغييره)
    </p>
  </div>
</div>

<div class="controls">
  <div class="player-stats">
    <div>
      <div class="main-value" id="dinarDisplay">0</div>
      <span>دينار</span>
    </div>
    <div>
      <div class="main-value" id="levelDisplay">1</div>
      <span>المستوى</span>
      <div class="secondary-value" id="xpRemainingDisplay">0 / 0 XP</div>
    </div>
  </div>

  <div class="tab-buttons" id="tabButtons">
    <button class="tab-button active" data-tab="image">
      <span class="icon">🖼️</span> الصورة
    </button>
    <button class="tab-button" data-tab="mainText">
      <span class="icon">📝</span> النص
    </button>
    <button class="tab-button" data-tab="redBanner">
      <span class="icon">🔴</span> الشريط
    </button>
    <button class="tab-button" data-tab="channelIcon">
      <span class="icon">✨</span> الأيقونة
    </button>
    <button class="tab-button" data-tab="store">
      <span class="icon">🛒</span> المتجر
    </button>
  </div>

  <div id="imageTabContent" class="tab-content active">
    <div class="control-group">
      <label for="imageUpload">
        <span class="icon">⬆️</span> تحميل صورة:
      </label>
      <div class="file-input-wrapper">
        <input type="file" id="imageUpload" accept="image/*">
        <button type="button" class="file-input-button">
          <span class="icon">📂</span> اختر صورة
        </button>
      </div>
      <small style="color: var(--text-muted);">ستأتي الصورة مربعة مع القص تلقائيًا.</small>
    </div>
  </div>

  <div id="mainTextTabContent" class="tab-content">
    <div class="control-group">
      <label for="newText">
        <span class="icon">🖊️</span> اكتب النص هنا:
      </label>
      <textarea id="newText" placeholder="أدخل نص الخبر هنا..."></textarea>
      <div class="text-info">
        <div id="charCount" class="char-count"></div>
        <div id="wordCount" class="word-count"></div>
      </div>
    </div>

    <div class="control-group">
      <label for="fontSelect">
          <span class="icon">🅰️</span> اختر الخط:
      </label>
      <select id="fontSelect">
          </select>
    </div>

    <div class="control-group">
      <label for="fontSize">
          <span class="icon">📏</span> حجم الخط:
      </label>
      <input type="range" id="fontSize" min="0.8" max="1.8" step="0.1" value="1.1">
      <span id="fontSizeValue" style="color: var(--text-muted); text-align: left;">1.1em</span>
    </div>

    <div class="control-group">
      <label for="textColor">
          <span class="icon">🎨</span> لون النص:
      </label>
      <input type="color" id="textColor" value="#ffffff">
    </div>

    <div class="control-group">
        <label for="textEffectSelect">
            <span class="icon">✨</span> تأثير النص:
        </label>
        <select id="textEffectSelect">
            <option value="none" data-is-free="true">لا شيء</option>
            </select>
    </div>

    <div class="control-group toggle-switch-group">
      <label for="textShadowToggle">
          <span class="icon">⚫</span> ظل النص:
      </label>
      <label class="toggle-switch">
          <input type="checkbox" id="textShadowToggle" checked>
          <span class="slider"></span>
      </label>
    </div>
  </div>

  <div id="redBannerTabContent" class="tab-content">
    <div class="control-group">
        <label for="bannerStyleSelect">
            <span class="icon">🎨</span> نمط الشريط:
        </label>
        <select id="bannerStyleSelect">
            <option value="default_red" data-is-free="true">أحمر (افتراضي)</option>
        </select>
    </div>
    <div class="control-group" id="redBannerColorInputGroup">
        <label for="redBannerColor">
            <span class="icon">🌈</span> لون الشريط الأحمر (تعديل):
        </label>
        <input type="color" id="redBannerColor" value="#F44336">
    </div>
    <div class="control-group">
      <label for="bannerHeight">
          <span class="icon">📐</span> ارتفاع الشريط:
      </label>
      <input type="range" id="bannerHeight" min="60" max="120" step="5" value="75">
      <span id="bannerHeightValue" style="color: var(--text-muted); text-align: left;">75px</span>
    </div>

    <div class="control-group">
      <label for="textPadding">
          <span class="icon">↔️</span> المسافة البادئة للنص:
      </label>
      <input type="range" id="textPadding" min="10" max="40" step="1" value="25">
      <span id="textPaddingValue" style="color: var(--text-muted); text-align: left;">25px</span>
    </div>
  </div>

  <div id="channelIconTabContent" class="tab-content">
    <div class="control-group">
        <label>
            <span class="icon">🖼️</span> نوع الأيقونة:
        </label>
        <select id="iconTypeSelect">
            <option value="none" data-is-free="true">لا شيء</option>
            </select>
    </div>

    <div class="control-group" id="customIconUploadGroup" style="display: none;">
        <label for="customIconUpload">
            <span class="icon">⬆️</span> تحميل أيقونة مخصصة:
        </label>
        <div class="file-input-wrapper">
            <input type="file" id="customIconUpload" accept="image/*">
            <button type="button" class="file-input-button">
                <span class="icon">📂</span> اختر أيقونة
            </button>
        </div>
        <small style="color: var(--text-muted);">يفضل أيقونة مربعة وشفافة</small>
        <button type="button" class="file-input-button" id="removeCustomIconButton" style="background-color: var(--accent-color); margin-top: 10px;">
            <span class="icon">🗑️</span> إزالة الأيقونة المخصصة
        </button>
    </div>

    <div class="control-group" id="iconColorAndSizeGroup">
        <label for="iconColor">
            <span class="icon">🎨</span> لون الأيقونة:
        </label>
        <input type="color" id="iconColor" value="#FFFFFF">
    </div>

    <div class="control-group" id="iconSizeGroup">
        <label for="iconSize">
            <span class="icon">🔍</span> حجم الأيقونة:
        </label>
        <input type="range" id="iconSize" min="1" max="2.5" step="0.1" value="1.5">
        <span id="iconSizeValue" style="color: var(--text-muted); text-align: left;">1.5em</span>
    </div>

    <div class="control-group">
        <label for="iconPosition">
            <span class="icon">↔️</span> موضع الأيقونة:
        </label>
        <select id="iconPosition">
            <option value="flex-start">يمين (RTL)</option>
            <option value="center">المنتصف</option>
            <option value="flex-end">يسار (RTL)</option>
        </select>
    </div>
  </div>

  <div id="storeTabContent" class="tab-content">
    <div class="store-section">
        <h3>الخطوط</h3>
        <div class="store-items-grid" id="storeFontsGrid">
            </div>
    </div>
    <div class="store-section">
        <h3>ألوان الشريط وأنماطه</h3>
        <div class="store-items-grid" id="storeBannerStylesGrid">
            </div>
    </div>
    <div class="store-section">
        <h3>تأثيرات النص</h3>
        <div class="store-items-grid" id="storeTextEffectsGrid">
            </div>
    </div>
    <div class="store-section">
        <h3>أحجام وتعديلات</h3>
        <div class="store-items-grid" id="storeSizesGrid">
            </div>
    </div>
    <div class="store-section">
        <h3>أيقونات إضافية</h3>
        <div class="store-items-grid" id="storeIconsGrid">
            </div>
    </div>
  </div>


  <div class="screenshot-buttons">
    <button id="viewScreenshotBtn">
      <span class="icon">📸</span> عرض لقطة الشاشة
    </button>
  </div>

  <div class="info-note">
    هذا التطبيق مصمم للعمل بسلاسة في أي متصفح حديث (مثل Chrome، Safari، Firefox) على أي جهاز، بما في ذلك هاتف سامسونج A55.
  </div>
</div>

<div id="updateNotification">تحديث قادم قريبا</div>

<div id="notificationArea"></div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  const mainImage = document.getElementById('mainImage');
  const mainText = document.getElementById('mainText');
  const imageUploadInput = document.getElementById('imageUpload');
  const newTextInput = document.getElementById('newText');
  const charCountDisplay = document.getElementById('charCount');
  const wordCountDisplay = document.getElementById('wordCount');
  const fontSelect = document.getElementById('fontSelect');
  const fontSizeInput = document.getElementById('fontSize');
  const fontSizeValueDisplay = document.getElementById('fontSizeValue');
  const textColorInput = document.getElementById('textColor');
  const redBannerColorInput = document.getElementById('redBannerColor');
  const redBanner = document.getElementById('redBanner');
  const textShadowToggle = document.getElementById('textShadowToggle');
  const viewScreenshotBtn = document.getElementById('viewScreenshotBtn');
  const captureArea = document.getElementById('captureArea');
  const textEffectSelect = document.getElementById('textEffectSelect'); // جديد لتأثيرات النص

  // عناصر التحكم بالأيقونات
  const iconTypeSelect = document.getElementById('iconTypeSelect');
  const customIconUploadGroup = document.getElementById('customIconUploadGroup');
  const customIconUploadInput = document.getElementById('customIconUpload');
  const removeCustomIconButton = document.getElementById('removeCustomIconButton');
  const iconColorAndSizeGroup = document.getElementById('iconColorAndSizeGroup');
  const iconSizeGroup = document.getElementById('iconSizeGroup');
  const iconColorInput = document.getElementById('iconColor');
  const iconSizeInput = document.getElementById('iconSize');
  const iconSizeValueDisplay = document.getElementById('iconSizeValue');
  const iconPositionSelect = document.getElementById('iconPosition');
  const channelIconsContainer = document.getElementById('channelIconsContainer');

  // عناصر التحكم بالشريط الأحمر
  const bannerHeightInput = document.getElementById('bannerHeight');
  const bannerHeightValueDisplay = document.getElementById('bannerHeightValue');
  const textPaddingInput = document.getElementById('textPadding');
  const textPaddingValueDisplay = document.getElementById('textPaddingValue');
  const bannerStyleSelect = document.getElementById('bannerStyleSelect'); // جديد لنمط الشريط

  // عناصر نظام النقاط والمستوى
  const dinarDisplay = document.getElementById('dinarDisplay');
  const levelDisplay = document.getElementById('levelDisplay');
  const xpRemainingDisplay = document.getElementById('xpRemainingDisplay');

  let totalDinar = parseInt(localStorage.getItem('totalDinar') || '0');
  let currentXP = parseInt(localStorage.getItem('currentXP') || '0');
  let currentLevel = parseInt(localStorage.getItem('currentLevel') || '1');
  let selectedBannerStyle = localStorage.getItem('selectedBannerStyle') || 'default_red'; // لحفظ نمط الشريط المختار
  let selectedTextEffect = localStorage.getItem('selectedTextEffect') || 'none'; // لحفظ تأثير النص المختار


  const XP_TO_LEVEL_UP_BASE = 5000; // XP المطلوبة لكل مستوى

  // عناصر المتجر
  const storeFontsGrid = document.getElementById('storeFontsGrid');
  const storeBannerStylesGrid = document.getElementById('storeBannerStylesGrid'); // شبكة جديدة لأنماط الشريط
  const storeTextEffectsGrid = document.getElementById('storeTextEffectsGrid'); // شبكة جديدة لتأثيرات النص
  const storeSizesGrid = document.getElementById('storeSizesGrid');
  const storeIconsGrid = document.getElementById('storeIconsGrid');
  let unlockedItems = JSON.parse(localStorage.getItem('unlockedItems') || '[]');

  // عناصر التنبيهات الداخلية
  const notificationArea = document.getElementById('notificationArea');


  let customIconBase64 = localStorage.getItem('customIconBase64') || null; // لتخزين صورة الأيقونة المخصصة
  if (customIconBase64 && !isItemUnlocked('icon-custom')) { // إذا كانت هناك صورة مخصصة محفوظة لكن العنصر غير مفتوح
      customIconBase64 = null; // لا تسمح باستخدامها
      localStorage.removeItem('customIconBase64');
  }


  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');

  const defaultText = "ترامب: باركت لأردوغان وقلت له لقد سيطرتم على سوريا";
  const maxCharLength = 150;

  mainText.innerHTML = defaultText;
  newTextInput.value = defaultText;

  // استخدام صورة افتراضية أو مساحة بيضاء إذا لم يتم تحميل صورة
  mainImage.src = localStorage.getItem('mainImageSrc') || "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";


  // --- بيانات المتجر ---
  const storeItemsData = [
    // الخطوط (القاهرة مجاني الآن)
    { id: 'font-changa', type: 'font', name: 'شانجا (Changa)', cost: 400, levelRequired: 2, value: 'Changa', style: 'font-family: \'Changa\', sans-serif;' },
    { id: 'font-almarai', type: 'font', name: 'المراعي (Almarai)', cost: 500, levelRequired: 3, value: 'Almarai', style: 'font-family: \'Almarai\', sans-serif;' },
    { id: 'font-notosansarabic', type: 'font', name: 'نوتو سانس عربي (Noto Sans Arabic)', cost: 600, levelRequired: 3, value: 'Noto Sans Arabic', style: 'font-family: \'Noto Sans Arabic\', sans-serif;' },
    { id: 'font-tajawal', type: 'font', name: 'تجوال (Tajawal)', cost: 700, levelRequired: 4, value: 'Tajawal', style: 'font-family: \'Tajawal\', sans-serif;' },
    { id: 'font-amiriquiran', type: 'font', name: 'الكوفي (Amiri Quran)', cost: 800, levelRequired: 4, value: 'Amiri Quran', style: 'font-family: \'Amiri Quran\', serif;' },
    { id: 'font-lateef', type: 'font', name: 'خط لطيف', cost: 900, levelRequired: 5, value: 'Lateef', style: 'font-family: \'Lateef\', serif;' },
    { id: 'font-reemkufiink', type: 'font', name: 'خط ريم كوفي', cost: 1000, levelRequired: 5, value: 'Reem Kufi Ink', style: 'font-family: \'Reem Kufi Ink\', sans-serif;' },
    { id: 'font-arefruqaa', type: 'font', name: 'عارف رقعة', cost: 1100, levelRequired: 6, value: 'Aref Ruqaa', style: 'font-family: \'Aref Ruqaa\', serif;' },
    { id: 'font-katibeh', type: 'font', name: 'كاتبه', cost: 1200, levelRequired: 6, value: 'Katibeh', style: 'font-family: \'Katibeh\', serif;' },
    { id: 'font-marhey', type: 'font', name: 'مرحي', cost: 1300, levelRequired: 7, value: 'Marhey', style: 'font-family: \'Marhey\', sans-serif;' },

    // أنماط الشريط (ألوان وأشكال)
    { id: 'banner-style-blue-solid', type: 'banner_style', name: 'أزرق سماوي', cost: 800, levelRequired: 2, value: '#007bff', preview: 'background-color: #007bff;', class: '' },
    { id: 'banner-style-purple-gradient', type: 'banner_style', name: 'تدرج بنفسجي', cost: 1200, levelRequired: 3, value: 'linear-gradient(to top, #6A11CB 50%, rgba(106,17,203,0.7) 75%, rgba(106,17,203,0.0) 100%)', preview: 'background: linear-gradient(to top, #6A11CB, #4A0F8A);', class: '' },
    { id: 'banner-style-green-wave', type: 'banner_style', name: 'موجة خضراء', cost: 1800, levelRequired: 4, value: 'linear-gradient(to top, #28a745 50%, rgba(40,167,69,0.7) 75%, rgba(40,167,69,0.0) 100%)', preview: 'background: linear-gradient(to top, #28a745, #1E7E34);', class: '' },
    { id: 'banner-style-rounded-bottom', type: 'banner_style', name: 'حواف سفلية دائرية', cost: 1000, levelRequired: 3, value: null, preview: 'background-color: #F44336; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;', class: 'rounded-bottom-banner' },
    { id: 'banner-style-dark-blue-gradient', type: 'banner_style', name: 'تدرج أزرق داكن', cost: 1500, levelRequired: 4, value: 'linear-gradient(to top, #153243 50%, rgba(21,50,67,0.7) 75%, rgba(21,50,67,0.0) 100%)', preview: 'background: linear-gradient(to top, #153243, #0A1C2C);', class: '' },

    // تأثيرات النص
    { id: 'text-effect-outline-white', type: 'text_effect', name: 'إطار أبيض', cost: 700, levelRequired: 2, value: '-webkit-text-stroke: 1.5px white; text-stroke: 1.5px white;', preview: 'font-size: 1.5em; -webkit-text-stroke: 1.5px white; text-stroke: 1.5px white; color: black; background-color: #eee; border-radius: 5px;' },
    { id: 'text-effect-outline-black', type: 'text_effect', name: 'إطار أسود', cost: 700, levelRequired: 2, value: '-webkit-text-stroke: 1.5px black; text-stroke: 1.5px black;', preview: 'font-size: 1.5em; -webkit-text-stroke: 1.5px black; text-stroke: 1.5px black; color: white; background-color: #222; border-radius: 5px;' },
    { id: 'text-effect-glow', type: 'text_effect', name: 'توهج', cost: 900, levelRequired: 3, value: 'text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #FFC107;', preview: 'font-size: 1.5em; text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #FFC107; background-color: #3A3A5A; border-radius: 5px;' },
    { id: 'text-effect-neon', type: 'text_effect', name: 'نيون', cost: 1500, levelRequired: 4, value: 'text-shadow: 0 0 7px #0ff, 0 0 10px #0ff, 0 0 21px #0ff, 0 0 42px #0fa, 0 0 82px #0fa, 0 0 92px #0fa, 0 0 102px #0fa, 0 0 151px #0fa;', preview: 'font-size: 1.5em; text-shadow: 0 0 7px #0ff; background-color: #3A3A5A; border-radius: 5px;' },


    // أحجام وتعديلات
    { id: 'size-banner-boost', type: 'size_boost', name: 'ارتفاع شريط إضافي', cost: 1500, levelRequired: 4, value: { target: 'bannerHeight', max: 150 }, description: 'يزيد أقصى ارتفاع للشريط إلى 150 بكسل.' },
    { id: 'size-text-boost', type: 'size_boost', name: 'حجم نص أكبر', cost: 1200, levelRequired: 3, value: { target: 'fontSize', max: 2.5 }, description: 'يزيد أقصى حجم للخط إلى 2.5em.' },

    // أيقونات إضافية (أيقونات SVG بسيطة كـ Data URLs)
    { id: 'icon-custom', type: 'icon', name: 'صورة مخصصة', cost: 500, levelRequired: 1, value: 'custom', description: 'تتيح لك استخدام صورتك الخاصة كأيقونة.' },
    { id: 'icon-square', type: 'icon', name: 'مربع ■', cost: 200, levelRequired: 2, value: 'square' },
    { id: 'icon-circle', type: 'icon', name: 'دائرة ●', cost: 250, levelRequired: 2, value: 'circle' },
    { id: 'icon-triangle', type: 'icon', name: 'مثلث ▲', cost: 300, levelRequired: 2, value: 'triangle' },
    { id: 'icon-star', type: 'icon', name: 'نجمة ★', cost: 400, levelRequired: 3, value: 'star' },
    { id: 'icon-broadcast', type: 'icon', name: 'بث 📡', cost: 500, levelRequired: 3, value: 'broadcast' },
    { id: 'icon-check', type: 'icon', name: 'أيقونة صح', cost: 600, levelRequired: 4, value: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPjxwYXRoIGQ9MTA5IDE2LjE3TDQgMTEuMTcgMi41OCAxMi41OCA5IDE5LjkyIDE5LjQyIDkuNTEgMTggOC4wOUw5IDE2LjE3eiIvPjwvc3ZnPg==' },
    { id: 'icon-message', type: 'icon', name: 'أيقونة رسالة', cost: 900, levelRequired: 4, value: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPjxwYXRoIGQ9TTIwIDJINEMyLjkgMiAyIDIuOSAyIDR2MTZjMCAxLjEuOSAyIDIgMi4wMUwyMiAyMC4wMVY0YzAtMS4xLS45LTItMi0yem0wIDE4SDhMNC4wMSAxNlY0aDE1Ljk5VjIzeiIvPjwvc3ZnPg==' },
    { id: 'icon-youtube', type: 'icon', name: 'أيقونة يوتيوب', cost: 700, levelRequired: 5, value: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI0ZGRiI+PHBhdGggZD0yMCAySDQuMUMzLjUxIDIgMyAyLjUxIDMgNGgzVjJoLTJWOWg0VjIuODhMMjAuMyAyLjU3QzIwLjYyIDIuNDYgMjEgMi44MiAyMSAzLjMxdjguMzhjMCAuNTEtLjQgLjc1LS42NC41OWwtMy4zMy0yLjQydi0xLjY3aC00VjE3hDcuMTZsLTIuMDYgMS40NGMtLjQyLjMxLS43NC43NS0uNzQgMS4zMnYyLjc5Yy40Ni0wLjE2LjgtLjYyLjgzLS45NWwzLjQ1LTIuNDFhMS40ODIgMS40ODIgMCAwIDAgLjc2LTEuMzJWMi43MmMwLTEuMjMtLjkuLTIuMTYtMi4zLTIuMDZsLjA1LS44OXoiLz48L3N2Zz4=' }
  ];

  // --- دوال اللعبة ونظام الحفظ ---

  function saveGameProgress() {
    localStorage.setItem('totalDinar', totalDinar.toString());
    localStorage.setItem('currentXP', currentXP.toString());
    localStorage.setItem('currentLevel', currentLevel.toString());
    localStorage.setItem('unlockedItems', JSON.stringify(unlockedItems));
    localStorage.setItem('selectedBannerStyle', selectedBannerStyle);
    localStorage.setItem('selectedTextEffect', selectedTextEffect);
    localStorage.setItem('customIconBase64', customIconBase64); // حفظ الأيقونة المخصصة

    // حفظ حالة العناصر التي يمكن تعديلها مباشرة
    localStorage.setItem('mainImageSrc', mainImage.src);
    localStorage.setItem('newText', newTextInput.value);
    localStorage.setItem('fontSelectValue', fontSelect.value);
    localStorage.setItem('fontSizeValue', fontSizeInput.value);
    localStorage.setItem('textColorValue', textColorInput.value);
    localStorage.setItem('redBannerColorValue', redBannerColorInput.value);
    localStorage.setItem('bannerHeightValue', bannerHeightInput.value);
    localStorage.setItem('textPaddingValue', textPaddingInput.value);
    localStorage.setItem('textShadowToggleChecked', textShadowToggle.checked);
    localStorage.setItem('iconTypeSelectValue', iconTypeSelect.value);
    localStorage.setItem('iconColorValue', iconColorInput.value);
    localStorage.setItem('iconSizeValue', iconSizeInput.value);
    localStorage.setItem('iconPositionValue', iconPositionSelect.value);


    updatePlayerStatsDisplay();
  }

  function loadGameProgress() {
    totalDinar = parseInt(localStorage.getItem('totalDinar') || '0');
    currentXP = parseInt(localStorage.getItem('currentXP') || '0');
    currentLevel = parseInt(localStorage.getItem('currentLevel') || '1');
    unlockedItems = JSON.parse(localStorage.getItem('unlockedItems') || '[]');
    selectedBannerStyle = localStorage.getItem('selectedBannerStyle') || 'default_red';
    selectedTextEffect = localStorage.getItem('selectedTextEffect') || 'none';
    customIconBase64 = localStorage.getItem('customIconBase64') || null;

    // استعادة حالة العناصر
    if (localStorage.getItem('mainImageSrc')) mainImage.src = localStorage.getItem('mainImageSrc');
    if (localStorage.getItem('newText')) newTextInput.value = localStorage.getItem('newText');
    if (localStorage.getItem('fontSelectValue')) fontSelect.value = localStorage.getItem('fontSelectValue');
    if (localStorage.getItem('fontSizeValue')) fontSizeInput.value = localStorage.getItem('fontSizeValue');
    if (localStorage.getItem('textColorValue')) textColorInput.value = localStorage.getItem('textColorValue');
    if (localStorage.getItem('redBannerColorValue')) redBannerColorInput.value = localStorage.getItem('redBannerColorValue');
    if (localStorage.getItem('bannerHeightValue')) bannerHeightInput.value = localStorage.getItem('bannerHeightValue');
    if (localStorage.getItem('textPaddingValue')) textPaddingInput.value = localStorage.getItem('textPaddingValue');
    if (localStorage.getItem('textShadowToggleChecked')) textShadowToggle.checked = (localStorage.getItem('textShadowToggleChecked') === 'true');
    if (localStorage.getItem('iconTypeSelectValue')) iconTypeSelect.value = localStorage.getItem('iconTypeSelectValue');
    if (localStorage.getItem('iconColorValue')) iconColorInput.value = localStorage.getItem('iconColorValue');
    if (localStorage.getItem('iconSizeValue')) iconSizeInput.value = localStorage.getItem('iconSizeValue');
    if (localStorage.getItem('iconPositionValue')) iconPositionSelect.value = localStorage.getItem('iconPositionValue');
  }


  function updatePlayerStatsDisplay() {
    dinarDisplay.textContent = totalDinar;
    levelDisplay.textContent = currentLevel;

    const xpForNextLevel = currentLevel * XP_TO_LEVEL_UP_BASE;
    xpRemainingDisplay.textContent = `${currentXP} / ${xpForNextLevel} XP`;
  }

  function checkLevelUp() {
    const xpForNextLevel = currentLevel * XP_TO_LEVEL_UP_BASE;
    if (currentXP >= xpForNextLevel) {
      currentLevel++;
      // لا يتم إعادة تعيين XP، بل تستمر في التراكم (تصاعدي)
      showNotification(`🎉 لقد ارتفعت إلى المستوى ${currentLevel}!`, 'success');
      checkLevelUp(); // Recursive call for multiple level ups
    }
    saveGameProgress();
    renderStore(); // إعادة عرض المتجر لتحديث حالة العناصر المفتوحة
    updateAvailableOptions(); // تحديث القوائم المنسدلة
  }

  function addRandomCurrencyAndXP() {
    const dinarToAdd = Math.floor(Math.random() * 5) + 1; // دينار عشوائي بين 1 و 5
    const xpToAdd = Math.floor(Math.random() * 7) + 1; // XP عشوائي بين 1 و 7

    totalDinar += dinarToAdd;
    currentXP += xpToAdd;

    checkLevelUp(); // تحقق من الارتقاء بالمستوى بعد إضافة الخبرة
    updatePlayerStatsDisplay(); // تحديث فوري للعرض
  }

  // بدء إضافة العملة والخبرة كل 5 ثوانٍ
  setInterval(addRandomCurrencyAndXP, 5000);

  // --- دوال المتجر ---

  function isItemUnlocked(itemId) {
    return unlockedItems.includes(itemId);
  }

  function renderStore() {
    storeFontsGrid.innerHTML = '';
    storeBannerStylesGrid.innerHTML = '';
    storeTextEffectsGrid.innerHTML = '';
    storeSizesGrid.innerHTML = '';
    storeIconsGrid.innerHTML = '';

    storeItemsData.forEach(item => {
      const itemElement = document.createElement('div');
      itemElement.classList.add('store-item');
      itemElement.dataset.itemId = item.id;

      const unlocked = isItemUnlocked(item.id);
      const canAfford = totalDinar >= item.cost;
      const levelMet = currentLevel >= item.levelRequired;
      const isLockedByLevel = !levelMet;

      if (unlocked) {
          itemElement.classList.add('unlocked');
      } else if (isLockedByLevel) {
          itemElement.classList.add('locked');
      }

      let previewContent = '';
      if (item.type === 'font') {
          previewContent = `<span style="${item.style}">نموذج</span>`;
      } else if (item.type === 'banner_style') {
          previewContent = `<div class="store-item-preview banner-preview ${item.class || ''}" style="${item.preview}">شريط</div>`;
      } else if (item.type === 'text_effect') {
          previewContent = `<span class="store-item-preview text-effect-preview" style="${item.preview}">نص</span>`;
      } else if (item.type === 'icon') {
          if (item.value.startsWith('data:image/svg+xml')) {
              previewContent = `<img src="${item.value}" alt="أيقونة" style="height: 40px; width: auto; filter: invert(100%);">`;
          } else if (item.value === 'custom') {
              previewContent = `<span class="icon">🖼️</span>`;
          }
          else {
              let iconChar = '';
              switch (item.value) {
                  case 'square': iconChar = '■'; break;
                  case 'circle': iconChar = '●'; break;
                  case 'triangle': iconChar = '▲'; break;
                  case 'star': iconChar = '★'; break;
                  case 'broadcast': iconChar = '📡'; break;
              }
              previewContent = `<span style="font-size: 1.5em; color: var(--text-light);">${iconChar}</span>`;
          }
      } else if (item.type === 'size_boost') {
          previewContent = `<span class="icon">⬆️</span>`;
      }


      itemElement.innerHTML = `
          ${isLockedByLevel ? `<div class="locked-overlay">🔒<br><span>المستوى ${item.levelRequired} مطلوب</span></div>` : ''}
          <div class="store-item-name">${item.name}</div>
          <div class="store-item-preview">${previewContent}</div>
          <div class="store-item-details">
              <span>التكلفة: ${item.cost} دينار</span>
              <span>المستوى المطلوب: ${item.levelRequired}</span>
              ${item.description ? `<span>${item.description}</span>` : ''}
          </div>
          <button class="buy-button" ${unlocked || !canAfford || isLockedByLevel ? 'disabled' : ''}>
              ${unlocked ? 'تم الشراء' : `شراء (${item.cost})`}
          </button>
      `;

      if (!unlocked) {
        const buyButton = itemElement.querySelector('.buy-button');
        buyButton.addEventListener('click', () => buyItem(item.id));
      }


      // إضافة العنصر إلى الشبكة الصحيحة
      if (item.type === 'font') {
        storeFontsGrid.appendChild(itemElement);
      } else if (item.type === 'banner_style') {
        storeBannerStylesGrid.appendChild(itemElement);
      } else if (item.type === 'text_effect') {
        storeTextEffectsGrid.appendChild(itemElement);
      } else if (item.type === 'size_boost') {
        storeSizesGrid.appendChild(itemElement);
      } else if (item.type === 'icon') {
        storeIconsGrid.appendChild(itemElement);
      }
    });
  }

  function buyItem(itemId) {
    const item = storeItemsData.find(i => i.id === itemId);

    if (!item) {
      showNotification('العنصر غير موجود.', 'error');
      return;
    }

    if (isItemUnlocked(itemId)) {
      showNotification('لقد اشتريت هذا العنصر بالفعل!', 'info');
      return;
    }

    if (currentLevel < item.levelRequired) {
      showNotification(`تحتاج إلى المستوى ${item.levelRequired} لشراء هذا العنصر.`, 'error');
      return;
    }

    if (totalDinar < item.cost) {
      showNotification('ليس لديك دينار كافية لشراء هذا العنصر.', 'error');
      return;
    }

    // خصم الدينار وإضافة العنصر إلى العناصر المفتوحة
    totalDinar -= item.cost;
    unlockedItems.push(itemId);
    saveGameProgress();
    showNotification(`لقد اشتريت ${item.name} بنجاح!`, 'success');

    // تطبيق العنصر المشتراة
    applyUnlockedItem(item);
    renderStore(); // إعادة عرض المتجر لتحديث حالة العناصر
    updateAvailableOptions(); // تحديث القوائم المنسدلة بناءً على المشتريات
  }

  function applyUnlockedItem(item) {
    if (item.type === 'size_boost') {
        if (item.value.target === 'bannerHeight') {
            bannerHeightInput.max = item.value.max;
            showNotification(`تم زيادة الحد الأقصى لارتفاع الشريط إلى ${item.value.max}px.`, 'info');
        } else if (item.value.target === 'fontSize') {
            fontSizeInput.max = item.value.max;
            showNotification(`تم زيادة الحد الأقصى لحجم الخط إلى ${item.value.max}em.`, 'info');
        }
    }
  }

  function updateAvailableOptions() {
    // تحديث خيارات الخطوط
    const currentFontValue = fontSelect.value;
    fontSelect.innerHTML = ''; // مسح جميع الخيارات

    // إضافة الخيار الافتراضي المجاني (خط النظام)
    const defaultFontOption = document.createElement('option');
    defaultFontOption.value = 'system-ui';
    defaultFontOption.textContent = 'افتراضي (System UI)';
    defaultFontOption.style.fontFamily = 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif';
    defaultFontOption.dataset.isFree = 'true';
    fontSelect.appendChild(defaultFontOption);

    // إضافة خط القاهرة مجانيًا
    const cairoFontOption = document.createElement('option');
    cairoFontOption.value = 'Cairo';
    cairoFontOption.textContent = 'القاهرة (Cairo)';
    cairoFontOption.style.fontFamily = 'Cairo, sans-serif';
    cairoFontOption.dataset.isFree = 'true';
    fontSelect.appendChild(cairoFontOption);

    // إضافة الخطوط المشتراة
    storeItemsData.filter(item => item.type === 'font' && isItemUnlocked(item.id)).forEach(item => {
        const option = document.createElement('option');
        option.value = item.value;
        option.textContent = item.name;
        option.style = item.style;
        fontSelect.appendChild(option);
    });
    fontSelect.value = currentFontValue; // محاولة استعادة القيمة المختارة

    // تحديث خيارات الأيقونات
    const currentIconValue = iconTypeSelect.value;
    iconTypeSelect.innerHTML = ''; // مسح جميع الخيارات

    const noneIconOption = document.createElement('option');
    noneIconOption.value = 'none';
    noneIconOption.textContent = 'لا شيء';
    noneIconOption.dataset.isFree = 'true';
    iconTypeSelect.appendChild(noneIconOption);

    storeItemsData.filter(item => item.type === 'icon' && isItemUnlocked(item.id)).forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.name;
        iconTypeSelect.appendChild(option);
    });
    iconTypeSelect.value = currentIconValue;


    // تحديث خيارات أنماط الشريط
    const currentBannerStyleValue = bannerStyleSelect.value;
    bannerStyleSelect.innerHTML = '';

    const defaultRedOption = document.createElement('option');
    defaultRedOption.value = 'default_red';
    defaultRedOption.textContent = 'أحمر (افتراضي)';
    defaultRedOption.dataset.isFree = 'true';
    bannerStyleSelect.appendChild(defaultRedOption);

    storeItemsData.filter(item => item.type === 'banner_style' && isItemUnlocked(item.id)).forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.name;
        bannerStyleSelect.appendChild(option);
    });
    bannerStyleSelect.value = currentBannerStyleValue;


    // تحديث خيارات تأثيرات النص
    const currentTextEffectValue = textEffectSelect.value;
    textEffectSelect.innerHTML = '';

    const noneTextEffectOption = document.createElement('option');
    noneTextEffectOption.value = 'none';
    noneTextEffectOption.textContent = 'لا شيء';
    noneTextEffectOption.dataset.isFree = 'true';
    textEffectSelect.appendChild(noneTextEffectOption);

    storeItemsData.filter(item => item.type === 'text_effect' && isItemUnlocked(item.id)).forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.name;
        textEffectSelect.appendChild(option);
    });
    textEffectSelect.value = currentTextEffectValue;

    // تطبيق تعديلات الأحجام المفتوحة (تغيير الـ max للـ sliders)
    storeItemsData.filter(item => item.type === 'size_boost' && isItemUnlocked(item.id)).forEach(item => {
        applyUnlockedItem(item); // Re-apply to set max values correctly
    });

    // تأكد من تطبيق النمط الحالي بعد تحديث الخيارات
    applyCurrentFont();
    applyCurrentBannerStyle();
    applyCurrentTextEffect();
    updateIcons();
  }


  // --- دوال التنبيهات الداخلية ---
  function showNotification(message, type = 'info', duration = 3000) {
    const notificationDiv = document.createElement('div');
    notificationDiv.classList.add('notification', type);
    notificationDiv.innerHTML = `<span class="icon">${getNotificationIcon(type)}</span> ${message}`;
    notificationArea.appendChild(notificationDiv);

    setTimeout(() => {
      notificationDiv.classList.add('show');
    }, 10);

    setTimeout(() => {
      notificationDiv.classList.remove('show');
      notificationDiv.addEventListener('transitionend', () => notificationDiv.remove());
    }, duration);
  }

  function getNotificationIcon(type) {
    switch (type) {
      case 'success': return '✅';
      case 'error': return '❌';
      case 'info': return 'ℹ️';
      default: return '';
    }
  }


  // --- دوال رئيسية للتطبيق ---

  function applyCurrentFont() {
      const selectedFontValue = fontSelect.value;
      if(selectedFontValue === 'system-ui') {
          mainText.style.fontFamily = 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif';
      } else if (selectedFontValue === 'Cairo') {
          mainText.style.fontFamily = 'Cairo, sans-serif';
      } else {
          const selectedFontItem = storeItemsData.find(item => item.type === 'font' && item.value === selectedFontValue);
          if (selectedFontItem && isItemUnlocked(selectedFontItem.id)) {
            mainText.style.fontFamily = selectedFontItem.style.replace('font-family: ', '').replace(';', '');
          }
      }
  }

  function applyCurrentBannerStyle() {
    const bannerStyleId = bannerStyleSelect.value;
    const bannerStyleItem = storeItemsData.find(item => item.type === 'banner_style' && item.id === bannerStyleId);

    redBanner.classList.remove('rounded-bottom-banner'); // إزالة أي فئات سابقة

    if (bannerStyleId === 'default_red') {
        redBannerColorInputGroup.style.display = 'flex'; // إظهار مدخل اللون الأحمر
        const hexToRgb = hex => {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r},${g},${b}`;
        };
        const rgbColor = hexToRgb(redBannerColorInput.value);
        redBanner.style.background = `linear-gradient(to top, ${redBannerColorInput.value} 50%, rgba(${rgbColor}, 0.7) 75%, rgba(${rgbColor}, 0.0) 100%)`;
    } else if (bannerStyleItem && isItemUnlocked(bannerStyleItem.id)) {
        redBannerColorInputGroup.style.display = 'none'; // إخفاء مدخل اللون الأحمر
        if (bannerStyleItem.value) { // إذا كان النمط هو لون أو تدرج
            redBanner.style.background = bannerStyleItem.value;
        } else { // إذا كان النمط يتعلق بشكل (مثل حواف دائرية)
            redBanner.style.background = `linear-gradient(to top, var(--accent-color) 50%, rgba(244,67,54,0.7) 75%, rgba(244,67,54,0.0) 100%)`; // لون افتراضي إذا لم يتم تحديد قيمة
        }
        if (bannerStyleItem.class) {
            redBanner.classList.add(bannerStyleItem.class);
        }
    } else { // حالة لم يتم شراء النمط أو لا يمكن الوصول إليه
        redBannerColorInputGroup.style.display = 'flex';
        redBannerColorInput.value = "#F44336"; // العودة للون الأحمر الافتراضي الجديد
        const hexToRgb = hex => {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r},${g},${b}`;
        };
        const rgbColor = hexToRgb(redBannerColorInput.value);
        redBanner.style.background = `linear-gradient(to top, ${redBannerColorInput.value} 50%, rgba(${rgbColor}, 0.7) 75%, rgba(${rgbColor}, 0.0) 100%)`;
        bannerStyleSelect.value = 'default_red'; // إعادة تحديد الخيار الافتراضي
    }
    saveGameProgress(); // Save the selected style
  }

  function applyCurrentTextEffect() {
    const textEffectId = textEffectSelect.value;
    const textEffectItem = storeItemsData.find(item => item.type === 'text_effect' && item.id === textEffectId);

    mainText.style.textShadow = textShadowToggle.checked ? '1px 1px 3px rgba(0,0,0,0.5)' : 'none';
    mainText.style.webkitTextStroke = 'none';
    mainText.style.textStroke = 'none';

    if (textEffectId === 'none') {
        // Shadow is handled by the toggle directly
    } else if (textEffectItem && isItemUnlocked(textEffectItem.id)) {
        // Apply the effect. Handle text-shadow and text-stroke separately
        if (textEffectItem.value.includes('text-shadow')) {
            mainText.style.textShadow = textEffectItem.value.split('text-shadow: ')[1].split(';')[0];
        }
        if (textEffectItem.value.includes('-webkit-text-stroke')) {
            mainText.style.webkitTextStroke = textEffectItem.value.split('-webkit-text-stroke: ')[1].split(';')[0];
            mainText.style.textStroke = mainText.style.webkitTextStroke; // Fallback for standard
        }
    }
    saveGameProgress(); // Save the selected effect
  }


  // دالة لتحديث الأيقونات (تم تحسينها للحجم الطبيعي)
  function updateIcons() {
      const iconType = iconTypeSelect.value;
      const iconColor = iconColorInput.value;
      const iconSizeMultiplier = parseFloat(iconSizeInput.value);

      const mainTextComputedStyle = window.getComputedStyle(mainText);
      const mainTextFontSizePx = parseFloat(mainTextComputedStyle.fontSize);
      const baseIconFactorOfText = 1.2;
      const currentIconPxHeight = iconSizeMultiplier * mainTextFontSizePx * baseIconFactorOfText;

      channelIconsContainer.innerHTML = '';

      const storeIcon = storeItemsData.find(item => item.id === iconType && item.type === 'icon');

      const isCustomIconSelected = (iconType === 'icon-custom' && isItemUnlocked('icon-custom'));

      customIconUploadGroup.style.display = isCustomIconSelected ? 'flex' : 'none';
      iconColorAndSizeGroup.style.display = (iconType !== 'none' && !isCustomIconSelected) ? 'flex' : 'none';
      iconSizeGroup.style.display = (iconType !== 'none') ? 'flex' : 'none';


      if (isCustomIconSelected) {
          if (customIconBase64) {
              const img = document.createElement('img');
              img.src = customIconBase64;
              img.style.height = `${currentIconPxHeight}px`;
              img.style.width = 'auto';
              channelIconsContainer.appendChild(img);
          }
      } else if (storeIcon && isItemUnlocked(storeIcon.id)) {
          if (storeIcon.value.startsWith('data:image/svg+xml')) {
              const img = document.createElement('img');
              img.src = storeIcon.value;
              img.style.height = `${currentIconPxHeight}px`;
              img.style.width = 'auto';
              img.style.filter = `invert(100%) saturate(100%) hue-rotate(90deg) brightness(1.5) contrast(1.5)`;
              channelIconsContainer.appendChild(img);
          } else {
              let iconChar = '';
              switch (storeIcon.value) {
                  case 'square': iconChar = '■'; break;
                  case 'circle': iconChar = '●'; break;
                  case 'triangle': iconChar = '▲'; break;
                  case 'star': iconChar = '★'; break;
                  case 'broadcast': iconChar = '📡'; break;
              }
              const span = document.createElement('span');
              span.style.color = iconColor;
              span.style.fontSize = `${currentIconPxHeight}px`;
              span.textContent = iconChar;
              channelIconsContainer.appendChild(span);
          }
      }

      iconSizeValueDisplay.textContent = `${currentIconPxHeight.toFixed(0)}px`;

      redBanner.style.justifyContent = iconPositionSelect.value;
      if (iconPositionSelect.value === 'flex-start') {
          channelIconsContainer.style.order = 1;
          mainText.style.order = 2;
      } else if (iconPositionSelect.value === 'flex-end') {
          channelIconsContainer.style.order = 2;
          mainText.style.order = 1;
      } else {
          channelIconsContainer.style.order = 1;
          mainText.style.order = 2;
      }

      if (channelIconsContainer.children.length > 0) {
          mainText.style.width = 'auto';
          mainText.style.flexShrink = '1';
          mainText.style.flexGrow = '1';
      } else {
          mainText.style.width = '100%';
          mainText.style.flexShrink = '0';
          mainText.style.flexGrow = '0';
      }
      saveGameProgress(); // Save icon settings
  }


  function updateText() {
    let currentRawText = newTextInput.value;

    const currentChars = currentRawText.length;
    const currentWords = currentRawText.split(/\s+/).filter(word => word.length > 0).length;

    if (currentChars > maxCharLength) {
        currentRawText = currentRawText.substring(0, maxCharLength);
        newTextInput.value = currentRawText;
    }

    const remainingChars = maxCharLength - currentRawText.length;
    charCountDisplay.textContent = `الأحرف: ${currentRawText.length} / ${maxCharLength}`;
    wordCountDisplay.textContent = `الكلمات: ${currentWords}`;

    charCountDisplay.classList.remove('warning', 'danger');
    if (remainingChars <= 15 && remainingChars > 0) {
        charCountDisplay.classList.add('warning');
    } else if (remainingChars <= 0) {
        charCountDisplay.classList.add('danger');
        charCountDisplay.textContent = `لقد تجاوزت الحد الأقصى للأحرف!`;
    }

    mainText.innerHTML = currentRawText;
    updateIcons();
    saveGameProgress();
  }


  // --- معالجات الأحداث (Event Listeners) ---

  fontSelect.addEventListener('change', function() {
      applyCurrentFont();
      updateIcons(); // استدعاء تحديث الأيقونات عند تغيير الخط
      saveGameProgress();
  });

  fontSizeInput.addEventListener('input', function() {
      mainText.style.fontSize = this.value + 'em';
      fontSizeValueDisplay.textContent = this.value + 'em';
      updateIcons(); // استدعاء تحديث الأيقونات عند تغيير حجم الخط
      saveGameProgress();
  });

  textColorInput.addEventListener('input', function() {
      mainText.style.color = this.value;
      saveGameProgress();
  });

  redBannerColorInput.addEventListener('input', function() {
      applyCurrentBannerStyle(); // ستقوم هذه الدالة بتطبيق اللون الأحمر إذا كان النمط الافتراضي هو المحدد
      saveGameProgress();
  });

  textShadowToggle.addEventListener('change', function() {
      applyCurrentTextEffect(); // سيتم تطبيق الظل أو إزالته كجزء من تأثيرات النص
      saveGameProgress();
  });

  // مستمعات الأحداث للأيقونات
  iconTypeSelect.addEventListener('change', updateIcons);
  iconColorInput.addEventListener('input', updateIcons);
  iconSizeInput.addEventListener('input', updateIcons);
  iconPositionSelect.addEventListener('change', updateIcons);

  // معالج تحميل الأيقونة المخصصة
  customIconUploadInput.addEventListener('change', function(event) {
      const file = event.target.files && event.target.files.length > 0 ? event.target.files[0] : null;
      if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
              customIconBase64 = e.target.result;
              updateIcons();
              saveGameProgress();
          };
          reader.readAsDataURL(file);
      } else {
          customIconBase64 = null;
          updateIcons();
          saveGameProgress();
      }
  });

  // معالج زر إزالة الأيقونة المخصصة
  removeCustomIconButton.addEventListener('click', function() {
      customIconBase64 = null;
      customIconUploadInput.value = '';
      iconTypeSelect.value = 'none';
      updateIcons();
      saveGameProgress();
  });


  imageUploadInput.addEventListener('change', function(event) {
    const file = event.target.files && event.target.files.length > 0 ? event.target.files [0] : null;

    if (file) {
      const reader = new FileReader();

      reader.onload = function(e) {
        mainImage.src = e.target.result;
        saveGameProgress();
      };

      reader.readAsDataURL(file);
    } else {
      mainImage.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";
      saveGameProgress();
    }
  });

  newTextInput.addEventListener('input', updateText);

  // مستمعات الأحداث (الخاصة بالشريط الأحمر)
  bannerHeightInput.addEventListener('input', function() {
      redBanner.style.minHeight = `${this.value}px`;
      bannerHeightValueDisplay.textContent = `${this.value}px`;
      saveGameProgress();
  });

  textPaddingInput.addEventListener('input', function() {
      redBanner.style.padding = `${this.value}px 25px`;
      textPaddingValueDisplay.textContent = `${this.value}px`;
      saveGameProgress();
  });

  bannerStyleSelect.addEventListener('change', function() {
      selectedBannerStyle = this.value;
      applyCurrentBannerStyle();
      saveGameProgress();
  });

  textEffectSelect.addEventListener('change', function() {
      selectedTextEffect = this.value;
      applyCurrentTextEffect();
      saveGameProgress();
  });


  // تحديث معالجات أزرار تحميل الملف لتشمل الأيقونة المخصصة
  document.querySelectorAll('.file-input-wrapper .file-input-button').forEach(button => {
    button.addEventListener('click', function() {
      this.parentNode.querySelector('input[type="file"]').click();
    });
  });


  tabButtons.forEach(button => {
      button.addEventListener('click', () => {
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));

          const targetTab = button.dataset.tab;
          document.getElementById(`${targetTab}TabContent`).classList.add('active');
          button.classList.add('active');

          if (targetTab === 'store') {
            renderStore(); // إعادة عرض المتجر عند التبديل إليه
          }
      });
  });

  // دالة لالتقاط وعرض الصورة وتحميلها
  function captureAndProcessImage() {
    const container = document.querySelector('.container');

    if (typeof html2canvas === 'undefined') {
      showNotification('تعذر عرض الصورة. مكتبة العرض غير متوفرة.', 'error');
      return;
    }

    viewScreenshotBtn.disabled = true;
    viewScreenshotBtn.textContent = 'جاري التحضير...';

    html2canvas(container, {
      allowTaint: true,
      useCORS: true,
      backgroundColor: null,
      scale: 3
    }).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const newWindow = window.open();
      newWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>صورة الخبر جاهزة للقطة الشاشة</title>
          <style>
            body {
              margin: 0;
              display: flex;
              flex-direction: column;
              justify-content: center;
              align-items: center;
              min-height: 100vh;
              background-color: #1A1A2E;
              padding: 20px;
              box-sizing: border-box;
              overflow: auto;
              color: white;
              font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            }
            img {
              display: block;
              max-width: 95vw;
              max-height: 80vh; /* مساحة لزر التحميل */
              object-fit: contain;
              box-shadow: 0 0 15px rgba(0,0,0,0.5);
              border-radius: 0;
              margin-bottom: 20px;
            }
            .download-btn {
              background-color: #28a745;
              color: white;
              padding: 15px 30px;
              border: none;
              border-radius: 10px;
              cursor: pointer;
              font-size: 1.1em;
              font-weight: bold;
              text-decoration: none;
              display: inline-flex;
              align-items: center;
              gap: 10px;
            }
            .download-btn:hover {
              background-color: #218838;
            }
          </style>
        </head>
        <body>
          <img src="${imgData}" alt="صورة الخبر">
          <a href="${imgData}" download="news_banner_${new Date().getTime()}.png" class="download-btn">
            ⬇️ تحميل الصورة
          </a>
        </body>
        </html>
      `);
      newWindow.document.close();
      showNotification('تم عرض الصورة في نافذة جديدة (مع خيار التحميل).', 'info');
      
      viewScreenshotBtn.disabled = false;
      viewScreenshotBtn.innerHTML = '<span class="icon">📸</span> عرض لقطة الشاشة';

    }).catch(error => {
      console.error('حدث خطأ أثناء إنشاء الصورة في Canvas:', error);
      showNotification('تعذر عرض الصورة. يرجى التأكد من تحميل صورة من جهازك وعدم وجود مشاكل.', 'error');
      viewScreenshotBtn.disabled = false;
      viewScreenshotBtn.innerHTML = '<span class="icon">📸</span> عرض لقطة الشاشة';
    });
  }

  viewScreenshotBtn.addEventListener('click', () => captureAndProcessImage());


  // --- التهيئة عند تحميل الصفحة ---
  function initializeApp() {
    loadGameProgress(); // تحميل حالة اللعبة المحفوظة

    newTextInput.value = localStorage.getItem('newText') || defaultText;
    mainText.innerHTML = newTextInput.value;

    textColorInput.value = localStorage.getItem('textColorValue') || "#ffffff";
    mainText.style.color = textColorInput.value;

    redBannerColorInput.value = localStorage.getItem('redBannerColorValue') || "#F44336"; // لون أحمر جديد
    bannerHeightInput.value = localStorage.getItem('bannerHeightValue') || "75";
    textPaddingInput.value = localStorage.getItem('textPaddingValue') || "25";
    textShadowToggle.checked = (localStorage.getItem('textShadowToggleChecked') === 'true');


    // تطبيق القيم التي تم تحميلها
    mainImage.src = localStorage.getItem('mainImageSrc') || "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";
    mainText.style.fontSize = fontSizeInput.value + 'em';
    fontSizeValueDisplay.textContent = fontSizeInput.value + 'em';
    redBanner.style.minHeight = `${bannerHeightInput.value}px`;
    bannerHeightValueDisplay.textContent = `${bannerHeightInput.value}px`;
    redBanner.style.padding = `${textPaddingInput.value}px 25px`;
    textPaddingValueDisplay.textContent = `${textPaddingInput.value}px`;

    // تأكد من أن خيارات القوائم المنسدلة موجودة أولاً
    updateAvailableOptions();

    // تطبيق القيم المختارة من القوائم المنسدلة بعد تحديث الخيارات
    fontSelect.value = localStorage.getItem('fontSelectValue') || 'system-ui';
    iconTypeSelect.value = localStorage.getItem('iconTypeSelectValue') || 'none';
    bannerStyleSelect.value = localStorage.getItem('selectedBannerStyle') || 'default_red';
    textEffectSelect.value = localStorage.getItem('selectedTextEffect') || 'none';
    iconPositionSelect.value = localStorage.getItem('iconPositionValue') || 'center';


    // تطبيق الأنماط الفعلية بناءً على القيم المحملة
    applyCurrentFont();
    applyCurrentBannerStyle();
    applyCurrentTextEffect();
    updateIcons(); // هذا سيقوم أيضًا بتحديث أحجام الأيقونات وموضعها

    updateText(); // تهيئة عدادات النص
    updatePlayerStatsDisplay(); // تحديث عرض النقاط والمستوى
    renderStore(); // عرض المتجر لأول مرة
  }

  initializeApp();

</script>

</body>
</html>
