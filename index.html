<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق جوال</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            direction: rtl;
            background: #1a202c;
            background-image: radial-gradient(circle at center, rgba(100, 116, 139, 0.1) 0%, transparent 70%);
            background-size: 300% 300%;
            animation: moveGradient 15s ease infinite alternate;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        @keyframes moveGradient {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }
        .menu-item {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }
        .view {
            transition: transform 0.3s ease-in-out;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            padding: 1.5rem;
        }
        .view-content {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 1rem;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            position: fixed;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.hidden {
            display: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #6366f1;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #6366f1;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3);
        }
        .popup-content {
            background: linear-gradient(135deg, #2d3748, #1a202c);
            border: 2px solid #4a5568;
            border-radius: 1.5rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            padding: 2.5rem;
            animation: fadeInScale 0.3s ease-out forwards;
        }
        @keyframes fadeInScale {
            from {
                transform: scale(0.9) translateY(20px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        .popup-number {
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
        }
        .message-modal-content {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            border: 2px solid #6366f1;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            padding: 2rem;
            animation: fadeInScale 0.3s ease-out forwards;
        }
        .store-item {
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #2d3748;
            border-radius: 1.5rem;
            padding: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .store-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.3);
        }
        .buy-button {
            background: #4a5568;
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: background 0.2s ease-in-out;
        }
        .buy-button:hover {
            background: #6366f1;
        }
        .house-container {
            position: relative;
            width: 8rem;
            height: 8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border-radius: 0.75rem;
            background: transparent;
            color: #fff;
            border: 0px solid transparent;
        }
        .house-container.locked-house {
            opacity: 0.5;
            filter: grayscale(100%);
        }
        .house-container img {
            width: 5rem;
            height: 5rem;
            object-fit: contain;
            margin-bottom: 0.25rem;
        }
        @keyframes glowing-border {
            0% { border-color: #FFD700; box-shadow: 0 0 10px #FFD700; }
            50% { border-color: #FFEA00; box-shadow: 0 0 20px #FFEA00; }
            100% { border-color: #FFD700; box-shadow: 0 0 10px #FFD700; }
        }
        @keyframes subtle-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .house-container.active-house {
            border: 2px solid;
            animation: glowing-border 2s infinite alternate, subtle-bounce 2s infinite ease-in-out;
        }
        .timer-digit-animation {
            display: inline-block;
            animation: digitFadeIn 0.5s ease-out;
        }
        @keyframes digitFadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #innovation-button {
            border-radius: 1.5rem;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease-in-out;
            font-size: 1rem;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 120px;
        }
        #innovation-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4);
        }
        #innovation-button:disabled {
            background: #4a5568;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #innovation-button-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.2;
        }
        #innovation-button-text .price-display {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            margin-top: 0.25rem;
        }
        .task-item {
            background: #2d3748;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: right;
            position: relative;
        }
        .task-progress-bar {
            height: 6px;
            background-color: #4a5568;
            border-radius: 3px;
            margin-top: 0.5rem;
        }
        .task-progress-fill {
            height: 100%;
            background-color: #6366f1;
            border-radius: 3px;
            transition: width 0.5s ease-in-out;
        }
        .task-completed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: #4CAF50;
            backdrop-filter: blur(3px);
        }
        #toast-notification {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s ease-out;
            z-index: 1000;
            text-align: center;
            white-space: nowrap;
        }
        #toast-notification.info {
            background-color: rgba(33, 150, 243, 0.9);
        }
        #tasks-modal .modal-content-inner {
            max-height: 80vh;
            overflow-y: auto;
            padding-right: 1rem;
        }
        #tasks-modal .bg-gray-700 {
            max-width: 320px;
            padding: 1.5rem;
        }
        #player-name-display {
            cursor: default;
            color: #f9fafb;
            text-decoration: none;
            font-weight: bold;
            transition: none;
        }
        #player-name-display:hover {
            color: #f9fafb;
        }
        .locked-menu-item {
            position: relative;
            opacity: 0.6;
            cursor: not-allowed;
        }
        .locked-menu-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .locked-menu-item .lock-icon {
            position: absolute;
            z-index: 10;
            color: white;
            font-size: 2rem;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .locked-menu-item .lock-text {
            position: absolute;
            z-index: 10;
            color: white;
            font-size: 0.875rem;
            bottom: 0.5rem;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }
        .icon-lg {
            height: 2.25rem;
            width: 2.25rem;
        }
        .reward-animation-text {
            display: inline-block;
            animation: digitFadeIn 0.5s ease-out;
        }
        #level-up-toast {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background-color: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            z-index: 1000;
            text-align: center;
            white-space: nowrap;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 200px;
        }
        #level-up-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        #level-up-toast .level-message {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        #level-up-toast .rewards-text {
            font-size: 0.9rem;
        }
        #level-up-toast .rewards-text span {
            font-weight: bold;
        }
        .quantity-input-container {
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        .quantity-input-container .quantity-buttons-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .quantity-input-container input[type="number"] {
            -moz-appearance: textfield;
            text-align: center;
            background-color: #2d3748;
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem;
            width: 4rem;
            border: none;
        }
        .quantity-input-container input[type="number"]::-webkit-inner-spin-button,
        .quantity-input-container input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .quantity-button {
            background-color: #4a5568;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .quantity-button:hover:not(:disabled) {
            background-color: #6366f1;
        }
        .quantity-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .royal-name {
            background: linear-gradient(90deg, #FFD700, #FFEA00, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: royalGlow 3s infinite alternate, royalSlide 5s infinite linear;
            display: inline-block;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
        }
        @keyframes royalGlow {
            0% { text-shadow: 0 0 8px rgba(255, 215, 0, 0.7); }
            50% { text-shadow: 0 0 15px rgba(255, 234, 0, 0.9); }
            100% { text-shadow: 0 0 8px rgba(255, 215, 0, 0.7); }
        }
        @keyframes royalSlide {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }
        /* Chat specific styles */
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* New messages at bottom */
            padding-bottom: 1rem;
        }
        .chat-message {
            background-color: #2d3748;
            padding: 0.75rem;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
            max-width: 90%;
            align-self: flex-start;
        }
        .chat-message.self {
            background-color: #4a5568;
            align-self: flex-end;
        }
        .chat-sender {
            font-weight: bold;
            color: #6366f1;
            margin-bottom: 0.25rem;
            display: block;
        }
        .chat-timestamp {
            font-size: 0.75rem;
            color: #a0aec0;
            text-align: left;
            margin-top: 0.25rem;
        }
        #chat-input-container {
            display: flex;
            padding-top: 1rem;
            gap: 0.5rem;
        }
        #chat-input {
            flex-grow: 1;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 0.75rem;
            padding: 0.75rem;
            color: white;
            outline: none;
        }
        #chat-send-button {
            background-color: #6366f1;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }
        #chat-send-button:hover {
            background-color: #5a5fe0;
        }
        /* Online users list */
        .online-user-item {
            background-color: #2d3748;
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .online-user-item .user-info {
            text-align: right;
        }
        .online-user-item .status-dot {
            width: 10px;
            height: 10px;
            background-color: #4CAF50; /* Green for online */
            border-radius: 50%;
            margin-left: 0.5rem;
        }
        /* Challenge players list */
        .challenge-player-item {
            background-color: #2d3748;
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .challenge-player-item .attack-button {
            background-color: #ef4444; /* Red for attack */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            transition: background-color 0.2s;
        }
        .challenge-player-item .attack-button:hover:not(:disabled) {
            background-color: #dc2626;
        }
        .challenge-player-item .attack-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body oncontextmenu="return false;" ondragstart="return false;">
    <div class="w-full max-w-md mx-auto h-screen relative overflow-hidden rounded-3xl shadow-2xl bg-gray-800">
        <div id="main-menu-view" class="view transform translate-x-0">
            <div id="updates-icon" class="absolute top-4 right-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon-lg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div id="tasks-icon" class="absolute top-4 left-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon-lg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
            </div>

            <div class="bg-gray-700 p-4 rounded-xl mb-6 shadow-md text-center">
                <h2 class="text-xl font-bold text-gray-100 mb-3" id="player-name-display">تعيين اسم</h2>
                <div class="flex items-center justify-center gap-x-8 mb-3">
                    <div class="flex items-center text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm.5 4.75a.75.75 0 00-1.5 0v.625H9.75a.75.75 0 000 1.5h1.25v.625a.75.75 0 001.5 0v-.625h1.25a.75.75 0 000-1.5h-1.25V7a.75.75 0 00-.75-.75zM12 18a.75.75 0 00.75-.75v-1.5a.75.75 0 00-1.5 0v1.5c0 .414.336.75.75.75zM12 13.5a.75.75 0 00.75-.75V9.75a.75.75 0 00-1.5 0v3c0 .414.336.75.75.75z" clip-rule="evenodd" />
                        </svg>
                        <span class="text-base" id="player-points-display">0</span>
                    </div>
                    <div class="flex items-center text-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V3m0 9v3m0 3.545c-1.472 0-2.688-.475-3.463-1.249A3.987 3.987 0 018 18a4 4 0 00-4 4h16c0-2.209-1.791-4-4-4a4 4 0 01-3.463-1.249C14.688 17.07 13.472 16.545 12 16.545z" />
                        </svg>
                        <span class="text-base" id="player-dollars-display">$0</span>
                    </div>
                </div>
                <div class="flex flex-col items-center text-gray-200 mt-3">
                    <div class="flex items-center mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <span class="text-base">XP: <span id="player-xp-display">0</span> (Lv.<span id="player-level-display">0</span>)</span>
                        <svg id="level-info-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-gray-400 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="w-full bg-gray-600 rounded-full h-2.5">
                        <div id="xp-progress-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%;"></div>
                    </div>
                    <span id="xp-remaining-display" class="text-xs text-gray-400 mt-1">المتبقي للمستوى التالي: 100 XP</span>
                </div>
            </div>

            <h1 class="text-3xl font-bold text-center text-gray-100 mb-8">القائمة الرئيسية</h1>
            <div class="grid grid-cols-2 gap-6 view-content">
                <div id="chat-menu-item" class="menu-item bg-gradient-to-br from-purple-600 to-indigo-700 text-white p-6 rounded-2xl flex flex-col items-center justify-center text-center shadow-lg cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                    </svg>
                    <span class="text-lg font-semibold">دردش</span>
                </div>
                <div id="play-menu-item" class="menu-item bg-gradient-to-br from-green-600 to-teal-700 text-white p-6 rounded-2xl flex flex-col items-center justify-center text-center shadow-lg cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17.25L15 12l-5.25-5.25M12 21a9 9 0 110-18 9 9 0 010 18z" />
                    </svg>
                    <span class="text-lg font-semibold">العب</span>
                </div>
                <div id="settings-menu-item" class="menu-item bg-gradient-to-br from-orange-600 to-red-700 text-white p-6 rounded-2xl flex flex-col items-center justify-center text-center shadow-lg cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.262 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="text-lg font-semibold">إعدادات</span>
                </div>
                <div id="store-menu-item" class="menu-item bg-gradient-to-br from-blue-600 to-cyan-700 text-white p-6 rounded-2xl flex flex-col items-center justify-center text-center shadow-lg cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                    </svg>
                    <span class="text-lg font-semibold">متجر</span>
                </div>
                <div id="online-menu-item" class="menu-item bg-gradient-to-br from-yellow-600 to-amber-700 text-white p-6 rounded-2xl flex flex-col items-center justify-center text-center shadow-lg cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span class="text-lg font-semibold">اونلاين</span>
                </div>
                <div id="challenge-menu-item" class="menu-item bg-gradient-to-br from-gray-600 to-gray-700 text-white p-6 rounded-2xl flex flex-col items-center justify-center text-center shadow-lg cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h2v-2a3 3 0 00-3-3H8a3 3 0 00-3 3v2H3m10-9a4 4 0 11-8 0 4 4 0 018 0zM7 10h.01M12 12h.01M17 12h.01M12 15h.01M12 18h.01M12 21h.01" />
                    </svg>
                    <span class="text-lg font-semibold">تحدي اللاعبون</span>
                    <div class="lock-icon absolute hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v3.06M16 17H8" />
                        </svg>
                    </div>
                    <span class="lock-text absolute hidden text-xs">يتطلب المستوى 10</span>
                </div>
            </div>
        </div>

        <div id="settings-view" class="view transform translate-x-full">
            <div id="back-to-main-from-settings" class="absolute top-4 left-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-center text-gray-100 mb-8">الإعدادات</h1>

            <div class="view-content">
                <div class="bg-gray-700 p-6 rounded-xl mb-6 shadow-md">
                    <h2 class="text-xl font-semibold text-gray-100 mb-4">صوت الموسيقى</h2>
                    <div class="flex items-center justify-between">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.12 2-2.5 2S4 20.105 4 19V6c0-1.105 1.12-2 2.5-2S9 4.895 9 6v13zm12-3c0 1.105-1.12 2-2.5 2s-2.5-.895-2.5-2V3c0-1.105 1.12-2 2.5-2s2.5.895 2.5 2v13z" />
                        </svg>
                        <input type="range" id="music-volume-slider" min="0" max="100" value="75" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                        <span id="music-volume-value" class="text-gray-200 ml-4 w-12 text-right">75%</span>
                    </div>
                </div>
                <button id="delete-account-button" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out mt-8 w-full">
                    حذف الحساب
                </button>
            </div>
        </div>

        <div id="game-view" class="view transform translate-x-full">
            <div id="back-to-main-from-game" class="absolute top-4 left-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-center text-gray-100 mb-8">العب</h1>

            <div id="game-info-icon" class="absolute top-4 right-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>

            <div id="inventory-icon" class="absolute top-4 left-12 text-gray-400 hover:text-gray-200 cursor-pointer flex items-center p-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon-lg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4m0-10h.01M12 12h.01" />
                </svg>
                <span id="inventory-count" class="bg-red-500 text-white text-xs font-bold rounded-full px-2 py-0.5 -mt-2 -mr-2">0</span>
            </div>

            <div class="flex items-center justify-center mb-6">
                <button id="innovation-prev-button" class="text-gray-400 hover:text-gray-200 p-2 rounded-full transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <button id="innovation-button" class="text-white font-bold flex items-center mx-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17H21l-9-15-9 15h11.337z" />
                    </svg>
                    <span id="innovation-button-text">
                        <span>تفعيل الابتكار</span>
                        <span class="price-display">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V3m0 9v3m0 3.545c-1.472 0-2.688-.475-3.463-1.249A3.987 3.987 0 018 18a4 4 0 00-4 4h16c0-2.209-1.791-4-4-4a4 4 0 01-3.463-1.249C14.688 17.07 13.472 16.545 12 16.545z" />
                            </svg>
                            <span>مجاني</span>
                        </span>
                    </span>
                </button>
                <button id="innovation-next-button" class="text-gray-400 hover:text-gray-200 p-2 rounded-full transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
            <div id="innovation-timer" class="text-gray-300 text-lg text-center mb-6 hidden">
                الوقت المتبقي: <span id="timer-display-value">5:00</span>
            </div>

            <div id="next-house-info" class="text-gray-300 text-center text-base mb-6 hidden">
            </div>

            <div id="houses-container" class="grid grid-cols-2 gap-4 justify-items-center view-content">
            </div>
        </div>

        <div id="store-view" class="view transform translate-x-full">
            <div id="back-to-main-from-store" class="absolute top-4 left-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-center text-gray-100 mb-8">المتجر</h1>

            <div class="flex items-center justify-center gap-x-8 mb-6 bg-gray-700 p-3 rounded-xl shadow-md">
                <div class="flex items-center text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm.5 4.75a.75.75 0 00-1.5 0v.625H9.75a.75.75 0 000 1.5h1.25v.625a.75.75 0 001.5 0v-.625h1.25a.75.75 0 000-1.5h-1.25V7a.75.75 0 00-.75-.75zM12 18a.75.75 0 00.75-.75v-1.5a.75.75 0 00-1.5 0v1.5c0 .414.336.75.75.75zM12 13.5a.75.75 0 00.75-.75V9.75a.75.75 0 00-1.5 0v3c0 .414.336.75.75.75z" clip-rule="evenodd" />
                        </svg>
                    <span class="text-base" id="store-player-points-display">0</span>
                </div>
                <div class="flex items-center text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V3m0 9v3m0 3.545c-1.472 0-2.688-.475-3.463-1.249A3.987 3.987 0 018 18a4 4 0 00-4 4h16c0-2.209-1.791-4-4-4a4 4 0 01-3.463-1.249C14.688 17.07 13.472 16.545 12 16.545z" />
                        </svg>
                    <span class="text-base" id="store-player-dollars-display">$0</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6 view-content">
                <div id="store-item-reduce-time" class="store-item">
                    <img src="https://f.top4top.io/p_3479ijdcl0.png" alt="Reduce Time" class="h-16 w-16 mb-2 object-contain">
                    <span class="text-lg font-semibold text-white">تقليل وقت الابتكار</span>
                    <span class="text-sm text-gray-300 mt-1">يقلل دقيقتين</span>
                    <button class="buy-button mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V3m0 9v3m0 3.545c-1.472 0-2.688-.475-3.463-1.249A3.987 3.987 0 018 18a4 4 0 00-4 4h16c0-2.209-1.791-4-4-4a4 4 0 01-3.463-1.249C14.688 17.07 13.472 16.545 12 16.545z" />
                        </svg>
                        <span>200</span>
                    </button>
                </div>
                <div id="store-item-convert-points" class="store-item">
                    <img src="https://i.top4top.io/s_34795cyi20.png" alt="Convert Points" class="h-16 w-16 mb-2 object-contain">
                    <span class="text-lg font-semibold text-white">تحويل النقاط</span>
                    <span class="text-sm text-gray-300 mt-1">يحول النقاط إلى دولارات</span>
                    <button class="buy-button mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm.5 4.75a.75.75 0 00-1.5 0v.625H9.75a.75.75 0 000 1.5h1.25v.625a.75.75 0 001.5 0v-.625h1.25a.75.75 0 000-1.5h-1.25V7a.75.75 0 00-.75-.75zM12 18a.75.75 0 00.75-.75v-1.5a.75.75 0 00-1.5 0v1.5c0 .414.336.75.75.75zM12 13.5a.75.75 0 00.75-.75V9.75a.75.75 0 00-1.5 0v3c0 .414.336.75.75.75z" clip-rule="evenodd" />
                        </svg>
                        <span>500</span>
                    </button>
                </div>
                <div id="store-item-buy-innovation3" class="store-item">
                    <img src="https://f.top4top.io/s_34796x9520.png" alt="Buy Innovation 3" class="h-16 w-16 mb-2 object-contain">
                    <span class="text-lg font-semibold text-white">شراء ابتكار ثالث</span>
                    <span class="text-sm text-gray-300 mt-1">يفتح ابتكارًا جديدًا</span>
                    <button class="buy-button mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm.5 4.75a.75.75 0 00-1.5 0v.625H9.75a.75.75 0 000 1.5h1.25v.625a.75.75 0 001.5 0v-.625h1.25a.75.75 0 000-1.5h-1.25V7a.75.75 0 00-.75-.75zM12 18a.75.75 0 00.75-.75v-1.5a.75.75 0 00-1.5 0v1.5c0 .414.336.75.75.75zM12 13.5a.75.75 0 00.75-.75V9.75a.75.75 0 00-1.5 0v3c0 .414.336.75.75.75z" clip-rule="evenodd" />
                        </svg>
                        <span>3000</span>
                    </button>
                </div>
                <div id="store-item-royal-name" class="store-item">
                    <img src="https://placehold.co/100x100/FFD700/000000?text=👑" alt="Royal Name" class="h-16 w-16 mb-2 object-contain">
                    <span class="text-lg font-semibold text-white">اسم ملكي</span>
                    <span class="text-sm text-gray-300 mt-1">يجعل اسمك ذهبي متحرك</span>
                    <button class="buy-button mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V3m0 9v3m0 3.545c-1.472 0-2.688-.475-3.463-1.249A3.987 3.987 0 018 18a4 4 0 00-4 4h16c0-2.209-1.791-4-4-4a4 4 0 01-3.463-1.249C14.688 17.07 13.472 16.545 12 16.545z" />
                        </svg>
                        <span>2000</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="challenge-view" class="view transform translate-x-full">
            <div id="back-to-main-from-challenge" class="absolute top-4 left-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-center text-gray-100 mb-8">تحدي اللاعبون</h1>
            <div id="challenge-players-list" class="view-content flex flex-col gap-4">
                <!-- Players will be listed here -->
            </div>
        </div>

        <div id="chat-view" class="view transform translate-x-full">
            <div id="back-to-main-from-chat" class="absolute top-4 left-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-center text-gray-100 mb-8">دردش</h1>
            <div id="chat-messages" class="view-content flex flex-col-reverse">
                <!-- Chat messages will be loaded here -->
            </div>
            <div id="chat-input-container" class="flex p-4 bg-gray-800 rounded-b-3xl">
                <input type="text" id="chat-input" placeholder="اكتب رسالتك..." class="flex-grow p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="chat-send-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out">
                    إرسال
                </button>
            </div>
        </div>

        <div id="online-view" class="view transform translate-x-full">
            <div id="back-to-main-from-online" class="absolute top-4 left-4 text-gray-400 hover:text-gray-200 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-center text-gray-100 mb-8">اونلاين</h1>
            <div id="online-users-list" class="view-content flex flex-col gap-4">
                <!-- Online users will be listed here -->
            </div>
        </div>
    </div>

    <div id="popup-modal" class="modal-overlay hidden">
        <div class="popup-content text-center max-w-sm w-full transform scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">تم الترقية!</h3>
            <p class="text-gray-200 text-lg mb-2">القوة المرتفعة: <span id="power-increase-display" class="popup-number text-yellow-300"></span></p>
            <p class="text-gray-200 text-lg mb-6">القوة الإجمالية: <span id="total-power-display" class="popup-number text-green-300"></span></p>
            <button id="popup-close-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                حسناً
            </button>
        </div>
    </div>

    <div id="level-up-toast">
        <div class="level-message">تم رفع المستوى إلى: <span id="current-level-display" class="reward-animation-text text-blue-300"></span></div>
        <div class="rewards-text">
            <span class="reward-animation-text text-yellow-300" id="level-points-reward"></span> نقطة,
            <span class="reward-animation-text text-green-300" id="level-dollars-reward"></span>$
        </div>
    </div>

    <div id="house-info-modal" class="modal-overlay hidden">
        <div class="bg-gray-700 p-8 rounded-xl shadow-2xl text-center max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300 ease-out">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">معلومات البيت والترقيات</h3>
            <div class="text-gray-200 text-lg mb-6 text-right">
                <p class="font-bold mb-2">جوائز ترقية البيت:</p>
                <ul id="house-upgrade-rewards-list" class="list-none p-0 m-0">
                </ul>
            </div>
            <button id="house-info-close-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                حسناً
            </button>
        </div>
    </div>

    <div id="message-modal" class="modal-overlay hidden">
        <div class="message-modal-content text-center max-w-sm w-full transform scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-gray-100 mb-4" id="message-modal-title"></h3>
            <p class="text-gray-200 text-lg mb-6" id="message-modal-text"></p>
            <button id="message-modal-close-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                حسناً
            </button>
        </div>
    </div>

    <div id="store-detail-modal" class="modal-overlay hidden">
        <div class="bg-gray-700 p-8 rounded-xl shadow-2xl text-center max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300 ease-out">
            <img id="store-detail-image" src="" alt="Item Image" class="h-24 w-24 object-contain mx-auto mb-4">
            <h3 id="store-detail-title" class="text-2xl font-bold text-gray-100 mb-2"></h3>
            <p id="store-detail-description" class="text-gray-300 text-base mb-4"></p>
            
            <div id="quantity-selection" class="flex items-center justify-center gap-4 mb-6">
                <button id="store-detail-quantity-minus" class="quantity-button">-</button>
                <span id="store-detail-quantity-display" class="text-white text-lg font-bold">1</span>
                <button id="store-detail-quantity-plus" class="quantity-button">+</button>
            </div>
            <p class="text-gray-200 text-lg mb-6">التكلفة الإجمالية: <span class="text-green-400 font-bold" id="store-detail-total-cost"></span></p>

            <div class="flex justify-center gap-4">
                <button id="store-detail-confirm-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                    تأكيد الشراء
                </button>
                <button id="store-detail-cancel-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <div id="inventory-modal" class="modal-overlay hidden">
        <div class="bg-gray-700 p-8 rounded-xl shadow-2xl text-center max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300 ease-out">
            <h3 class="text-2xl font-bold text-gray-100 mb-6">حقيبتي</h3>
            <div id="inventory-items-list" class="flex flex-col gap-4">
            </div>
            <button id="inventory-close-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out mt-6">
                إغلاق
            </button>
        </div>
    </div>

    <div id="tasks-modal" class="modal-overlay hidden">
        <div class="bg-gray-700 p-8 rounded-xl shadow-2xl text-center w-full transform scale-95 opacity-0 transition-all duration-300 ease-out" style="max-width: 320px;">
            <h3 class="text-2xl font-bold text-gray-100 mb-6">المهام</h3>
            <div class="modal-content-inner text-right">
                <h4 class="text-xl font-semibold text-gray-200 mb-3 flex justify-between items-center">
                    <span>مهام يومية</span>
                    <span id="daily-tasks-timer" class="text-sm text-gray-400"></span>
                </h4>
                <div id="daily-tasks-list" class="flex flex-col gap-3">
                </div>
                <h4 class="text-xl font-semibold text-gray-200 mt-6 mb-3">مهام لمرة واحدة</h4>
                <div id="one-time-tasks-list" class="flex flex-col gap-3">
                </div>
            </div>
            <button id="tasks-close-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out mt-6">
                إغلاق
            </button>
        </div>
    </div>

    <div id="updates-modal" class="modal-overlay hidden">
        <div class="bg-gray-700 p-8 rounded-xl shadow-2xl text-center max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300 ease-out">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">إضافات التحديث</h3>
            <p class="text-gray-200 text-lg mb-6">لا يوجد تحديث حالياً.</p>
            <button id="updates-close-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                حسناً
            </button>
        </div>
    </div>

    <div id="set-name-modal" class="modal-overlay hidden">
        <div class="bg-gray-700 p-8 rounded-xl shadow-2xl text-center max-w-sm w-full transform scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">تعيين اسم اللاعب</h3>
            <input type="text" id="player-name-input" class="w-full p-3 rounded-lg bg-gray-800 text-white placeholder-gray-400 mb-6 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="أدخل اسمك هنا..." maxlength="15">
            <div class="flex justify-center gap-4">
                <button id="set-name-confirm-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                    تأكيد
                </button>
                <button id="set-name-cancel-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal-overlay hidden">
        <div class="message-modal-content text-center max-w-sm w-full transform scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">تأكيد حذف الحساب</h3>
            <p class="text-gray-200 text-lg mb-6">هل أنت متأكد أنك تريد حذف حسابك؟ هذا الإجراء لا يمكن التراجع عنه.</p>
            <div class="flex justify-center gap-4">
                <button id="delete-confirm-yes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                    نعم، احذف
                </button>
                <button id="delete-confirm-no" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <div id="reset-countdown-modal" class="modal-overlay hidden">
        <div class="message-modal-content text-center max-w-sm w-full transform scale-95 opacity-0">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">جاري حذف الحساب...</h3>
            <p class="text-gray-200 text-lg mb-6">سيتم إعادة تشغيل التطبيق في <span id="countdown-display" class="text-yellow-400 font-bold text-3xl">10</span> ثوانٍ.</p>
        </div>
    </div>

    <div id="toast-notification" class="fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, remove, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgmDkMKcfMG3r_16t_6rcjZQJOUFVpVOo",
            authDomain: "kingb7ar-935b8.firebaseapp.com",
            databaseURL: "https://kingb7ar-935b8-default-rtdb.firebaseio.com",
            projectId: "kingb7ar-935b8",
            storageBucket: "kingb7ar-935b8.firebasestorage.app",
            messagingSenderId: "157617641483",
            appId: "1:157617641483:web:f8a0e51c1cd1bc4199cf0e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let userId = 'anonymous';
        let isFirebaseLoaded = false;
        let totalPlayerPower = 0; // Added for challenge feature

        const mainMenu = document.getElementById('main-menu-view');
        const settingsView = document.getElementById('settings-view');
        const gameView = document.getElementById('game-view');
        const storeView = document.getElementById('store-view');
        const challengeView = document.getElementById('challenge-view');
        const chatView = document.getElementById('chat-view');
        const onlineView = document.getElementById('online-view');

        const settingsMenuItem = document.getElementById('settings-menu-item');
        const playMenuItem = document.getElementById('play-menu-item');
        const storeMenuItem = document.getElementById('store-menu-item');
        const challengeMenuItem = document.getElementById('challenge-menu-item');
        const chatMenuItem = document.getElementById('chat-menu-item');
        const onlineMenuItem = document.getElementById('online-menu-item');

        const musicVolumeSlider = document.getElementById('music-volume-slider');
        const musicVolumeValue = document.getElementById('music-volume-value');

        const housesContainer = document.getElementById('houses-container');
        const innovationButton = document.getElementById('innovation-button');
        const innovationButtonText = document.getElementById('innovation-button-text');
        const innovationPrevButton = document.getElementById('innovation-prev-button');
        const innovationNextButton = document.getElementById('innovation-next-button');
        const innovationTimer = document.getElementById('innovation-timer');
        const timerDisplayValue = document.getElementById('timer-display-value');
        const nextHouseInfoDisplay = document.getElementById('next-house-info');
        const popupModal = document.getElementById('popup-modal');
        const powerIncreaseDisplay = document.getElementById('power-increase-display');
        const totalPowerDisplay = document.getElementById('total-power-display');
        const popupCloseButton = document.getElementById('popup-close-button');

        const levelInfoIcon = document.getElementById('level-info-icon');
        const levelUpToast = document.getElementById('level-up-toast');
        const currentLevelDisplay = document.getElementById('current-level-display');
        const levelPointsRewardDisplay = document.getElementById('level-points-reward');
        const levelDollarsRewardDisplay = document.getElementById('level-dollars-reward');

        const gameInfoIcon = document.getElementById('game-info-icon');
        const houseInfoModal = document.getElementById('house-info-modal');
        const houseUpgradeRewardsList = document.getElementById('house-upgrade-rewards-list');
        const houseInfoCloseButton = document.getElementById('house-info-close-button');

        const messageModal = document.getElementById('message-modal');
        const messageModalTitle = document.getElementById('message-modal-title');
        const messageModalText = document.getElementById('message-modal-text');
        const messageModalCloseButton = document.getElementById('message-modal-close-button');

        const storeItemReduceTime = document.getElementById('store-item-reduce-time');
        const storeItemConvertPoints = document.getElementById('store-item-convert-points');
        const storeItemBuyInnovation3 = document.getElementById('store-item-buy-innovation3');
        const storeItemRoyalName = document.getElementById('store-item-royal-name');

        const storeDetailModal = document.getElementById('store-detail-modal');
        const storeDetailImage = document.getElementById('store-detail-image');
        const storeDetailTitle = document.getElementById('store-detail-title');
        const storeDetailDescription = document.getElementById('store-detail-description');
        const storeDetailQuantityMinus = document.getElementById('store-detail-quantity-minus');
        const storeDetailQuantityDisplay = document.getElementById('store-detail-quantity-display');
        const storeDetailQuantityPlus = document.getElementById('store-detail-quantity-plus');
        const storeDetailTotalCost = document.getElementById('store-detail-total-cost');
        const storeDetailConfirmButton = document.getElementById('store-detail-confirm-button');
        const storeDetailCancelButton = document.getElementById('store-detail-cancel-button');

        const inventoryIcon = document.getElementById('inventory-icon');
        const inventoryCountDisplay = document.getElementById('inventory-count');
        const inventoryModal = document.getElementById('inventory-modal');
        const inventoryItemsList = document.getElementById('inventory-items-list');
        const inventoryCloseButton = document.getElementById('inventory-close-button');

        const tasksIcon = document.getElementById('tasks-icon');
        const tasksModal = document.getElementById('tasks-modal');
        const tasksCloseButton = document.getElementById('tasks-close-button');
        const dailyTasksList = document.getElementById('daily-tasks-list');
        const oneTimeTasksList = document.getElementById('one-time-tasks-list');
        const dailyTasksTimerDisplay = document.getElementById('daily-tasks-timer');

        const updatesIcon = document.getElementById('updates-icon');
        const updatesModal = document.getElementById('updates-modal');
        const updatesCloseButton = document.getElementById('updates-close-button');

        const playerNameDisplay = document.getElementById('player-name-display');
        const setNameModal = document.getElementById('set-name-modal');
        const playerNameInput = document.getElementById('player-name-input');
        const setNameConfirmButton = document.getElementById('set-name-confirm-button');
        const setNameCancelButton = document.getElementById('set-name-cancel-button');

        const deleteAccountButton = document.getElementById('delete-account-button');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteConfirmYes = document.getElementById('delete-confirm-yes');
        const deleteConfirmNo = document.getElementById('delete-confirm-no');
        const resetCountdownModal = document.getElementById('reset-countdown-modal');
        const countdownDisplay = document.getElementById('countdown-display');

        const storePlayerPointsDisplay = document.getElementById('store-player-points-display');
        const storePlayerDollarsDisplay = document.getElementById('store-player-dollars-display');

        const toastNotification = document.getElementById('toast-notification');

        // Chat elements
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send-button');

        // Online users elements
        const onlineUsersList = document.getElementById('online-users-list');

        // Challenge players elements
        const challengePlayersList = document.getElementById('challenge-players-list');

        let houses = [
            { id: 1, power: 1, unlocked: true, threshold: 5000, rewardedThresholds: [] },
            { id: 2, power: 1, unlocked: false, threshold: 5000, rewardedThresholds: [] },
            { id: 3, power: 1, unlocked: false, threshold: 5000, rewardedThresholds: [] },
            { id: 4, power: 1, unlocked: false, threshold: 5000, rewardedThresholds: [] },
            { id: 5, power: 1, unlocked: false, threshold: 5000, rewardedThresholds: [] },
            { id: 6, power: 1, unlocked: false, threshold: 25000, rewardedThresholds: [] }
        ];
        let activeHouseIndex = 0;
        let globalCooldownUpdater = null;
        let dailyResetTimerInterval = null;
        let onlineStatusUpdater = null; // for online users feature

        let playerXP = 0;
        let playerLevel = 0;
        let playerPoints = 0;
        let playerDollars = 0;
        let playerInventory = {
            reduceTime: 0
        };
        let playerName = "تعيين اسم";
        let isNameSetPermanently = false;
        let isRoyalNameActive = false;
        let attackCooldowns = {}; // Stores cooldowns for attacking other players { targetUserId: timestamp }

        const baseXpThreshold = 100;
        let xpForCurrentLevel = 0;
        let xpThresholdForNextLevel = baseXpThreshold;

        const housePowerTiers = [
            { minPower: 1, imageUrl: "https://d.top4top.io/p_347985vd10.png" },
            { minPower: 2500, imageUrl: "https://l.top4top.io/p_3479h0oa70.png" },
            { minPower: 7000, imageUrl: "https://a.top4top.io/p_3479npbk21.png" },
            { minPower: 10000, imageUrl: "https://b.top4top.io/p_3479hfhop2.png" },
            { minPower: 15000, imageUrl: "https://b.top4top.io/p_3479hfhop2.png" },
            { minPower: 25000, imageUrl: "https://d.top4top.io/p_34798y7o83.png" }
        ];

        const houseUpgradeRewards = [
            { power: 1000, points: 200, dollars: 100 },
            { power: 5000, points: 350, dollars: 150 },
            { power: 7000, points: 500, dollars: 200 },
            { power: 10000, points: 1000, dollars: 300 },
            { power: 15000, points: 2000, dollars: 500 },
            { power: 25000, points: 5000, dollars: 1000 }
        ];

        const innovationTypes = [
            { id: 'innovation1', name: 'ابتكار 1', cooldownTimeLeft: 0, initialCooldown: 5 * 60, colorClass: 'from-purple-600 to-indigo-700' },
            { id: 'innovation2', name: 'ابتكار 2', cooldownTimeLeft: 0, initialCooldown: 10 * 60, colorClass: 'from-orange-600 to-amber-700' }
        ];
        let currentInnovationTypeIndex = 0;

        const storeItems = {
            'reduceTime': {
                name: 'تقليل وقت الابتكار',
                description: 'يقلل الوقت المتبقي للابتكار الحالي بمقدار دقيقتين.',
                cost: 200,
                costType: 'dollars',
                image: 'https://f.top4top.io/p_3479ijdcl0.png',
                useEffect: (quantity = 1) => {
                    const timeReductionPerItem = 120;
                    const totalTimeReduction = timeReductionPerItem * quantity;
                    const currentInnovation = innovationTypes[currentInnovationTypeIndex];
                    if (currentInnovation && currentInnovation.cooldownTimeLeft > 0) {
                        currentInnovation.cooldownTimeLeft = Math.max(0, currentInnovation.cooldownTimeLeft - totalTimeReduction);
                        updateInnovationTimerDisplay();
                        showMessageModal('تم الاستخدام', `تم تقليل وقت الابتكار بمقدار ${quantity * 2} دقائق. الوقت المتبقي: ${formatTime(currentInnovation.cooldownTimeLeft)}`);
                    } else {
                        showMessageModal('لا يوجد مؤقت', 'لا يوجد ابتكار قيد الانتظار حالياً.');
                    }
                    const xpGain = (Math.floor(Math.random() * (400 - 250 + 1)) + 250) * quantity;
                    updatePlayerXP(xpGain);
                    saveInnovationTypes();
                }
            },
            'convertPoints': {
                name: 'تحويل النقاط',
                description: 'يحول 500 نقطة إلى 200-600 دولار.',
                cost: 500,
                costType: 'points',
                image: 'https://i.top4top.io/s_34795cyi20.png',
                useEffect: (quantity = 1) => {
                    const dollarsGain = (Math.floor(Math.random() * (600 - 200 + 1)) + 200) * quantity;
                    playerDollars += dollarsGain;
                    updatePlayerInfoDisplay();
                    showMessageModal('تم التحويل', `لقد حصلت على ${formatPower(dollarsGain)}$!`);
                    const xpGain = (Math.floor(Math.random() * (400 - 250 + 1)) + 250) * quantity;
                    updatePlayerXP(xpGain);
                },
                directUse: true
            },
            'buyInnovation3': {
                name: 'شراء ابتكار ثالث',
                description: 'يفتح ابتكارًا جديدًا بمدة تهدئة 7 دقائق.',
                cost: 3000,
                costType: 'points',
                image: 'https://f.top4top.io/s_34796x9520.png',
                useEffect: (quantity = 1) => {
                    const innovationId = 'innovation3';
                    const innovationExists = innovationTypes.some(inv => inv.id === innovationId);
                    if (!innovationExists) {
                        innovationTypes.push({ id: innovationId, name: 'ابتكار 3', cooldownTimeLeft: 0, initialCooldown: 7 * 60, colorClass: 'from-green-600 to-emerald-700' });
                        saveInnovationTypes();
                        updateInnovationButtonText();
                        showMessageModal('تم الشراء', 'تم فتح الابتكار الثالث بنجاح!');
                    } else {
                        showMessageModal('موجود بالفعل', 'لقد قمت بفتح هذا الابتكار بالفعل.');
                    }
                    const xpGain = (Math.floor(Math.random() * (500 - 300 + 1)) + 300) * quantity;
                    updatePlayerXP(xpGain);
                },
                directUse: true
            },
            'royalName': {
                name: 'اسم ملكي',
                description: 'يجعل اسمك ذهبي متحرك وكأنه ملكي.',
                cost: 2000,
                costType: 'dollars',
                image: 'https://placehold.co/100x100/FFD700/000000?text=👑',
                levelRequirement: 20,
                useEffect: () => {
                    isRoyalNameActive = true;
                    savePlayerData();
                    applyRoyalNameEffect();
                    showMessageModal('تهانينا!', 'أصبح اسمك ملكياً الآن!');
                },
                directUse: true
            }
        };

        const tasks = {
            daily: [
                { id: 'innovate', name: 'فعل الابتكار', description: 'فعل الابتكار 3 مرات', targetCount: 3, currentCount: 0, completed: false, claimed: false, rewardPoints: 200, rewardDollars: 100 },
                { id: 'buy_store', name: 'اشتري من المتجر', description: 'اشتري 3 مرات من المتجر', targetCount: 3, currentCount: 0, completed: false, claimed: false, rewardPoints: 300, rewardDollars: 150 },
                { id: 'level_up', name: 'ارتفع مستوى', description: 'ارتفع 3 مستويات XP', targetCount: 3, currentCount: 0, completed: false, claimed: false, rewardPoints: 100, rewardDollars: 200 }
            ],
            oneTime: []
        };
        let lastDailyResetDate = null;

        function formatPower(num) {
            if (num >= 10000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            const pad = (num) => num < 10 ? '0' + num : num;
            return `${pad(hours)}:${pad(minutes)}:${pad(remainingSeconds)}`;
        }

        function closeModal(modalElement) {
            if (modalElement && modalElement.querySelector('div')) {
                modalElement.querySelector('div').classList.remove('scale-100', 'opacity-100');
                modalElement.querySelector('div').classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modalElement.classList.add('hidden');
                }, 300);
            }
        }

        function showToast(message, type = 'success') {
            if (!toastNotification) return;

            toastNotification.textContent = message;
            toastNotification.className = `fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50`;
            if (type === 'success') {
                toastNotification.classList.add('bg-green-600');
            } else if (type === 'info') {
                toastNotification.classList.add('bg-blue-600');
            }
            toastNotification.classList.remove('opacity-0');
            toastNotification.classList.add('opacity-100');

            setTimeout(() => {
                toastNotification.classList.remove('opacity-100');
                toastNotification.classList.add('opacity-0');
            }, 2000);
        }

        function calculateTotalPower() {
            let total = 0;
            houses.forEach(house => {
                total += house.power;
            });
            totalPlayerPower = total;
            return total;
        }

        function updatePlayerXP(amount) {
            const oldLevel = playerLevel;
            playerXP += amount;
            xpForCurrentLevel += amount;

            while (xpForCurrentLevel >= xpThresholdForNextLevel) {
                playerLevel++;
                xpForCurrentLevel -= xpThresholdForNextLevel;
                xpThresholdForNextLevel = Math.floor(baseXpThreshold * Math.pow(1.2, playerLevel));

                const pointsReward = Math.floor(Math.random() * (100 - 50 + 1)) + 50;
                const dollarsReward = Math.floor(Math.random() * (500 - 10 + 1)) + 10;
                playerPoints += pointsReward;
                playerDollars += dollarsReward;

                if (currentLevelDisplay) currentLevelDisplay.textContent = playerLevel;
                if (levelPointsRewardDisplay) levelPointsRewardDisplay.textContent = formatPower(pointsReward);
                if (levelDollarsRewardDisplay) levelDollarsRewardDisplay.textContent = formatPower(dollarsReward);
                
                if (currentLevelDisplay) currentLevelDisplay.classList.add('timer-digit-animation');
                if (levelPointsRewardDisplay) levelPointsRewardDisplay.classList.add('timer-digit-animation');
                if (levelDollarsRewardDisplay) levelDollarsRewardDisplay.classList.add('timer-digit-animation');

                if (levelUpToast) levelUpToast.classList.add('show');

                setTimeout(() => {
                    if (currentLevelDisplay) currentLevelDisplay.classList.remove('timer-digit-animation');
                    if (levelPointsRewardDisplay) levelPointsRewardDisplay.classList.remove('timer-digit-animation');
                    if (levelDollarsRewardDisplay) levelDollarsRewardDisplay.classList.remove('timer-digit-animation');
                    if (levelUpToast) levelUpToast.classList.remove('show');
                }, 3000);
            }
            if (playerLevel - oldLevel > 0) {
                trackTaskProgress('level_up', playerLevel - oldLevel);
            }
            updatePlayerInfoDisplay();
            updateChallengeMenuItemLock();
            savePlayerData();
        }

        function updatePlayerInfoDisplay() {
            calculateTotalPower(); // Update total player power before displaying
            if (document.getElementById('player-xp-display')) document.getElementById('player-xp-display').textContent = formatPower(playerXP);
            if (document.getElementById('player-level-display')) document.getElementById('player-level-display').textContent = playerLevel;
            if (document.getElementById('player-points-display')) document.getElementById('player-points-display').textContent = formatPower(playerPoints);
            if (document.getElementById('player-dollars-display')) document.getElementById('player-dollars-display').textContent = `$${formatPower(playerDollars)}`;
            if (inventoryCountDisplay) inventoryCountDisplay.textContent = playerInventory.reduceTime;
            if (playerNameDisplay) playerNameDisplay.textContent = playerName;
            
            const progressBarWidth = (xpForCurrentLevel / xpThresholdForNextLevel) * 100;
            if (document.getElementById('xp-progress-bar')) document.getElementById('xp-progress-bar').style.width = `${progressBarWidth}%`;
            
            if (document.getElementById('xp-remaining-display')) document.getElementById('xp-remaining-display').textContent = `المتبقي للمستوى التالي: ${formatPower(xpThresholdForNextLevel - xpForCurrentLevel)} XP`;

            if (storePlayerPointsDisplay) storePlayerPointsDisplay.textContent = formatPower(playerPoints);
            if (storePlayerDollarsDisplay) storePlayerDollarsDisplay.textContent = `$${formatPower(playerDollars)}`;

            if (isRoyalNameActive) {
                applyRoyalNameEffect();
            } else {
                if (playerNameDisplay) playerNameDisplay.classList.remove('royal-name');
            }

            // Update public player profile
            if (isFirebaseLoaded && userId && playerName !== "تعيين اسم") {
                set(ref(db, `artifacts/${appId}/public/playerProfiles/${userId}`), {
                    name: playerName,
                    level: playerLevel,
                    totalPower: totalPlayerPower
                });
            }
        }

        function navigateTo(targetViewId, direction = 'right') {
            const currentView = document.querySelector('.view.translate-x-0');
            const targetView = document.getElementById(targetViewId);

            if (currentView === targetView) return;

            if (currentView) {
                if (direction === 'right') {
                    currentView.classList.add('-translate-x-full');
                } else {
                    currentView.classList.add('translate-x-full');
                }
                currentView.classList.remove('translate-x-0');
            }
            
            if (targetView) {
                if (direction === 'right') {
                    targetView.classList.remove('-translate-x-full');
                    targetView.classList.add('translate-x-full');
                } else {
                    targetView.classList.remove('translate-x-full');
                    targetView.classList.add('-translate-x-full');
                }
                
                setTimeout(() => {
                    targetView.classList.remove('translate-x-full', '-translate-x-full');
                    targetView.classList.add('translate-x-0');
                    const targetViewContent = targetView.querySelector('.view-content');
                    if (targetViewContent) {
                        targetViewContent.scrollTop = 0;
                    }
                }, 10);
            }
            if (targetViewId === 'store-view') {
                updatePlayerInfoDisplay();
            }
            if (targetViewId === 'online-view') {
                updateOnlineStatus();
            }
            if (targetViewId === 'challenge-view') {
                renderChallengePlayers();
            }
        }

        function getHouseImage(power) {
            for (let i = housePowerTiers.length - 1; i >= 0; i--) {
                if (power >= housePowerTiers[i].minPower) {
                    return housePowerTiers[i].imageUrl;
                }
            }
            return housePowerTiers[0].imageUrl;
        }

        function renderHouses() {
            if (!housesContainer) return;

            housesContainer.innerHTML = '';
            houses.forEach((house, index) => {
                const houseElement = document.createElement('div');
                const houseImageUrl = getHouseImage(house.power);
                houseElement.className = `house-container ${!house.unlocked ? 'locked-house' : ''}`;
                if (index === activeHouseIndex) {
                    houseElement.classList.add('active-house');
                }
                houseElement.innerHTML = `
                    <img src="${houseImageUrl}" alt="House">
                    <div class="text-sm font-bold mt-1">القوة: ${formatPower(house.power)}</div>
                    ${!house.unlocked ? '<div class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center rounded-xl"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v3.06M16 17H8"></path></svg></div>' : ''}
                `;
                housesContainer.appendChild(houseElement);
            });

            updateNextHouseInfo();
        }

        function updateNextHouseInfo() {
            if (!nextHouseInfoDisplay) return;

            const currentHouse = houses[activeHouseIndex];
            const nextHouse = houses[activeHouseIndex + 1];

            if (nextHouse && !nextHouse.unlocked) {
                const remainingPower = nextHouse.threshold - currentHouse.power;
                nextHouseInfoDisplay.textContent = `لفتح البيت التالي: ${formatPower(Math.max(0, remainingPower))} قوة متبقية`;
                nextHouseInfoDisplay.classList.remove('hidden');
            } else {
                nextHouseInfoDisplay.classList.add('hidden');
            }
        }

        function showMessageModal(title, text) {
            if (!messageModal || !messageModalTitle || !messageModalText) return;

            messageModal.classList.remove('hidden');
            messageModalTitle.innerHTML = title;
            messageModalText.innerHTML = text;
            setTimeout(() => {
                if (messageModal.querySelector('.message-modal-content')) {
                    messageModal.querySelector('.message-modal-content').classList.remove('scale-95', 'opacity-0');
                    messageModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                }
            }, 10);
        }

        if (settingsMenuItem) settingsMenuItem.addEventListener('click', () => navigateTo('settings-view', 'right'));
        if (playMenuItem) playMenuItem.addEventListener('click', () => navigateTo('game-view', 'right'));
        if (storeMenuItem) storeMenuItem.addEventListener('click', () => navigateTo('store-view', 'right'));
        if (challengeMenuItem) {
            challengeMenuItem.addEventListener('click', () => {
                if (playerLevel >= 10) {
                    navigateTo('challenge-view', 'right');
                } else {
                    showMessageModal('مقفول!', `يتطلب الوصول إلى المستوى 10 لفتح تحدي اللاعبون. مستواك الحالي: ${playerLevel}`);
                }
            });
        }
        if (chatMenuItem) chatMenuItem.addEventListener('click', () => navigateTo('chat-view', 'right'));
        if (onlineMenuItem) onlineMenuItem.addEventListener('click', () => navigateTo('online-view', 'right'));

        document.addEventListener('click', (event) => {
            if (event.target.closest('#back-to-main-from-settings')) {
                navigateTo('main-menu-view', 'left');
            } else if (event.target.closest('#back-to-main-from-game')) {
                navigateTo('main-menu-view', 'left');
            } else if (event.target.closest('#back-to-main-from-store')) {
                navigateTo('main-menu-view', 'left');
            } else if (event.target.closest('#back-to-main-from-challenge')) {
                navigateTo('main-menu-view', 'left');
            } else if (event.target.closest('#back-to-main-from-chat')) {
                navigateTo('main-menu-view', 'left');
            } else if (event.target.closest('#back-to-main-from-online')) {
                navigateTo('main-menu-view', 'left');
            }
        });

        if (musicVolumeSlider) {
            musicVolumeSlider.addEventListener('input', (event) => {
                if (musicVolumeValue) musicVolumeValue.textContent = `${event.target.value}%`;
            });
        }

        if (innovationPrevButton) innovationPrevButton.addEventListener('click', () => {
            currentInnovationTypeIndex = (currentInnovationTypeIndex - 1 + innovationTypes.length) % innovationTypes.length;
            updateInnovationButtonText();
            updateInnovationTimerDisplay();
        });

        if (innovationNextButton) innovationNextButton.addEventListener('click', () => {
            currentInnovationTypeIndex = (currentInnovationTypeIndex + 1) % innovationTypes.length;
            updateInnovationButtonText();
            updateInnovationTimerDisplay();
        });

        function updateInnovationButtonText() {
            if (!innovationButton || !innovationButtonText) return;

            const currentType = innovationTypes[currentInnovationTypeIndex];
            innovationButton.className = `text-white font-bold flex items-center mx-2 bg-gradient-to-br ${currentType.colorClass}`;
            innovationButtonText.innerHTML = `<span>تفعيل ${currentType.name}</span><span class="price-display"><span>مجاني</span></span>`;
            
            if (currentType.cooldownTimeLeft > 0) {
                innovationButton.disabled = true;
                innovationButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                innovationButton.disabled = false;
                innovationButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function updateInnovationTimerDisplay() {
            if (!innovationTimer || !timerDisplayValue) return;

            const currentInnovation = innovationTypes[currentInnovationTypeIndex];
            if (currentInnovation && currentInnovation.cooldownTimeLeft > 0) {
                innovationTimer.classList.remove('hidden');
                timerDisplayValue.textContent = formatTime(currentInnovation.cooldownTimeLeft);
                timerDisplayValue.classList.add('timer-digit-animation');
            } else {
                innovationTimer.classList.add('hidden');
                timerDisplayValue.classList.remove('timer-digit-animation');
            }
            updateInnovationButtonText();
        }

        if (innovationButton) {
            innovationButton.addEventListener('click', () => {
                if (!houses[activeHouseIndex].unlocked) return;

                const currentInnovation = innovationTypes[currentInnovationTypeIndex];

                if (currentInnovation && currentInnovation.cooldownTimeLeft > 0) {
                    showMessageModal('الابتكار قيد الانتظار', `هذا الابتكار لا يزال في فترة التهدئة. الوقت المتبقي: ${formatTime(currentInnovation.cooldownTimeLeft)}`);
                    return;
                }

                const currentHouse = houses[activeHouseIndex];
                const oldPower = currentHouse.power;

                const powerIncrease = Math.floor(Math.random() * (300 - 25 + 1)) + 25;
                currentHouse.power += powerIncrease;
                
                houseUpgradeRewards.forEach(reward => {
                    if (currentHouse.power >= reward.power && oldPower < reward.power && !currentHouse.rewardedThresholds.includes(reward.power)) {
                        playerPoints += reward.points;
                        playerDollars += reward.dollars;
                        currentHouse.rewardedThresholds.push(reward.power);
                        updatePlayerInfoDisplay();
                    }
                });

                renderHouses();
                saveHouses();

                const xpGain = Math.floor(Math.random() * (100 - 25 + 1)) + 25;
                updatePlayerXP(xpGain);

                if (powerIncreaseDisplay) powerIncreaseDisplay.textContent = formatPower(powerIncrease);
                if (totalPowerDisplay) totalPowerDisplay.textContent = formatPower(currentHouse.power);
                
                if (popupModal) {
                    popupModal.classList.remove('hidden');
                    setTimeout(() => {
                        if (popupModal.querySelector('.popup-content')) {
                            popupModal.querySelector('.popup-content').classList.remove('scale-95', 'opacity-0');
                            popupModal.querySelector('.popup-content').classList.add('scale-100', 'opacity-100');
                        }
                    }, 10);
                }

                if (currentHouse.power >= currentHouse.threshold && activeHouseIndex < houses.length - 1) {
                    activeHouseIndex++;
                    houses[activeHouseIndex].unlocked = true;
                    renderHouses();
                    saveHouses();
                }

                if (currentInnovation) {
                    currentInnovation.cooldownTimeLeft = currentInnovation.initialCooldown;
                    updateInnovationTimerDisplay();
                    startGlobalCooldownUpdater();
                }

                trackTaskProgress('innovate', 1);
            });
        }

        if (popupCloseButton) {
            popupCloseButton.addEventListener('click', () => {
                closeModal(popupModal);
            });
        }

        if (levelInfoIcon) {
            levelInfoIcon.addEventListener('click', () => {
                showMessageModal('جوائز المستوى', `عند رفع المستوى، تحصل على:<br><span class="text-yellow-300 font-bold">50-100 نقطة</span><br><span class="text-green-300 font-bold">10-500 دولار</span>`);
            });
        }

        if (gameInfoIcon) {
            gameInfoIcon.addEventListener('click', () => {
                if (!houseUpgradeRewardsList || !houseInfoModal) return;

                houseUpgradeRewardsList.innerHTML = '';
                houseUpgradeRewards.forEach(reward => {
                    const houseImageUrl = getHouseImage(reward.power);
                    const listItem = document.createElement('li');
                    listItem.className = 'mb-2 flex items-center justify-end';
                    listItem.innerHTML = `
                        <div class="text-left flex-grow">
                            <p class="font-bold">قوة ${formatPower(reward.power)}:</p>
                            <p><span class="text-yellow-300">${formatPower(reward.points)} نقطة</span>, <span class="text-green-300">${formatPower(reward.dollars)}$</span></p>
                        </div>
                        <img src="${houseImageUrl}" alt="House Tier ${formatPower(reward.power)}" class="w-16 h-16 object-contain rounded-md mr-3">
                    `;
                    houseUpgradeRewardsList.appendChild(listItem);
                });

                houseInfoModal.classList.remove('hidden');
                setTimeout(() => {
                    if (houseInfoModal.querySelector('div')) {
                        houseInfoModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                        houseInfoModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                    }
                }, 10);
            });
        }

        if (houseInfoCloseButton) {
            houseInfoCloseButton.addEventListener('click', () => {
                closeModal(houseInfoModal);
            });
        }

        if (messageModalCloseButton) {
            messageModalCloseButton.addEventListener('click', () => {
                closeModal(messageModal);
            });
        }

        if (storeItemReduceTime) storeItemReduceTime.addEventListener('click', () => {
            showStoreItemDetail('reduceTime');
        });

        if (storeItemConvertPoints) storeItemConvertPoints.addEventListener('click', () => {
            showStoreItemDetail('convertPoints');
        });

        if (storeItemBuyInnovation3) storeItemBuyInnovation3.addEventListener('click', () => {
            showStoreItemDetail('buyInnovation3');
        });

        if (storeItemRoyalName) storeItemRoyalName.addEventListener('click', () => {
            showStoreItemDetail('royalName');
        });

        let currentStoreItem = null;
        let currentStoreQuantity = 1;

        function updateStoreDetailQuantityDisplay() {
            if (!storeDetailQuantityDisplay || !storeDetailTotalCost || !storeDetailQuantityPlus || !storeDetailQuantityMinus) {
                console.error("DOM elements for store detail quantity/cost not found. Cannot update display.");
                return;
            }

            storeDetailQuantityDisplay.textContent = currentStoreQuantity;
            const item = storeItems[currentStoreItem];
            if (item) {
                storeDetailTotalCost.textContent = `${formatPower(item.cost * currentStoreQuantity)}${item.costType === 'dollars' ? '$' : ' نقطة'}`;
            } else {
                console.error("Current store item not found:", currentStoreItem);
                storeDetailTotalCost.textContent = "N/A";
            }

            if (item && !item.directUse) {
                let maxQuantity = item.costType === 'dollars' ? Math.floor(playerDollars / item.cost) : Math.floor(playerPoints / item.cost);

                if (currentStoreItem === 'reduceTime') {
                    const currentInnovation = innovationTypes[currentInnovationTypeIndex];
                    const timeReductionPerItem = 120;
                    if (currentInnovation && currentInnovation.cooldownTimeLeft > 0) {
                        const maxItemsToReduceToZero = Math.ceil(currentInnovation.cooldownTimeLeft / timeReductionPerItem);
                        maxQuantity = Math.min(maxQuantity, maxItemsToReduceToZero);
                    } else {
                        maxQuantity = 0;
                    }
                }

                storeDetailQuantityPlus.disabled = currentStoreQuantity >= maxQuantity;
                storeDetailQuantityMinus.disabled = currentStoreQuantity <= 1;
            } else {
                storeDetailQuantityPlus.disabled = true;
                storeDetailQuantityMinus.disabled = true;
            }
        }

        if (storeDetailQuantityMinus) {
            storeDetailQuantityMinus.addEventListener('click', () => {
                if (currentStoreQuantity > 1) {
                    currentStoreQuantity--;
                    updateStoreDetailQuantityDisplay();
                }
            });
        }

        if (storeDetailQuantityPlus) {
            storeDetailQuantityPlus.addEventListener('click', () => {
                const item = storeItems[currentStoreItem];
                if (item) {
                    let maxQuantity = item.costType === 'dollars' ? Math.floor(playerDollars / item.cost) : Math.floor(playerPoints / item.cost);

                    if (currentStoreItem === 'reduceTime') {
                        const currentInnovation = innovationTypes[currentInnovationTypeIndex];
                        const timeReductionPerItem = 120;
                        if (currentInnovation && currentInnovation.cooldownTimeLeft > 0) {
                            const maxItemsToReduceToZero = Math.ceil(currentInnovation.cooldownTimeLeft / timeReductionPerItem);
                            maxQuantity = Math.min(maxQuantity, maxItemsToReduceToZero);
                        } else {
                            maxQuantity = 0;
                        }
                    }

                    if (currentStoreQuantity < maxQuantity) {
                        currentStoreQuantity++;
                        updateStoreDetailQuantityDisplay();
                    }
                }
            });
        }

        function showStoreItemDetail(itemId) {
            currentStoreItem = itemId;
            currentStoreQuantity = 1;
            const item = storeItems[itemId];

            if (!item || !storeDetailImage || !storeDetailTitle || !storeDetailDescription || !storeDetailModal || !document.getElementById('quantity-selection')) {
                console.error("One or more DOM elements or item data missing for store detail modal.");
                return;
            }

            storeDetailImage.src = item.image;
            storeDetailTitle.textContent = item.name;
            storeDetailDescription.textContent = item.description;
            
            if (item.directUse) {
                document.getElementById('quantity-selection').classList.add('hidden');
            } else {
                document.getElementById('quantity-selection').classList.remove('hidden');
            }

            if (item.levelRequirement && playerLevel < item.levelRequirement) {
                if (storeDetailConfirmButton) {
                    storeDetailConfirmButton.disabled = true;
                    storeDetailConfirmButton.textContent = `يتطلب مستوى ${item.levelRequirement}`;
                    storeDetailConfirmButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } else {
                if (storeDetailConfirmButton) {
                    storeDetailConfirmButton.disabled = false;
                    storeDetailConfirmButton.textContent = 'تأكيد الشراء';
                    storeDetailConfirmButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            updateStoreDetailQuantityDisplay();

            storeDetailModal.classList.remove('hidden');
            setTimeout(() => {
                if (storeDetailModal.querySelector('div')) {
                    storeDetailModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                    storeDetailModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                }
            }, 10);

            if (storeDetailConfirmButton) {
                storeDetailConfirmButton.onclick = () => {
                    if (storeDetailConfirmButton.disabled) return;

                    const quantityToBuy = currentStoreQuantity;
                    const totalCost = item.cost * quantityToBuy;
                    let canAfford = false;
                    if (item.costType === 'dollars') {
                        if (playerDollars >= totalCost) {
                            playerDollars -= totalCost;
                            canAfford = true;
                        }
                    } else if (item.costType === 'points') {
                        if (playerPoints >= totalCost) {
                            playerPoints -= totalCost;
                            canAfford = true;
                        }
                    }

                    if (canAfford) {
                        if (item.directUse) {
                            item.useEffect(quantityToBuy);
                        } else {
                            playerInventory[itemId] += quantityToBuy;
                            showMessageModal('نجاح الشراء', `لقد اشتريت ${quantityToBuy} من ${item.name}. لديك الآن ${playerInventory[itemId]} في حقيبتك.`);
                        }
                        updatePlayerInfoDisplay();
                        savePlayerData();
                        savePlayerInventory();
                        trackTaskProgress('buy_store', quantityToBuy);
                    } else {
                        showMessageModal('فشل الشراء', `ليس لديك ${item.costType === 'dollars' ? 'دولارات' : 'نقاط'} كافية لشراء ${quantityToBuy} من هذا العنصر.`);
                    }
                    closeModal(storeDetailModal);
                };
            }
        }

        if (storeDetailCancelButton) {
            storeDetailCancelButton.addEventListener('click', () => {
                closeModal(storeDetailModal);
            });
        }

        if (inventoryIcon) {
            inventoryIcon.addEventListener('click', () => {
                renderInventoryItems();
                if (inventoryModal) {
                    inventoryModal.classList.remove('hidden');
                    setTimeout(() => {
                        if (inventoryModal.querySelector('div')) {
                            inventoryModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                            inventoryModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                        }
                    }, 10);
                }
            });
        }

        if (inventoryCloseButton) {
            inventoryCloseButton.addEventListener('click', () => {
                closeModal(inventoryModal);
            });
        }

        function renderInventoryItems() {
            if (!inventoryItemsList) return;

            inventoryItemsList.innerHTML = '';
            let hasItems = false;

            for (const itemId in playerInventory) {
                if (playerInventory[itemId] > 0) {
                    hasItems = true;
                    const item = storeItems[itemId];
                    if (!item) continue;

                    const inventoryItemElement = document.createElement('div');
                    inventoryItemElement.className = 'flex flex-col items-center justify-between bg-gray-600 p-4 rounded-xl shadow-md';
                    inventoryItemElement.innerHTML = `
                        <div class="flex items-center justify-between w-full mb-2">
                            <div class="flex items-center">
                                <img src="${item.image}" alt="${item.name}" class="h-12 w-12 object-contain mr-4">
                                <div>
                                    <p class="text-lg font-semibold text-white">${item.name}</p>
                                    <p class="text-sm text-gray-300">الكمية: ${playerInventory[itemId]}</p>
                                </div>
                            </div>
                            <button data-item-id="${itemId}" class="use-inventory-item-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out">
                                استخدام
                            </button>
                        </div>
                        <div class="flex items-center gap-2 quantity-buttons-row">
                            <button class="quantity-button inventory-quantity-minus" data-item-id="${itemId}">-</button>
                            <span class="inventory-item-quantity-display text-white text-lg font-bold">1</span>
                            <button class="quantity-button inventory-quantity-plus" data-item-id="${itemId}">+</button>
                        </div>
                    `;
                    inventoryItemsList.appendChild(inventoryItemElement);
                }
            }

            if (!hasItems) {
                inventoryItemsList.innerHTML = '<p class="text-gray-300">حقيبتك فارغة.</p>';
            }

            document.querySelectorAll('.inventory-quantity-minus').forEach(button => {
                button.removeEventListener('click', handleInventoryQuantityChange);
                button.addEventListener('click', handleInventoryQuantityChange);
            });

            document.querySelectorAll('.inventory-quantity-plus').forEach(button => {
                button.removeEventListener('click', handleInventoryQuantityChange);
                button.addEventListener('click', handleInventoryQuantityChange);
            });

            document.querySelectorAll('.use-inventory-item-button').forEach(button => {
                button.removeEventListener('click', handleUseItemClick);
                button.addEventListener('click', handleUseItemClick);
            });

            document.querySelectorAll('.quantity-buttons-row').forEach(container => {
                const itemId = container.querySelector('.inventory-quantity-minus').dataset.itemId;
                if (itemId) {
                    updateInventoryQuantityButtons(container, itemId);
                }
            });
        }

        function handleInventoryQuantityChange(event) {
            const itemId = event.target.dataset.itemId;
            const parentContainer = event.target.closest('.quantity-buttons-row');
            if (!parentContainer) return;

            const quantityDisplay = parentContainer.querySelector('.inventory-item-quantity-display');
            let current = parseInt(quantityDisplay.textContent, 10);
            const max = playerInventory[itemId];

            if (event.target.classList.contains('inventory-quantity-minus')) {
                if (current > 1) {
                    quantityDisplay.textContent = current - 1;
                }
            } else if (event.target.classList.contains('inventory-quantity-plus')) {
                if (current < max) {
                    quantityDisplay.textContent = current + 1;
                }
            }
            updateInventoryQuantityButtons(parentContainer, itemId);
        }

        function updateInventoryQuantityButtons(container, itemId) {
            const quantityDisplay = container.querySelector('.inventory-item-quantity-display');
            const minusButton = container.querySelector('.inventory-quantity-minus');
            const plusButton = container.querySelector('.inventory-quantity-plus');
            
            if (!quantityDisplay || !minusButton || !plusButton) {
                console.error("Missing elements for inventory quantity buttons update.");
                return;
            }

            const currentQuantity = parseInt(quantityDisplay.textContent, 10);
            const maxAvailable = playerInventory[itemId];

            minusButton.disabled = currentQuantity <= 1;
            plusButton.disabled = currentQuantity >= maxAvailable;
        }

        function handleUseItemClick(event) {
            const itemId = event.target.dataset.itemId;
            const item = storeItems[itemId];
            const parentContainer = event.target.closest('.flex.flex-col');
            if (!parentContainer) return;

            const quantityDisplay = parentContainer.querySelector('.inventory-item-quantity-display');
            const quantityToUse = parseInt(quantityDisplay.textContent, 10);

            if (isNaN(quantityToUse) || quantityToUse < 1) {
                showMessageModal('خطأ', 'الكمية غير صالحة.');
                return;
            }

            if (playerInventory[itemId] >= quantityToUse) {
                playerInventory[itemId] -= quantityToUse;
                updatePlayerInfoDisplay();
                savePlayerInventory();
                if (item && typeof item.useEffect === 'function') {
                    item.useEffect(quantityToUse);
                }
                closeModal(inventoryModal);
                navigateTo('game-view');
            } else {
                showMessageModal('لا يوجد عناصر', `ليس لديك ${quantityToUse} من هذا العنصر. لديك فقط ${playerInventory[itemId]}.`);
            }
        }

        function getSaudiTime() {
            const now = new Date();
            const localTime = now.getTime();
            const localOffset = now.getTimezoneOffset() * 60000;
            const utc = localTime + localOffset;
            const saudiOffset = 3 * 60 * 60 * 1000;
            return new Date(utc + saudiOffset);
        }

        function getTimeUntilNextSaudiMidnight() {
            const now = getSaudiTime();
            const nextMidnight = new Date(now);
            nextMidnight.setDate(now.getDate() + 1);
            nextMidnight.setHours(0, 0, 0, 0);
            return Math.max(0, Math.floor((nextMidnight.getTime() - now.getTime()) / 1000));
        }

        function startDailyResetTimer() {
            function updateTimer() {
                const remainingSeconds = getTimeUntilNextSaudiMidnight();
                if (dailyTasksTimerDisplay) {
                    dailyTasksTimerDisplay.textContent = formatTime(remainingSeconds);
                }
                if (remainingSeconds <= 0) {
                    loadTasks();
                    updateTimer();
                }
            }
            clearInterval(dailyResetTimerInterval);
            dailyResetTimerInterval = setInterval(updateTimer, 1000);
            updateTimer();
        }

        function loadTasks() {
            if (!isFirebaseLoaded) return;
            const tasksRef = ref(db, `artifacts/${appId}/users/${userId}/tasks`);
            onValue(tasksRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    tasks.daily = data.daily || [];
                    tasks.oneTime = data.oneTime || [];
                    lastDailyResetDate = data.lastDailyResetDate || null;
                } else {
                    tasks.daily = [
                        { id: 'innovate', name: 'فعل الابتكار', description: 'فعل الابتكار 3 مرات', targetCount: 3, currentCount: 0, completed: false, claimed: false, rewardPoints: 200, rewardDollars: 100 },
                        { id: 'buy_store', name: 'اشتري من المتجر', description: 'اشتري 3 مرات من المتجر', targetCount: 3, currentCount: 0, completed: false, claimed: false, rewardPoints: 300, rewardDollars: 150 },
                        { id: 'level_up', name: 'ارتفع مستوى', description: 'ارتفع 3 مستويات XP', targetCount: 3, currentCount: 0, completed: false, claimed: false, rewardPoints: 100, rewardDollars: 200 }
                    ];
                    tasks.oneTime = [];
                    lastDailyResetDate = null;
                    saveTasks();
                }

                const now = getSaudiTime();
                const todaySaudiDate = now.toDateString();

                if (lastDailyResetDate !== todaySaudiDate) {
                    tasks.daily.forEach(task => {
                        task.currentCount = 0;
                        task.completed = false;
                        task.claimed = false;
                    });
                    lastDailyResetDate = todaySaudiDate;
                    saveTasks();
                    showToast('تم تحديث المهام اليومية!', 'info');
                }
                renderTasks();
            }, { onlyOnce: true });
        }

        function saveTasks() {
            if (!isFirebaseLoaded) return;
            set(ref(db, `artifacts/${appId}/users/${userId}/tasks`), {
                daily: tasks.daily,
                oneTime: tasks.oneTime,
                lastDailyResetDate: lastDailyResetDate
            });
        }

        function renderTasks() {
            if (!dailyTasksList || !oneTimeTasksList) return;

            dailyTasksList.innerHTML = '';
            oneTimeTasksList.innerHTML = '';

            tasks.daily.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item text-white';
                taskElement.innerHTML = `
                    <p class="font-bold">${task.name}</p>
                    <p class="text-sm text-gray-300">${task.description}</p>
                    <p class="text-xs text-gray-400 mt-1">المكافأة: ${formatPower(task.rewardPoints)} نقطة, ${formatPower(task.rewardDollars)}$</p>
                    <div class="w-full task-progress-bar mt-2">
                        <div class="task-progress-fill" style="width: ${(task.currentCount / task.targetCount) * 100}%;"></div>
                    </div>
                    <p class="text-xs text-gray-300 mt-1">${task.currentCount}/${task.targetCount}</p>
                    ${task.completed && !task.claimed ? `<button data-task-id="${task.id}" class="claim-task-button mt-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm">استلام الجوائز</button>` : ''}
                    ${task.claimed ? '<div class="task-completed-overlay">مكتمل <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>' : ''}
                `;
                dailyTasksList.appendChild(taskElement);
            });

            tasks.oneTime.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item text-white';
                taskElement.innerHTML = `
                    <p class="font-bold">${task.name}</p>
                    <p class="text-sm text-gray-300">${task.description}</p>
                    <p class="text-xs text-gray-400 mt-1">المكافأة: ${formatPower(task.rewardDollars)}$</p>
                    ${!task.completed ? `<button id="complete-task-${task.id}" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm">أكمل المهمة</button>` : '<div class="task-completed-overlay">مكتمل <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>'}
                `;
                oneTimeTasksList.appendChild(taskElement);
            });

            document.querySelectorAll('.claim-task-button').forEach(button => {
                button.removeEventListener('click', handleClaimTaskClick);
                button.addEventListener('click', handleClaimTaskClick);
            });
        }

        function trackTaskProgress(taskId, amount = 1) {
            const dailyTask = tasks.daily.find(task => task.id === taskId);
            if (dailyTask && !dailyTask.completed) {
                dailyTask.currentCount += amount;
                if (dailyTask.currentCount >= dailyTask.targetCount) {
                    dailyTask.completed = true;
                }
                saveTasks();
                renderTasks();
            }
        }

        function handleClaimTaskClick(event) {
            const taskId = event.target.dataset.taskId;
            claimTask(taskId);
        }

        function claimTask(taskId) {
            const task = tasks.daily.find(t => t.id === taskId);
            if (task && task.completed && !task.claimed) {
                playerPoints += task.rewardPoints;
                playerDollars += task.rewardDollars;
                task.claimed = true;
                updatePlayerInfoDisplay();
                savePlayerData();
                saveTasks();
                renderTasks();
            }
        }

        if (tasksIcon) {
            tasksIcon.addEventListener('click', () => {
                renderTasks();
                if (tasksModal) {
                    tasksModal.classList.remove('hidden');
                    setTimeout(() => {
                        if (tasksModal.querySelector('div')) {
                            tasksModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                            tasksModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                        }
                    }, 10);
                }
            });
        }

        if (tasksCloseButton) {
            tasksCloseButton.addEventListener('click', () => {
                closeModal(tasksModal);
            });
        }

        if (updatesIcon) {
            updatesIcon.addEventListener('click', () => {
                if (updatesModal) {
                    updatesModal.classList.remove('hidden');
                    setTimeout(() => {
                        if (updatesModal.querySelector('div')) {
                            updatesModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                            updatesModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                        }
                    }, 10);
                }
            });
        }

        if (updatesCloseButton) {
            updatesCloseButton.addEventListener('click', () => {
                closeModal(updatesModal);
            });
        }

        if (playerNameDisplay) {
            playerNameDisplay.addEventListener('click', () => {
                if (!isNameSetPermanently) {
                    if (setNameModal && playerNameInput) {
                        setNameModal.classList.remove('hidden');
                        playerNameInput.value = playerName === "تعيين اسم" ? "" : playerName;
                        setTimeout(() => {
                            if (setNameModal.querySelector('div')) {
                                setNameModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                                setNameModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                            }
                        }, 10);
                    }
                } else {
                    showMessageModal('الاسم', `اسمك الحالي هو: ${playerName}`);
                }
            });
        }

        if (setNameConfirmButton) {
            setNameConfirmButton.addEventListener('click', () => {
                if (!playerNameInput) return;
                const newName = playerNameInput.value.trim();
                if (newName !== '') {
                    playerName = newName;
                    isNameSetPermanently = true;
                    savePlayerData();
                    updatePlayerInfoDisplay();
                    showToast(`تم تعيين اسمك إلى ${playerName}!`, 'success');
                    closeModal(setNameModal);
                } else {
                    showMessageModal('خطأ', 'الاسم لا يمكن أن يكون فارغاً.');
                }
            });
        }

        if (setNameCancelButton) {
            setNameCancelButton.addEventListener('click', () => {
                if (!isNameSetPermanently) {
                    closeModal(setNameModal);
                } else {
                    closeModal(setNameModal);
                }
            });
        }

        if (deleteAccountButton) {
            deleteAccountButton.addEventListener('click', () => {
                if (deleteConfirmModal) {
                    deleteConfirmModal.classList.remove('hidden');
                    setTimeout(() => {
                        if (deleteConfirmModal.querySelector('div')) {
                            deleteConfirmModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                            deleteConfirmModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                        }
                    }, 10);
                }
            });
        }

        if (deleteConfirmYes) {
            deleteConfirmYes.addEventListener('click', async () => {
                if (!isFirebaseLoaded) {
                    showMessageModal('خطأ', 'البيانات غير جاهزة للحذف.');
                    return;
                }
                try {
                    // Remove player's public profile and online status
                    await remove(ref(db, `artifacts/${appId}/public/playerProfiles/${userId}`));
                    await remove(ref(db, `artifacts/${appId}/public/onlineUsers/${userId}`));
                    // Remove player's private data
                    await remove(ref(db, `artifacts/${appId}/users/${userId}`));
                    
                    localStorage.clear();
                    closeModal(deleteConfirmModal);
                    if (resetCountdownModal && countdownDisplay) {
                        resetCountdownModal.classList.remove('hidden');
                        setTimeout(() => {
                            if (resetCountdownModal.querySelector('div')) {
                                resetCountdownModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                                resetCountdownModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                            }
                        }, 10);

                        let countdown = 10;
                        countdownDisplay.textContent = countdown;
                        const countdownInterval = setInterval(() => {
                            countdown--;
                            if (countdownDisplay) countdownDisplay.textContent = countdown;
                            if (countdown <= 0) {
                                clearInterval(countdownInterval);
                                location.reload();
                            }
                        }, 1000);
                    }
                } catch (error) {
                    console.error("Error deleting user data from Firebase:", error);
                    showMessageModal('خطأ في الحذف', 'فشل حذف بيانات الحساب. يرجى المحاولة مرة أخرى.');
                }
            });
        }

        if (deleteConfirmNo) {
            deleteConfirmNo.addEventListener('click', () => {
                closeModal(deleteConfirmModal);
            });
        }

        function loadInnovationTypes() {
            if (!isFirebaseLoaded) return;
            const innovationRef = ref(db, `artifacts/${appId}/users/${userId}/innovationTypes`);
            onValue(innovationRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    data.forEach(savedType => {
                        const existingType = innovationTypes.find(type => type.id === savedType.id);
                        if (existingType) {
                            existingType.cooldownTimeLeft = savedType.cooldownTimeLeft;
                        } else {
                            if (savedType.id === 'innovation3') {
                                innovationTypes.push({ id: 'innovation3', name: 'ابتكار 3', cooldownTimeLeft: savedType.cooldownTimeLeft, initialCooldown: 7 * 60, colorClass: 'from-green-600 to-emerald-700' });
                            }
                        }
                    });
                } else {
                    saveInnovationTypes();
                }
                updateInnovationButtonText();
                updateInnovationTimerDisplay();
            }, { onlyOnce: true });
        }

        function saveInnovationTypes() {
            if (!isFirebaseLoaded) return;
            set(ref(db, `artifacts/${appId}/users/${userId}/innovationTypes`), innovationTypes.map(type => ({
                id: type.id,
                cooldownTimeLeft: type.cooldownTimeLeft
            })));
        }

        function startGlobalCooldownUpdater() {
            if (globalCooldownUpdater) clearInterval(globalCooldownUpdater);

            globalCooldownUpdater = setInterval(() => {
                let anyInnovationOnCooldown = false;
                innovationTypes.forEach(type => {
                    if (type.cooldownTimeLeft > 0) {
                        type.cooldownTimeLeft--;
                        anyInnovationOnCooldown = true;
                    }
                });
                updateInnovationTimerDisplay(); 

                if (!anyInnovationOnCooldown) {
                    clearInterval(globalCooldownUpdater);
                    globalCooldownUpdater = null;
                }
                saveInnovationTypes();
            }, 1000);
        }

        function updateChallengeMenuItemLock() {
            if (!challengeMenuItem) return;
            const lockIcon = challengeMenuItem.querySelector('.lock-icon');
            const lockText = challengeMenuItem.querySelector('.lock-text');
            if (lockIcon && lockText) {
                if (playerLevel < 10) {
                    challengeMenuItem.classList.add('locked-menu-item');
                    lockIcon.classList.remove('hidden');
                    lockText.classList.remove('hidden');
                } else {
                    challengeMenuItem.classList.remove('locked-menu-item');
                    lockIcon.classList.add('hidden');
                    lockText.classList.add('hidden');
                }
            }
        }

        function applyRoyalNameEffect() {
            if (playerNameDisplay) {
                playerNameDisplay.classList.add('royal-name');
            }
        }

        async function loadPlayerData() {
            if (!isFirebaseLoaded) return;
            const playerRef = ref(db, `artifacts/${appId}/users/${userId}/playerData`);
            const snapshot = await get(playerRef);
            if (snapshot.exists()) {
                const data = snapshot.val();
                playerXP = data.playerXP || 0;
                playerLevel = data.playerLevel || 0;
                playerPoints = data.playerPoints || 0;
                playerDollars = data.playerDollars || 0;
                playerName = data.playerName || "تعيين اسم";
                isNameSetPermanently = data.isNameSetPermanently || false;
                isRoyalNameActive = data.isRoyalNameActive || false;
                xpForCurrentLevel = data.xpForCurrentLevel || 0;
                xpThresholdForNextLevel = data.xpThresholdForNextLevel || baseXpThreshold;
            } else {
                savePlayerData();
            }
            updatePlayerInfoDisplay();
        }

        function savePlayerData() {
            if (!isFirebaseLoaded) return;
            set(ref(db, `artifacts/${appId}/users/${userId}/playerData`), {
                playerXP: playerXP,
                playerLevel: playerLevel,
                playerPoints: playerPoints,
                playerDollars: playerDollars,
                playerName: playerName,
                isNameSetPermanently: isNameSetPermanently,
                isRoyalNameActive: isRoyalNameActive,
                xpForCurrentLevel: xpForCurrentLevel,
                xpThresholdForNextLevel: xpThresholdForNextLevel
            });
        }

        async function loadHouses() {
            if (!isFirebaseLoaded) return;
            const housesRef = ref(db, `artifacts/${appId}/users/${userId}/houses`);
            const snapshot = await get(housesRef);
            if (snapshot.exists()) {
                houses = snapshot.val();
                activeHouseIndex = houses.findIndex(h => h.unlocked === true && h.power < h.threshold) || 0;
                if (activeHouseIndex === -1) {
                    activeHouseIndex = houses.length - 1;
                }
            } else {
                saveHouses();
            }
            renderHouses();
        }

        function saveHouses() {
            if (!isFirebaseLoaded) return;
            set(ref(db, `artifacts/${appId}/users/${userId}/houses`), houses);
        }

        async function loadPlayerInventory() {
            if (!isFirebaseLoaded) return;
            const inventoryRef = ref(db, `artifacts/${appId}/users/${userId}/playerInventory`);
            const snapshot = await get(inventoryRef);
            if (snapshot.exists()) {
                playerInventory = snapshot.val();
            } else {
                savePlayerInventory();
            }
            updatePlayerInfoDisplay();
        }

        function savePlayerInventory() {
            if (!isFirebaseLoaded) return;
            set(ref(db, `artifacts/${appId}/users/${userId}/playerInventory`), playerInventory);
        }

        async function loadAttackCooldowns() {
            if (!isFirebaseLoaded) return;
            const cooldownsRef = ref(db, `artifacts/${appId}/users/${userId}/attackCooldowns`);
            onValue(cooldownsRef, (snapshot) => {
                attackCooldowns = snapshot.val() || {};
                renderChallengePlayers(); // Re-render to update button states
            });
        }

        function saveAttackCooldowns() {
            if (!isFirebaseLoaded) return;
            set(ref(db, `artifacts/${appId}/users/${userId}/attackCooldowns`), attackCooldowns);
        }

        async function migrateLocalStorageToFirebase() {
            const localStorageKeys = [
                'playerXP', 'playerLevel', 'playerPoints', 'playerDollars',
                'playerInventory', 'playerName', 'isNameSetPermanently', 'isRoyalNameActive',
                'xpForCurrentLevel', 'xpThresholdForNextLevel',
                'houses', 'innovationTypes', 'tasks', 'lastDailyResetDate'
            ];

            let hasLocalStorageData = false;
            for (const key of localStorageKeys) {
                if (localStorage.getItem(key) !== null) {
                    hasLocalStorageData = true;
                    break;
                }
            }

            if (hasLocalStorageData) {
                showMessageModal('نقل البيانات', 'جاري نقل بياناتك القديمة إلى السحابة. قد يستغرق هذا بضع لحظات.');
                
                try {
                    playerXP = parseInt(localStorage.getItem('playerXP') || '0');
                    playerLevel = parseInt(localStorage.getItem('playerLevel') || '0');
                    playerPoints = parseInt(localStorage.getItem('playerPoints') || '0');
                    playerDollars = parseInt(localStorage.getItem('playerDollars') || '0');
                    playerName = localStorage.getItem('playerName') || "تعيين اسم";
                    isNameSetPermanently = localStorage.getItem('isNameSetPermanently') === 'true';
                    isRoyalNameActive = localStorage.getItem('isRoyalNameActive') === 'true';
                    xpForCurrentLevel = parseInt(localStorage.getItem('xpForCurrentLevel') || '0');
                    xpThresholdForNextLevel = parseInt(localStorage.getItem('xpThresholdForNextLevel') || `${baseXpThreshold}`);

                    const savedHouses = JSON.parse(localStorage.getItem('houses'));
                    if (savedHouses) houses = savedHouses;

                    const savedInnovationTypes = JSON.parse(localStorage.getItem('innovationTypes'));
                    if (savedInnovationTypes) {
                        savedInnovationTypes.forEach(savedType => {
                            const existingType = innovationTypes.find(type => type.id === savedType.id);
                            if (existingType) {
                                existingType.cooldownTimeLeft = savedType.cooldownTimeLeft;
                            } else {
                                if (savedType.id === 'innovation3') {
                                    innovationTypes.push({ id: 'innovation3', name: 'ابتكار 3', cooldownTimeLeft: savedType.cooldownTimeLeft, initialCooldown: 7 * 60, colorClass: 'from-green-600 to-emerald-700' });
                                }
                            }
                        });
                    }

                    const savedPlayerInventory = JSON.parse(localStorage.getItem('playerInventory'));
                    if (savedPlayerInventory) playerInventory = savedPlayerInventory;

                    const savedTasks = JSON.parse(localStorage.getItem('tasks'));
                    if (savedTasks) {
                        tasks.daily = savedTasks.daily;
                        tasks.oneTime = savedTasks.oneTime;
                    }
                    lastDailyResetDate = localStorage.getItem('lastDailyResetDate');

                    await savePlayerData();
                    await saveHouses();
                    await saveInnovationTypes();
                    await savePlayerInventory();
                    await saveTasks();
                    await saveAttackCooldowns(); // Save empty cooldowns if not present

                    localStorage.clear();
                    showMessageModal('نقل البيانات', 'تم نقل بياناتك بنجاح إلى السحابة!');
                } catch (error) {
                    console.error("Error migrating data:", error);
                    showMessageModal('خطأ في النقل', 'فشل نقل البيانات. يرجى تحديث الصفحة والمحاولة مرة أخرى.');
                }
            }
        }

        setInterval(() => {
            const xpGain = Math.floor(Math.random() * (5 - 1 + 1)) + 1;
            updatePlayerXP(xpGain);
        }, 3 * 1000);

        // Chat functionality
        if (chatSendButton) {
            chatSendButton.addEventListener('click', sendMessage);
        }
        if (chatInput) {
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        function sendMessage() {
            if (!isFirebaseLoaded || !userId || !playerName || playerName === "تعيين اسم") {
                showMessageModal('خطأ', 'يجب تسجيل الدخول وتعيين اسم اللاعب قبل الدردشة.');
                return;
            }
            const messageText = chatInput.value.trim();
            if (messageText === '') return;

            const chatRef = ref(db, `artifacts/${appId}/public/chat`);
            push(chatRef, {
                senderId: userId,
                senderName: playerName,
                message: messageText,
                timestamp: serverTimestamp()
            }).then(() => {
                chatInput.value = '';
            }).catch(error => {
                console.error("Error sending message:", error);
                showMessageModal('خطأ', 'فشل إرسال الرسالة.');
            });
        }

        function listenForChatMessages() {
            if (!isFirebaseLoaded) return;
            const chatRef = ref(db, `artifacts/${appId}/public/chat`);
            onValue(chatRef, (snapshot) => {
                if (!chatMessagesDiv) return;
                chatMessagesDiv.innerHTML = '';
                const messages = [];
                snapshot.forEach(childSnapshot => {
                    const message = childSnapshot.val();
                    messages.push(message);
                });

                // Sort messages by timestamp to ensure correct order
                messages.sort((a, b) => a.timestamp - b.timestamp);

                messages.forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `chat-message ${message.senderId === userId ? 'self' : ''}`;
                    const date = message.timestamp ? new Date(message.timestamp) : new Date();
                    messageElement.innerHTML = `
                        <span class="chat-sender">${message.senderName}:</span>
                        <p class="text-gray-100">${message.message}</p>
                        <span class="chat-timestamp">${date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })}</span>
                    `;
                    chatMessagesDiv.prepend(messageElement); // Add to top for reverse-column display
                });
                // Scroll to bottom if new message is added by self or if near bottom
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
            });
        }

        // Online Users functionality
        function updateOnlineStatus() {
            if (!isFirebaseLoaded || !userId || playerName === "تعيين اسم") return;

            const onlineRef = ref(db, `artifacts/${appId}/public/onlineUsers/${userId}`);
            set(onlineRef, {
                name: playerName,
                level: playerLevel,
                totalPower: totalPlayerPower,
                lastOnline: serverTimestamp()
            }).catch(error => {
                console.error("Error updating online status:", error);
            });
        }

        function listenForOnlineUsers() {
            if (!isFirebaseLoaded) return;
            const onlineUsersRef = ref(db, `artifacts/${appId}/public/onlineUsers`);
            onValue(onlineUsersRef, (snapshot) => {
                if (!onlineUsersList) return;
                onlineUsersList.innerHTML = '';
                const users = [];
                const now = Date.now();
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    const userUid = childSnapshot.key;
                    if (userUid !== userId && user.lastOnline && (now - user.lastOnline < 60 * 1000)) { // Consider online if active in last minute
                        users.push({ uid: userUid, ...user });
                    }
                });

                if (users.length === 0) {
                    onlineUsersList.innerHTML = '<p class="text-gray-300 text-center">لا يوجد لاعبون متصلون حالياً غيرك.</p>';
                } else {
                    users.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'online-user-item text-white';
                        userElement.innerHTML = `
                            <div class="user-info">
                                <p class="font-bold text-lg">${user.name}</p>
                                <p class="text-sm text-gray-300">المستوى: ${user.level}</p>
                                <p class="text-sm text-gray-300">القوة الإجمالية: ${formatPower(user.totalPower)}</p>
                            </div>
                            <div class="status-dot"></div>
                        `;
                        onlineUsersList.appendChild(userElement);
                    });
                }
            });
        }

        // Challenge functionality
        function renderChallengePlayers() {
            if (!isFirebaseLoaded || !challengePlayersList) return;

            const playerProfilesRef = ref(db, `artifacts/${appId}/public/playerProfiles`);
            onValue(playerProfilesRef, (snapshot) => {
                challengePlayersList.innerHTML = '';
                const players = [];
                snapshot.forEach(childSnapshot => {
                    const player = childSnapshot.val();
                    const playerUid = childSnapshot.key;
                    if (playerUid !== userId) { // Don't list self
                        players.push({ uid: playerUid, ...player });
                    }
                });

                if (players.length === 0) {
                    challengePlayersList.innerHTML = '<p class="text-gray-300 text-center">لا يوجد لاعبون آخرون متاحون للتحدي حالياً.</p>';
                } else {
                    players.forEach(player => {
                        const attackCooldownRemaining = getAttackCooldownRemaining(player.uid);
                        const isAttackReady = attackCooldownRemaining <= 0;

                        const playerElement = document.createElement('div');
                        playerElement.className = 'challenge-player-item text-white';
                        playerElement.innerHTML = `
                            <div class="player-info text-right">
                                <p class="font-bold text-lg">${player.name}</p>
                                <p class="text-sm text-gray-300">المستوى: ${player.level}</p>
                                <p class="text-sm text-gray-300">القوة الإجمالية: ${formatPower(player.totalPower)}</p>
                            </div>
                            <button data-target-id="${player.uid}" data-target-name="${player.name}" data-target-power="${player.totalPower}"
                                class="attack-button ${isAttackReady ? '' : 'opacity-50 cursor-not-allowed'}" ${isAttackReady ? '' : 'disabled'}>
                                ${isAttackReady ? 'هجوم' : formatTime(attackCooldownRemaining)}
                            </button>
                        `;
                        challengePlayersList.appendChild(playerElement);
                    });

                    document.querySelectorAll('.attack-button').forEach(button => {
                        button.removeEventListener('click', handleAttackClick);
                        button.addEventListener('click', handleAttackClick);
                    });
                }
            });
        }

        function getAttackCooldownRemaining(targetId) {
            const lastAttackTime = attackCooldowns[targetId];
            if (!lastAttackTime) return 0;
            const cooldownDuration = 30 * 60; // 30 minutes in seconds
            const elapsed = (Date.now() - lastAttackTime) / 1000;
            return Math.max(0, Math.floor(cooldownDuration - elapsed));
        }

        async function handleAttackClick(event) {
            const targetId = event.target.dataset.targetId;
            const targetName = event.target.dataset.targetName;
            const targetPower = parseInt(event.target.dataset.targetPower, 10);

            if (!targetId || !targetName || isNaN(targetPower)) {
                showMessageModal('خطأ', 'بيانات اللاعب المستهدف غير صالحة.');
                return;
            }

            if (getAttackCooldownRemaining(targetId) > 0) {
                showMessageModal('مؤقت التهدئة', `لا يمكنك الهجوم على ${targetName} الآن. يرجى الانتظار.`);
                return;
            }

            // Calculate win chance
            let winChance = 0.25; // Default 25% if weaker
            if (totalPlayerPower > targetPower) {
                winChance = 0.75; // 75% if stronger
            }

            const didWin = Math.random() < winChance;
            const pointsStolen = 50;
            const dollarsStolen = 50;

            if (didWin) {
                playerPoints += pointsStolen;
                playerDollars += dollarsStolen;
                showMessageModal('فوز!', `لقد هاجمت ${targetName} بنجاح وسرقت ${pointsStolen} نقطة و ${dollarsStolen}$!`);
            } else {
                playerPoints -= pointsStolen; // Lose points/dollars if fail
                playerDollars -= dollarsStolen;
                playerPoints = Math.max(0, playerPoints); // Ensure no negative points
                playerDollars = Math.max(0, playerDollars); // Ensure no negative dollars
                showMessageModal('خسارة!', `فشلت في الهجوم على ${targetName} وخسرت ${pointsStolen} نقطة و ${dollarsStolen}$.`);
            }

            // Update opponent's data (reduce their points/dollars)
            if (didWin) {
                const targetPlayerRef = ref(db, `artifacts/${appId}/users/${targetId}/playerData`);
                get(targetPlayerRef).then(snapshot => {
                    if (snapshot.exists()) {
                        const targetData = snapshot.val();
                        const newTargetPoints = Math.max(0, (targetData.playerPoints || 0) - pointsStolen);
                        const newTargetDollars = Math.max(0, (targetData.playerDollars || 0) - dollarsStolen);
                        set(targetPlayerRef, {
                            ...targetData,
                            playerPoints: newTargetPoints,
                            playerDollars: newTargetDollars
                        });
                    }
                }).catch(error => {
                    console.error("Error updating target player data:", error);
                });
            }

            attackCooldowns[targetId] = Date.now();
            saveAttackCooldowns();
            updatePlayerInfoDisplay(); // Update player's own stats
            renderChallengePlayers(); // Re-render challenge list to update cooldowns
        }

        let authReadyPromise;

        document.addEventListener('DOMContentLoaded', async () => {
            authReadyPromise = (async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Initial authentication failed:", error);
                    if (initialAuthToken && error.code === 'auth/custom-token-mismatch') {
                        try {
                            await signInAnonymously(auth);
                        } catch (anonError) {
                            console.error("Anonymous sign-in fallback also failed:", anonError);
                            showMessageModal('خطأ في المصادقة', 'فشل تسجيل الدخول المجهول. يرجى تحديث الصفحة.');
                            return null;
                        }
                    } else {
                        showMessageModal('خطأ في المصادقة', 'فشل تسجيل الدخول. يرجى تحديث الصفحة.');
                        return null;
                    }
                }
                return auth.currentUser;
            })();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isFirebaseLoaded = true;
                    console.log("Firebase Auth State Changed: User is signed in with UID:", userId);

                    await migrateLocalStorageToFirebase();

                    // Load all data from Firebase
                    await loadPlayerData();
                    await loadHouses();
                    await loadInnovationTypes();
                    await loadPlayerInventory();
                    await loadTasks();
                    await loadAttackCooldowns();

                    // Start real-time listeners after initial data load
                    listenForChatMessages();
                    listenForOnlineUsers();
                    startDailyResetTimer();

                    // Set up online status update interval
                    if (onlineStatusUpdater) clearInterval(onlineStatusUpdater);
                    onlineStatusUpdater = setInterval(updateOnlineStatus, 30 * 1000); // Update every 30 seconds
                    updateOnlineStatus(); // Initial update

                    // Remove online status when user disconnects
                    const onlineRef = ref(db, `artifacts/${appId}/public/onlineUsers/${userId}`);
                    onDisconnect(onlineRef).remove().catch(error => {
                        console.error("Could not establish onDisconnect for online status:", error);
                    });

                    // Start global cooldown updater if needed
                    let anySavedCooldown = innovationTypes.some(type => type.cooldownTimeLeft > 0);
                    if (anySavedCooldown && !globalCooldownUpdater) {
                        startGlobalCooldownUpdater();
                    }

                    // Check for initial name setup after data is loaded
                    if (!isNameSetPermanently && (!playerName || playerName === "تعيين اسم")) {
                        if (setNameModal) {
                            setNameModal.classList.remove('hidden');
                            setTimeout(() => {
                                if (setNameModal.querySelector('div')) {
                                    setNameModal.querySelector('div').classList.remove('scale-95', 'opacity-0');
                                    setNameModal.querySelector('div').classList.add('scale-100', 'opacity-100');
                                }
                            }, 10);
                        }
                    }

                } else {
                    console.log("Firebase Auth State Changed: No user signed in.");
                }
            });

            await authReadyPromise;
        });
    </script>
</body>
</html>
