<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة الأسئلة الذهبية</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif; /* Apply Cairo font */
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text color */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem; /* Padding for mobile view */
            box-sizing: border-box;
        }
        .container {
            background-color: #2d3748; /* Slightly lighter dark for container */
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5); /* Darker shadow */
            padding: 1.5rem;
            width: 100%;
            max-width: 400px; /* Max width for mobile-first design */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            border: 2px solid #d4af37; /* Golden border */
        }
        .golden-text {
            color: #d4af37; /* Golden color */
        }
        .btn-primary {
            background-color: #d4af37; /* Golden button */
            color: #1a202c; /* Dark text on golden button */
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* Rounded button */
            font-weight: bold;
            transition: background-color 0.3s ease;
            text-align: center;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #e6b800; /* Lighter golden on hover */
        }
        .btn-secondary {
            background-color: #4a5568; /* Darker grey button */
            color: #e2e8f0;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            transition: background-color 0.3s ease;
            text-align: center;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #6a7588;
        }
        .input-field {
            background-color: #4a5568; /* Darker input field */
            border: 1px solid #d4af37; /* Golden border for input */
            color: #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            box-sizing: border-box;
        }
        .answer-option {
            background-color: #4a5568;
            color: #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
            text-align: center;
        }
        .answer-option:hover {
            background-color: #6a7588;
        }
        .answer-option.correct {
            background-color: #10b981; /* Green for correct */
            color: #ffffff;
        }
        .answer-option.incorrect {
            background-color: #ef4444; /* Red for incorrect */
            color: #ffffff;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2d3748;
            border: 2px solid #d4af37;
            border-radius: 1rem;
            padding: 1.5rem;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.7);
            display: none; /* Hidden by default */
            max-width: 90%; /* Responsive message box */
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
            display: none; /* Hidden by default */
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            background-color: #4a5568;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .leaderboard-item span {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Start Screen -->
        <div id="start-screen" class="flex flex-col items-center gap-6">
            <h1 class="text-3xl font-bold golden-text mb-4">لعبة الأسئلة الذهبية</h1>
            <p class="text-center text-lg">أدخل اسمك:</p>
            <input type="text" id="player-name-input" class="input-field" placeholder="اسم اللاعب" maxlength="15">
            <button id="show-room-screen-btn" class="btn-primary w-full">بدء اللعب</button>
        </div>

        <!-- Room Screen -->
        <div id="room-screen" class="hidden flex-col items-center gap-6">
            <h2 class="text-2xl font-bold golden-text mb-4">الغرف</h2>
            <button id="create-room-btn" class="btn-primary w-full">إنشاء غرفة جديدة</button>
            <div class="w-full text-center text-lg">أو</div>
            <input type="text" id="room-id-input" class="input-field" placeholder="أدخل رمز الغرفة للانضمام" maxlength="10">
            <button id="join-room-btn" class="btn-secondary w-full">الانضمام إلى غرفة</button>
            <button id="back-to-start-btn" class="btn-secondary w-full">العودة</button>
        </div>

        <!-- Waiting Room Screen -->
        <div id="waiting-room-screen" class="hidden flex-col items-center gap-6">
            <h2 class="text-2xl font-bold golden-text mb-4">غرفة الانتظار</h2>
            <p class="text-center text-lg">رمز الغرفة: <span id="display-room-id" class="golden-text font-bold"></span></p>
            <p class="text-center text-gray-400">شارك هذا الرمز مع صديقك لينضم إليك.</p>
            <p class="text-center text-xl" id="waiting-message">في انتظار لاعب آخر...</p>
            <button id="leave-room-btn" class="btn-secondary w-full">مغادرة الغرفة</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden flex-col items-center gap-4">
            <div class="w-full flex justify-between text-lg mb-4">
                <span id="current-player-display" class="golden-text font-bold"></span>
                <span id="turn-display" class="text-gray-400"></span>
            </div>
            <div class="w-full flex justify-around text-base mb-4">
                <div class="flex flex-col items-center">
                    <span id="player1-name-display" class="golden-text font-bold"></span>
                    <span id="player1-score-display" class="text-xl font-bold">النقاط: 0</span>
                    <span id="player1-money-display" class="text-lg">المال: 0</span>
                </div>
                <div class="flex flex-col items-center">
                    <span id="player2-name-display" class="golden-text font-bold"></span>
                    <span id="player2-score-display" class="text-xl font-bold">النقاط: 0</span>
                    <span id="player2-money-display" class="text-lg">المال: 0</span>
                </div>
            </div>

            <h2 id="question-text" class="text-xl text-center mb-6"></h2>
            <div id="answers-container" class="w-full flex flex-col gap-3">
                <!-- Answer options will be injected here by JavaScript -->
            </div>
            <button id="next-question-btn" class="btn-secondary w-full mt-6 hidden">السؤال التالي</button>
        </div>

        <!-- Main Menu (after game or for navigation) -->
        <div id="main-menu" class="hidden flex-col items-center gap-4">
            <h2 class="text-2xl font-bold golden-text mb-4">القائمة الرئيسية</h2>
            <button id="play-again-btn" class="btn-primary w-full">اللعب مرة أخرى</button>
            <button id="leaderboard-btn" class="btn-primary w-full">لوحة الترتيب</button>
            <button id="store-btn" class="btn-secondary w-full">المتجر (قريباً)</button>
            <button id="profile-btn" class="btn-secondary w-full">الملف الشخصي (قريباً)</button>
            <button id="settings-btn" class="btn-secondary w-full">الإعدادات (قريباً)</button>
        </div>

        <!-- Leaderboard Screen -->
        <div id="leaderboard-screen" class="hidden flex-col items-center gap-4">
            <h2 class="text-2xl font-bold golden-text mb-4">لوحة الترتيب</h2>
            <div id="leaderboard-list" class="w-full flex flex-col gap-2">
                <!-- Leaderboard items will be injected here -->
                <p class="text-center text-gray-400" id="leaderboard-loading">جاري تحميل الترتيب...</p>
            </div>
            <button class="btn-secondary w-full" id="back-to-main-from-leaderboard">العودة للقائمة الرئيسية</button>
        </div>

        <!-- Store Screen (Placeholder) -->
        <div id="store-screen" class="hidden flex-col items-center gap-4">
            <h2 class="text-2xl font-bold golden-text mb-4">المتجر</h2>
            <p class="text-center">هنا يمكنك شراء عناصر باستخدام أموالك في اللعبة.</p>
            <p class="text-center text-gray-400">(هذه الميزة تتطلب تطويرًا إضافيًا)</p>
            <button class="btn-secondary w-full" id="back-to-main-from-store">العودة للقائمة الرئيسية</button>
        </div>

        <!-- Profile Screen (Placeholder) -->
        <div id="profile-screen" class="hidden flex-col items-center gap-4">
            <h2 class="text-2xl font-bold golden-text mb-4">الملف الشخصي</h2>
            <p class="text-center">هنا ستعرض إحصائياتك وإنجازاتك.</p>
            <p class="text-center text-gray-400">(هذه الميزة تتطلب تطويرًا إضافيًا)</p>
            <button class="btn-secondary w-full" id="back-to-main-from-profile">العودة للقائمة الرئيسية</button>
        </div>

        <!-- Settings Screen (Placeholder) -->
        <div id="settings-screen" class="hidden flex-col items-center gap-4">
            <h2 class="text-2xl font-bold golden-text mb-4">الإعدادات</h2>
            <p class="text-center">هنا يمكنك تعديل إعدادات اللعبة.</p>
            <p class="text-center text-gray-400">(هذه الميزة تتطلب تطويرًا إضافيًا)</p>
            <button class="btn-secondary w-full" id="back-to-main-from-settings">العودة للقائمة الرئيسية</button>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box" class="message-box">
        <p id="message-text" class="text-xl mb-4"></p>
        <button id="message-ok-btn" class="btn-primary">موافق</button>
    </div>
    <div id="overlay" class="overlay"></div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, addDoc, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================================
        // === هام جداً: إعدادات Firebase الخاصة بك ===
        // ====================================================================================
        // عند تشغيل اللعبة على GitHub Pages أو أي خادم ويب آخر، يجب عليك استبدال
        // المتغيرات __app_id و __firebase_config و __initial_auth_token
        // بإعدادات مشروع Firebase الخاص بك.
        // احصل على هذه الإعدادات من وحدة تحكم Firebase (إعدادات المشروع -> تطبيقاتك).
        //
        // مثال:
        // const MY_FIREBASE_CONFIG = {
        //     apiKey: "YOUR_API_KEY",
        //     authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        //     projectId: "YOUR_PROJECT_ID",
        //     storageBucket: "YOUR_PROJECT_ID.appspot.com",
        //     messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        //     appId: "YOUR_APP_ID"
        // };
        //
        // ثم استخدمها كالتالي:
        // const firebaseConfig = MY_FIREBASE_CONFIG;
        // const appId = MY_FIREBASE_CONFIG.projectId; // استخدم projectId كـ appId لمسارات Firestore
        // const initialAuthToken = null; // لن يكون لديك رمز مصادقة مخصص هنا عادةً

        // ====================================================================================
        // === استخدام المتغيرات العامة لبيئة Canvas (لا تعدل هذا الجزء إذا كنت في Canvas) ===
        // ====================================================================================
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // سيتم استبداله بمعرف مشروعك إذا كنت خارج Canvas
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {}; // سيتم استبداله بإعدادات مشروعك
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // لن يكون متاحًا خارج Canvas

        // إذا كنت تقوم بالتشغيل خارج بيئة Canvas، قم بإلغاء التعليق على الأسطر التالية
        // واستبدل "YOUR_..." بقيم مشروعك الفعلية من Firebase Console.
        /*
        const MY_FIREBASE_CONFIG = {
             apiKey: "YOUR_API_KEY",
             authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
             projectId: "YOUR_PROJECT_ID",
             storageBucket: "YOUR_PROJECT_ID.appspot.com",
             messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
             appId: "YOUR_APP_ID" // هذا هو appId الفعلي لتطبيق الويب الخاص بك
        };
        const firebaseConfig = MY_FIREBASE_CONFIG;
        const appId = MY_FIREBASE_CONFIG.projectId; // نستخدم projectId كـ appId في مسارات Firestore
        const initialAuthToken = null; // لا يوجد رمز مصادقة مخصص عند التشغيل خارج Canvas
        */
        // ====================================================================================


        let app;
        let db;
        let auth;
        let userId = null; // User ID for Firestore operations
        let unsubscribeFromRoom = null; // To unsubscribe from Firestore listener

        // Initialize Firebase and authenticate
        const initializeFirebase = async () => {
            try {
                // تحقق مما إذا كانت إعدادات Firebase موجودة
                if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.projectId) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Sign in with custom token if available, otherwise anonymously
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Firebase: Signed in with custom token.");
                    } else {
                        // إذا لم يكن هناك رمز مخصص، قم بتسجيل الدخول كمستخدم مجهول
                        await signInAnonymously(auth);
                        console.log("Firebase: Signed in anonymously.");
                    }

                    // Listen for auth state changes to get the user ID
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Firebase: User ID:", userId);
                            // هنا يمكنك تحميل بيانات المستخدم من Firestore إذا لزم الأمر
                        } else {
                            userId = null;
                            console.log("Firebase: No user signed in.");
                        }
                    });
                } else {
                    console.warn("Firebase: إعدادات Firebase غير موجودة أو غير كاملة. لن يتم تهيئة Firebase.");
                    showMessage("إعدادات Firebase غير موجودة. الرجاء التأكد من تهيئة Firebase بشكل صحيح.", "خطأ في التهيئة");
                }
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showMessage("حدث خطأ في تهيئة Firebase: " + error.message + ". قد لا تعمل ميزات الحفظ السحابي.", "خطأ");
            }
        };

        // Call Firebase initialization
        initializeFirebase();

        // --- Game Variables ---
        let playerName = '';
        let currentRoomId = null;
        let players = [
            { id: '', name: '', score: 0, money: 0 },
            { id: '', name: '', score: 0, money: 0 }
        ];
        let currentPlayerIndex = 0; // Index in the `players` array
        let currentTurnPlayerId = ''; // The actual Firebase user ID of the player whose turn it is
        let currentQuestionIndex = 0;
        let askedQuestions = new Set(); // To keep track of asked questions
        const maxQuestionsPerGame = 50; // Total questions for the game
        const pointsPerCorrectAnswer = 10;
        const moneyPerCorrectAnswer = 5;

        // Sample Questions (50 general questions)
        const questions = [
            { question: "ما هي عاصمة العراق؟", options: ["بغداد", "الرياض", "القاهرة", "دمشق"], correct: "بغداد" },
            { question: "كم عدد الكواكب في نظامنا الشمسي؟", options: ["7", "8", "9", "10"], correct: "8" },
            { question: "ما هو أكبر محيط في العالم؟", options: ["المحيط الأطلسي", "المحيط الهندي", "المحيط الهادئ", "المحيط المتجمد الشمالي"], correct: "المحيط الهادئ" },
            { question: "من هو مؤلف رواية 'الأمير الصغير'؟", options: ["فيكتور هوغو", "أنتوان دو سانت-إكزوبيري", "تشارلز ديكنز", "ليو تولستوي"], correct: "أنتوان دو سانت-إكزوبيري" },
            { question: "ما هو العنصر الكيميائي الذي رمزه Au؟", options: ["الفضة", "النحاس", "الذهب", "الحديد"], correct: "الذهب" },
            { question: "ما هو أطول نهر في العالم؟", options: ["نهر النيل", "نهر الأمازون", "نهر يانغتسي", "نهر المسيسيبي"], correct: "نهر النيل" },
            { question: "في أي قارة تقع صحراء غوبي؟", options: ["أفريقيا", "آسيا", "أمريكا الشمالية", "أستراليا"], correct: "آسيا" },
            { question: "ما هو الحيوان المعروف بأنه 'سفينة الصحراء'؟", options: ["الحصان", "الجمل", "الفيل", "الزرافة"], correct: "الجمل" },
            { question: "ما هو اسم أول رجل سار على سطح القمر؟", options: ["يوري غاغارين", "نيل أرمسترونغ", "باز ألدرين", "مايكل كولينز"], correct: "نيل أرمسترونغ" },
            { question: "ما هي أكبر دولة في العالم من حيث المساحة؟", options: ["الصين", "كندا", "روسيا", "الولايات المتحدة"], correct: "روسيا" },
            { question: "ما هو الكوكب الأحمر؟", options: ["المريخ", "المشتري", "الزهرة", "زحل"], correct: "المريخ" },
            { question: "من بنى الأهرامات في مصر؟", options: ["الرومان", "اليونانيون", "المصريون القدماء", "الفرس"], correct: "المصريون القدماء" },
            { question: "ما هي العملة الرسمية لليابان؟", options: ["اليورو", "الدولار", "الين", "الجنيه"], correct: "الين" },
            { question: "ما هو أسرع حيوان على وجه الأرض؟", options: ["الأسد", "الفهد", "الغزال", "الحصان"], correct: "الفهد" },
            { question: "ما هو أكبر حيوان على وجه الأرض؟", options: ["الفيل", "الحوت الأزرق", "الزرافة", "الدب القطبي"], correct: "الحوت الأزرق" },
            { question: "ما هي أعلى قمة جبلية في العالم؟", options: ["كي2", "كانغشينجونغا", "إيفرست", "لوتسي"], correct: "إيفرست" },
            { question: "ما هو الغاز الأكثر وفرة في الغلاف الجوي للأرض؟", options: ["الأكسجين", "ثاني أكسيد الكربون", "النيتروجين", "الأرغون"], correct: "النيتروجين" },
            { question: "ما هو الاسم الكيميائي للملح؟", options: ["كلوريد البوتاسيوم", "بيكربونات الصوديوم", "كلوريد الصوديوم", "كبريتات المغنيسيوم"], correct: "كلوريد الصوديوم" },
            { question: "من اخترع المصباح الكهربائي؟", options: ["نيكولا تسلا", "توماس إديسون", "ألكسندر غراهام بيل", "ألبرت أينشتاين"], correct: "توماس إديسون" },
            { question: "ما هي اللغة الأكثر تحدثًا في العالم (كلغة أم)؟", options: ["الإنجليزية", "الإسبانية", "الماندرين الصينية", "الهندية"], correct: "الماندرين الصينية" },
            { question: "ما هو الحيوان الذي يمتلك 3 قلوب؟", options: ["الأخطبوط", "التمساح", "الكنغر", "الضفدع"], correct: "الأخطبوط" },
            { question: "ما هي المدينة التي يقع فيها برج إيفل؟", options: ["لندن", "روما", "باريس", "برلين"], correct: "باريس" },
            { question: "ما هو لون الزرافة؟", options: ["أصفر وأسود", "بني وأبيض", "بني وأصفر", "أبيض وأسود"], correct: "بني وأصفر" },
            { question: "ما هي عاصمة إيطاليا؟", options: ["ميلانو", "البندقية", "روما", "فلورنسا"], correct: "روما" },
            { question: "ما هو أكبر صحراء حارة في العالم؟", options: ["صحراء غوبي", "الصحراء الكبرى", "صحراء أتاكاما", "الصحراء العربية"], correct: "الصحراء الكبرى" },
            { question: "ما هو اسم الكوكب الذي يعرف بـ 'جوهرة النظام الشمسي'؟", options: ["المشتري", "زحل", "نبتون", "أورانوس"], correct: "زحل" },
            { question: "ما هو الطائر الذي لا يطير؟", options: ["النسر", "البطريق", "الصقر", "العصفور"], correct: "البطريق" },
            { question: "ما هو أطول سلسلة جبلية في العالم؟", options: ["جبال روكي", "جبال الأنديز", "جبال الهيمالايا", "جبال الألب"], correct: "جبال الأنديز" },
            { question: "ما هي الدولة التي تشتهر بالسامبا؟", options: ["إسبانيا", "البرازيل", "الأرجنتين", "كولومبيا"], correct: "البرازيل" },
            { question: "ما هو عدد ألوان قوس قزح؟", options: ["5", "6", "7", "8"], correct: "7" },
            { question: "ما هو اسم أكبر جزيرة في العالم؟", options: ["مدغشقر", "بورنيو", "غرينلاند", "نيو غينيا"], correct: "غرينلاند" },
            { question: "ما هو اسم المحيط الذي يفصل بين أوروبا وأمريكا؟", options: ["المحيط الهادئ", "المحيط الهندي", "المحيط الأطلسي", "المحيط المتجمد الجنوبي"], correct: "المحيط الأطلسي" },
            { question: "ما هو الحيوان الذي ينام وعيناه مفتوحتان؟", options: ["الضفدع", "السمكة", "الثعبان", "التمساح"], correct: "السمكة" },
            { question: "ما هو اسم أول رئيس للولايات المتحدة الأمريكية؟", options: ["توماس جيفرسون", "أبراهام لينكون", "جورج واشنطن", "بنجامين فرانكلين"], correct: "جورج واشنطن" },
            { question: "ما هي الرياضة التي تعرف بـ 'ملكة الرياضات'؟", options: ["كرة القدم", "كرة السلة", "ألعاب القوى", "السباحة"], correct: "ألعاب القوى" },
            { question: "ما هو اسم الكوكب الأقرب إلى الشمس؟", options: ["الزهرة", "المريخ", "عطارد", "الأرض"], correct: "عطارد" },
            { question: "ما هو اسم الغاز الذي تستنشقه النباتات؟", options: ["الأكسجين", "النيتروجين", "ثاني أكسيد الكربون", "الهيدروجين"], correct: "ثاني أكسيد الكربون" },
            { question: "ما هو اسم أكبر حيوان بري على وجه الأرض؟", options: ["وحيد القرن", "الفيل الأفريقي", "الدب القطبي", "الزرافة"], correct: "الفيل الأفريقي" },
            { question: "ما هي عاصمة أستراليا؟", options: ["سيدني", "ملبورن", "كانبرا", "بريزبان"], correct: "كانبرا" },
            { question: "ما هو اسم العملية التي تحول فيها النباتات ضوء الشمس إلى طاقة؟", options: ["التنفس", "التمثيل الضوئي", "التبخر", "التكثف"], correct: "التمثيل الضوئي" },
            { question: "ما هو اسم أصغر قارة في العالم؟", options: ["أفريقيا", "أوروبا", "أستراليا", "أمريكا الجنوبية"], correct: "أستراليا" },
            { question: "ما هو اسم البحر الذي يفصل بين أفريقيا وأوروبا؟", options: ["البحر الأحمر", "البحر الأسود", "البحر الأبيض المتوسط", "بحر العرب"], correct: "البحر الأبيض المتوسط" },
            { question: "ما هو اسم الجهاز الذي يقيس درجة الحرارة؟", options: ["البارومتر", "الأنيمومتر", "الترمومتر", "الهايدروميتر"], correct: "الترمومتر" },
            { question: "ما هو اسم أكبر محيط متجمد؟", options: ["المحيط المتجمد الشمالي", "المحيط المتجمد الجنوبي", "المحيط الهادئ", "المحيط الأطلسي"], correct: "المحيط المتجمد الجنوبي" },
            { question: "ما هو اسم الفاكهة التي تعرف بـ 'ملك الفواكه'؟", options: ["التفاح", "المانجو", "الموز", "البرتقال"], correct: "المانجو" },
            { question: "ما هو اسم أطول مبنى في العالم؟", options: ["برج شنغهاي", "أبراج بتروناس", "برج خليفة", "تايبيه 101"], correct: "برج خليفة" },
            { question: "ما هو اسم الحيوان الذي يمتلك أطول رقبة؟", options: ["الزرافة", "النعامة", "الجمل", "الفيل"], correct: "الزرافة" },
            { question: "ما هي عاصمة اليونان؟", options: ["أثينا", "سالونيك", "باتراس", "هيراكليون"], correct: "أثينا" },
            { question: "ما هو اسم العملية التي يتحول فيها الماء من سائل إلى غاز؟", options: ["التكثف", "التجمد", "التبخر", "الانصهار"], correct: "التبخر" },
            { question: "ما هو اسم أكبر عضو في جسم الإنسان؟", options: ["القلب", "الرئة", "الجلد", "الكبد"], correct: "الجلد" }
        ];


        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const roomScreen = document.getElementById('room-screen');
        const waitingRoomScreen = document.getElementById('waiting-room-screen');
        const gameScreen = document.getElementById('game-screen');
        const mainMenu = document.getElementById('main-menu');
        const leaderboardScreen = document.getElementById('leaderboard-screen');
        const storeScreen = document.getElementById('store-screen');
        const profileScreen = document.getElementById('profile-screen');
        const settingsScreen = document.getElementById('settings-screen');

        const playerNameInput = document.getElementById('player-name-input');
        const showRoomScreenBtn = document.getElementById('show-room-screen-btn');

        const createRoomBtn = document.getElementById('create-room-btn');
        const roomIdInput = document.getElementById('room-id-input');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const displayRoomId = document.getElementById('display-room-id');
        const waitingMessage = document.getElementById('waiting-message');
        const leaveRoomBtn = document.getElementById('leave-room-btn');

        const currentPlayerDisplay = document.getElementById('current-player-display');
        const turnDisplay = document.getElementById('turn-display');
        const player1NameDisplay = document.getElementById('player1-name-display');
        const player1ScoreDisplay = document.getElementById('player1-score-display');
        const player1MoneyDisplay = document.getElementById('player1-money-display');
        const player2NameDisplay = document.getElementById('player2-name-display');
        const player2ScoreDisplay = document.getElementById('player2-score-display');
        const player2MoneyDisplay = document.getElementById('player2-money-display');
        const questionText = document.getElementById('question-text');
        const answersContainer = document.getElementById('answers-container');
        const nextQuestionBtn = document.getElementById('next-question-btn');

        const playAgainBtn = document.getElementById('play-again-btn');
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const storeBtn = document.getElementById('store-btn');
        const profileBtn = document.getElementById('profile-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const backToStartBtn = document.getElementById('back-to-start-btn');
        const backToMainFromStoreBtn = document.getElementById('back-to-main-from-store');
        const backToMainFromProfileBtn = document.getElementById('back-to-main-from-profile');
        const backToMainFromSettingsBtn = document.getElementById('back-to-main-from-settings');
        const backToMainFromLeaderboardBtn = document.getElementById('back-to-main-from-leaderboard');
        const leaderboardList = document.getElementById('leaderboard-list');
        const leaderboardLoading = document.getElementById('leaderboard-loading');


        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageOkBtn = document.getElementById('message-ok-btn');
        const overlay = document.getElementById('overlay');

        // --- Utility Functions ---
        function showMessage(message, title = "إشعار") {
            messageText.textContent = message;
            messageBox.style.display = 'block';
            overlay.style.display = 'block';
            messageOkBtn.onclick = () => {
                messageBox.style.display = 'none';
                overlay.style.display = 'none';
            };
        }

        function showScreen(screenId) {
            startScreen.classList.add('hidden');
            roomScreen.classList.add('hidden');
            waitingRoomScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            mainMenu.classList.add('hidden');
            leaderboardScreen.classList.add('hidden');
            storeScreen.classList.add('hidden');
            profileScreen.classList.add('hidden');
            settingsScreen.classList.add('hidden');

            document.getElementById(screenId).classList.remove('hidden');
            document.getElementById(screenId).classList.add('flex');
        }

        function generateRoomId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // --- Room Management Functions ---
        async function createRoom() {
            if (!userId) {
                showMessage("الرجاء الانتظار حتى يتم تهيئة Firebase.");
                return;
            }
            if (!playerName) {
                showMessage("الرجاء إدخال اسمك أولاً.");
                return;
            }

            currentRoomId = generateRoomId();
            displayRoomId.textContent = currentRoomId;
            waitingMessage.textContent = "في انتظار لاعب آخر...";
            showScreen('waiting-room-screen');

            try {
                await setDoc(doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId), {
                    hostId: userId,
                    hostName: playerName,
                    player2Id: null,
                    player2Name: null,
                    status: 'waiting',
                    questions: [],
                    playerScores: { [userId]: { score: 0, money: 0 } },
                    currentQuestionIndex: 0,
                    currentTurnPlayerId: userId,
                    lastUpdated: new Date()
                });
                console.log("Room created with ID:", currentRoomId);
                showMessage(`تم إنشاء الغرفة بنجاح! رمز الغرفة: ${currentRoomId}. شاركه مع صديقك.`);

                listenToRoomChanges(currentRoomId);

            } catch (error) {
                console.error("Error creating room:", error);
                showMessage("فشل في إنشاء الغرفة. الرجاء المحاولة مرة أخرى.");
                showScreen('room-screen');
            }
        }

        async function joinRoom() {
            if (!userId) {
                showMessage("الرجاء الانتظار حتى يتم تهيئة Firebase.");
                return;
            }
            if (!playerName) {
                showMessage("الرجاء إدخال اسمك أولاً.");
                return;
            }

            const roomId = roomIdInput.value.trim().toUpperCase();
            if (!roomId) {
                showMessage("الرجاء إدخال رمز الغرفة.");
                return;
            }

            currentRoomId = roomId;
            displayRoomId.textContent = currentRoomId;
            waitingMessage.textContent = "جاري الانضمام للغرفة...";
            showScreen('waiting-room-screen');

            try {
                const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomId);
                const roomSnap = await getDoc(roomRef);

                if (roomSnap.exists()) {
                    const roomData = roomSnap.data();
                    if (roomData.status === 'waiting' && !roomData.player2Id) {
                        await updateDoc(roomRef, {
                            player2Id: userId,
                            player2Name: playerName,
                            status: 'playing',
                            playerScores: {
                                ...roomData.playerScores,
                                [userId]: { score: 0, money: 0 }
                            },
                            lastUpdated: new Date()
                        });
                        console.log("Joined room:", roomId);
                        showMessage(`تم الانضمام إلى الغرفة ${roomId} بنجاح!`);

                        listenToRoomChanges(roomId);

                    } else if (roomData.status === 'playing') {
                        showMessage("هذه الغرفة قيد اللعب بالفعل أو ممتلئة.");
                        showScreen('room-screen');
                    } else {
                        showMessage("لا يمكن الانضمام لهذه الغرفة حالياً.");
                        showScreen('room-screen');
                    }
                } else {
                    showMessage("رمز الغرفة غير صحيح أو الغرفة غير موجودة.");
                    showScreen('room-screen');
                }
            } catch (error) {
                console.error("Error joining room:", error);
                showMessage("فشل في الانضمام إلى الغرفة. الرجاء المحاولة مرة أخرى.");
                showScreen('room-screen');
            }
        }

        function leaveRoom() {
            if (unsubscribeFromRoom) {
                unsubscribeFromRoom();
                unsubscribeFromRoom = null;
            }
            currentRoomId = null;
            showMessage("لقد غادرت الغرفة.");
            showScreen('room-screen');
        }

        function listenToRoomChanges(roomId) {
            if (!db) {
                console.warn("Firestore not initialized, cannot listen to room changes.");
                return;
            }

            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomId);

            if (unsubscribeFromRoom) {
                unsubscribeFromRoom();
            }

            unsubscribeFromRoom = onSnapshot(roomRef, (docSnap) => {
                if (docSnap.exists()) {
                    const roomData = docSnap.data();
                    console.log("Room data updated:", roomData);

                    if (roomData.status === 'playing' && roomData.player2Id && roomData.hostId) {
                        players[0] = { id: roomData.hostId, name: roomData.hostName, score: roomData.playerScores[roomData.hostId]?.score || 0, money: roomData.playerScores[roomData.hostId]?.money || 0 };
                        players[1] = { id: roomData.player2Id, name: roomData.player2Name, score: roomData.playerScores[roomData.player2Id]?.score || 0, money: roomData.playerScores[roomData.player2Id]?.money || 0 };

                        player1NameDisplay.textContent = players[0].name;
                        player2NameDisplay.textContent = players[1].name;

                        if (roomData.questions.length === 0 && userId === roomData.hostId) {
                            const shuffledQuestions = [...questions].sort(() => Math.random() - 0.5).slice(0, maxQuestionsPerGame);
                            updateDoc(roomRef, { questions: shuffledQuestions });
                        }

                        if (roomData.questions.length > 0) {
                            currentQuestionIndex = roomData.currentQuestionIndex;
                            currentTurnPlayerId = roomData.currentTurnPlayerId;
                            currentPlayerIndex = players.findIndex(p => p.id === currentTurnPlayerId);
                            if (currentPlayerIndex === -1) currentPlayerIndex = 0;

                            showScreen('game-screen');
                            updatePlayerDisplays();
                            loadQuestionFromRoomState(roomData.questions[currentQuestionIndex]);
                        }
                    } else if (roomData.status === 'finished') {
                        endGame(roomData.playerScores);
                    }
                    if (roomData.status === 'waiting' && !roomData.player2Id && userId === roomData.hostId) {
                         waitingMessage.textContent = "في انتظار لاعب آخر...";
                    }
                } else {
                    showMessage("الغرفة لم تعد موجودة. الرجاء إنشاء غرفة جديدة أو الانضمام إلى أخرى.");
                    leaveRoom();
                    showScreen('room-screen');
                }
            }, (error) => {
                console.error("Error listening to room changes:", error);
                showMessage("حدث خطأ أثناء الاتصال بالغرفة. الرجاء المحاولة مرة أخرى.");
                leaveRoom();
                showScreen('room-screen');
            });
        }

        function getRandomQuestion() {
            if (askedQuestions.size === questions.length) {
                return null;
            }
            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * questions.length);
            } while (askedQuestions.has(randomIndex));
            askedQuestions.add(randomIndex);
            return questions[randomIndex];
        }

        // --- Game Logic Functions ---
        function setPlayerName() {
            const name = playerNameInput.value.trim();
            if (!name) {
                showMessage("الرجاء إدخال اسمك.");
                return;
            }
            playerName = name;
            showScreen('room-screen');
        }

        function loadQuestionFromRoomState(questionData) {
            if (!questionData) {
                endGame();
                return;
            }

            questionText.textContent = questionData.question;
            answersContainer.innerHTML = '';
            nextQuestionBtn.classList.add('hidden');

            const shuffledOptions = [...questionData.options].sort(() => Math.random() - 0.5);

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('answer-option', 'w-full');
                button.disabled = (userId !== currentTurnPlayerId);
                button.style.cursor = (userId !== currentTurnPlayerId) ? 'not-allowed' : 'pointer';
                button.onclick = () => checkAnswer(option, questionData.correct, button);
                answersContainer.appendChild(button);
            });
        }

        async function checkAnswer(selectedOption, correctAnswer, clickedButton) {
            Array.from(answersContainer.children).forEach(btn => {
                btn.disabled = true;
                btn.style.cursor = 'default';
            });

            let isCorrect = (selectedOption === correctAnswer);

            if (isCorrect) {
                clickedButton.classList.add('correct');
                showMessage("إجابة صحيحة!");
            } else {
                clickedButton.classList.add('incorrect');
                Array.from(answersContainer.children).forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });
                showMessage(`إجابة خاطئة. الإجابة الصحيحة هي: ${correctAnswer}`);
            }

            const currentPlayer = players.find(p => p.id === userId);
            if (currentPlayer) {
                if (isCorrect) {
                    currentPlayer.score += pointsPerCorrectAnswer;
                    currentPlayer.money += moneyPerCorrectAnswer;
                }
            }
            updatePlayerDisplays();

            if (db && currentRoomId) {
                const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
                const nextQuestionIdx = currentQuestionIndex + 1;
                const nextPlayerIdx = (currentPlayerIndex + 1) % players.length;
                const nextTurnPlayerId = players[nextPlayerIdx].id;

                let updatedPlayerScores = {};
                players.forEach(p => {
                    updatedPlayerScores[p.id] = { score: p.score, money: p.money };
                });

                await updateDoc(roomRef, {
                    playerScores: updatedPlayerScores,
                    currentQuestionIndex: nextQuestionIdx,
                    currentTurnPlayerId: nextTurnPlayerId,
                    lastUpdated: new Date()
                }).catch(error => {
                    console.error("Error updating room state after answer:", error);
                });
            }

            nextQuestionBtn.classList.remove('hidden');
            nextQuestionBtn.disabled = (userId !== currentTurnPlayerId);
            nextQuestionBtn.style.cursor = (userId !== currentTurnPlayerId) ? 'not-allowed' : 'pointer';
        }

        function updatePlayerDisplays() {
            const player1 = players[0];
            const player2 = players[1];

            player1NameDisplay.textContent = player1.name || "اللاعب 1";
            player1ScoreDisplay.textContent = `النقاط: ${player1.score}`;
            player1MoneyDisplay.textContent = `المال: ${player1.money}`;

            player2NameDisplay.textContent = player2.name || "اللاعب 2";
            player2ScoreDisplay.textContent = `النقاط: ${player2.score}`;
            player2MoneyDisplay.textContent = `المال: ${player2.money}`;

            currentPlayerDisplay.textContent = `الدور: ${players.find(p => p.id === currentTurnPlayerId)?.name || '...'}`;
            turnDisplay.textContent = `السؤال ${currentQuestionIndex + 1} من ${maxQuestionsPerGame}`;
        }

        async function nextTurn() {
            if (currentQuestionIndex + 1 >= maxQuestionsPerGame) {
                endGame();
                return;
            }

            if (userId !== currentTurnPlayerId) {
                showMessage("ليس دورك!");
                return;
            }
            showMessage("جاري الانتقال للسؤال التالي...");
        }

        async function endGame(finalScores = null) {
            if (unsubscribeFromRoom) {
                unsubscribeFromRoom();
                unsubscribeFromRoom = null;
            }

            let winnerMessage = "";
            let p1Score = finalScores ? finalScores[players[0].id]?.score || 0 : players[0].score;
            let p2Score = finalScores ? finalScores[players[1].id]?.score || 0 : players[1].score;
            let p1Money = finalScores ? finalScores[players[0].id]?.money || 0 : players[0].money;
            let p2Money = finalScores ? finalScores[players[1].id]?.money || 0 : players[1].money;

            if (p1Score > p2Score) {
                winnerMessage = `تهانينا، ${players[0].name} فاز باللعبة!`;
            } else if (p2Score > p1Score) {
                winnerMessage = `تهانينا، ${players[1].name} فاز باللعبة!`;
            } else {
                winnerMessage = "تعادل بين اللاعبين!";
            }
            showMessage(`انتهت اللعبة!\n${winnerMessage}\nالنتائج النهائية:\n${players[0].name}: ${p1Score} نقطة, ${p1Money} مال\n${players[1].name}: ${p2Score} نقطة, ${p2Money} مال`);

            await updatePlayerProfile(players[0].id, players[0].name, p1Score, p1Money);
            await updatePlayerProfile(players[1].id, players[1].name, p2Score, p2Money);

            showScreen('main-menu');

            if (db && userId && currentRoomId) {
                try {
                    const userGameResultRef = doc(collection(db, `artifacts/${appId}/users/${userId}/game_history`));
                    await setDoc(userGameResultRef, {
                        roomId: currentRoomId,
                        player1Id: players[0].id,
                        player1Name: players[0].name,
                        player1Score: p1Score,
                        player1Money: p1Money,
                        player2Id: players[1].id,
                        player2Name: players[1].name,
                        player2Score: p2Score,
                        player2Money: p2Money,
                        timestamp: new Date(),
                        playedBy: userId
                    });
                    console.log("Game results saved to Firestore for user:", userId);

                    await updateDoc(doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId), {
                        status: 'finished',
                        lastUpdated: new Date()
                    });

                } catch (error) {
                    console.error("Error saving game results to Firestore:", error);
                    showMessage("حدث خطأ في حفظ نتائج اللعبة سحابياً.");
                }
            } else {
                console.warn("Firebase not initialized, userId, or currentRoomId not available. Cannot save to cloud.");
            }
            currentRoomId = null;
        }

        // --- Player Profile & Leaderboard Functions ---
        async function updatePlayerProfile(playerId, playerName, gameScore, gameMoney) {
            if (!db || !playerId) {
                console.warn("Firestore not initialized or player ID not available. Cannot update profile.");
                return;
            }

            const profileRef = doc(db, `artifacts/${appId}/public/data/player_profiles`, playerId);
            try {
                const profileSnap = await getDoc(profileRef);
                let currentTotalScore = 0;
                let currentTotalMoney = 0;

                if (profileSnap.exists()) {
                    const data = profileSnap.data();
                    currentTotalScore = data.totalScore || 0;
                    currentTotalMoney = data.totalMoney || 0;
                }

                await setDoc(profileRef, {
                    name: playerName,
                    totalScore: currentTotalScore + gameScore,
                    totalMoney: currentTotalMoney + gameMoney,
                    lastPlayed: new Date(),
                    userId: playerId
                }, { merge: true });
                console.log(`Player profile updated for ${playerName} (${playerId})`);
            } catch (error) {
                console.error("Error updating player profile:", error);
                showMessage("حدث خطأ أثناء تحديث ملف اللاعب الشخصي.");
            }
        }

        async function loadLeaderboard() {
            if (!db) {
                showMessage("Firebase غير مهيأ. لا يمكن تحميل لوحة الترتيب.");
                return;
            }

            leaderboardList.innerHTML = '';
            leaderboardLoading.classList.remove('hidden');

            try {
                const profilesCollection = collection(db, `artifacts/${appId}/public/data/player_profiles`);
                const querySnapshot = await getDocs(profilesCollection);
                const playersData = [];
                querySnapshot.forEach((doc) => {
                    playersData.push(doc.data());
                });

                playersData.sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));

                leaderboardLoading.classList.add('hidden');

                if (playersData.length === 0) {
                    leaderboardList.innerHTML = '<p class="text-center text-gray-400">لا توجد بيانات في لوحة الترتيب بعد.</p>';
                    return;
                }

                playersData.forEach((player, index) => {
                    const playerItem = document.createElement('div');
                    playerItem.classList.add('leaderboard-item');
                    playerItem.innerHTML = `
                        <span>${index + 1}. ${player.name}</span>
                        <span class="golden-text">${player.totalScore || 0} نقطة</span>
                    `;
                    leaderboardList.appendChild(playerItem);
                });

            } catch (error) {
                console.error("Error loading leaderboard:", error);
                showMessage("فشل في تحميل لوحة الترتيب. الرجاء المحاولة مرة أخرى.");
                leaderboardLoading.classList.add('hidden');
                leaderboardList.innerHTML = '<p class="text-center text-red-400">حدث خطأ أثناء تحميل لوحة الترتيب.</p>';
            }
        }


        // --- Event Listeners ---
        showRoomScreenBtn.addEventListener('click', setPlayerName);
        createRoomBtn.addEventListener('click', createRoom);
        joinRoomBtn.addEventListener('click', joinRoom);
        nextQuestionBtn.addEventListener('click', nextTurn);
        leaveRoomBtn.addEventListener('click', leaveRoom);
        backToStartBtn.addEventListener('click', () => showScreen('start-screen'));
        backToMainFromStoreBtn.addEventListener('click', () => showScreen('main-menu'));
        backToMainFromProfileBtn.addEventListener('click', () => showScreen('main-menu'));
        backToMainFromSettingsBtn.addEventListener('click', () => showScreen('main-menu'));
        backToMainFromLeaderboardBtn.addEventListener('click', () => showScreen('main-menu'));

        playAgainBtn.addEventListener('click', () => {
            players = [
                { id: '', name: '', score: 0, money: 0 },
                { id: '', name: '', score: 0, money: 0 }
            ];
            currentPlayerIndex = 0;
            currentQuestionIndex = 0;
            askedQuestions.clear();
            currentRoomId = null;
            playerNameInput.value = '';
            roomIdInput.value = '';
            showScreen('start-screen');
        });
        storeBtn.addEventListener('click', () => showScreen('store-screen'));
        profileBtn.addEventListener('click', () => showScreen('profile-screen'));
        settingsBtn.addEventListener('click', () => showScreen('settings-screen'));
        leaderboardBtn.addEventListener('click', () => {
            showScreen('leaderboard-screen');
            loadLeaderboard();
        });

        // Initial screen on load
        showScreen('start-screen');
    </script>
</body>
</html>
